<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dirigenti ‚Äì MyApp ‚Äì Il tuo dirigente sempre con te</title>

  <!-- PWA Meta -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a2e">

  <!-- Icone (metti i file dentro /icons) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind (ok per test/dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:'#1a1a2e', secondary:'#16213e', accent:'#0f3460', aurora:'#e94560',
            cyan:'#00d4ff', magenta:'#ff006e', gold:'#ffd700', teal:'#03dac6',
            dark:'#0a0a23', light:'#ffffff', muted:'#64748b', success:'#00ea8d',
            warning:'#ffb800', error:'#ff4757', textPrimary:'#111827', textSecondary:'#1f2937',
            textMuted:'#374151', bgCard:'#ffffff', bgOverlay:'#ffffff', bgSection:'rgba(255,255,255,0.98)'
          },
          fontFamily:{ sans:['Inter','system-ui','sans-serif'] },
          fontSize:{
            'fluid-xs':'clamp(0.875rem,2.5vw,1rem)',
            'fluid-sm':'clamp(1rem,2.8vw,1.125rem)',
            'fluid-base':'clamp(1.125rem,3vw,1.25rem)',
            'fluid-lg':'clamp(1.25rem,3.5vw,1.5rem)',
            'fluid-xl':'clamp(1.5rem,4vw,1.75rem)',
            'fluid-2xl':'clamp(1.75rem,4.5vw,2.25rem)',
            'fluid-3xl':'clamp(2.25rem,5.5vw,2.75rem)',
            'fluid-4xl':'clamp(2.75rem,6.5vw,3.5rem)',
            'fluid-5xl':'clamp(3rem,7.5vw,4.5rem)',
            'fluid-6xl':'clamp(3.5rem,8.5vw,5.5rem)',
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --gradient-aurora: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-cyber: linear-gradient(135deg,#0a0a23 0%,#1a1a2e 50%,#00d4ff 100%);
      --gradient-magic: linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
      --bg-card-solid:#fff; --bg-card-slight:rgba(255,255,255,.98); --bg-section:rgba(255,255,255,.95);
      --shadow-card-readable:0 8px 40px rgba(0,0,0,.12);
      --shadow-card-hover-readable:0 16px 60px rgba(0,0,0,.18);
      --border-card-readable:2px solid rgba(226,232,240,.8);
      --line-height-comfortable:1.7; --line-height-headers:1.3;
    }
    *{scroll-behavior:smooth}
    body{
      background:var(--gradient-aurora); background-size:400% 400%;
      animation:aurora-subtle 25s ease infinite; min-height:100vh;
      font-family:'Inter',system-ui,sans-serif; overflow-x:hidden; position:relative;
      line-height:var(--line-height-comfortable); font-weight:500;
    }
    @keyframes aurora-subtle{0%,100%{background-position:0% 50%}25%{background-position:100% 50%}50%{background-position:100% 100%}75%{background-position:0% 100%}}
    .text-ultra-visible{color:#fff;text-shadow:0 4px 8px rgba(0,0,0,.9),0 2px 4px rgba(0,0,0,.8),0 1px 2px rgba(0,0,0,1);font-weight:900;line-height:var(--line-height-headers)}
    .dirigente-card{background:var(--bg-card-solid);border:var(--border-card-readable);border-radius:20px;padding:clamp(2rem,5vw,3rem) clamp(2rem,5vw,3rem) clamp(2.5rem,6vw,3.5rem);transition:.3s cubic-bezier(.4,0,.2,1);position:relative;overflow:visible;box-shadow:var(--shadow-card-readable);color:#111827;line-height:var(--line-height-comfortable);min-height:clamp(400px,50vw,500px)}
    .dirigente-card::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:var(--gradient-magic);transform:scaleX(0);transition:transform .4s ease}
    .dirigente-card:hover::before{transform:scaleX(1)}
    .dirigente-card:hover{transform:translateY(-8px) scale(1.01);box-shadow:var(--shadow-card-hover-readable);border-color:rgba(233,69,96,.4)}
    .dirigente-avatar{width:clamp(100px,15vw,130px);height:clamp(100px,15vw,130px);border-radius:50%;background:var(--gradient-magic);display:flex;align-items:center;justify-content:center;font-size:clamp(2.5rem,6vw,3.5rem);margin:0 auto 2rem;box-shadow:0 12px 40px rgba(233,69,96,.4);transition:.3s;border:4px solid #fff;font-weight:900;color:#fff;overflow:hidden}
    .dirigente-card:hover .dirigente-avatar{transform:scale(1.05);box-shadow:0 16px 50px rgba(233,69,96,.5)}
    .readable-title{color:#111827;font-weight:800;letter-spacing:-.01em;line-height:var(--line-height-headers);margin-bottom:1rem}
    .readable-subtitle{color:#1f2937;font-weight:700;line-height:var(--line-height-headers);margin-bottom:.75rem}
    .readable-text{color:#374151;font-weight:600;line-height:var(--line-height-comfortable);margin-bottom:.5rem}
    .btn-back{background:var(--gradient-cyber);color:#fff;border:3px solid rgba(0,212,255,.4);z-index:1000;padding:clamp(.6rem,2vw,.8rem) clamp(1rem,3vw,1.5rem);border-radius:15px;transition:.3s cubic-bezier(.4,0,.2,1);text-decoration:none;display:flex;align-items:center;gap:.75rem;font-weight:700;font-size:clamp(.9rem,2.5vw,1rem);box-shadow:0 8px 25px rgba(0,212,255,.3);line-height:1.2;cursor:pointer;border:none;min-width:clamp(90px,20vw,120px);position:fixed;top:18px;left:18px}
    .btn-back:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 12px 35px rgba(0,212,255,.4)}
    .loading-card{background:#fff;border-radius:24px;padding:3rem;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:350px;animation:pulse 2s infinite;border:var(--border-card-readable)}
    .loading-spinner{width:60px;height:60px;border:5px solid rgba(233,69,96,.1);border-left:5px solid #e94560;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1.5rem}
    .loading-text{color:#374151;font-size:clamp(1.1rem,3vw,1.3rem);font-weight:600}
    .error-card{background:rgba(255,71,87,.05);border:3px solid rgba(255,71,87,.4);border-radius:24px;padding:3rem;text-align:center;color:#dc2626;font-weight:600}
    .filter-tabs{display:flex;gap:1rem;margin-bottom:2rem;overflow-x:auto;padding:.5rem;-webkit-overflow-scrolling:touch}
    .filter-tab{padding:clamp(1rem,3vw,1.3rem) clamp(1.5rem,4vw,2rem);border-radius:25px;font-size:clamp(.9rem,2.5vw,1.1rem);font-weight:700;white-space:nowrap;transition:.3s cubic-bezier(.4,0,.2,1);cursor:pointer;border:3px solid;line-height:1.2}
    .filter-tab:not(.active){background:rgba(255,255,255,.15);color:#fff;border-color:rgba(255,255,255,.4);text-shadow:0 2px 4px rgba(0,0,0,.8)}
    .filter-tab:not(.active):hover{background:rgba(255,255,255,.25);transform:translateY(-2px)}
    .filter-tab.active{background:#fff;color:#111827;border-color:#e94560;box-shadow:0 12px 30px rgba(233,69,96,.4);transform:translateY(-2px)}
    .role-badge{display:inline-block;padding:clamp(.7rem,2vw,1rem) clamp(1.2rem,3vw,1.6rem);border-radius:25px;font-weight:800;font-size:clamp(.85rem,2.2vw,1rem);text-align:center;margin-bottom:1.5rem;text-transform:uppercase;letter-spacing:1.2px;border:3px solid;line-height:1.2}
    .role-regionale{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border-color:rgba(245,158,11,.5);text-shadow:0 2px 4px rgba(0,0,0,.5)}
    .role-provinciale{background:linear-gradient(135deg,#10b981,#047857);color:#fff;border-color:rgba(16,185,129,.5);text-shadow:0 2px 4px rgba(0,0,0,.5)}
    .contact-button{background:var(--gradient-magic);color:#fff;padding:clamp(1rem,3vw,1.3rem) clamp(1.8rem,5vw,2.3rem);border-radius:25px;font-size:clamp(1rem,2.8vw,1.2rem);font-weight:700;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:.75rem;transition:.3s cubic-bezier(.4,0,.2,1);border:3px solid rgba(233,69,96,.4);text-shadow:0 2px 4px rgba(0,0,0,.3);line-height:1.2;min-width:clamp(120px,25vw,150px);white-space:nowrap;box-shadow:0 4px 12px rgba(233,69,96,.2)}
    .contact-button:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 12px 30px rgba(233,69,96,.5);border-color:rgba(233,69,96,.8)}
    .stat-card{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border:3px solid rgba(255,255,255,.3);border-radius:20px;transition:.3s ease;padding:clamp(1.5rem,4vw,2rem)}
    .stat-card:hover{transform:translateY(-3px) scale(1.02);background:#fff;box-shadow:0 16px 40px rgba(0,0,0,.15);border-color:rgba(233,69,96,.3)}
    .stat-number{font-size:clamp(2rem,6vw,3rem);font-weight:900;color:#111827;line-height:1.1;margin-bottom:.5rem}
    .stat-label{font-size:clamp(.9rem,2.5vw,1.1rem);color:#374151;font-weight:700;line-height:1.3}
    .empty-state{text-align:center;padding:clamp(3rem,8vw,5rem);color:#fff}
    .empty-icon{font-size:clamp(4rem,12vw,6rem);margin-bottom:2rem}
    .contact-section{background:#fff;border-radius:24px;padding:clamp(2.5rem,6vw,4rem);box-shadow:var(--shadow-card-readable);border:var(--border-card-readable)}
    .contact-title{font-size:clamp(2rem,5vw,3rem);font-weight:900;color:#111827;margin-bottom:2.5rem;line-height:var(--line-height-headers)}
    .contact-info-card{border-radius:20px;padding:clamp(2rem,5vw,2.5rem);transition:.3s ease;border:3px solid rgba(255,255,255,.2)}
    .contact-icon{font-size:clamp(3rem,8vw,4rem);margin-bottom:1.5rem}
    .contact-info-title{font-size:clamp(1.2rem,3.5vw,1.5rem);font-weight:800;margin-bottom:1rem;line-height:var(--line-height-headers)}
    .contact-info-text{font-size:clamp(1rem,2.8vw,1.2rem);font-weight:600;line-height:var(--line-height-comfortable)}
    .contact-cta{background:var(--gradient-magic);color:#fff;padding:clamp(1.2rem,4vw,1.5rem) clamp(2rem,5vw,2.5rem);border-radius:25px;font-size:clamp(1.1rem,3vw,1.3rem);font-weight:800;text-decoration:none;transition:.3s ease;border:3px solid rgba(233,69,96,.4);text-shadow:0 2px 4px rgba(0,0,0,.3);line-height:1.3}
    .contact-cta:hover{transform:scale(1.03);box-shadow:0 16px 40px rgba(233,69,96,.5)}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
    .fade-in-up{animation:fadeInUp .8s ease-out forwards}
  </style>
</head>
<body class="relative overflow-x-hidden">

  <!-- Back Button (smart) -->
  <button id="backBtn" type="button" class="btn-back" aria-label="Torna alla home">
    <span class="text-xl">‚Üê</span><span>Indietro</span>
  </button>

  <!-- Hero -->
  <section class="min-h-screen flex flex-col justify-center items-center text-center px-4 relative pt-20">
    <h1 class="text-ultra-visible mb-8 fade-in-up" style="font-size:clamp(3rem,10vw,5rem);font-weight:900;line-height:1.1;">I Nostri Dirigenti</h1>
    <div class="text-ultra-visible mb-16 fade-in-up" style="font-size:clamp(1.5rem,5vw,2.5rem);font-weight:800;animation-delay:.2s;">Al servizio del Sindacato Carabinieri</div>

    <div class="bg-white rounded-3xl p-8 md:p-12 mb-20 max-w-5xl fade-in-up shadow-xl border-2 border-gray-200" style="animation-delay:.4s;">
      <p class="readable-text text-xl md:text-2xl leading-relaxed mb-8">
        <span class="readable-title text-3xl md:text-4xl block mb-6">Esperienza e Competenza</span>
        <span class="readable-subtitle text-xl md:text-2xl">Il nostro team di dirigenti unisce esperienza militare e competenza legale per offrire la migliore tutela ai nostri iscritti.</span>
      </p>
    </div>

    <div class="grid grid-cols-3 gap-6 mb-12 max-w-2xl w-full fade-in-up" style="animation-delay:.6s;">
      <div class="stat-card text-center"><div class="stat-number" id="totalCount">-</div><div class="stat-label text-cyan">Totali</div></div>
      <div class="stat-card text-center"><div class="stat-number" id="regionaliCount">-</div><div class="stat-label text-cyan">Regionali</div></div>
      <div class="stat-card text-center"><div class="stat-number" id="provincialiCount">-</div><div class="stat-label text-cyan">Provinciali</div></div>
    </div>
  </section>

  <!-- Dirigenti -->
  <section class="py-20 md:py-32 px-4 relative">
    <div class="max-w-7xl mx-auto container-custom">

      <div class="text-center mb-20">
        <h2 class="text-ultra-visible mb-12" style="font-size:clamp(2.5rem,8vw,4rem);font-weight:900;">Il Nostro Team</h2>
        <p class="text-cyan text-xl md:text-2xl max-w-4xl mx-auto leading-relaxed font-bold mb-16">Dirigenti con esperienza pluriennale al servizio del personale dell'Arma dei Carabinieri</p>
      </div>

      <div class="max-w-3xl mx-auto mb-16">
        <input type="text" id="searchInput" class="search-box w-full" placeholder="üîç Cerca dirigente per nome o provincia...">
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">Tutti</button>
          <button class="filter-tab" data-filter="Regionale">Regionali</button>
          <button class="filter-tab" data-filter="Provinciale">Provinciali</button>
        </div>
      </div>

      <div id="loadingContainer" class="dirigenti-grid grid gap-8 mb-20">
        <div class="loading-card">
          <div class="loading-spinner"></div>
          <p class="loading-text">Caricamento dirigenti...</p>
        </div>
      </div>

      <div id="errorContainer" class="hidden mb-20">
        <div class="error-card max-w-2xl mx-auto">
          <h3 class="text-2xl font-bold mb-4">‚ö†Ô∏è Errore di Caricamento</h3>
          <p class="text-lg mb-6">Non √® stato possibile caricare i dati dei dirigenti.</p>
          <button onclick="window.dirigentiManager?.reload()" class="bg-red-500 text-white px-8 py-4 rounded-lg hover:bg-red-600 transition-colors font-bold text-lg">üîÑ Riprova</button>
        </div>
      </div>

      <div id="emptyState" class="empty-state hidden">
        <div class="empty-icon">üë•</div>
        <h3 class="empty-title text-ultra-visible">Nessun dirigente trovato</h3>
        <p class="empty-text text-cyan font-bold">Prova a modificare i filtri di ricerca</p>
      </div>

      <div id="dirigentiContainer" class="dirigenti-grid grid gap-8 mb-20 hidden"></div>

      <!-- Contatti -->
      <div class="contact-section">
        <h3 class="contact-title text-center">Contatta la Dirigenza</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <div class="contact-info-card bg-gradient-to-r from-primary to-secondary text-white group">
            <div class="contact-icon group-hover:scale-110 transition-transform duration-300">üìß</div>
            <div class="contact-info-title">Email Generale</div>
            <div class="contact-info-text">veneto@carabinierinsc.it</div>
          </div>
          <div class="contact-info-card bg-gradient-to-r from-aurora to-magenta text-white group">
            <div class="contact-icon group-hover:scale-110 transition-transform duration-300">üì±</div>
            <div class="contact-info-title">Telefono</div>
            <div class="contact-info-text">378 081 9900</div>
          </div>
          <div class="contact-info-card bg-gradient-to-r from-teal to-success text-white group">
            <div class="contact-icon group-hover:scale-110 transition-transform duration-300">‚è∞</div>
            <div class="contact-info-title">Orari</div>
            <div class="contact-info-text">Lun-Ven 9:00-18:00</div>
          </div>
        </div>
        <div class="text-center">
          <a href="https://form.jotform.com/250396120847357" target="_blank" class="contact-cta inline-block">üìù Richiedi Appuntamento</a>
        </div>
      </div>

    </div>
  </section>

  <!-- Supabase + Logica -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Progetto che mi hai dato
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Back intelligente
    const backBtn = document.getElementById('backBtn');
    backBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        backBtn.style.transform = 'scale(0.96)';
        setTimeout(()=> backBtn.style.transform = '', 150);

        const { data:{ session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/home.html'; return; }

        const uid = session.user.id;
        const { data: prof, error } = await supabase
          .from('user_profiles')
          .select('role')
          .eq('user_id', uid)
          .single();

        if (error) { console.warn('role fallback:', error.message); window.location.href='/home.html'; return; }

        const role = (prof?.role || '').toUpperCase();
        window.location.href = (role === 'DIRIGENTE' || role === 'ADMIN') ? '/home_dirigenti.html' : '/home.html';
      } catch (err) {
        console.error('Smart back error:', err);
        window.location.href = '/home.html';
      }
    });

    class DirigentiManager {
      constructor(){
        this.allDirigenti = [];
        this.filteredDirigenti = [];
        this.currentFilter = 'all';
        this.deviceType = this.detectDevice();
        this.init();
      }

      detectDevice(){
        const w = window.innerWidth, h = window.innerHeight;
        const orientation = w > h ? 'landscape' : 'portrait';
        if (w <= 320) return {type:'smartwatch', orientation};
        if (w <= 480) return {type: orientation==='portrait'?'mobile-portrait':'mobile-landscape', orientation};
        if (w <= 667) return {type:'mobile-large', orientation};
        if (w <= 768) return {type:'phablet', orientation};
        if (w <= 1024) return {type: orientation==='portrait'?'tablet-portrait':'tablet-landscape', orientation};
        if (w <= 1366) return {type:'laptop-small', orientation};
        if (w <= 1920) return {type:'desktop', orientation};
        if (w <= 2560) return {type:'desktop-ultrawide', orientation};
        return {type:'desktop-4k', orientation};
      }

      async init(){
        try {
          await this.loadDirigenti();
          this.setupEventListeners();
          this.adjustForDevice();
        } catch (e){
          console.error('Init error:', e);
          this.showError();
        }
      }

      async loadDirigenti(){
        this.showLoading();
        try{
          const { data, error } = await supabase
            .from('organico_dirigentisindacali')
            .select('id,nome_cognome,ruolo,provincia,regione,email,telefono,foto_url,competenze,ordine,attivo')
            .eq('attivo', true)
            .order('ordine', { ascending:true })
            .order('nome_cognome', { ascending:true });

          if (error) throw error;
          this.allDirigenti = data ?? [];
          this.filteredDirigenti = [...this.allDirigenti];
          this.renderDirigenti();
          this.updateStats();
        } catch (err){
          console.error('Caricamento dirigenti fallito:', err);
          this.showError();
        }
      }

      showLoading(){
        document.getElementById('loadingContainer').classList.remove('hidden');
        document.getElementById('dirigentiContainer').classList.add('hidden');
        document.getElementById('errorContainer').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
      }
      showError(){
        document.getElementById('loadingContainer').classList.add('hidden');
        document.getElementById('dirigentiContainer').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('errorContainer').classList.remove('hidden');
      }

      renderDirigenti(){
        const container = document.getElementById('dirigentiContainer');
        const loading = document.getElementById('loadingContainer');
        const errorBox = document.getElementById('errorContainer');
        const empty = document.getElementById('emptyState');
        loading.classList.add('hidden'); errorBox.classList.add('hidden');

        if (this.filteredDirigenti.length === 0){
          container.classList.add('hidden'); empty.classList.remove('hidden'); return;
        }
        empty.classList.add('hidden'); container.classList.remove('hidden');

        container.innerHTML = this.filteredDirigenti.map((d, i) => this.card(d, i)).join('');
        this.animateCards();
      }

      card(d, i){
        const initials = d?.nome_cognome ? d.nome_cognome.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : '??';
        const roleClass = this.roleClass(d?.ruolo);
        const provincia = d?.provincia || 'Non specificata';
        const avatar = d?.foto_url
          ? `<img src="${d.foto_url}" alt="${d.nome_cognome}" class="w-full h-full object-cover rounded-full">`
          : `<span>${initials}</span>`;
        return `
          <article class="dirigente-card fade-in-up" style="animation-delay:${i*0.08}s;opacity:0;" tabindex="0" aria-label="Informazioni su ${d?.nome_cognome ?? 'Dirigente'}">
            <div class="dirigente-avatar" aria-hidden="true">${avatar}</div>
            <h3 class="readable-title text-center">${d?.nome_cognome ?? 'Nome non disponibile'}</h3>
            <div class="text-center">
              <span class="role-badge ${roleClass}">${d?.ruolo ?? 'Ruolo non specificato'}</span>
            </div>
            <p class="readable-text text-center mb-8"><span class="inline-flex items-center gap-2"><span class="text-2xl">üìç</span><span class="font-bold text-lg">${provincia}</span></span></p>
            <div class="flex flex-col gap-4 justify-center items-center mt-auto pt-4">
              ${d?.email ? `<a href="mailto:${d.email}" class="contact-button w-full max-w-xs" aria-label="Invia email a ${d.nome_cognome}"><span class="text-xl">üìß</span><span>Email</span></a>`:''}
              ${d?.telefono ? `<a href="tel:${d.telefono}" class="contact-button w-full max-w-xs" aria-label="Chiama ${d.nome_cognome}"><span class="text-xl">üìû</span><span>Chiama</span></a>`:''}
            </div>
          </article>
        `;
      }

      roleClass(ruolo){
        if (!ruolo) return 'role-provinciale';
        if (ruolo.includes('Regionale')) return 'role-regionale';
        if (ruolo.includes('Provinciale')) return 'role-provinciale';
        if (ruolo.includes('Segretario Generale')) return 'role-provinciale';
        return 'role-provinciale';
        }

      animateCards(){
        document.querySelectorAll('.dirigente-card').forEach((c, i)=>{
          setTimeout(()=>{ c.style.opacity='1'; }, i*120);
        });
      }

      updateStats(){
        const total = this.allDirigenti.length;
        const regionali = this.allDirigenti.filter(d => d.ruolo?.includes('Regionale')).length;
        const provinciali = this.allDirigenti.filter(d => d.ruolo?.includes('Provinciale')).length;
        document.getElementById('totalCount').textContent = total;
        document.getElementById('regionaliCount').textContent = regionali;
        document.getElementById('provincialiCount').textContent = provinciali;
      }

      filterDirigenti(){
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        this.filteredDirigenti = this.allDirigenti.filter(d=>{
          const matchText = !term ||
            d.nome_cognome?.toLowerCase().includes(term) ||
            d.provincia?.toLowerCase().includes(term) ||
            d.ruolo?.toLowerCase().includes(term);
          const matchFilter = this.currentFilter === 'all' || d.ruolo?.includes(this.currentFilter);
          return matchText && matchFilter;
        });
        this.renderDirigenti();
      }

      setupEventListeners(){
        // Search debounce
        let t;
        document.getElementById('searchInput').addEventListener('input', ()=>{
          clearTimeout(t); t = setTimeout(()=> this.filterDirigenti(), 250);
        });
        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab=>{
          tab.addEventListener('click', ()=>{
            document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            this.currentFilter = tab.dataset.filter;
            this.filterDirigenti();
          });
        });
        // Resize
        let r;
        window.addEventListener('resize', ()=>{
          clearTimeout(r);
          r = setTimeout(()=>{
            this.deviceType = this.detectDevice();
            this.adjustForDevice();
          }, 200);
        });
      }

      adjustForDevice(){
        const grid = document.getElementById('dirigentiContainer');
        if (!grid) return;
        grid.classList.remove('grid-cols-1','grid-cols-2','grid-cols-3','grid-cols-4','xl:grid-cols-4','lg:grid-cols-3');

        const t = this.deviceType.type;
        if (t.includes('smartwatch') || t.includes('mobile-portrait')) grid.classList.add('grid-cols-1');
        else if (t.includes('mobile-large') || t.includes('phablet')) grid.classList.add('grid-cols-1','sm:grid-cols-2');
        else if (t.includes('tablet')) grid.classList.add('grid-cols-2');
        else if (t.includes('laptop') || t.includes('desktop')) grid.classList.add('grid-cols-2','lg:grid-cols-3','xl:grid-cols-4');
        else grid.classList.add('grid-cols-3','xl:grid-cols-4');
      }

      async reload(){ await this.loadDirigenti(); }
    }

    document.addEventListener('DOMContentLoaded', ()=> {
      window.dirigentiManager = new DirigentiManager();
    });

    // Stato pagina/animazioni minori
    window.addEventListener('error', (e)=> console.error('Errore globale:', e.error));
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) document.body.classList.add('reduced-motion');
    document.addEventListener('visibilitychange', ()=> document.body.style.animationPlayState = document.hidden ? 'paused':'running');
  </script>
</body>
</html>
