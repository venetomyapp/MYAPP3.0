<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Academy & Live ‚Äî MyApp</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#1a1a2e" />
  <meta name="background-color" content="#1a1a2e" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/public/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png" />

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: {
            primary: '#1a1a2e',
            secondary: '#16213e',
            accent: '#0f3460',
            aurora: '#e94560',
            cyan: '#00d4ff',
            success: '#10b981',
            gold: '#ffd700',
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
      --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
      --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
      --gradient-hero: linear-gradient(135deg, #1a1a2e 0%, #e94560 50%, #00d4ff 100%);
    }
    
    * { 
      font-family: 'Inter', sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      scroll-behavior: smooth;
    }
    
    body {
      background: var(--gradient-aurora);
      background-size: 400% 400%;
      animation: aurora 20s ease infinite;
      margin: 0; 
      padding: 0; 
      overflow-x: hidden;
    }
    
    @keyframes aurora { 
      0%{background-position:0% 50%} 
      50%{background-position:100% 50%} 
      100%{background-position:0% 50%} 
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(1deg); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(233, 69, 96, 0.3); }
      50% { box-shadow: 0 0 40px rgba(233, 69, 96, 0.6), 0 0 60px rgba(0, 212, 255, 0.4); }
    }
    
    @keyframes slide-in {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .text-ultra-visible { 
      color:#fff; 
      text-shadow:0 8px 25px rgba(0,0,0,.9), 0 4px 12px rgba(0,0,0,.8), 0 2px 6px rgba(0,0,0,1); 
      font-weight: 900; 
    }
    
    .glass-card { 
      background: rgba(255,255,255,.95); 
      border:1px solid rgba(255,255,255,.3); 
      border-radius:24px; 
      box-shadow:0 20px 60px rgba(0,0,0,.1), 0 10px 30px rgba(0,0,0,.05); 
      backdrop-filter: blur(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .glass-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow:0 30px 80px rgba(0,0,0,.15), 0 15px 40px rgba(0,0,0,.1);
    }
    
    .feature-card {
      background: rgba(255,255,255,.98);
      border:2px solid rgba(255,255,255,.4);
      border-radius:28px;
      box-shadow:0 25px 50px rgba(0,0,0,.08);
      backdrop-filter: blur(25px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .feature-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(233,69,96,0.05) 0%, rgba(0,212,255,0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .feature-card:hover::before {
      opacity: 1;
    }
    
    .feature-card:hover {
      transform: translateY(-12px) scale(1.03);
      box-shadow:0 40px 80px rgba(0,0,0,.12), 0 20px 40px rgba(233,69,96,.15);
      border-color: rgba(233,69,96,.3);
    }
    
    .btn-aurora { 
      background: var(--gradient-magic); 
      color:#fff; 
      border:2px solid rgba(233,69,96,.3); 
      border-radius:18px; 
      padding:14px 28px; 
      font-weight:800;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn-aurora::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; right: 0; bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-aurora:hover::before {
      left: 100%;
    }
    
    .btn-aurora:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(233,69,96,.4);
    }
    
    .btn-cyber { 
      background: var(--gradient-cyber); 
      color:#fff; 
      border:2px solid rgba(0,212,255,.3); 
      border-radius:18px; 
      padding:14px 28px; 
      font-weight:800;
      transition: all 0.3s ease;
    }
    
    .btn-cyber:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,212,255,.4);
    }
    
    .btn-ghost { 
      background: rgba(255,255,255,.95); 
      border:2px solid rgba(0,0,0,.08); 
      border-radius:18px; 
      padding:14px 28px; 
      font-weight:800;
      transition: all 0.3s ease;
    }
    
    .btn-ghost:hover {
      background: rgba(255,255,255,1);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,.1);
    }
    
    .chip { 
      background: rgba(255,255,255,.9); 
      border:1px solid rgba(0,0,0,.08); 
      border-radius:999px; 
      padding:8px 16px; 
      font-weight:700; 
      font-size:12px;
      transition: all 0.3s ease;
    }
    
    .chip:hover {
      background: rgba(233,69,96,.1);
      border-color: rgba(233,69,96,.3);
      transform: scale(1.05);
    }

    .hero-section {
      background: var(--gradient-hero);
      background-size: 400% 400%;
      animation: aurora 25s ease infinite;
      position: relative;
      overflow: hidden;
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: float 20s ease-in-out infinite;
    }
    
    .nav-pill {
      background: rgba(255,255,255,.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 20px;
      padding: 12px 24px;
      color: white;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .nav-pill::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--gradient-magic);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .nav-pill.active::before,
    .nav-pill:hover::before {
      opacity: 1;
    }
    
    .nav-pill.active,
    .nav-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(233,69,96,.3);
    }
    
    .nav-pill span {
      position: relative;
      z-index: 1;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .stat-card {
      background: rgba(255,255,255,.95);
      border-radius: 24px;
      padding: 32px 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(233,69,96,0.1), rgba(0,212,255,0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .stat-card:hover::before {
      opacity: 1;
    }
    
    .stat-card:hover {
      transform: translateY(-8px) rotate(1deg);
      box-shadow: 0 25px 50px rgba(0,0,0,.15);
    }
    
    .section { 
      display: none; 
      animation: slide-in 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
    } 
    
    .section.active { 
      display: block; 
    }
    
    .floating-action {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--gradient-magic);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 10px 25px rgba(233,69,96,.3);
      z-index: 1000;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .floating-action:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 15px 35px rgba(233,69,96,.5);
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-top: 40px;
    }
    
    .section-content {
      padding: 0 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .feature-card {
        padding: 20px;
      }
    }

    .live-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse-glow 1.5s ease-in-out infinite;
      margin-right: 8px;
    }
  </style>
</head>
<body>

  <!-- Hero Section -->
  <section class="hero-section min-h-screen flex flex-col">
    <!-- Header with floating back button -->
    <div class="relative z-10 p-6">
      <a href="#" onclick="navigateBack()" class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-white hover:bg-white/30 transition-all duration-300">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
    </div>

    <!-- Hero Content -->
    <div class="flex-1 flex flex-col justify-center items-center text-center px-6 relative z-10">
      <div class="mb-8">
        <div class="w-32 h-32 bg-gradient-to-br from-white/20 to-white/10 rounded-full mx-auto mb-8 flex items-center justify-center backdrop-blur-lg border border-white/20 animate-float">
          <span class="text-6xl">üéì</span>
        </div>
        <h1 class="text-5xl md:text-6xl text-ultra-visible mb-4 leading-tight">Academy & Live</h1>
        <p class="text-xl text-white/90 mb-8 max-w-2xl">La tua piattaforma di formazione completa: videoconferenze, corsi online, canali YouTube e risorse all'avanguardia</p>
      </div>

      <!-- Quick Stats -->
      <div class="stats-grid w-full max-w-4xl mb-12">
        <div class="stat-card">
          <div class="text-4xl font-black text-aurora mb-2" id="stat-live-today">0</div>
          <div class="text-sm font-bold text-gray-600">Live di oggi</div>
        </div>
        <div class="stat-card">
          <div class="text-4xl font-black text-cyan-500 mb-2" id="stat-corsi-attivi">0</div>
          <div class="text-sm font-bold text-gray-600">Corsi attivi</div>
        </div>
        <div class="stat-card">
          <div class="text-4xl font-black text-success mb-2" id="stat-preferiti">0</div>
          <div class="text-sm font-bold text-gray-600">Nei preferiti</div>
        </div>
        <div class="stat-card">
          <div class="text-4xl font-black text-gold mb-2" id="stat-ore">0h</div>
          <div class="text-sm font-bold text-gray-600">Ore formazione</div>
        </div>
      </div>

      <!-- Navigation Pills -->
      <div class="flex flex-wrap gap-4 justify-center max-w-4xl">
        <div class="nav-pill active" onclick="show('dashboard')" data-target="dashboard">
          <span>üè† Dashboard</span>
        </div>
        <div class="nav-pill" onclick="show('live')" data-target="live">
          <span>üî¥ Live Sessions</span>
        </div>
        <div class="nav-pill" onclick="show('courses')" data-target="courses">
          <span>üìö Corsi Online</span>
        </div>
        <div class="nav-pill" onclick="show('channels')" data-target="channels">
          <span>‚ñ∂Ô∏è Canali YouTube</span>
        </div>
        <div class="nav-pill" onclick="show('library')" data-target="library">
          <span>üóÇÔ∏è Libreria</span>
        </div>
        <div class="nav-pill" onclick="show('stats')" data-target="stats">
          <span>üìà Analytics</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Content Sections -->
  <div class="min-h-screen bg-gradient-to-b from-transparent to-black/20">
    
    <!-- Dashboard -->
    <div id="dashboard" class="section active">
      <div class="section-content py-16">
        <h2 class="text-4xl font-black text-ultra-visible mb-8 text-center">üöÄ Dashboard Panoramica</h2>
        
        <div class="content-grid">
          <!-- Prossime Live -->
          <div class="feature-card p-8">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-black text-gray-800 flex items-center">
                <span class="live-indicator"></span>
                üìÖ Prossime Live
              </h3>
              <button class="btn-aurora" onclick="show('live')">Vedi tutto</button>
            </div>
            <div id="upcoming-live" class="space-y-4"></div>
          </div>

          <!-- Consigliati -->
          <div class="feature-card p-8">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-black text-gray-800">üåü In Evidenza</h3>
              <div class="flex gap-2">
                <span class="chip">Trending</span>
                <span class="chip">New</span>
              </div>
            </div>
            <div id="featured" class="space-y-4"></div>
          </div>

          <!-- Quick Actions -->
          <div class="feature-card p-8">
            <h3 class="text-2xl font-black text-gray-800 mb-6">‚ö° Quick Actions</h3>
            <div class="grid grid-cols-2 gap-4">
              <button class="btn-aurora" onclick="joinNextLive()">Join Live</button>
              <button class="btn-cyber" onclick="show('courses')">Nuovo Corso</button>
              <button class="btn-ghost" onclick="show('library')">Sfoglia Risorse</button>
              <button class="btn-ghost" onclick="show('stats')">Vedi Stats</button>
            </div>
          </div>

          <!-- Activity Feed -->
          <div class="feature-card p-8">
            <h3 class="text-2xl font-black text-gray-800 mb-6">üìä Attivit√† Recente</h3>
            <div class="space-y-3" id="activity-feed">
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                <span class="text-2xl">üéØ</span>
                <div>
                  <div class="font-bold text-sm">Corso completato</div>
                  <div class="text-xs text-gray-600">Project Management Base</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                <span class="text-2xl">üì∫</span>
                <div>
                  <div class="font-bold text-sm">Live session partecipata</div>
                  <div class="text-xs text-gray-600">Q&A con la Direzione</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Sessions -->
    <div id="live" class="section">
      <div class="section-content py-16">
        <div class="flex flex-col md:flex-row gap-6 items-center justify-between mb-8">
          <h2 class="text-4xl font-black text-ultra-visible flex items-center">
            <span class="live-indicator"></span>
            üî¥ Live Sessions
          </h2>
          <div class="flex gap-4">
            <input id="live-search" type="search" placeholder="Cerca webinar, relatore..." class="w-64 bg-white/90 border-2 border-white/50 rounded-2xl px-6 py-3 text-sm font-semibold backdrop-blur-lg">
            <select id="live-platform" class="bg-white/90 border-2 border-white/50 rounded-2xl px-4 py-3 text-sm font-semibold backdrop-blur-lg">
              <option value="">Tutte le piattaforme</option>
              <option>Zoom</option><option>Teams</option><option>Meet</option><option>YouTube Live</option>
            </select>
          </div>
        </div>
        <div id="live-list" class="content-grid"></div>
      </div>
    </div>

    <!-- Courses -->
    <div id="courses" class="section">
      <div class="section-content py-16">
        <div class="flex flex-col md:flex-row gap-6 items-center justify-between mb-8">
          <h2 class="text-4xl font-black text-ultra-visible">üìö Corsi Online</h2>
          <div class="flex gap-4">
            <input id="course-search" type="search" placeholder="Cerca corso, autore..." class="w-64 bg-white/90 border-2 border-white/50 rounded-2xl px-6 py-3 text-sm font-semibold backdrop-blur-lg">
            <select id="course-level" class="bg-white/90 border-2 border-white/50 rounded-2xl px-4 py-3 text-sm font-semibold backdrop-blur-lg">
              <option value="">Tutti i livelli</option>
              <option value="base">Base</option><option value="intermedio">Intermedio</option><option value="avanzato">Avanzato</option>
            </select>
          </div>
        </div>
        <div id="course-list" class="content-grid"></div>
      </div>
    </div>

    <!-- Channels -->
    <div id="channels" class="section">
      <div class="section-content py-16">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-4xl font-black text-ultra-visible">‚ñ∂Ô∏è Canali YouTube</h2>
          <input id="channel-search" type="search" placeholder="Cerca canale..." class="w-64 bg-white/90 border-2 border-white/50 rounded-2xl px-6 py-3 text-sm font-semibold backdrop-blur-lg">
        </div>
        <div id="channel-list" class="content-grid"></div>
      </div>
    </div>

    <!-- Library -->
    <div id="library" class="section">
      <div class="section-content py-16">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-4xl font-black text-ultra-visible">üóÇÔ∏è Libreria Risorse</h2>
          <input id="library-search" type="search" placeholder="Cerca risorsa..." class="w-64 bg-white/90 border-2 border-white/50 rounded-2xl px-6 py-3 text-sm font-semibold backdrop-blur-lg">
        </div>
        <div id="library-list" class="content-grid"></div>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="section">
      <div class="section-content py-16">
        <h2 class="text-4xl font-black text-ultra-visible mb-8 text-center">üìà Analytics & Insights</h2>
        
        <div class="content-grid">
          <div class="feature-card p-8 md:col-span-2">
            <h3 class="text-2xl font-black text-gray-800 mb-6">Distribuzione Tempo per Categoria</h3>
            <div style="position:relative; height:300px;"><canvas id="stats-chart"></canvas></div>
          </div>
          
          <div class="feature-card p-8 text-center">
            <div class="text-5xl font-black text-aurora mb-4" id="stats-live-count">0</div>
            <div class="text-lg font-bold text-gray-600">Live Totali Seguite</div>
          </div>
          
          <div class="feature-card p-8 text-center">
            <div class="text-5xl font-black text-success mb-4" id="stats-course-progress">0%</div>
            <div class="text-lg font-bold text-gray-600">Progresso Medio Corsi</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="floating-action" onclick="joinNextLive()" title="Quick Join Next Live">
    üî¥
  </button>

  <!-- MODAL DETTAGLIO RISORSA -->
  <div id="resource-modal" class="fixed inset-0 bg-black/70 hidden z-[200] p-5 overflow-y-auto backdrop-blur-sm">
    <div class="mx-auto max-w-lg glass-card p-8 my-8">
      <div class="flex justify-between items-center mb-6">
        <h3 id="res-title" class="text-2xl font-black text-gray-800">Titolo</h3>
        <button class="text-3xl font-black text-gray-400 hover:text-gray-600 transition-colors" onclick="closeModal()">&times;</button>
      </div>
      <div id="res-embed" class="rounded-2xl overflow-hidden mb-6 hidden"></div>
      <p id="res-desc" class="text-gray-700 mb-6 leading-relaxed"></p>
      <div id="res-tags" class="flex flex-wrap gap-2 mb-6"></div>
      <div class="grid grid-cols-2 gap-4">
        <a id="res-open" target="_blank" rel="noopener" class="btn-aurora text-center">Apri Risorsa</a>
        <button id="res-fav" class="btn-ghost" onclick="toggleFavActive()">‚òÜ Preferito</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SUPABASE_URL = "https://pvzdilkozpspsnepedqc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

    // Demo flag: dati fittizi SOLO se passi ?demo=1 nell'URL
    const DEMO = new URLSearchParams(location.search).has('demo');

    // ===== State =====
    let user = null;
    let liveSessions = [];
    let courses = [];
    let channels = [];
    let library = [];
    let favorites = new Set(); // ids
    let statsChart = null;
    let modalResource = null;

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', async () => {
      await initUser();
      await loadAll();
      renderAll();
      initFilters();
      console.log('üåê Academy & Live ‚Äî Enhanced Version Ready!');
    });

    async function initUser() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        console.warn('No session: demo mode available via ?demo=1');
      } else {
        user = session.user;
      }
      try {
        const raw = localStorage.getItem('academy_favs');
        if (raw) favorites = new Set(JSON.parse(raw));
      } catch(e) {}
    }

    async function loadAll() {
      await Promise.all([
        loadLive(),
        loadCourses(),
        loadChannels(),
        loadLibrary()
      ]);
    }

    // ===== Loaders =====
    async function loadLive() {
      try {
        const { data, error } = await supabase.from('live_sessions')
          .select('*')
          .order('start_at', { ascending: true })
          .limit(50);
        if (error) throw error;
        liveSessions = (data || []).map(normalizeLive);
      } catch (e) {
        console.error('loadLive error:', e);
        liveSessions = [];
      }
      
      // Aggiungi sempre dati demo se non ci sono contenuti sufficienti
      if (liveSessions.length < 3) {
        const demoLive = [
          { id:'demo-live-1', title:'üéØ Aggiornamento Normativo Q4', start_at:addHours(2), end_at:addHours(3), platform:'Zoom', join_url:'https://zoom.us/j/123456789', host:'Ufficio Formazione', track:'Compliance', tags:['norme','compliance'], passcode:'', status:'scheduled' },
          { id:'demo-live-2', title:'üíº Q&A con la Direzione', start_at:addDays(1,10), end_at:addDays(1,11), platform:'Teams', join_url:'https://teams.microsoft.com/l/meetup-join/xxx', host:'Direzione', track:'Company', tags:['strategie','q&a'], passcode:'', status:'scheduled' },
          { id:'demo-live-3', title:'ü§ñ Live Tech ‚Äî AI Update', start_at:addDays(3,9), end_at:addDays(3,10), platform:'YouTube Live', join_url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ', host:'Tech Guild', track:'Tech', tags:['ai','dev'], passcode:'', status:'scheduled' },
        ].map(normalizeLive);
        liveSessions = [...liveSessions, ...demoLive];
      }
    }

    async function loadCourses() {
      try {
        const { data, error } = await supabase.from('learning_resources')
          .select('*').eq('type','course').order('created_at', { ascending:false }).limit(100);
        if (error) throw error;
        courses = (data || []).map(normalizeResource);
      } catch (e) {
        console.error('loadCourses error:', e);
        courses = [];
      }
      
      // Aggiungi sempre dati demo se non ci sono contenuti sufficienti
      if (courses.length < 3) {
        const demoCourses = [
          { id:'demo-c-1', title:'üöÄ Project Management Avanzato', url:'#', provider:'Coursera', level:'base', duration_minutes:120, description:'Metodologie agili e strumenti moderni per gestire progetti complessi', tags:['management','agile','scrum'] },
          { id:'demo-c-2', title:'üîê Cybersecurity Essentials', url:'#', provider:'edX', level:'intermedio', duration_minutes:180, description:'Protezione dati, threat analysis e incident response', tags:['security','it','privacy'] },
          { id:'demo-c-3', title:'üìä Advanced Excel & Data Analysis', url:'#', provider:'Udemy', level:'avanzato', duration_minutes:240, description:'Power Query, Pivot avanzate, Dashboard e automazioni', tags:['excel','data','analytics'] },
        ].map(normalizeResource);
        courses = [...courses, ...demoCourses];
      }
    }

    async function loadChannels() {
      try {
        const { data, error } = await supabase.from('learning_resources')
          .select('*').eq('type','youtube_channel').order('created_at', { ascending:false }).limit(100);
        if (error) throw error;
        channels = (data || []).map(normalizeResource);
      } catch (e) {
        console.error('loadChannels error:', e);
        channels = [];
      }
      
      // Aggiungi sempre dati demo se non ci sono contenuti sufficienti
      if (channels.length < 3) {
        const demoChannels = [
          { id:'demo-y-1', title:'üíª Computerphile', url:'https://www.youtube.com/@Computerphile', provider:'YouTube', description:'Computer Science spiegata in modo semplice e coinvolgente', tags:['cs','teoria','algoritmi'] },
          { id:'demo-y-2', title:'üî• Fireship', url:'https://www.youtube.com/@Fireship', provider:'YouTube', description:'Web development, tutorial rapidi e news tech', tags:['web','frontend','javascript'] },
          { id:'demo-y-3', title:'üéì MIT OpenCourseWare', url:'https://www.youtube.com/@mitocw', provider:'YouTube', description:'Corsi universitari completi del MIT', tags:['universit√†','ingegneria','matematica'] },
        ].map(normalizeResource);
        channels = [...channels, ...demoChannels];
      }
    }

    async function loadLibrary() {
      try {
        const { data, error } = await supabase.from('learning_resources')
          .select('*').neq('type','course').neq('type','youtube_channel').order('created_at', { ascending:false }).limit(200);
        if (error) throw error;
        library = (data || []).map(normalizeResource);
      } catch (e) {
        console.error('loadLibrary error:', e);
        library = [];
      }
      
      // Aggiungi sempre dati demo se non ci sono contenuti sufficienti
      if (library.length < 3) {
        const demoLibrary = [
          { id:'demo-l-1', title:'üìã Guida OKR 2025 (PDF)', url:'#', provider:'Company Docs', type:'document', description:'Template e esempi pratici per implementare OKR efficaci', tags:['okr','strategy','planning'] },
          { id:'demo-l-2', title:'üéß Podcast ‚Äî Data Culture Revolution', url:'#', provider:'Tech Podcast', type:'podcast', description:'Intervista esclusiva con CDO delle migliori aziende tech', tags:['data','culture','leadership'] },
          { id:'demo-l-3', title:'üîó API Documentation Hub', url:'#', provider:'DevDocs', type:'documentation', description:'Documentazione completa delle API interne', tags:['api','development','docs'] },
        ].map(normalizeResource);
        library = [...library, ...demoLibrary];
      }
    }

    function normalizeLive(r){
      return {
        id: r.id,
        title: r.title || r.nome || 'Live Session',
        start_at: r.start_at ? new Date(r.start_at) : new Date(),
        end_at: r.end_at ? new Date(r.end_at) : addHoursTo(new Date(r.start_at||Date.now()),1),
        platform: r.platform || r.piattaforma || 'Zoom',
        join_url: r.join_url || r.link || '#',
        passcode: r.passcode || '',
        host: r.host || '',
        track: r.track || '',
        tags: r.tags || [],
        status: r.status || 'scheduled'
      }
    }

    function normalizeResource(r){
      return {
        id: r.id,
        title: r.title || r.nome || 'Risorsa',
        url: r.url || '#',
        provider: r.provider || r.fornitore || '',
        type: r.type || r.tipo || 'resource',
        level: r.level || '',
        duration_minutes: r.duration_minutes || null,
        thumbnail_url: r.thumbnail_url || '',
        description: r.description || '',
        tags: r.tags || [],
        language: r.language || 'IT',
        created_at: r.created_at ? new Date(r.created_at) : new Date()
      }
    }

    // ===== Rendering =====
    function renderAll(){
      renderStats();
      renderUpcomingLive();
      renderFeatured();
      renderLiveList();
      renderCourseList();
      renderChannelList();
      renderLibraryList();
      updateCounters();
    }

    function updateCounters(){
      const today = new Date();
      const liveToday = liveSessions.filter(s => sameDay(s.start_at, today)).length;
      document.getElementById('stat-live-today').textContent = liveToday;
      document.getElementById('stat-corsi-attivi').textContent = courses.length;
      document.getElementById('stat-preferiti').textContent = favorites.size;
      const totalMin = (courses.reduce((a,c)=>a+(c.duration_minutes||0),0));
      document.getElementById('stat-ore').textContent = Math.round(totalMin/60)+'h';
    }

    function renderUpcomingLive(){
      const box = document.getElementById('upcoming-live');
      const items = liveSessions.slice(0,3).map(s => compactLiveCard(s)).join('');
      box.innerHTML = items || emptyState('Nessuna live in programma');
    }

    function renderFeatured(){
      const box = document.getElementById('featured');
      const picks = [...courses.slice(0,2), ...channels.slice(0,1)];
      box.innerHTML = picks.map(r => compactResourceCard(r)).join('') || emptyState('Nessun contenuto consigliato');
    }

    function renderLiveList(){
      const q = (document.getElementById('live-search').value||'').toLowerCase();
      const p = document.getElementById('live-platform').value;
      const list = document.getElementById('live-list');
      const filtered = liveSessions.filter(s => {
        const matchQ = !q || s.title.toLowerCase().includes(q) || (s.host||'').toLowerCase().includes(q) || (s.track||'').toLowerCase().includes(q);
        const matchP = !p || s.platform === p;
        return matchQ && matchP;
      });
      list.innerHTML = filtered.map(s => liveCard(s)).join('') || emptyState('Nessuna live trovata');
    }

    function renderCourseList(){
      const q = (document.getElementById('course-search').value||'').toLowerCase();
      const lvl = document.getElementById('course-level').value;
      const list = document.getElementById('course-list');
      const filtered = courses.filter(c => {
        const mQ = !q || c.title.toLowerCase().includes(q) || (c.provider||'').toLowerCase().includes(q);
        const mL = !lvl || (c.level||'')===lvl;
        return mQ && mL;
      });
      list.innerHTML = filtered.map(c => courseCard(c)).join('') || emptyState('Nessun corso trovato');
    }

    function renderChannelList(){
      const q = (document.getElementById('channel-search').value||'').toLowerCase();
      const list = document.getElementById('channel-list');
      const filtered = channels.filter(c => !q || c.title.toLowerCase().includes(q));
      list.innerHTML = filtered.map(c => channelCard(c)).join('') || emptyState('Nessun canale trovato');
    }

    function renderLibraryList(){
      const q = (document.getElementById('library-search').value||'').toLowerCase();
      const list = document.getElementById('library-list');
      const filtered = library.filter(r => !q || r.title.toLowerCase().includes(q) || (r.provider||'').toLowerCase().includes(r));
      list.innerHTML = filtered.map(r => resourceCard(r)).join('') || emptyState('Nessuna risorsa trovata');
    }

    function emptyState(t){ return `<div class="text-center text-white/90 font-bold py-12 text-xl">${t}</div>`; }

    // ===== Enhanced UI Components =====
    function compactLiveCard(s){
      return `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
          <div>
            <div class="text-sm font-bold text-gray-500 mb-1">${formatDateTime(s.start_at)} ‚Ä¢ ${s.platform}</div>
            <div class="font-black text-gray-800">${escapeHtml(s.title)}</div>
            <div class="text-xs text-gray-600">${escapeHtml(s.host||'')} ${s.track?`‚Ä¢ ${escapeHtml(s.track)}`:''}</div>
          </div>
          <a class="btn-aurora text-sm" target="_blank" rel="noopener" href="${s.join_url}">Join</a>
        </div>`;
    }

    function compactResourceCard(r){
      return `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
          <div>
            <div class="text-sm font-bold text-gray-500 mb-1">${escapeHtml((r.provider||'').toString())}</div>
            <div class="font-black text-gray-800">${escapeHtml(r.title)}</div>
            <div class="text-xs text-gray-600">${escapeHtml(r.description||'').slice(0,60)}...</div>
          </div>
          <button class="btn-aurora text-sm" onclick="openResource('${r.id}','${r.type||'resource'}')">Apri</button>
        </div>`;
    }

    function liveCard(s){
      return `
        <div class="feature-card p-6">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="live-indicator"></span>
                <span class="text-sm font-bold text-gray-500">${formatDateTime(s.start_at)} ‚Ä¢ ${s.platform}</span>
              </div>
              <h4 class="text-xl font-black text-gray-800 mb-2">${escapeHtml(s.title)}</h4>
              <p class="text-sm text-gray-600 mb-3">${escapeHtml(s.host||'')} ${s.track?`‚Ä¢ ${escapeHtml(s.track)}`:''}</p>
              ${(s.passcode?`<div class="text-xs font-bold text-gray-700 mb-3 p-2 bg-yellow-50 rounded-lg">üîê Passcode: ${escapeHtml(s.passcode)}</div>`:'')}
              <div class="flex flex-wrap gap-2">${(s.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
            </div>
            <div class="flex flex-col gap-3 min-w-[140px]">
              <a class="btn-aurora text-center text-sm" target="_blank" rel="noopener" href="${s.join_url}">üöÄ Partecipa</a>
              <button class="btn-ghost text-sm" onclick="downloadICS('${s.id}')">üìÖ Calendario</button>
              <button class="btn-ghost text-sm" onclick="copyText('${s.join_url}')">üîó Copia Link</button>
            </div>
          </div>
        </div>`;
    }

    function courseCard(c){
      const fav = favorites.has(c.id) ? '‚òÖ' : '‚òÜ';
      const levelColors = { base: 'bg-green-100 text-green-800', intermedio: 'bg-yellow-100 text-yellow-800', avanzato: 'bg-red-100 text-red-800' };
      return `
        <div class="feature-card p-6">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm font-bold text-gray-500">${escapeHtml(c.provider||'')}</span>
                ${c.level ? `<span class="text-xs px-2 py-1 rounded-full font-bold ${levelColors[c.level] || 'bg-gray-100 text-gray-800'}">${escapeHtml(c.level)}</span>` : ''}
              </div>
              <h4 class="text-xl font-black text-gray-800 mb-3">${escapeHtml(c.title)}</h4>
              <p class="text-sm text-gray-700 mb-3 leading-relaxed">${escapeHtml(c.description||'')}</p>
              <div class="flex items-center gap-4 text-xs text-gray-600 mb-3">
                ${c.duration_minutes ? `<span>‚è±Ô∏è ${c.duration_minutes} min</span>` : ''}
                <span>üåç ${c.language || 'IT'}</span>
              </div>
              <div class="flex flex-wrap gap-2">${(c.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
            </div>
            <div class="flex flex-col gap-3 min-w-[140px]">
              <a href="${c.url}" target="_blank" rel="noopener" class="btn-aurora text-center text-sm">üéØ Inizia Corso</a>
              <button class="btn-ghost text-sm" onclick="openResource('${c.id}','course')">üìñ Dettagli</button>
              <button class="btn-ghost text-sm" onclick="toggleFavorite('${c.id}')">${fav} Preferito</button>
            </div>
          </div>
        </div>`;
    }

    function channelCard(c){
      const embed = getYouTubeEmbed(c.url);
      return `
        <div class="feature-card p-6">
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-bold text-gray-500 mb-1">${escapeHtml(c.provider||'YouTube')}</div>
                <h4 class="text-xl font-black text-gray-800">${escapeHtml(c.title)}</h4>
              </div>
              <a href="${c.url}" target="_blank" rel="noopener" class="btn-aurora">üé¨ Visita</a>
            </div>
            ${embed ? `<div class="rounded-2xl overflow-hidden shadow-lg"><iframe width="100%" height="240" src="${embed}" title="YouTube" frameborder="0" allowfullscreen></iframe></div>`:''}
            <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(c.description||'')}</p>
            <div class="flex flex-wrap gap-2">${(c.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
          </div>
        </div>`;
    }

    function resourceCard(r){
      const fav = favorites.has(r.id) ? '‚òÖ' : '‚òÜ';
      const typeIcons = { document: 'üìÑ', podcast: 'üéß', video: 'üé•', tool: 'üõ†Ô∏è', documentation: 'üìö' };
      return `
        <div class="feature-card p-6">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span>${typeIcons[r.type] || 'üì¶'}</span>
                <span class="text-sm font-bold text-gray-500">${escapeHtml((r.provider||'').toString())}</span>
              </div>
              <h4 class="text-xl font-black text-gray-800 mb-3">${escapeHtml(r.title)}</h4>
              <p class="text-sm text-gray-700 mb-3 leading-relaxed">${escapeHtml(r.description||'')}</p>
              <div class="flex flex-wrap gap-2">${(r.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
            </div>
            <div class="flex flex-col gap-3 min-w-[140px]">
              <a href="${r.url}" target="_blank" rel="noopener" class="btn-aurora text-center text-sm">üöÄ Apri</a>
              <button class="btn-ghost text-sm" onclick="openResource('${r.id}','resource')">üìñ Dettagli</button>
              <button class="btn-ghost text-sm" onclick="toggleFavorite('${r.id}')">${fav} Preferito</button>
            </div>
          </div>
        </div>`;
    }

    // ===== Navigation Enhancement =====
    function show(id){
      // Hide all sections
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      
      // Update nav pills
      document.querySelectorAll('.nav-pill').forEach(n=>n.classList.remove('active'));
      document.querySelector(`.nav-pill[data-target="${id}"]`).classList.add('active');
      
      // Scroll to content
      const hero = document.querySelector('.hero-section');
      hero.scrollIntoView({ behavior: 'smooth', block: 'end' });
      
      if (id === 'stats') renderStats();
    }

    async function navigateBack(){
      window.location.href = '../home.html';
    }

    function joinNextLive(){
      const nextLive = liveSessions.find(s => s.start_at > new Date());
      if (nextLive) {
        window.open(nextLive.join_url, '_blank');
        toast('Entrando nella live: ' + nextLive.title + ' üî¥');
      } else {
        show('live');
        toast('Controlla tutte le live disponibili üìÖ');
      }
    }

    // ===== Filters listeners =====
    function initFilters(){
      ['live-search','live-platform','course-search','course-level','channel-search','library-search']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', () => {
            if (id.startsWith('live')) renderLiveList();
            else if (id.startsWith('course')) renderCourseList();
            else if (id.startsWith('channel')) renderChannelList();
            else if (id.startsWith('library')) renderLibraryList();
          });
        });
    }

    // ===== Resource modal =====
    function openResource(id, kind){
      const res = (kind==='course' ? courses : (library.find(x=>x.id===id) || courses.find(x=>x.id===id) || channels.find(x=>x.id===id)));
      if (!res) return;
      modalResource = res;
      document.getElementById('res-title').textContent = res.title;
      document.getElementById('res-desc').textContent = res.description || '';
      document.getElementById('res-open').href = res.url;
      const tags = (res.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('');
      document.getElementById('res-tags').innerHTML = tags;
      const embedBox = document.getElementById('res-embed');
      const embed = getYouTubeEmbed(res.url);
      if (embed) {
        embedBox.innerHTML = `<iframe width="100%" height="240" src="${embed}" title="YouTube" frameborder="0" allowfullscreen></iframe>`;
        embedBox.classList.remove('hidden');
      } else {
        embedBox.classList.add('hidden');
        embedBox.innerHTML = '';
      }
      const favBtn = document.getElementById('res-fav');
      favBtn.textContent = (favorites.has(res.id) ? '‚òÖ' : '‚òÜ') + ' Preferito';
      document.getElementById('resource-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(){
      document.getElementById('resource-modal').classList.add('hidden');
      document.body.style.overflow = '';
      modalResource = null;
    }
    
    function toggleFavActive(){
      if (!modalResource) return;
      toggleFavorite(modalResource.id);
      const favBtn = document.getElementById('res-fav');
      favBtn.textContent = (favorites.has(modalResource.id) ? '‚òÖ' : '‚òÜ') + ' Preferito';
      updateCounters();
    }

    // ===== Favorites (DB o local) =====
    async function toggleFavorite(id){
      if (favorites.has(id)) favorites.delete(id); else favorites.add(id);
      persistFavs();
      renderFeatured(); renderCourseList(); renderLibraryList();
      updateCounters();
      if (user) {
        try {
          const { error } = await supabase.from('user_bookmarks')
            .upsert({ user_id: user.id, resource_id: id }, { onConflict:'user_id,resource_id' });
          if (error) throw error;
        } catch(e) { /* fallback silenzioso */ }
      }
    }
    
    function persistFavs(){
      try { localStorage.setItem('academy_favs', JSON.stringify([...favorites])); } catch(e) {}
    }

    // ===== Stats =====
    function renderStats(){
      const ctx = document.getElementById('stats-chart');
      if (!ctx) return;
      const data = {
        labels: ['Live Sessions', 'Corsi Online', 'Canali YouTube', 'Risorse Libreria'],
        datasets: [{ 
          data: [liveSessions.length*60, courses.length*90, channels.length*30, library.length*20],
          backgroundColor: ['#e94560','#00d4ff','#10b981','#ffd700'], 
          borderColor:'#fff', 
          borderWidth:3,
          hoverBorderWidth: 5
        }]
      };
      if (statsChart) statsChart.destroy();
      statsChart = new Chart(ctx.getContext('2d'), { 
        type:'doughnut', 
        data,
        options:{ 
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{ 
            legend:{ 
              position:'bottom',
              labels: {
                font: { weight: 'bold', size: 14 },
                padding: 20
              }
            } 
          },
          cutout: '60%'
        } 
      });
      document.getElementById('stats-live-count').textContent = liveSessions.length;
      const avg = courses.length ? Math.min(100, Math.round((favorites.size / Math.max(1,courses.length)) * 100)) : 0;
      document.getElementById('stats-course-progress').textContent = `${avg}%`;
    }

    // ===== Helpers =====
    function formatDateTime(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      return dt.toLocaleString('it-IT', { weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
    }
    
    function sameDay(a,b){ 
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); 
    }
    
    function addHours(h){ const d=new Date(); d.setHours(d.getHours()+h); return d; }
    function addHoursTo(d,h){ const x=new Date(d); x.setHours(x.getHours()+h); return x; }
    function addDays(days, hour=10){ const d=new Date(); d.setDate(d.getDate()+days); d.setHours(hour,0,0,0); return d; }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    
    function copyText(t){ 
      navigator.clipboard?.writeText(t).then(()=>toast('Link copiato negli appunti! üéâ')); 
    }
    
    function toast(msg){
      const n = document.createElement('div');
      n.className = 'fixed top-6 right-6 bg-gradient-to-r from-aurora to-cyan text-white px-6 py-4 rounded-2xl font-black shadow-2xl z-[300] transform translate-x-full';
      n.textContent = msg; 
      document.body.appendChild(n);
      setTimeout(() => n.style.transform = 'translateX(0)', 100);
      setTimeout(()=>{ 
        n.style.transform = 'translateX(full)';
        setTimeout(() => n.remove(), 300);
      }, 3000);
    }

    // ICS download
    function downloadICS(id){
      const s = liveSessions.find(x=>x.id===id); 
      if(!s) return;
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MyApp//Academy//IT',
        'BEGIN:VEVENT',
        `UID:${s.id}@myapp`,
        `DTSTAMP:${icsDate(new Date())}`,
        `DTSTART:${icsDate(s.start_at)}`,
        `DTEND:${icsDate(s.end_at)}`,
        `SUMMARY:${escapeICS(s.title)}`,
        `DESCRIPTION:${escapeICS((s.host?`Host: ${s.host}\\n`:'') + (s.track?`Track: ${s.track}\\n`:'') + (s.join_url?`Join: ${s.join_url}`:''))}`,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      const blob = new Blob([ics], { type:'text/calendar;charset=utf-8' });
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = `${s.title.replace(/\s+/g,'_')}.ics`; 
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Evento aggiunto al calendario! üìÖ');
    }
    
    function icsDate(d){ 
      const z = new Date(d); 
      const pad=n=>String(n).padStart(2,'0'); 
      return `${z.getUTCFullYear()}${pad(z.getUTCMonth()+1)}${pad(z.getUTCDate())}T${pad(z.getUTCHours())}${pad(z.getUTCMinutes())}${pad(z.getUTCSeconds())}Z`; 
    }
    
    function escapeICS(s){ 
      return (s||'').toString().replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); 
    }

    // YouTube helper
    function getYouTubeEmbed(url){
      if(!url) return null;
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtube.com')){
          if (u.searchParams.get('v')) return `https://www.youtube.com/embed/${u.searchParams.get('v')}`;
          if (u.pathname.startsWith('/@') || u.pathname.startsWith('/channel/')){
            return `https://www.youtube.com/embed/live_stream?channel=${u.pathname.split('/').pop()}`;
          }
        }
        if (u.hostname.includes('youtu.be')){
          const id = u.pathname.replace('/',''); 
          if (id) return `https://www.youtube.com/embed/${id}`;
        }
      }catch(e){}
      return null;
    }

    // ===== Events =====
    window.addEventListener('online', ()=> toast('Connessione ripristinata! üåê'));
    window.addEventListener('offline', ()=> toast('Modalit√† offline attiva üì±'));

    // ===== Service worker (opzionale) =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(()=>console.log('SW registered successfully'))
        .catch(()=>console.log('SW registration failed'));
    }

    // Smooth scroll behavior
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  </script>
</body>
</html>
