<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Area Riservata Dirigenti</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind (ok per test; in prod builda con CLI/PostCSS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','sans-serif'] },
          colors: {
            primary:'#1a1a2e', secondary:'#16213e', accent:'#0f3460', aurora:'#e94560',
            cyan:'#00d4ff', magenta:'#ff006e', gold:'#ffd700', teal:'#03dac6',
            dark:'#0a0a23', light:'#f8fafc', success:'#10b981'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --gradient-aurora:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-gold:linear-gradient(135deg,#ffd700 0%,#ffb347 100%);
      --gradient-magic:linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
    }
    *{font-family:'Inter',sans-serif}
    body{background:var(--gradient-aurora);background-size:400% 400%;animation:aurora 15s ease infinite;min-height:100vh}
    @keyframes aurora{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes fade-in{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fade-in .6s ease-out forwards}
    .text-ultra-visible{color:#fff;text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1);font-weight:800}
    .hero-title{font-size:clamp(2.5rem,8vw,4.5rem);font-weight:900;line-height:1.1}
    .section-title{font-size:clamp(1.5rem,5vw,2.25rem);font-weight:900;line-height:1.2}
    .glass-card{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border:2px solid rgba(255,215,0,.15);border-radius:24px;box-shadow:0 25px 50px rgba(0,0,0,.12);transition:.4s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
    .glass-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#ffd700,#e94560,#00d4ff,#03dac6)}
    .glass-card:hover{transform:translateY(-8px);box-shadow:0 35px 70px rgba(0,0,0,.15);border-color:rgba(255,215,0,.25)}
    .function-card{background:rgba(255,255,255,.2);backdrop-filter:blur(16px);border:3px solid rgba(255,255,255,.4);border-radius:18px;padding:1.5rem;transition:.4s cubic-bezier(.4,0,.2,1);cursor:pointer;text-align:center;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.2),0 0 0 1px rgba(255,215,0,.1);position:relative;text-decoration:none;color:inherit}
    .function-card::before{content:'';position:absolute;inset:0;border-radius:15px;padding:2px;background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(233,69,96,.3),rgba(0,212,255,.3));mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
    .function-card:hover{background:rgba(255,255,255,.3);transform:translateY(-6px) scale(1.03);border-color:rgba(255,215,0,.6);box-shadow:0 25px 50px rgba(255,215,0,.2),inset 0 1px 0 rgba(255,255,255,.3),0 0 0 2px rgba(255,215,0,.3)}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:9999px;font-size:.70rem;font-weight:800;color:#fff;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(4px)}
    .role-badge{display:inline-block;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:700;margin:.125rem}
    .role-badge.admin{background:var(--gradient-gold);color:#1a1a2e}
    .role-badge.dirigente{background:var(--gradient-magic);color:#fff}
    .role-badge.user{background:linear-gradient(135deg,#6b7280,#4b5563);color:#fff}
    .btn-aurora{background:var(--gradient-magic);color:#fff;border:2px solid rgba(233,69,96,.3);transition:.4s cubic-bezier(.4,0,.2,1);min-height:44px;font-weight:700;border-radius:12px;padding:.75rem 1.5rem;text-decoration:none;display:inline-block}
    .btn-aurora:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 15px 35px rgba(233,69,96,.4);border-color:rgba(233,69,96,.6)}
    .btn-secondary{background:rgba(255,255,255,.9);color:#1a1a2e;border:2px solid rgba(255,255,255,.8);transition:.3s;min-height:44px;font-weight:700;border-radius:12px;padding:.75rem 1.5rem;text-decoration:none;display:inline-block}
    .btn-secondary:hover{background:#fff;transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .spinner{border:3px solid rgba(255,215,0,.3);border-radius:50%;border-top:3px solid #ffd700;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;margin-right:.5rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    /* Overlays sessione */
    #session-guard,#session-required{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,35,.6);backdrop-filter:blur(6px);z-index:2000;color:#fff;font-weight:800}
    #session-guard.active,#session-required.active{display:flex}
  </style>
</head>
<body class="font-inter">

  <!-- Overlay: verifica sessione -->
  <div id="session-guard" aria-live="polite">
    <div class="flex items-center gap-3 text-xl">
      <span class="spinner"></span>
      <span>Verifica accesso‚Ä¶</span>
    </div>
  </div>
  <!-- Overlay: sessione richiesta -->
  <div id="session-required" class="p-4">
    <div class="glass-card max-w-md w-full p-6 text-center">
      <div class="text-4xl mb-3">üîê</div>
      <h3 class="text-xl font-extrabold text-primary mb-2">Sessione non attiva</h3>
      <p class="text-gray-600 mb-5">Accedi per continuare nell‚Äôarea dirigenti.</p>
      <div class="flex gap-3 justify-center">
        <a id="btnGoLogin" class="btn-aurora" href="auth.html">Accedi</a>
        <button id="btnRetry" class="btn-secondary">Riprova</button>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="absolute top-6 left-6 z-10">
    <a href="javascript:history.length>1?history.back():'home.html'" class="flex items-center gap-3 text-ultra-visible hover:text-gold transition-all duration-300 transform hover:scale-110 group" aria-label="Indietro">
      <svg class="w-8 h-8 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="text-lg font-bold">Indietro</span>
    </a>
  </div>

  <main class="min-h-screen px-4 py-8 max-w-6xl mx-auto">

    <!-- Hero -->
    <div class="text-center mb-12 fade-in">
      <div class="w-24 h-24 bg-gradient-to-br from-gold to-aurora rounded-full mx-auto mb-8 flex items-center justify-center shadow-2xl">
        <span class="text-4xl text-white">üèõÔ∏è</span>
      </div>
      <h1 class="hero-title text-ultra-visible mb-6">Area Riservata Dirigenti</h1>
      <p class="text-xl text-ultra-visible opacity-90 max-w-3xl mx-auto font-semibold">
        Accesso esclusivo alle funzioni direzionali e amministrative
      </p>
    </div>

    <!-- ========== 1) Azioni Personali ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="azioni-title">
      <h2 id="azioni-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üß≠</span>Azioni Personali
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <a class="function-card" href="https://form.jotform.com/243226223182044" target="_blank" rel="noopener noreferrer" aria-label="Richiedi Rimborso">
          <div class="text-4xl mb-3">üí∞</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Richiedi Rimborso</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Compila il modulo per richieste di rimborso spese</p>
        </a>

        <a class="function-card" href="https://form.jotform.com/243262801203343" target="_blank" rel="noopener noreferrer" aria-label="Richiedi Permesso">
          <div class="text-4xl mb-3">üìù</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Richiedi Permesso</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Inoltra richiesta di permesso sindacale</p>
        </a>

        <a class="function-card" href="https://www.carabinierinsc.it/webmail/?_task=mail&_mbox=INBOX#" target="_blank" rel="noopener noreferrer" aria-label="Casella di Posta">
          <div class="text-4xl mb-3">üìß</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Casella di Posta</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Accedi alla webmail</p>
        </a>
      </div>
    </section>

    <!-- ========== 2) I Tuoi Dati dirigenziali ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="dati-title">
      <h2 id="dati-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">ü™™</span>I Tuoi Dati dirigenziali
      </h2>

      <div class="flex items-center justify-center gap-4 mb-4">
        <div class="w-16 h-16 bg-gradient-to-br from-gold to-aurora rounded-full flex items-center justify-center shadow-lg">
          <span class="text-2xl text-white" id="userIcon">üë§</span>
        </div>
        <div class="text-left">
          <h3 class="text-2xl font-bold text-primary" id="userName">Caricamento...</h3>
          <div id="userRoles" class="mt-2"></div>
          <p class="text-gray-600 font-semibold" id="userEmail">‚Äî</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-4">
        <span class="inline-flex items-center gap-2 bg-white px-3 py-1 rounded-full border">
          üìÖ Iscritto dal: <strong id="iscrittoDal" class="ml-1">‚Äî</strong>
        </span>
        <span class="inline-flex items-center gap-2 bg-white px-3 py-1 rounded-full border">
          üîê Accesso: <strong id="accessLevel" class="ml-1">Verificando privilegi...</strong>
        </span>
      </div>

      <div id="noAccessBox" class="hidden mt-6 p-4 rounded-xl border border-rose-200 bg-rose-50 text-rose-700">
        <div class="font-bold mb-1">Accesso limitato</div>
        <p class="text-sm">Il tuo profilo non ha i privilegi da DIRIGENTE/ADMIN. Se pensi sia un errore, contatta l‚Äôamministratore.</p>
        <a href="home.html" class="btn-secondary mt-3 inline-block">Vai alla Home</a>
      </div>
    </section>

    <!-- ========== 3) Panoramica di sistema ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="panoramica-title">
      <h2 id="panoramica-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üìà</span>Panoramica di sistema
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">üì∞</div>
          <div class="text-sm text-gray-500">News pubblicate</div>
          <div id="newsCount" class="text-3xl font-extrabold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">‚≠ê</div>
          <div class="text-sm text-gray-500">News in evidenza</div>
          <div id="featuredNewsCount" class="text-3xl font-extrabold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">üõ°Ô∏è</div>
          <div class="text-sm text-gray-500">Ruolo attivo</div>
          <div id="rolesSummary" class="text-lg font-bold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">‚öôÔ∏è</div>
          <div class="text-sm text-gray-500">Stato</div>
          <div class="text-lg font-bold text-success mt-1">Attivo</div>
        </div>
      </div>
    </section>

    <!-- ========== 4) Area Amministrativa dirigenziale ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="area-admin-title">
      <h2 id="area-admin-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üèóÔ∏è</span>Area Amministrativa dirigenziale
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="areadirigenti.html" class="function-card" aria-label="Area Dirigenti">
          <div class="text-4xl mb-2">üß≠</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Area Dirigenti</div>
          <p class="text-ultra-visible opacity-80 text-sm">Vai all'area operativa per dirigenti</p>
        </a>

        <a href="gestione-convenzioni.html" class="function-card" aria-label="Gestione Convenzioni">
          <div class="text-4xl mb-2">üè∑Ô∏è</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Gestione Convenzioni</div>
          <p class="text-ultra-visible opacity-80 text-sm">Crea e gestisci partnership</p>
        </a>

        <a href="gestione-notizie.html" class="function-card" aria-label="Gestione Notizie">
          <div class="text-4xl mb-2">üì∞</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Gestione Notizie</div>
          <p class="text-ultra-visible opacity-80 text-sm">Pubblica e modifica comunicazioni</p>
        </a>
      </div>
    </section>

    <!-- ========== 5) Ultime Notizie ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="ultime-notizie-title">
      <h2 id="ultime-notizie-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üóûÔ∏è</span>Ultime Notizie
      </h2>

      <div id="latestNews" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <div id="newsEmptyState" class="hidden text-center py-10">
        <div class="text-5xl mb-4">ü™ß</div>
        <p class="text-gray-700 font-semibold">Nessuna notizia pubblicata al momento</p>
      </div>
    </section>

    <!-- ========== 6) Convenzioni in evidenza ========== -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="conv-evidenza-title">
      <h2 id="conv-evidenza-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">ü§ù</span>Convenzioni in evidenza
      </h2>

      <div id="featuredConvenzioni" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <div id="convEmptyState" class="text-center py-10">
        <div class="text-5xl mb-4">üîé</div>
        <p class="text-gray-700 font-semibold">Al momento non ci sono convenzioni in evidenza.</p>
        <p class="text-gray-500 mt-1">Gestiscile da <a class="text-aurora font-bold underline" href="gestione-convenzioni.html">Gestione Convenzioni</a>.</p>
      </div>
    </section>

    <!-- Supporto -->
    <div class="glass-card p-6 md:p-8 text-center fade-in">
      <h3 class="section-title text-primary mb-4">Supporto Tecnico</h3>
      <p class="text-gray-600 text-lg mb-6">Hai bisogno di assistenza con le funzioni dirigenziali?</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="mailto:support@aurora.app" class="btn-aurora"><span class="mr-2">üìß</span>Contatta Supporto</a>
        <a href="tel:+390000000000" class="btn-secondary"><span class="mr-2">üìû</span>Chiamata Urgente</a>
      </div>
    </div>

  </main>

  <!-- Supabase v2 (ESM) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // üëá STESSO PROGETTO DEL TUO LOGIN
    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk',
      { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
    );

    // ===== Utils
    const fmtDate = (iso) => { try { return iso ? new Intl.DateTimeFormat('it-IT',{dateStyle:'long'}).format(new Date(iso)) : '‚Äî'; } catch { return '‚Äî'; } };
    const escapeHTML = (s) => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    const sessionGuard = {
      show(){ document.getElementById('session-guard')?.classList.add('active') },
      hide(){ document.getElementById('session-guard')?.classList.remove('active') },
      require(){ document.getElementById('session-required')?.classList.add('active') },
      clearRequire(){ document.getElementById('session-required')?.classList.remove('active') },
    };

    async function ensureUser(timeoutMs=6000){
      sessionGuard.show();
      try{
        const { data:{ user } } = await supabase.auth.getUser();
        if (user) return user;
        return await new Promise((resolve)=>{
          let done=false;
          const t=setTimeout(()=>{ if(!done){done=true; resolve(null);} }, timeoutMs);
          const { data:{ subscription } } = supabase.auth.onAuthStateChange((_e, sess)=>{
            if (sess?.user && !done){ done=true; clearTimeout(t); subscription?.unsubscribe?.(); resolve(sess.user); }
          });
        });
      } finally { sessionGuard.hide(); }
    }

    // ===== Stato
    let currentUser=null;
    let currentRole='USER';

    // ===== Init
    async function init(){
      try{
        const u = await ensureUser();
        if(!u){
          sessionGuard.require();
          document.getElementById('btnRetry').onclick = async ()=>{ sessionGuard.clearRequire(); init(); };
          return;
        }
        currentUser = u;

        await loadUserProfile();     // nome/email/ruolo + gate
        await loadIscrittoDal();     // tessere.data_emissione
        await loadSystemOverview();  // counts
        await loadLatestNews();      // news collegate
        await loadFeaturedConvenzioni(); // convenzioni in evidenza
      }catch(e){
        console.error('Errore init:', e);
        sessionGuard.require();
      }
    }

    // ===== Profile & Ruolo (user_profiles)
    async function loadUserProfile(){
      let nome='Dirigente', email='‚Äî', ruoloDb='USER';
      try{
        const { data, error } = await supabase
          .from('user_profiles')
          .select('nome,cognome,email,role')
          .eq('user_id', currentUser.id)
          .single();
        if (!error && data){
          nome = data.nome || data.full_name || nome;
          email = data.email || email;
          ruoloDb = data.role || 'USER';
        }
      }catch(e){ console.warn('Profilo non trovato:', e?.message); }

      currentRole = ruoloDb?.toUpperCase?.() || 'USER';

      document.getElementById('userName').textContent = nome;
      document.getElementById('userEmail').textContent = email;
      document.getElementById('userIcon').textContent = currentRole==='ADMIN' ? 'üëë' : (currentRole==='DIRIGENTE' ? 'üéØ' : 'üë§');

      const rolesContainer = document.getElementById('userRoles');
      const cls = currentRole==='ADMIN'?'admin':currentRole==='DIRIGENTE'?'dirigente':'user';
      const icon = currentRole==='ADMIN'?'üëë':currentRole==='DIRIGENTE'?'üéØ':'üë§';
      rolesContainer.innerHTML = `<span class="role-badge ${cls}">${icon} ${escapeHTML(currentRole)}</span>`;

      document.getElementById('rolesSummary').textContent = currentRole;
      document.getElementById('accessLevel').textContent =
        (currentRole==='ADMIN' || currentRole==='DIRIGENTE')
          ? 'Accesso Dirigente Autorizzato' : 'Accesso Utente Base';

      if (!(currentRole==='ADMIN' || currentRole==='DIRIGENTE')){
        document.getElementById('noAccessBox').classList.remove('hidden');
      }
    }

    // ===== "Iscritto dal" (tessere.data_emissione)
    async function loadIscrittoDal(){
      try{
        const uid=currentUser?.id;
        if(!uid){ document.getElementById('iscrittoDal').textContent='‚Äî'; return; }

        const { data, error } = await supabase
          .from('tessere')
          .select('data_emissione')
          .eq('user_id', uid)
          .order('data_emissione',{ ascending:true })
          .limit(1);

        if(error) throw error;

        const de = data && data[0]?.data_emissione;
        document.getElementById('iscrittoDal').textContent = de ? fmtDate(de) : 'Non disponibile';
      }catch(e){
        console.warn('Impossibile leggere tessere:', e?.message);
        document.getElementById('iscrittoDal').textContent='Non disponibile';
      }
    }

    // ===== Panoramica counts (news & in evidenza)
    async function loadSystemOverview(){
      try{
        const nowIso = new Date().toISOString();

        const { count: totalNews } = await supabase
          .from('news')
          .select('id',{ count:'exact', head:true })
          .eq('pubblicata', true)
          .or(`data_scadenza.is.null,data_scadenza.gt.${nowIso}`);

        const { count: featuredCount } = await supabase
          .from('news')
          .select('id',{ count:'exact', head:true })
          .eq('pubblicata', true)
          .eq('in_evidenza', true)
          .or(`data_scadenza.is.null,data_scadenza.gt.${nowIso}`);

        document.getElementById('newsCount').textContent = Number.isFinite(totalNews) ? totalNews : '‚Äî';
        document.getElementById('featuredNewsCount').textContent = Number.isFinite(featuredCount) ? featuredCount : '‚Äî';
      }catch{
        document.getElementById('newsCount').textContent='‚Äî';
        document.getElementById('featuredNewsCount').textContent='‚Äî';
      }
    }

    // ===== Ultime Notizie (tabella "news")
    async function loadLatestNews(){
      const wrap=document.getElementById('latestNews');
      const empty=document.getElementById('newsEmptyState');
      wrap.innerHTML = `
        <div class="col-span-full flex items-center justify-center py-8">
          <span class="spinner"></span><span class="font-semibold text-gray-600">Caricamento notizie‚Ä¶</span>
        </div>`;

      try{
        const nowIso = new Date().toISOString();
        const { data: news, error } = await supabase
          .from('news')
          .select('id,titolo,sottotitolo,immagine_url,categoria,data_pubblicazione,in_evidenza')
          .eq('pubblicata', true)
          .or(`data_scadenza.is.null,data_scadenza.gt.${nowIso}`)
          .order('in_evidenza',{ ascending:false })
          .order('data_pubblicazione',{ ascending:false })
          .limit(6);
        if(error) throw error;

        if(!news || !news.length){
          wrap.innerHTML=''; empty.classList.remove('hidden'); return;
        }
        empty.classList.add('hidden');
        wrap.innerHTML='';

        for(const n of news){
          const el=document.createElement('article');
          el.className='rounded-2xl border border-yellow-200/40 bg-white/95 overflow-hidden shadow group';
          el.innerHTML=`
            <div class="relative h-40 bg-gray-100 overflow-hidden">
              ${n.immagine_url ? `<img src="${escapeHTML(n.immagine_url)}" alt="" class="w-full h-full object-cover group-hover:scale-[1.02] transition-transform duration-300">` : `<div class="w-full h-full flex items-center justify-center text-4xl">üì∞</div>`}
              <div class="absolute top-2 left-2"><span class="badge">${escapeHTML(n.categoria||'GENERALE')}</span></div>
              ${n.in_evidenza ? `<div class="absolute top-2 right-2"><span class="badge">‚≠ê In evidenza</span></div>` : ``}
            </div>
            <div class="p-5">
              <h3 class="font-extrabold text-primary text-lg leading-snug mb-1">${escapeHTML(n.titolo)}</h3>
              ${n.sottotitolo ? `<p class="text-gray-600 text-sm mb-3">${escapeHTML(n.sottotitolo)}</p>` : ``}
              <div class="flex items-center justify-between text-xs text-gray-500">
                <span>${n.data_pubblicazione ? fmtDate(n.data_pubblicazione) : '‚Äî'}</span>
                <a href="gestione-notizie.html?id=${encodeURIComponent(n.id)}" class="text-aurora font-bold hover:underline">Apri</a>
              </div>
            </div>`;
          wrap.appendChild(el);
        }
      }catch(e){
        console.error('Errore news:', e);
        wrap.innerHTML = `
          <div class="col-span-full text-center py-10">
            <div class="text-5xl mb-4">‚ö†Ô∏è</div>
            <p class="text-gray-700 font-semibold">Impossibile caricare le notizie</p>
            <p class="text-gray-500 text-sm">Riprova pi√π tardi</p>
          </div>`;
      }
    }

    // ===== Convenzioni in evidenza (fallback su "attiva=true")
    async function loadFeaturedConvenzioni(){
      const wrap=document.getElementById('featuredConvenzioni');
      const empty=document.getElementById('convEmptyState');
      try{
        // 1) prova in_evidenza
        let data=null;
        try{
          const r = await supabase.from('convenzioni')
            .select('id,nome_azienda,descrizione,logo_url,immagine_url,link_esterno,in_evidenza')
            .eq('in_evidenza', true)
            .limit(6);
          data=r.data;
        }catch{}

        // 2) fallback attiva
        if (!data || !data.length){
          const r2 = await supabase.from('convenzioni')
            .select('id,nome_azienda,descrizione,logo_url,immagine_url,link_esterno,attiva')
            .eq('attiva', true)
            .limit(6);
          data=r2.data;
        }

        if(!data || !data.length){ empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        wrap.innerHTML='';

        for(const c of data){
          const a=document.createElement('a');
          a.className='function-card rounded-2xl border border-yellow-200/40 bg-white/95 overflow-hidden shadow';
          a.href = c.link_esterno || 'gestione-convenzioni.html';
          a.target='_blank'; a.rel='noopener noreferrer';
          const imgSrc = c.logo_url || c.immagine_url;
          a.innerHTML = `
            <div class="w-full h-28 bg-gray-50 flex items-center justify-center overflow-hidden rounded-xl mb-3">
              ${imgSrc ? `<img src="${escapeHTML(imgSrc)}" alt="" class="max-h-28 object-contain">` : `<div class="text-4xl">üè∑Ô∏è</div>`}
            </div>
            <div class="font-bold text-ultra-visible text-lg mb-1">${escapeHTML(c.nome_azienda || 'Convenzione')}</div>
            <p class="text-ultra-visible opacity-80 text-sm">${escapeHTML((c.descrizione || '').slice(0,120))}${c.descrizione && c.descrizione.length>120 ? '‚Ä¶' : ''}</p>`;
          wrap.appendChild(a);
        }
      }catch(e){
        console.warn('Errore convenzioni:', e);
        empty.classList.remove('hidden');
      }
    }

    // Start
    init();
  </script>
</body>
</html>
