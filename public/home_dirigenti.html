<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Convenzioni</title>

  <!-- Font & Tailwind (ok per test; in produzione builda con CLI/PostCSS) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        fontFamily:{ inter:['Inter','sans-serif'] },
        colors:{ primary:'#1a1a2e', aurora:'#e94560', gold:'#ffd700', success:'#10b981'}
      }}
    }
  </script>

  <style>
    body{background:#f6f8fb}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.04)}
    .btn-primary{background:linear-gradient(135deg,#ff006e,#e94560,#03dac6);color:#fff;border:0;border-radius:12px;padding:.8rem 1.2rem;font-weight:800}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-light{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem 1rem;font-weight:700}
    .input{appearance:none;width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem 1rem}
    .switch{width:42px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;transition:.2s}
    .switch > span{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px;background:#fff;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.15)}
    input[type="checkbox"]:checked + .switch{background:#22c55e}
    input[type="checkbox"]:checked + .switch > span{left:21px}
    .badge{display:inline-block;background:#0f172a;color:#fff;border-radius:999px;font-weight:800;font-size:.7rem;padding:.25rem .6rem}
    .chip{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;font-weight:700;font-size:.7rem;padding:.2rem .55rem}
    .spinner{border:3px solid rgba(16,185,129,.3);border-top:3px solid #10b981;border-radius:50%;width:22px;height:22px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:40}
    .modal.show{display:flex}
  </style>
</head>
<body class="font-inter">

  <!-- Header -->
  <header class="bg-primary text-white">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-gold to-aurora rounded-xl flex items-center justify-center">ü§ù</div>
        <div>
          <div class="font-extrabold">Gestione Convenzioni</div>
          <div class="text-white/70 text-sm">Crea, modifica e metti in evidenza le convenzioni</div>
        </div>
      </div>
      <a href="home_dirigenti.html" class="btn-light">‚Üê Area Dirigenti</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">

    <!-- Azioni & Filtri -->
    <section class="card p-5">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <button id="btnNew" class="btn-primary">‚ûï Nuova convenzione</button>
          <button id="btnReload" class="btn-light">üîÑ Ricarica</button>
        </div>
        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
          <input id="q" class="input md:w-64" placeholder="Cerca azienda‚Ä¶">
          <select id="fCategoria" class="input">
            <option value="">Tutte le categorie</option>
            <option>SALUTE</option><option>VIAGGI</option><option>SHOPPING</option><option>SERVIZI</option>
            <option>FORMAZIONE</option><option>TEMPO_LIBERO</option><option>RISTORAZIONE</option><option>AUTOMOTIVE</option><option>ALTRO</option>
          </select>
          <label class="flex items-center gap-2">
            <input id="onlyEvidenza" type="checkbox" class="hidden">
            <div class="switch"><span></span></div><span class="text-sm">Solo in evidenza</span>
          </label>
        </div>
      </div>
    </section>

    <!-- Lista -->
    <section class="card p-5">
      <div id="listInfo" class="flex items-center justify-between mb-4">
        <div class="font-extrabold text-primary">Elenco convenzioni</div>
        <div class="text-sm text-gray-500">
          <span id="countSpan">0</span> risultati
        </div>
      </div>

      <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>

      <div id="emptyState" class="hidden text-center py-10">
        <div class="text-6xl mb-2">üóÇÔ∏è</div>
        <div class="text-gray-700 font-semibold">Nessuna convenzione trovata</div>
        <div class="text-gray-500">Prova a cambiare i filtri o aggiungi una nuova convenzione</div>
      </div>
    </section>
  </main>

  <!-- Modal Form -->
  <div id="modal" class="modal">
    <div class="card max-w-3xl w-[96vw] p-6 relative">
      <button id="closeModal" class="absolute top-3 right-3 btn-light">‚úñ</button>
      <h3 id="formTitle" class="text-xl font-extrabold text-primary mb-4">Nuova convenzione</h3>

      <form id="convForm" class="grid gap-4 md:grid-cols-2">
        <input type="hidden" id="convId">

        <div class="md:col-span-2">
          <label class="font-semibold block mb-1">Nome azienda*</label>
          <input id="nome_azienda" class="input" required>
        </div>

        <div>
          <label class="font-semibold block mb-1">Categoria*</label>
          <select id="categoria" class="input" required>
            <option>SALUTE</option><option>VIAGGI</option><option>SHOPPING</option><option>SERVIZI</option>
            <option>FORMAZIONE</option><option>TEMPO_LIBERO</option><option>RISTORAZIONE</option><option>AUTOMOTIVE</option><option>ALTRO</option>
          </select>
        </div>

        <div>
          <label class="font-semibold block mb-1">Copertura geografica</label>
          <input id="copertura_geografica" class="input" placeholder="NAZIONALE / REGIONALE / LOCALE / ONLINE">
        </div>

        <div>
          <label class="font-semibold block mb-1">Sconto %</label>
          <input id="sconto_percentuale" type="number" min="0" max="100" class="input" placeholder="0-100">
        </div>

        <div>
          <label class="font-semibold block mb-1">Codice sconto</label>
          <input id="codice_sconto" class="input" placeholder="facoltativo">
        </div>

        <div class="md:col-span-2">
          <label class="font-semibold block mb-1">Descrizione*</label>
          <textarea id="descrizione" class="input" rows="5" required placeholder="Dettagli e vantaggi della convenzione"></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="font-semibold block mb-1">Condizioni</label>
          <textarea id="condizioni" class="input" rows="3" placeholder="Limiti, requisiti, ecc."></textarea>
        </div>

        <div>
          <label class="font-semibold block mb-1">Link esterno</label>
          <input id="link_esterno" class="input" placeholder="https://‚Ä¶">
        </div>

        <div>
          <label class="font-semibold block mb-1">Logo URL</label>
          <input id="logo_url" class="input" placeholder="https://‚Ä¶">
        </div>

        <div>
          <label class="font-semibold block mb-1">Immagine URL</label>
          <input id="immagine_url" class="input" placeholder="https://‚Ä¶">
        </div>

        <div>
          <label class="font-semibold block mb-1">Contatti (JSON)</label>
          <textarea id="contatti" class="input" rows="3" placeholder='{"telefono":"...", "email":"..."}'></textarea>
        </div>

        <div>
          <label class="font-semibold block mb-1">Valida dal</label>
          <input id="valida_dal" type="date" class="input">
        </div>

        <div>
          <label class="font-semibold block mb-1">Valida fino al</label>
          <input id="valida_fino" type="date" class="input">
        </div>

        <div>
          <label class="font-semibold block mb-1">Attiva</label>
          <label class="flex items-center gap-2"><input id="attiva" type="checkbox" class="hidden"><div class="switch"><span></span></div></label>
        </div>

        <div>
          <label class="font-semibold block mb-1">In evidenza</label>
          <label class="flex items-center gap-2"><input id="in_evidenza" type="checkbox" class="hidden"><div class="switch"><span></span></div></label>
        </div>

        <div class="md:col-span-2">
          <label class="font-semibold block mb-1">Note</label>
          <textarea id="note" class="input" rows="3"></textarea>
        </div>

        <!-- Anteprima -->
        <div class="md:col-span-2 grid md:grid-cols-2 gap-4">
          <div class="card p-3">
            <div class="text-sm font-semibold mb-2">Anteprima Logo/Immagine</div>
            <div id="previewBox" class="w-full h-36 bg-gray-100 rounded-lg flex items-center justify-center text-4xl">üñºÔ∏è</div>
          </div>
          <div class="card p-3">
            <div class="text-sm font-semibold mb-2">Info</div>
            <div class="text-sm text-gray-600">
              <div>Categoria: <span id="infoCat">‚Äî</span></div>
              <div>Copertura: <span id="infoCop">‚Äî</span></div>
              <div>Link esterno: <span id="infoLink">‚Äî</span></div>
            </div>
          </div>
        </div>

        <div class="md:col-span-2 flex items-center gap-3 pt-2">
          <button id="saveBtn" type="submit" class="btn-primary">üíæ Salva</button>
          <button id="deleteBtn" type="button" class="btn-light hidden">üóëÔ∏è Elimina</button>
          <button id="resetBtn" type="button" class="btn-light">Nuova</button>
          <span id="formMsg" class="ml-auto text-sm font-semibold"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase JS (ESM) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk'
    );

    const $ = id => document.getElementById(id);
    const state = { items:[], filters:{ q:'', categoria:'', onlyEvidenza:false } };

    // ---------- AUTH GUARD ----------
    (async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ window.location.href = 'auth.html'; return; }
      init();
    })();

    // ---------- INIT ----------
    function init(){
      bindFilters();
      bindModal();
      bindForm();
      loadList();
    }

    // ---------- LISTA ----------
    async function loadList(){
      const list = $('list'), empty=$('emptyState'), countSpan=$('countSpan');
      list.innerHTML = `<div class="col-span-full flex items-center justify-center py-8"><span class="spinner"></span></div>`;

      try{
        const sel = 'id,nome_azienda,descrizione,categoria,sconto_percentuale,condizioni,codice_sconto,link_esterno,logo_url,immagine_url,valida_dal,valida_fino,attiva,in_evidenza,copertura_geografica,visualizzazioni,created_at';
        let query = supabase.from('convenzioni').select(sel);

        // filtri
        if(state.filters.onlyEvidenza) query = query.eq('in_evidenza', true);
        if(state.filters.categoria) query = query.eq('categoria', state.filters.categoria);
        if(state.filters.q){
          // FULL-TEXT semplice: filtro client-side dopo fetch all? Usiamo il like case-insensitive
          query = query.ilike('nome_azienda', `%${state.filters.q}%`);
        }

        // ordering: prima evidenza, poi create desc
        query = query.order('in_evidenza', { ascending:false }).order('created_at', { ascending:false }).limit(60);

        const { data, error } = await query;
        if(error) throw error;

        state.items = data || [];
        countSpan.textContent = state.items.length;

        if(!state.items.length){
          list.innerHTML=''; empty.classList.remove('hidden'); return;
        }
        empty.classList.add('hidden');

        list.innerHTML = state.items.map(row => renderCard(row)).join('');
        // Events (delegation)
        list.querySelectorAll('[data-action]').forEach(btn=>{
          btn.addEventListener('click', onListAction);
        });
      }catch(err){
        console.error(err);
        list.innerHTML = `<div class="col-span-full text-center text-red-600 py-8">Errore nel caricamento</div>`;
      }
    }

    function renderCard(c){
      const img = c.logo_url || c.immagine_url;
      const sc = Number.isFinite(c.sconto_percentuale) ? `-${c.sconto_percentuale}%` : 'ü§ù';
      const valida = (c.valida_dal || c.valida_fino) ? 
        `${c.valida_dal || '‚Äî'} ‚Üí ${c.valida_fino || '‚Äî'}` : '‚Äî';
      return `
      <article class="card p-4 flex flex-col">
        <div class="flex items-start justify-between">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-xl flex items-center justify-center text-white font-bold">${sc}</div>
          <div class="space-x-1">
            ${c.in_evidenza ? `<span class="chip bg-yellow-50">‚≠ê evidenza</span>`:''}
            ${c.attiva ? `<span class="chip bg-green-50">‚úî attiva</span>`:`<span class="chip bg-gray-50">‚è∏ inattiva</span>`}
            <span class="chip">üëÅ ${c.visualizzazioni||0}</span>
          </div>
        </div>

        <div class="mt-3">
          ${img ? `<img src="${(img||'').replaceAll('"','&quot;')}" alt="" class="w-full h-32 object-contain rounded-md bg-gray-50">` : `<div class="w-full h-32 rounded-md bg-gray-50 flex items-center justify-center text-3xl">üñºÔ∏è</div>`}
        </div>

        <h3 class="mt-3 text-lg font-extrabold text-primary">${(c.nome_azienda||'').replaceAll('<','&lt;')}</h3>
        <div class="text-xs text-gray-500 mb-2">
          <span class="badge">${c.categoria}</span>
          <span class="ml-2">üìç ${c.copertura_geografica || 'NAZIONALE'}</span>
        </div>
        <p class="text-sm text-gray-700 line-clamp-3">${(c.descrizione||'').slice(0,180)}${(c.descrizione||'').length>180?'‚Ä¶':''}</p>
        <div class="text-xs text-gray-500 mt-2">‚è∞ ${valida}</div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button class="btn-light" data-action="edit" data-id="${c.id}">‚úèÔ∏è Modifica</button>
          <button class="btn-light" data-action="toggle-evid" data-id="${c.id}">${c.in_evidenza?'‚≠ê Rimuovi evidenza':'‚≠ê Metti in evidenza'}</button>
          <button class="btn-light" data-action="toggle-attiva" data-id="${c.id}">${c.attiva?'‚è∏ Disattiva':'‚ñ∂Ô∏è Attiva'}</button>
          ${c.link_esterno ? `<a target="_blank" rel="noopener" class="btn-light text-center" href="${(c.link_esterno||'').replaceAll('"','&quot;')}">üåê Apri link</a>` : `<button class="btn-light opacity-60 cursor-not-allowed" disabled>üåê Nessun link</button>`}
        </div>
      </article>`;
    }

    async function onListAction(e){
      const btn = e.currentTarget;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if(!id) return;

      if(action==='edit'){
        openModal(); await loadIntoForm(id);
      }
      if(action==='toggle-evid'){
        btn.disabled=true; btn.textContent='‚Ä¶';
        const row = state.items.find(x=>x.id===id);
        await supabase.from('convenzioni').update({ in_evidenza: !row.in_evidenza }).eq('id', id);
        await loadList();
      }
      if(action==='toggle-attiva'){
        btn.disabled=true; btn.textContent='‚Ä¶';
        const row = state.items.find(x=>x.id===id);
        await supabase.from('convenzioni').update({ attiva: !row.attiva }).eq('id', id);
        await loadList();
      }
    }

    // ---------- FILTRI ----------
    function bindFilters(){
      $('btnReload').addEventListener('click', loadList);
      $('btnNew').addEventListener('click', ()=>{ openModal(); resetForm(); });
      $('q').addEventListener('input', debounce(()=>{ state.filters.q = $('q').value.trim(); loadList(); }, 300));
      $('fCategoria').addEventListener('change', ()=>{ state.filters.categoria = $('fCategoria').value; loadList(); });
      $('onlyEvidenza').addEventListener('change', ()=>{ state.filters.onlyEvidenza = $('onlyEvidenza').checked; loadList(); });
    }
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }

    // ---------- MODAL ----------
    function openModal(){ $('modal').classList.add('show'); }
    function closeModal(){ $('modal').classList.remove('show'); }
    function bindModal(){
      $('closeModal').addEventListener('click', closeModal);
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
      $('modal').addEventListener('click', e=>{ if(e.target.id==='modal') closeModal(); });
    }

    // ---------- FORM ----------
    function bindForm(){
      const livePreview = ()=> {
        const img = $('logo_url').value.trim() || $('immagine_url').value.trim();
        $('previewBox').innerHTML = img ? `<img src="${img.replaceAll('"','&quot;')}" class="w-full h-full object-contain rounded-md">` : 'üñºÔ∏è';
        $('infoCat').textContent = $('categoria').value || '‚Äî';
        $('infoCop').textContent = $('copertura_geografica').value || '‚Äî';
        $('infoLink').textContent = $('link_esterno').value || '‚Äî';
      };
      ['logo_url','immagine_url','categoria','copertura_geografica','link_esterno'].forEach(id=>{
        $(id).addEventListener('input', livePreview);
      });
      livePreview();

      $('convForm').addEventListener('submit', saveForm);
      $('resetBtn').addEventListener('click', resetForm);
      $('deleteBtn').addEventListener('click', onDelete);
    }

    function resetForm(){
      $('formTitle').textContent='Nuova convenzione';
      $('convId').value='';
      ['nome_azienda','descrizione','categoria','sconto_percentuale','condizioni','codice_sconto','link_esterno','logo_url','immagine_url','contatti','copertura_geografica','valida_dal','valida_fino','note'].forEach(id=>$(id).value='');
      $('attiva').checked = true;
      $('in_evidenza').checked = false;
      $('deleteBtn').classList.add('hidden');
      $('formMsg').textContent='';
      $('previewBox').innerHTML='üñºÔ∏è';
      $('infoCat').textContent='‚Äî'; $('infoCop').textContent='‚Äî'; $('infoLink').textContent='‚Äî';
    }

    async function loadIntoForm(id){
      resetForm();
      $('formTitle').textContent='Modifica convenzione';
      $('formMsg').textContent='Caricamento‚Ä¶';
      const { data, error } = await supabase.from('convenzioni').select('*').eq('id', id).single();
      if(error || !data){ $('formMsg').textContent='Errore caricamento'; $('formMsg').className='text-red-600'; return; }

      $('convId').value = data.id;
      $('nome_azienda').value = data.nome_azienda || '';
      $('descrizione').value = data.descrizione || '';
      $('categoria').value = data.categoria || 'ALTRO';
      $('sconto_percentuale').value = data.sconto_percentuale ?? '';
      $('condizioni').value = data.condizioni ?? '';
      $('codice_sconto').value = data.codice_sconto ?? '';
      $('link_esterno').value = data.link_esterno ?? '';
      $('logo_url').value = data.logo_url ?? '';
      $('immagine_url').value = data.immagine_url ?? '';
      $('contatti').value = data.contatti ? JSON.stringify(data.contatti, null, 2) : '';
      $('valida_dal').value = data.valda_dal || data.valida_dal || '';
      $('valida_fino').value = data.valida_fino || '';
      $('attiva').checked = !!data.attiva;
      $('in_evidenza').checked = !!data.in_evidenza;
      $('copertura_geografica').value = data.copertura_geografica || '';
      $('note').value = data.note || '';
      $('deleteBtn').classList.remove('hidden');
      $('formMsg').textContent='';

      // trigger preview
      ['logo_url','immagine_url','categoria','copertura_geografica','link_esterno'].forEach(id=>{
        const evt=new Event('input'); $(id).dispatchEvent(evt);
      });
    }

    function parseJSONSafe(txt){
      if(!txt || !txt.trim()) return null;
      try{ return JSON.parse(txt); }
      catch{ return '__invalid__'; }
    }

    async function saveForm(e){
      e.preventDefault();
      $('formMsg').textContent='';

      // base validation
      if(!$('nome_azienda').value.trim() || !$('descrizione').value.trim()){
        $('formMsg').textContent='Compila Nome azienda e Descrizione';
        $('formMsg').className='text-red-600'; return;
      }
      const sconto = $('sconto_percentuale').value;
      if(sconto && (sconto<0 || sconto>100)){ $('formMsg').textContent='Sconto % deve essere 0-100'; $('formMsg').className='text-red-600'; return; }

      const contatti = parseJSONSafe($('contatti').value);
      if(contatti==='__invalid__'){ $('formMsg').textContent='Contatti non √® un JSON valido'; $('formMsg').className='text-red-600'; return; }

      const payload = {
        nome_azienda: $('nome_azienda').value.trim(),
        descrizione: $('descrizione').value.trim(),
        categoria: $('categoria').value,
        sconto_percentuale: sconto==='' ? null : Number(sconto),
        condizioni: $('condizioni').value.trim() || null,
        codice_sconto: $('codice_sconto').value.trim() || null,
        link_esterno: $('link_esterno').value.trim() || null,
        logo_url: $('logo_url').value.trim() || null,
        immagine_url: $('immagine_url').value.trim() || null,
        contatti: contatti ?? {},
        valida_dal: $('valida_dal').value || null,
        valida_fino: $('valida_fino').value || null,
        attiva: $('attiva').checked,
        in_evidenza: $('in_evidenza').checked,
        copertura_geografica: $('copertura_geografica').value.trim() || null,
        note: $('note').value.trim() || null
      };

      $('saveBtn').disabled = true; $('saveBtn').textContent='‚è≥ Salvataggio‚Ä¶';
      try{
        const id = $('convId').value;
        if(id){
          const { error } = await supabase.from('convenzioni').update(payload).eq('id', id);
          if(error) throw error;
        }else{
          const { error } = await supabase.from('convenzioni').insert([payload]);
          if(error) throw error;
        }
        $('formMsg').textContent='‚úÖ Salvato'; $('formMsg').className='text-green-600';
        setTimeout(()=>{ closeModal(); loadList(); }, 500);
      }catch(err){
        $('formMsg').textContent='‚ùå ' + (err?.message || 'Errore salvataggio'); $('formMsg').className='text-red-600';
      }finally{
        $('saveBtn').disabled = false; $('saveBtn').textContent='üíæ Salva';
      }
    }

    async function onDelete(){
      const id = $('convId').value;
      if(!id) return;
      if(!confirm('Eliminare definitivamente questa convenzione?')) return;
      $('formMsg').textContent='Eliminazione‚Ä¶';
      try{
        const { error } = await supabase.from('convenzioni').delete().eq('id', id);
        if(error) throw error;
        $('formMsg').textContent='‚úÖ Eliminata'; $('formMsg').className='text-green-600';
        setTimeout(()=>{ closeModal(); loadList(); }, 500);
      }catch(err){
        $('formMsg').textContent='‚ùå ' + (err?.message || 'Errore eliminazione'); $('formMsg').className='text-red-600';
      }
    }
  </script>
</body>
</html>
