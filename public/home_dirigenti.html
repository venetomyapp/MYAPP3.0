<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Area Riservata Dirigenti</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind (ok per test; in produzione builda con CLI/PostCSS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'inter': ['Inter', 'sans-serif'] },
          colors: {
            primary: '#1a1a2e',
            secondary: '#16213e',
            accent: '#0f3460',
            aurora: '#e94560',
            cyan: '#00d4ff',
            magenta: '#ff006e',
            gold: '#ffd700',
            teal: '#03dac6',
            dark: '#0a0a23',
            light: '#f8fafc',
            success: '#10b981'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
      --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
      --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
      --gradient-gold: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
      --gradient-teal: linear-gradient(135deg, #03dac6 0%, #00d4ff 100%);
    }

    * { font-family: 'Inter', sans-serif; }

    body {
      background: var(--gradient-aurora);
      background-size: 400% 400%;
      animation: aurora 15s ease infinite;
      min-height: 100vh;
    }

    @keyframes aurora {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fade-in { from {opacity:0; transform:translateY(30px)} to {opacity:1; transform:translateY(0)} }
    .fade-in { animation: fade-in .6s ease-out forwards; }

    .text-ultra-visible {
      color:#ffffff;
      text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1);
      font-weight:800;
    }
    .hero-title{ font-size: clamp(2.5rem, 8vw, 4.5rem); font-weight: 900; line-height: 1.1; }
    .section-title{ font-size: clamp(1.5rem, 5vw, 2.25rem); font-weight: 900; line-height: 1.2; }

    .glass-card{
      background:rgba(255,255,255,.95);
      backdrop-filter:blur(20px);
      border:2px solid rgba(255,215,0,.15);
      border-radius:24px;
      box-shadow:0 25px 50px rgba(0,0,0,.12);
      transition:all .4s cubic-bezier(.4,0,.2,1);
      position:relative; overflow:hidden;
    }
    .glass-card::before{
      content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(90deg, #ffd700, #e94560, #00d4ff, #03dac6);
    }
    .glass-card:hover{ transform:translateY(-8px); box-shadow:0 35px 70px rgba(0,0,0,.15); border-color:rgba(255,215,0,.25); }

    .admin-card{
      background:linear-gradient(145deg, rgba(255,215,0,.1), rgba(255,215,0,.05));
      backdrop-filter:blur(16px);
      border:2px solid rgba(255,215,0,.2);
      border-radius:20px; box-shadow:0 20px 40px rgba(255,215,0,.1);
      transition:all .3s ease; position:relative; overflow:hidden;
    }
    .admin-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gradient-gold); }

    .function-card{
      background:rgba(255,255,255,.2);
      backdrop-filter:blur(16px);
      border:3px solid rgba(255,255,255,.4);
      border-radius:18px; padding:1.5rem; transition:all .4s cubic-bezier(.4,0,.2,1);
      cursor:pointer; text-align:center; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center;
      box-shadow:0 8px 25px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.2), 0 0 0 1px rgba(255,215,0,.1);
      position:relative; text-decoration:none; color:inherit;
    }
    .function-card::before{
      content:''; position:absolute; inset:0; border-radius:15px; padding:2px;
      background:linear-gradient(135deg, rgba(255,215,0,.3), rgba(233,69,96,.3), rgba(0,212,255,.3));
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: xor; -webkit-mask-composite:xor; pointer-events:none;
    }
    .function-card:hover{
      background:rgba(255,255,255,.3);
      transform:translateY(-6px) scale(1.03);
      border-color:rgba(255,215,0,.6);
      box-shadow:0 25px 50px rgba(255,215,0,.2), inset 0 1px 0 rgba(255,255,255,.3), 0 0 0 2px rgba(255,215,0,.3);
    }

    .role-badge{ display:inline-block; padding:.25rem .75rem; border-radius:20px; font-size:.75rem; font-weight:700; margin:.125rem; }
    .role-badge.admin{ background:var(--gradient-gold); color:#1a1a2e; }
    .role-badge.dirigente{ background:var(--gradient-magic); color:#fff; }
    .role-badge.user{ background:linear-gradient(135deg,#6b7280,#4b5563); color:#fff; }

    .btn-aurora{ background:var(--gradient-magic); color:#fff; border:2px solid rgba(233,69,96,.3); transition:all .4s cubic-bezier(.4,0,.2,1); min-height:44px; font-weight:700; border-radius:12px; padding:.75rem 1.5rem; text-decoration:none; display:inline-block }
    .btn-aurora:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 15px 35px rgba(233,69,96,.4); border-color:rgba(233,69,96,.6); }
    .btn-secondary{ background:rgba(255,255,255,.9); color:#1a1a2e; border:2px solid rgba(255,255,255,.8); transition:.3s; min-height:44px; font-weight:700; border-radius:12px; padding:.75rem 1.5rem; text-decoration:none; display:inline-block }
    .btn-secondary:hover{ background:#fff; transform:translateY(-2px); box-shadow:0 10px 25px rgba(0,0,0,.15); }

    .user-row{ background:rgba(255,255,255,.95); border:1px solid rgba(255,215,0,.2); border-radius:12px; padding:1rem; margin-bottom:.75rem; transition:.3s }
    .user-row:hover{ background:#fff; border-color:rgba(255,215,0,.3); transform:translateY(-2px); box-shadow:0 8px 20px rgba(255,215,0,.1); }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); z-index:1000; }
    .modal.active{ display:flex; align-items:center; justify-content:center; }
    .modal-content{ background:rgba(255,255,255,.95); backdrop-filter:blur(20px); border-radius:20px; padding:2rem; max-width:520px; width:90%; max-height:85vh; overflow-y:auto; border:2px solid rgba(255,215,0,.2); box-shadow:0 25px 50px rgba(0,0,0,.25); }

    .spinner{ border:3px solid rgba(255,215,0,.3); border-radius:50%; border-top:3px solid #ffd700; width:24px; height:24px; animation:spin 1s linear infinite; display:inline-block; margin-right:.5rem }
    @keyframes spin{to{transform:rotate(360deg)}}

    .badge{display:inline-block;background:#0f172a;color:#fff;border-radius:999px;font-weight:800;font-size:.7rem;padding:.25rem .6rem}
  </style>
</head>
<body class="font-inter">

  <!-- Pulsante Home Utente -->
  <div class="absolute top-6 left-6 z-10">
    <a href="home.html" class="flex items-center gap-3 text-ultra-visible hover:text-gold transition-all duration-300 transform hover:scale-110 group" aria-label="Home utente">
      <svg class="w-8 h-8 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="text-lg font-bold">Home utente</span>
    </a>
  </div>

  <main class="min-h-screen px-4 py-8 max-w-6xl mx-auto">

    <!-- Hero -->
    <div class="text-center mb-12 fade-in">
      <div class="w-24 h-24 bg-gradient-to-br from-gold to-aurora rounded-full mx-auto mb-8 flex items-center justify-center shadow-2xl">
        <span class="text-4xl text-white">üèõÔ∏è</span>
      </div>
      <h1 class="hero-title text-ultra-visible mb-6">Area Riservata Dirigenti</h1>
      <p class="text-xl text-ultra-visible opacity-90 max-w-3xl mx-auto font-semibold">
        Accesso esclusivo alle funzioni direzionali e amministrative
      </p>
    </div>

    <!-- 1) Azioni Personali -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="azioni-title">
      <h2 id="azioni-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üß≠</span>Azioni Personali
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <a class="function-card" href="https://form.jotform.com/243226223182044" target="_blank" rel="noopener noreferrer" aria-label="Richiedi Rimborso">
          <div class="text-4xl mb-3">üí∞</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Richiedi Rimborso</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Compila il modulo per richieste di rimborso spese</p>
        </a>

        <a class="function-card" href="https://form.jotform.com/243262801203343" target="_blank" rel="noopener noreferrer" aria-label="Richiedi Permesso">
          <div class="text-4xl mb-3">üìù</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Richiedi Permesso</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Inoltra richiesta di permesso sindacale</p>
        </a>

        <a class="function-card" href="https://eu.jotform.com/tables/243226223182044" target="_blank" rel="noopener noreferrer" aria-label="Tabella Rendiconto">
          <div class="text-4xl mb-3">üìä</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Tabella Rendiconto</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Visualizza i dati di rendiconto</p>
        </a>

        <a class="function-card" href="https://eu.jotform.com/tables/243262801203343" target="_blank" rel="noopener noreferrer" aria-label="Tabella Permessi">
          <div class="text-4xl mb-3">üìÖ</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Tabella Permessi</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Gestisci permessi sindacali</p>
        </a>

        <a class="function-card" href="https://mega.nz/#fm/b3ojlZgY" target="_blank" rel="noopener noreferrer" aria-label="Accesso Cloud">
          <div class="text-4xl mb-3">‚òÅÔ∏è</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Accesso Cloud</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Repository documenti</p>
        </a>

        <a class="function-card" href="https://www.carabinierinsc.it/webmail/?_task=mail&_mbox=INBOX#" target="_blank" rel="noopener noreferrer" aria-label="Casella di Posta">
          <div class="text-4xl mb-3">üìß</div>
          <h4 class="font-bold text-ultra-visible text-lg mb-2">Casella di Posta</h4>
          <p class="text-ultra-visible opacity-80 text-sm">Accedi alla webmail</p>
        </a>
      </div>
    </section>

    <!-- 2) I Tuoi Dati dirigenziali -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="dati-title">
      <h2 id="dati-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">ü™™</span>I Tuoi Dati dirigenziali
      </h2>

      <div class="flex items-center justify-center gap-4 mb-4">
        <div class="w-16 h-16 bg-gradient-to-br from-gold to-aurora rounded-full flex items-center justify-center shadow-lg">
          <span class="text-2xl text-white" id="userIcon">üë§</span>
        </div>
        <div class="text-left">
          <h3 class="text-2xl font-bold text-primary" id="userName">Caricamento...</h3>
          <div id="userRoles" class="mt-2"></div>
          <p class="text-gray-600 font-semibold" id="userEmail">‚Äî</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-4">
        <span class="inline-flex items-center gap-2 badge bg-white px-3 py-1 rounded-full border">
          üìÖ Iscritto dal: <strong id="iscrittoDal" class="ml-1">‚Äî</strong>
        </span>
        <span class="inline-flex items-center gap-2 badge bg-white px-3 py-1 rounded-full border">
          üîê Accesso: <strong id="accessLevel" class="ml-1">Verificando privilegi...</strong>
        </span>
      </div>
    </section>

    <!-- 3) Panoramica di sistema -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="panoramica-title">
      <h2 id="panoramica-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üìà</span>Panoramica di sistema
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">üì∞</div>
          <div class="text-sm text-gray-500">News pubblicate</div>
          <div id="newsCount" class="text-3xl font-extrabold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">‚≠ê</div>
          <div class="text-sm text-gray-500">News in evidenza</div>
          <div id="featuredNewsCount" class="text-3xl font-extrabold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">üõ°Ô∏è</div>
          <div class="text-sm text-gray-500">Ruolo</div>
          <div id="rolesSummary" class="text-lg font-bold text-primary mt-1">‚Äî</div>
        </div>
        <div class="p-5 rounded-2xl border border-yellow-200/40 bg-white/90 shadow">
          <div class="text-2xl mb-2">‚öôÔ∏è</div>
          <div class="text-sm text-gray-500">Stato</div>
          <div class="text-lg font-bold text-success mt-1">Attivo</div>
        </div>
      </div>
    </section>

    <!-- 4) Area Amministrativa dirigenziale -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="area-admin-title">
      <h2 id="area-admin-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üèóÔ∏è</span>Area Amministrativa dirigenziale
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="areadirigenti.html" class="function-card" aria-label="Area Dirigenti">
          <div class="text-4xl mb-2">üß≠</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Area Dirigenti</div>
          <p class="text-ultra-visible opacity-80 text-sm">Vai all'area operativa per dirigenti</p>
        </a>

        <a href="gestione-convenzioni.html" class="function-card" aria-label="Gestione Convenzioni">
          <div class="text-4xl mb-2">üè∑Ô∏è</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Gestione Convenzioni</div>
          <p class="text-ultra-visible opacity-80 text-sm">Crea e gestisci partnership</p>
        </a>

        <a href="gestione-notizie.html" class="function-card" aria-label="Gestione Notizie">
          <div class="text-4xl mb-2">üì∞</div>
          <div class="font-bold text-ultra-visible text-lg mb-1">Gestione Notizie</div>
          <p class="text-ultra-visible opacity-80 text-sm">Pubblica e modifica comunicazioni</p>
        </a>
      </div>
    </section>

    <!-- 5) Ultime Notizie -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="ultime-notizie-title">
      <h2 id="ultime-notizie-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">üóûÔ∏è</span>Ultime Notizie
      </h2>

      <div id="latestNews" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <div id="newsEmptyState" class="hidden text-center py-10">
        <div class="text-5xl mb-4">ü™ß</div>
        <p class="text-gray-700 font-semibold">Nessuna notizia pubblicata al momento</p>
      </div>
    </section>

    <!-- 6) Convenzioni in evidenza -->
    <section class="glass-card p-6 md:p-8 mb-8 fade-in" aria-labelledby="conv-evidenza-title">
      <h2 id="conv-evidenza-title" class="section-title text-primary mb-8 text-center">
        <span class="mr-3 text-3xl">ü§ù</span>Convenzioni in evidenza
      </h2>

      <div id="featuredConvenzioni" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <div id="convEmptyState" class="text-center py-10">
        <div class="text-5xl mb-4">üîé</div>
        <p class="text-gray-700 font-semibold">Al momento non ci sono convenzioni in evidenza.</p>
        <p class="text-gray-500 mt-1">Gestiscile da <a class="text-aurora font-bold underline" href="gestione-convenzioni.html">Gestione Convenzioni</a>.</p>
      </div>
    </section>

    <!-- Sezione Admin (solo ADMIN) -->
    <div id="adminSection" class="admin-card p-6 md:p-8 mb-8 fade-in" style="display:none;">
      <h3 class="section-title text-ultra-visible mb-8 text-center">
        <span class="mr-3 text-3xl">üëë</span>
        Gestione Ruoli Utenti
        <span class="text-sm font-normal opacity-80 block mt-2">Solo Amministratori</span>
      </h3>

      <div class="mb-6 text-center">
        <button onclick="loadUsers()" class="btn-aurora" id="loadUsersBtn">
          <span class="mr-2">üîÑ</span> Carica Utenti
        </button>
      </div>

      <div id="usersContainer" class="max-h-96 overflow-y-auto"></div>
    </div>

    <!-- Supporto -->
    <div class="glass-card p-6 md:p-8 text-center fade-in">
      <h3 class="section-title text-primary mb-4">Supporto Tecnico</h3>
      <p class="text-gray-600 text-lg mb-6">Hai bisogno di assistenza con le funzioni dirigenziali?</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="mailto:support@aurora.app" class="btn-aurora">
          <span class="mr-2">üìß</span> Contatta Supporto
        </a>
        <a href="tel:+390000000000" class="btn-secondary">
          <span class="mr-2">üìû</span> Chiamata Urgente
        </a>
      </div>
    </div>

  </main>

  <!-- Modal Ruoli -->
  <div id="rolesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rolesModalTitle">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 id="rolesModalTitle" class="text-xl font-bold text-primary">Modifica Ruolo Utente</h3>
        <button onclick="closeRolesModal()" class="text-gray-500 hover:text-aurora text-3xl font-bold transition-colors" aria-label="Chiudi">&times;</button>
      </div>

      <div class="mb-6">
        <h4 class="font-bold text-primary mb-1" id="modalUserName">Nome Utente</h4>
        <p class="text-gray-600" id="modalUserEmail">email@example.com</p>
      </div>

      <form id="rolesForm" class="space-y-4">
        <input type="hidden" id="modalUserId">

        <div>
          <label class="block text-sm font-bold text-primary mb-2">Ruolo Corrente:</label>
          <div id="currentRole" class="role-badge user">USER</div>
        </div>

        <div>
          <label class="block text-sm font-bold text-primary mb-2">Seleziona Nuovo Ruolo:</label>
          <select id="newRole" class="w-full border rounded-xl px-3 py-2">
            <option value="USER">USER</option>
            <option value="DIRIGENTE">DIRIGENTE</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>

        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 btn-aurora" id="saveRolesBtn">
            <span class="mr-2">üíæ</span> Salva Modifiche
          </button>
          <button type="button" onclick="closeRolesModal()" class="flex-1 btn-secondary">
            <span class="mr-2">‚ùå</span> Annulla
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase + App -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === Supabase (tuo progetto) ===
    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk'
    );

    let currentUser = null;
    let userProfile = null;
    let allUsers = [];
    let editingUserId = null;

    // === Utils ===
    const fmtDate = (isoOrDate) => {
      try {
        if(!isoOrDate) return '‚Äî';
        const d = new Date(isoOrDate);
        if(isNaN(d)) return '‚Äî';
        return new Intl.DateTimeFormat('it-IT', { dateStyle:'long' }).format(d);
      } catch { return '‚Äî'; }
    };
    const escapeHTML = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const colors = {
        success: 'bg-gradient-to-r from-green-500 to-green-600',
        error: 'bg-gradient-to-r from-red-500 to-red-600',
        info: 'bg-gradient-to-r from-blue-500 to-blue-600'
      };
      notification.className = `fixed top-6 right-6 ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-transform duration-500 font-bold text-base backdrop-blur-md border border-white/20`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.remove('translate-x-full'), 100);
      setTimeout(() => { notification.classList.add('translate-x-full'); setTimeout(() => notification.remove(), 500); }, 4000);
    }

    // === Init ===
    async function init(){
      try{
        const { data:{ user } } = await supabase.auth.getUser();
        if(!user){ window.location.href='auth.html'; return; }
        currentUser = user;

        await loadUserProfile();    // nome, email, ruolo + guard
        await loadIscrittoDal();    // tessere.data_emissione
        await loadSystemOverview(); // counts
        await loadLatestNews();     // news pubblicate/non scadute (fallback)
        await loadFeaturedConvenzioni(); // convenzioni in evidenza (fallback)

      }catch(err){
        console.error('Init error', err);
        showNotification('‚ùå Errore inizializzazione', 'error');
      }
    }

    // === Profilo & Ruolo ===
    async function loadUserProfile(){
      try{
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('nome,cognome,email,role')
          .eq('user_id', currentUser.id)
          .single();

        userProfile = profile || { nome: currentUser.user_metadata?.nome || 'Utente', cognome: currentUser.user_metadata?.cognome || '', email: currentUser.email, role:'USER' };
        const fullName = `${userProfile?.nome||''} ${userProfile?.cognome||''}`.trim() || 'Dirigente';
        const role = (userProfile?.role || 'USER').toUpperCase();

        // Guard autorizzazione
        if(!['ADMIN','DIRIGENTE'].includes(role)){
          window.location.href = 'home.html';
          return;
        }

        // UI
        document.getElementById('userName').textContent = fullName;
        document.getElementById('userEmail').textContent = userProfile?.email || '‚Äî';
        document.getElementById('userIcon').textContent = role === 'ADMIN' ? 'üëë' : 'üéØ';

        const rolesContainer = document.getElementById('userRoles');
        const badgeClass = role === 'ADMIN' ? 'admin' : role === 'DIRIGENTE' ? 'dirigente' : 'user';
        const icon = role === 'ADMIN' ? 'üëë' : role === 'DIRIGENTE' ? 'üéØ' : 'üë§';
        rolesContainer.innerHTML = `<span class="role-badge ${badgeClass}">${icon} ${escapeHTML(role)}</span>`;

        document.getElementById('accessLevel').textContent = role === 'ADMIN' ? 'Accesso Amministratore Completo' : 'Accesso Dirigente Autorizzato';
        document.getElementById('rolesSummary').textContent = role;

        if(role === 'ADMIN'){
          document.getElementById('adminSection').style.display = 'block';
        }
      }catch(e){
        console.error('Errore profilo', e);
        showNotification('‚ùå Errore caricamento profilo', 'error');
      }
    }

    // === "Iscritto dal" (tessere) ===
    async function loadIscrittoDal(){
      try{
        const { data } = await supabase
          .from('tessere')
          .select('data_emissione')
          .eq('user_id', currentUser.id)
          .order('data_emissione', { ascending:true })
          .limit(1);
        const de = data && data[0]?.data_emissione;
        document.getElementById('iscrittoDal').textContent = de ? fmtDate(de) : 'Non disponibile';
      }catch(e){
        console.warn('tessere non disponibili', e?.message);
        document.getElementById('iscrittoDal').textContent = 'Non disponibile';
      }
    }

    // === Panoramica (news counts) ===
    async function loadSystemOverview(){
      try{
        const nowIso = new Date().toISOString();

        const { count: totalNews } = await supabase
          .from('news')
          .select('id', { count:'exact', head:true })
          .eq('pubblicata', true)
          .or('data_scadenza.is.null,data_scadenza.gt.' + nowIso);

        const { count: featuredCount } = await supabase
          .from('news')
          .select('id', { count:'exact', head:true })
          .eq('pubblicata', true)
          .eq('in_evidenza', true)
          .or('data_scadenza.is.null,data_scadenza.gt.' + nowIso);

        document.getElementById('newsCount').textContent = (typeof totalNews === 'number') ? totalNews : '‚Äî';
        document.getElementById('featuredNewsCount').textContent = (typeof featuredCount === 'number') ? featuredCount : '‚Äî';
      }catch(e){
        console.error('Panoramica error', e);
        document.getElementById('newsCount').textContent = '‚Äî';
        document.getElementById('featuredNewsCount').textContent = '‚Äî';
      }
    }

    // === Ultime Notizie ===
    async function loadLatestNews(){
      const wrap = document.getElementById('latestNews');
      const empty = document.getElementById('newsEmptyState');
      wrap.innerHTML = `
        <div class="col-span-full flex items-center justify-center py-8">
          <span class="spinner"></span><span class="font-semibold text-gray-600">Caricamento notizie‚Ä¶</span>
        </div>`;

      try{
        const nowIso = new Date().toISOString();

        // Preferisci pubblicate & non scadute
        let { data: news, error } = await supabase
          .from('news')
          .select('id,titolo,sottotitolo,immagine_url,categoria,data_pubblicazione,in_evidenza,pubblicata,url_articolo,created_at')
          .eq('pubblicata', true)
          .or('data_scadenza.is.null,data_scadenza.gt.' + nowIso)
          .order('in_evidenza', { ascending:false })
          .order('data_pubblicazione', { ascending:false })
          .limit(6);

        // Fallback: ultime create (anche se non pubblicate)
        if((!news || news.length===0) && !error){
          const r2 = await supabase
            .from('news')
            .select('id,titolo,sottotitolo,immagine_url,categoria,data_pubblicazione,in_evidenza,pubblicata,url_articolo,created_at')
            .order('created_at', { ascending:false })
            .limit(6);
          news = r2.data || [];
        }

        if(!news || news.length===0){
          wrap.innerHTML = ''; empty.classList.remove('hidden'); return;
        }
        empty.classList.add('hidden'); wrap.innerHTML = '';

        for(const n of news){
          const href = n.url_articolo ? n.url_articolo : 'gestione-notizie.html?id=' + encodeURIComponent(n.id);
          const target = n.url_articolo ? '_blank' : '_self';

          const article = document.createElement('article');
          article.className = 'rounded-2xl border border-yellow-200/40 bg-white/95 overflow-hidden shadow group';
          article.innerHTML = `
            <div class="relative h-40 bg-gray-100 overflow-hidden">
              ${n.immagine_url
                ? `<img src="${escapeHTML(n.immagine_url)}" alt="" class="w-full h-full object-cover group-hover:scale-[1.02] transition-transform duration-300">`
                : `<div class="w-full h-full flex items-center justify-center text-4xl">üì∞</div>`}
              <div class="absolute top-2 left-2"><span class="badge">${escapeHTML(n.categoria || 'GENERALE')}</span></div>
              ${n.in_evidenza ? `<div class="absolute top-2 right-2"><span class="badge">‚≠ê In evidenza</span></div>` : ``}
              ${n.pubblicata ? `` : `<div class="absolute bottom-2 right-2"><span class="badge">Bozza</span></div>`}
            </div>
            <div class="p-5">
              <h3 class="font-extrabold text-primary text-lg leading-snug mb-1">${escapeHTML(n.titolo)}</h3>
              ${n.sottotitolo ? `<p class="text-gray-600 text-sm mb-3">${escapeHTML(n.sottotitolo)}</p>` : ``}
              <div class="flex items-center justify-between text-xs text-gray-500">
                <span>${fmtDate(n.data_pubblicazione || n.created_at)}</span>
                <a href="${escapeHTML(href)}" target="${target}" class="text-aurora font-bold hover:underline">Apri</a>
              </div>
            </div>`;
          wrap.appendChild(article);
        }
      }catch(e){
        console.error('Errore caricamento news', e);
        wrap.innerHTML = `
          <div class="col-span-full text-center py-10">
            <div class="text-5xl mb-4">‚ö†Ô∏è</div>
            <p class="text-gray-700 font-semibold">Impossibile caricare le notizie</p>
            <p class="text-gray-500 text-sm">Riprova pi√π tardi</p>
          </div>`;
      }
    }

    // === Convenzioni in evidenza ===
    async function loadFeaturedConvenzioni(){
      const wrap = document.getElementById('featuredConvenzioni');
      const empty = document.getElementById('convEmptyState');

      try{
        // Priorit√†: in evidenza & attive
        let { data, error } = await supabase
          .from('convenzioni')
          .select('id,nome_azienda,descrizione,logo_url,immagine_url,link_esterno,in_evidenza,attiva,created_at')
          .eq('attiva', true)
          .eq('in_evidenza', true)
          .order('created_at', { ascending:false })
          .limit(6);

        // Fallback: solo attive
        if((!data || data.length===0) && !error){
          const r2 = await supabase
            .from('convenzioni')
            .select('id,nome_azienda,descrizione,logo_url,immagine_url,link_esterno,in_evidenza,attiva,created_at')
            .eq('attiva', true)
            .order('created_at', { ascending:false })
            .limit(6);
          data = r2.data || [];
        }

        if(!data || data.length===0){
          empty.classList.remove('hidden'); return;
        }

        empty.classList.add('hidden');
        wrap.innerHTML = '';

        for(const c of data){
          const a = document.createElement('a');
          a.className = 'function-card rounded-2xl border border-yellow-200/40 bg-white/95 overflow-hidden shadow';
          a.href = c.link_esterno || 'gestione-convenzioni.html';
          a.target = c.link_esterno ? '_blank' : '_self';
          a.rel = c.link_esterno ? 'noopener noreferrer' : '';
          const img = c.logo_url || c.immagine_url;

          a.innerHTML = `
            <div class="w-full h-28 bg-gray-50 flex items-center justify-center overflow-hidden rounded-xl mb-3">
              ${img ? `<img src="${escapeHTML(img)}" alt="" class="max-h-28 object-contain">` : `<div class="text-4xl">üè∑Ô∏è</div>`}
            </div>
            <div class="font-bold text-ultra-visible text-lg mb-1">${escapeHTML(c.nome_azienda || 'Convenzione')}</div>
            <p class="text-ultra-visible opacity-80 text-sm">${escapeHTML((c.descrizione || '').slice(0,120))}${(c.descrizione||'').length>120?'‚Ä¶':''}</p>
          `;
          wrap.appendChild(a);
        }
      }catch(e){
        console.warn('Errore convenzioni', e);
        empty.classList.remove('hidden');
      }
    }

    // === Admin: gestione ruoli (user_profiles.role) ===
    async function loadUsers(){
      const loadBtn = document.getElementById('loadUsersBtn');
      loadBtn.innerHTML = '<div class="spinner"></div>Caricamento...';
      loadBtn.disabled = true;

      try{
        const { data: users } = await supabase
          .from('user_profiles')
          .select('user_id,nome,cognome,email,role,created_at')
          .order('created_at', { ascending:false });

        allUsers = users || [];
        displayUsers();

        loadBtn.innerHTML = '<span class="mr-2">‚úÖ</span>Aggiorna Lista';
      }catch(e){
        console.error('Errore utenti', e);
        showNotification('‚ùå Errore nel caricamento degli utenti', 'error');
        loadBtn.innerHTML = '<span class="mr-2">‚ö†Ô∏è</span>Riprova';
      }finally{
        loadBtn.disabled = false;
      }
    }

    function displayUsers(){
      const container = document.getElementById('usersContainer');
      if(allUsers.length===0){
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="text-4xl mb-4">üë•</div>
            <p class="text-ultra-visible font-semibold">Nessun utente trovato</p>
          </div>`;
        return;
      }

      container.innerHTML = allUsers.map(u=>{
        const role = (u.role||'USER').toUpperCase();
        const badgeClass = role === 'ADMIN' ? 'admin' : role === 'DIRIGENTE' ? 'dirigente' : 'user';
        const icon = role === 'ADMIN' ? 'üëë' : role === 'DIRIGENTE' ? 'üéØ' : 'üë§';
        const name = `${u.nome||''} ${u.cognome||''}`.trim() || 'Senza nome';

        return `
          <div class="user-row">
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <div class="font-bold text-primary text-lg">${escapeHTML(name)}</div>
                <div class="text-gray-600 text-sm mb-2">${escapeHTML(u.email||'')}</div>
                <div class="flex flex-wrap gap-1"><span class="role-badge ${badgeClass}">${icon} ${escapeHTML(role)}</span></div>
              </div>
              <div class="ml-4">
                <button onclick="openRolesModal('${u.user_id}')" class="btn-aurora text-sm px-3 py-2">
                  <span class="mr-1">‚úèÔ∏è</span> Modifica
                </button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function openRolesModal(userId){
      const u = allUsers.find(x=>x.user_id===userId);
      if(!u) return;
      editingUserId = userId;

      const name = `${u.nome||''} ${u.cognome||''}`.trim() || 'Senza nome';
      document.getElementById('modalUserName').textContent = name;
      document.getElementById('modalUserEmail').textContent = u.email || '';
      document.getElementById('modalUserId').value = userId;

      const role = (u.role||'USER').toUpperCase();
      const badgeClass = role === 'ADMIN' ? 'admin' : role === 'DIRIGENTE' ? 'dirigente' : 'user';
      const icon = role === 'ADMIN' ? 'üëë' : role === 'DIRIGENTE' ? 'üéØ' : 'üë§';
      document.getElementById('currentRole').outerHTML = `<div id="currentRole" class="role-badge ${badgeClass}">${icon} ${escapeHTML(role)}</div>`;
      document.getElementById('newRole').value = role;

      document.getElementById('rolesModal').classList.add('active');
    }
    function closeRolesModal(){
      document.getElementById('rolesModal').classList.remove('active');
      editingUserId = null;
    }
    async function saveUserRole(e){
      e.preventDefault();
      if(!editingUserId) return;

      const saveBtn = document.getElementById('saveRolesBtn');
      saveBtn.innerHTML = '<div class="spinner"></div>Salvando...';
      saveBtn.disabled = true;

      try{
        const newRole = document.getElementById('newRole').value;
        const { error } = await supabase
          .from('user_profiles')
          .update({ role: newRole })
          .eq('user_id', editingUserId);
        if(error) throw error;

        showNotification('‚úÖ Ruolo aggiornato!', 'success');
        closeRolesModal();
        await loadUsers();
      }catch(e){
        console.error('Salvataggio ruolo', e);
        showNotification('‚ùå Errore nel salvataggio del ruolo', 'error');
      }finally{
        saveBtn.innerHTML = '<span class="mr-2">üíæ</span>Salva Modifiche';
        saveBtn.disabled = false;
      }
    }

    // Event listeners
    document.getElementById('rolesForm').addEventListener('submit', saveUserRole);
    document.addEventListener('click', (e)=>{ if(e.target.classList.contains('modal')) closeRolesModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeRolesModal(); });

    // Expose admin funcs
    window.loadUsers = loadUsers;
    window.openRolesModal = openRolesModal;
    window.closeRolesModal = closeRolesModal;

    // Go!
    init();
  </script>
</body>
</html>
