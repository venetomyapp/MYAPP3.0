<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>FileBox - MyApp</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

  <!-- iOS -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MyApp">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    /* ========== THEME ========== */
    :root{
      --primary:#1a1a2e; --secondary:#16213e; --accent:#0f3460; --aurora:#e94560;
      --cyan:#00d4ff; --magenta:#ff006e; --teal:#03dac6;
      --dark:#0a0a23; --light:#f8fafc; --muted:#64748b; --success:#00ea8d; --error:#ff4757;
      --bg-aurora: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --glass-bg: rgba(255,255,255,.95);
      --glass-strong: rgba(255,255,255,.12);
      --glass-border: 1px solid rgba(255,255,255,.18);
      --glass-shadow: 0 8px 32px rgba(31,38,135,.37);
      --radius: 16px; --radius-lg: 20px; --radius-xl: 24px;
      --space-1: 6px; --space-2: 10px; --space-3: 14px; --space-4: 18px; --space-5: 24px; --space-6: 32px;
      --container: min(1180px, 100% - 24px);
    }

    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      min-height:100vh; font-family:'Inter',system-ui,sans-serif; color:var(--primary);
      background:var(--bg-aurora); overflow-x:hidden; position:relative;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2; background:var(--bg-aurora);
      animation:aurora 20s ease-in-out infinite;
    }
    @keyframes aurora{
      0%,100%{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%)}
      25%{background:linear-gradient(135deg,#16213e 0%,#0f3460 25%,#e94560 50%,#00d4ff 75%,#1a1a2e 100%)}
      50%{background:linear-gradient(135deg,#0f3460 0%,#e94560 25%,#00d4ff 50%,#1a1a2e 75%,#16213e 100%)}
      75%{background:linear-gradient(135deg,#e94560 0%,#00d4ff 25%,#1a1a2e 50%,#16213e 75%,#0f3460 100%)}
    }
    .hidden{display:none !important}
    .text-ultra-visible{color:#fff;text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1);font-weight:800}

    /* ========== LAYOUT ========== */
    .container{width:var(--container); margin-inline:auto}
    .section{margin-block: var(--space-4)}
    .stack{display:flex; gap:var(--space-2); align-items:center}
    .pill-row{display:flex; gap:10px; overflow:auto; padding-bottom:6px; margin-top:12px;} /* <— spazio aumentato */
    @media (min-width:768px){ .pill-row{ margin-top:14px; } }                      /* <— spazio leggermente + su tablet/desktop */

    /* Header */
    header{position:relative; padding:14px 0}
    .brand{display:flex; gap:10px; align-items:center; justify-content:center}
    .brand-icon{width:40px; height:40px; border-radius:50%; background:linear-gradient(90deg,var(--cyan),var(--teal)); display:grid; place-items:center; color:#fff; font-size:20px}
    .brand-title{font-weight:900; font-size: clamp(18px,3vw,22px)}
    #backBtn{
      position:absolute; left:8px; top:50%; transform:translateY(-50%);
      color:#fff; padding:6px; border-radius:10px; transition:transform .15s ease, opacity .15s ease;
      opacity:.95;
    }
    #backBtn:hover{transform:translateY(-50%) scale(1.05); opacity:1}
    #backBtn svg{width:22px; height:22px}

    /* Cards / glass */
    .glass-card{
      background:var(--glass-bg); border:1px solid rgba(0,0,0,.06);
      border-radius: var(--radius-lg); box-shadow: var(--glass-shadow);
    }
    .glass-strong{
      background:var(--glass-strong); border:var(--glass-border);
      border-radius: var(--radius-xl); box-shadow: var(--glass-shadow);
    }

    /* Tabs */
    .tabs{display:flex; gap:10px; margin-bottom:16px; overflow:auto}
    .tab-btn{
      --bg: rgba(255,255,255,.15); --fg:#fff; --bd: rgba(255,255,255,.25);
      background:var(--bg); color:var(--fg); border:1px solid var(--bd);
      backdrop-filter: blur(10px); border-radius:999px; font-weight:800; font-size:13px;
      padding:8px 12px; display:inline-flex; align-items:center; gap:8px; cursor:pointer; white-space:nowrap;
      transition: transform .15s ease, background-color .2s ease, color .2s ease;
    }
    .tab-btn:hover{transform:translateY(-1px)}
    .tab-btn.active{--bg:#fff; --fg:var(--primary); --bd:#fff}

    /* Search + Filters block */
    .search-card{padding:12px}
    .searchbar{display:flex; align-items:center; gap:10px}
    .searchbar svg{width:18px; height:18px; color:var(--primary); flex:0 0 auto}
    .searchbar input{
      flex:1; border:none; outline:none; background:transparent;
      font-size:14px; color:var(--primary)
    }
    .category-filter{
      background:rgba(255,255,255,.9); color:var(--dark); border:1px solid rgba(0,0,0,.06);
      padding:8px 12px; border-radius:999px; font-weight:800; font-size:13px; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, background-color .15s ease, color .15s ease;
    }
    .category-filter:hover{transform:translateY(-1px)}
    .category-filter.active{
      background:linear-gradient(90deg,var(--aurora),var(--magenta)); color:#fff;
      box-shadow:0 8px 24px rgba(233,69,96,.25);
    }

    /* Stats */
    .stats{display:flex; gap:32px; justify-content:center}
    .stat{ text-align:center }
    .stat .value{ color:#fff; font-weight:900; font-size: clamp(22px,4vw,32px) }
    .stat .label{ color:var(--cyan); font-weight:800; font-size:12px }

    /* Grids */
    .grid-files,.grid-downloads,.grid-manage{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    /* Tiles */
    .file-tile,.download-tile{
      display:block; padding:14px; border-radius:18px; background:#fff; border:1px solid #eef1f4;
      box-shadow:0 6px 20px rgba(0,0,0,.06);
      transition:transform .15s ease, box-shadow .15s ease;
      text-decoration:none; color:inherit;
    }
    .file-tile:hover,.download-tile:hover{ transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,.12) }
    .tile-row{ display:flex; gap:12px; align-items:flex-start }
    .tile-ico{
      width:48px; height:48px; border-radius:14px;
      background:linear-gradient(90deg,var(--cyan),var(--teal));
      display:grid; place-items:center; font-size:22px; color:#fff; flex:0 0 auto;
    }
    .tile-title{ font-weight:800; color:var(--primary); font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .tile-meta{ font-size:12px; color:var(--muted); margin-top:4px }

    /* Empty states */
    .empty{ text-align:center; padding:48px 0 }
    .empty .ico{ width:84px; height:84px; display:grid; place-items:center; border-radius:50%;
      background:linear-gradient(90deg,#94a3b8,#cbd5e1); color:#0f172a; font-size:30px; margin-inline:auto  }
    .empty h3{ color:#fff; font-size: clamp(18px,3vw,24px); font-weight:900; margin: 10px 0 }
    .empty p{ color:var(--cyan); font-weight:600 }

    /* Viewer */
    #viewer{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; z-index:50 }
    #viewer.active{ display:block }
    .viewer-wrap{ position:absolute; inset:0; padding:12px; display:grid; place-items:center }
    .viewer-card{ width:min(100%,1100px); height: min(82vh, 820px); display:flex; flex-direction:column }
    .viewer-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid #e5e7eb; padding:10px 12px; border-top-left-radius:inherit; border-top-right-radius:inherit;
    }
    .viewer-file{ display:flex; gap:10px; align-items:center; min-width:0 }
    .viewer-file .ico{ width:36px; height:36px; border-radius:10px; background:linear-gradient(90deg,var(--cyan),var(--teal)); display:grid; place-items:center }
    .viewer-name{ font-weight:800; color:var(--primary); font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .viewer-meta{ color:var(--muted); font-size:12px }
    .viewer-body{ position:relative; flex:1; }
    .viewer-loading{ position:absolute; inset:0; display:grid; place-items:center }
    .spinner{ width:40px; height:40px; border-radius:50%; border:3px solid transparent; border-bottom-color:var(--aurora); animation:spin 1s linear infinite }
    @keyframes spin { to { transform:rotate(360deg) } }
    #viewerBody{ width:100%; height:100%; display:grid; place-items:center; }
    #viewerBody > *{ max-width:100%; max-height:100%; }
    #viewerBody img{ object-fit:contain }
    #viewerBody video{ width:100%; height:100%; object-fit:contain; background:#000; border-bottom-left-radius:inherit; border-bottom-right-radius:inherit }
    #viewerBody iframe{ width:100%; height:100%; border:0; border-bottom-left-radius:inherit; border-bottom-right-radius:inherit }

    /* Buttons */
    .btn{ border:0; border-radius:999px; padding:8px 12px; font-weight:800; font-size:13px; cursor:pointer }
    .btn-primary{ color:#fff; background:linear-gradient(90deg,var(--aurora),var(--magenta)) }
    .btn-ghost{ color:var(--primary); background:#f4f6f8 }
    .btn-success{ color:#fff; background:linear-gradient(90deg,var(--success),var(--teal)) }
    .badge{ display:inline-block; border-radius:999px; font-size:11px; padding:4px 8px; font-weight:800; color:#fff }
    .badge-green{ background:linear-gradient(90deg,var(--success),var(--teal)) }

    /* Utilities */
    .center{text-align:center}
    .muted{color:var(--muted)}
    .mt-8{margin-top:var(--space-6)}
    .mb-8{margin-bottom:var(--space-6)}
    .mb-4{margin-bottom:var(--space-3)}
    .p-12{padding:12px}
    .p-16{padding:16px}

    /* Responsive tweaks */
    @media (max-width: 640px){
      header{padding:12px 0}
      .viewer-card{height: 80vh}
      .tile-ico{width:44px;height:44px;font-size:20px}
      .tab-btn{font-size:12px;padding:7px 10px}
      #backBtn{left:6px}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="container">
      <button id="backBtn" aria-label="Indietro" class="text-ultra-visible">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="brand">
        <div class="brand-icon">📦</div>
        <h1 class="brand-title text-ultra-visible">FileBox</h1>
      </div>
    </div>
  </header>

  <!-- Loading overlay -->
  <div id="loading" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(26,26,46,.9); z-index:60">
    <div class="glass-card" style="padding:18px 22px; text-align:center">
      <div class="spinner" style="margin:0 auto 12px"></div>
      <p style="color:var(--aurora); font-weight:800">Caricamento…</p>
    </div>
  </div>

  <!-- Main -->
  <main class="container section">
    <!-- Tabs -->
    <div class="tabs">
      <button id="tabFiles" class="tab-btn active"><span>📁</span> File Cartella</button>
      <button id="tabDownloads" class="tab-btn"><span>💾</span> Download</button>
      <button id="tabManage" class="tab-btn hidden"><span>⚙️</span> Gestione</button>
    </div>

    <!-- Files Section -->
    <section id="filesSection">
      <div class="glass-strong p-16 mb-8 center">
        <h2 class="text-ultra-visible" style="font-size:clamp(18px,3vw,24px); font-weight:900; margin:0 0 6px">Documenti in cartella</h2>
        <p class="text-ultra-visible muted" style="margin:0 0 14px; font-size:14px">Visualizza e scarica i file senza uscire dalla pagina</p>

        <!-- Search + filters -->
        <div class="section">
          <div class="glass-card search-card">
            <div class="searchbar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
                <path d="M20 20l-3.5-3.5" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <input id="searchInput" type="text" placeholder="Cerca per nome o estensione..." maxlength="100" autocomplete="off">
            </div>
          </div>

          <div class="pill-row">
            <button class="filterBtn category-filter active" data-type="all">Tutti</button>
            <button class="filterBtn category-filter" data-type="doc">📄 Doc</button>
            <button class="filterBtn category-filter" data-type="img">🖼️ Img</button>
            <button class="filterBtn category-filter" data-type="vid">🎬 Video</button>
            <button class="filterBtn category-filter" data-type="aud">🎧 Audio</button>
          </div>
        </div>

        <!-- Stats -->
        <div class="stats">
          <div class="stat">
            <div id="statTot" class="value">--</div>
            <div class="label">File</div>
          </div>
          <div class="stat">
            <div id="statSize" class="value">--</div>
            <div class="label">Dimensione</div>
          </div>
        </div>
      </div>

      <!-- Files Grid -->
      <div id="filesContainer" class="grid-files">
        <!-- skeletons -->
        <div class="glass-card" style="height:96px; border-radius:18px"></div>
        <div class="glass-card" style="height:96px; border-radius:18px"></div>
        <div class="glass-card" style="height:96px; border-radius:18px"></div>
      </div>

      <!-- Empty -->
      <div id="emptyState" class="empty hidden">
        <div class="ico">🗂️</div>
        <h3 class="text-ultra-visible">Nessun file trovato</h3>
        <p>Prova a cambiare filtri o ricerca</p>
      </div>
    </section>

    <!-- Downloads Section -->
    <section id="downloadsSection" class="hidden">
      <div class="glass-strong p-16 mb-8 center">
        <div class="stack center" style="justify-content:center; margin-bottom:10px; font-size:22px">💾</div>
        <h2 class="text-ultra-visible" style="font-size:clamp(18px,3vw,24px); font-weight:900; margin:0 0 6px">Link Download</h2>
        <p class="text-ultra-visible muted" style="margin:0 0 14px; font-size:14px">Accedi ai link di download condivisi</p>
        <div class="stat">
          <div id="downloadCount" class="value">--</div>
          <div class="label">Link disponibili</div>
        </div>
      </div>

      <div id="downloadsContainer" class="grid-downloads">
        <div class="glass-card" style="height:120px; border-radius:18px"></div>
        <div class="glass-card" style="height:120px; border-radius:18px"></div>
        <div class="glass-card" style="height:120px; border-radius:18px"></div>
      </div>

      <div id="emptyDownloads" class="empty hidden">
        <div class="ico">📥</div>
        <h3 class="text-ultra-visible">Nessun link disponibile</h3>
        <p>I link di download verranno aggiunti dalla direzione</p>
      </div>
    </section>

    <!-- Management Section (solo se admin) -->
    <section id="manageSection" class="hidden">
      <div class="glass-strong p-16 mb-8 center">
        <div class="stack center" style="justify-content:center; margin-bottom:10px; font-size:22px">⚙️</div>
        <h2 class="text-ultra-visible" style="font-size:clamp(18px,3vw,24px); font-weight:900; margin:0 0 6px">Gestione Download</h2>
        <p class="text-ultra-visible muted" style="margin:0 0 14px; font-size:14px">Aggiungi, modifica ed elimina i link di download</p>
      </div>

      <div class="glass-card p-16 mb-8">
        <h3 class="stack" style="color:var(--primary); font-weight:800; font-size:16px; margin:0 0 14px">
          <span id="formIcon">➕</span><span id="formTitle">Aggiungi Nuovo Link</span>
        </h3>

        <form id="linkForm" class="form">
          <input type="hidden" id="editId" value="">
          <div class="grid-2" style="display:grid; gap:12px; grid-template-columns:1fr">
            <label class="field">
              <div class="label">Titolo *</div>
              <input type="text" id="linkTitolo" required maxlength="255" placeholder="es. Materiale Corso Base">
            </label>
            <label class="field">
              <div class="label">Descrizione</div>
              <textarea id="linkDescrizione" rows="3" maxlength="500" placeholder="Descrizione opzionale del contenuto..."></textarea>
            </label>
            <label class="field">
              <div class="label">URL *</div>
              <input type="url" id="linkUrl" required placeholder="https://mega.nz/file/...">
            </label>
          </div>

          <div class="grid-2" style="display:grid; gap:12px; grid-template-columns:1fr 1fr; margin-top:12px">
            <label class="field">
              <div class="label">Tipo Transfer</div>
              <select id="linkTipo">
                <option value="Download">Download</option>
                <option value="MEGA">MEGA</option>
                <option value="Google Drive">Google Drive</option>
                <option value="WeTransfer">WeTransfer</option>
                <option value="Dropbox">Dropbox</option>
                <option value="OneDrive">OneDrive</option>
                <option value="MediaFire">MediaFire</option>
                <option value="GitHub">GitHub</option>
              </select>
            </label>
            <label class="field">
              <div class="label">Ordine</div>
              <input type="number" id="linkOrder" min="0" max="999" value="0">
            </label>
          </div>

          <label class="stack" style="margin-top:10px; align-items:center">
            <input type="checkbox" id="linkAttivo" checked>
            <span style="font-weight:600; color:var(--primary); font-size:14px">Link attivo</span>
          </label>

          <div class="stack" style="gap:10px; margin-top:16px; flex-wrap:wrap">
            <button type="submit" id="submitBtn" class="btn btn-primary">Salva Link</button>
            <button type="button" id="cancelBtn" class="btn btn-ghost hidden">Annulla</button>
          </div>
        </form>
      </div>

      <div class="stack" style="justify-content:space-between; margin-bottom:12px">
        <h3 class="text-ultra-visible" style="font-size:18px">Link Esistenti</h3>
        <button id="refreshLinks" class="btn btn-success">🔄 Aggiorna</button>
      </div>

      <div id="manageContainer" class="grid-manage"></div>

      <div id="emptyManage" class="empty hidden">
        <div class="ico">📝</div>
        <h3 class="text-ultra-visible">Nessun link configurato</h3>
        <p>Aggiungi il primo link usando il form sopra</p>
      </div>
    </section>
  </main>

  <!-- Modal Viewer -->
  <div id="viewer">
    <div class="viewer-wrap">
      <div class="glass-card viewer-card">
        <div class="viewer-head">
          <div class="viewer-file">
            <div class="ico">📄</div>
            <div style="min-width:0">
              <div id="viewerName" class="viewer-name"></div>
              <div id="viewerMeta" class="viewer-meta"></div>
            </div>
          </div>
          <div class="stack" style="flex-wrap:wrap">
            <a id="downloadBtn" class="btn btn-primary" download>Scarica</a>
            <button id="closeViewer" class="btn btn-ghost">Chiudi</button>
          </div>
        </div>
        <div class="viewer-body">
          <div id="viewerLoading" class="viewer-loading">
            <div class="spinner"></div>
          </div>
          <div id="viewerBody" class="hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Form elements */
    .field .label{font-weight:700; color:var(--primary); font-size:13px; margin-bottom:6px}
    .field input,.field textarea,.field select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #dfe3e8; outline:none;
      font-size:14px; color:var(--primary); background:#fff; transition:border-color .15s ease, box-shadow .15s ease
    }
    .field textarea{resize:vertical}
    .field input:focus,.field textarea:focus,.field select:focus{border-color:var(--aurora); box-shadow:0 0 0 3px rgba(233,69,96,.15)}
  </style>

  <!-- Scripts -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { File as MegaFile } from 'https://unpkg.com/megajs/dist/main.browser-es.mjs';

    // === CONFIG ===
    const MEGA_FOLDER_URL = 'https://mega.nz/folder/figRhbTT#dw0ZS1lb6sv8l-CHVfNSTA';
    const PREVIEW_SIZE_LIMIT = 100 * 1024 * 1024; // 100MB

    // Supabase
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // === UTILS ===
    const $  = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const show = el => el && el.classList.remove('hidden');
    const hide = el => el && el.classList.add('hidden');
    const humanSize = b => {
      if (!Number.isFinite(b)) return '--';
      const u = ['B','KB','MB','GB','TB']; let i=0;
      while(b>=1024 && i<u.length-1){ b/=1024; i++; }
      return `${b.toFixed( b<10&&i>0 ? 1 : 0)} ${u[i]}`;
    };

    // === STATE ===
    let currentUser = null;
    let allFiles = [];
    let downloadLinks = [];
    let lastObjectURL = null;
    let activeTab = 'files';
    let isAdmin = false;
    let editingLinkId = null;

    const EXT_MAP = {
      doc: ['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','odt','ods','csv'],
      img: ['jpg','jpeg','png','gif','webp','svg'],
      vid: ['mp4','webm','mkv','mov','avi','m4v'],
      aud: ['mp3','wav','ogg','m4a','flac']
    };
    const detectType = (ext) => {
      ext = ext.toLowerCase();
      if (EXT_MAP.img.includes(ext)) return 'img';
      if (EXT_MAP.vid.includes(ext)) return 'vid';
      if (EXT_MAP.aud.includes(ext)) return 'aud';
      if (EXT_MAP.doc.includes(ext)) return 'doc';
      return 'other';
    };
    const mimeFromExt = (ext) => {
      ext = ext.toLowerCase();
      const map = {
        pdf:'application/pdf', txt:'text/plain', csv:'text/csv',
        jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', gif:'image/gif', webp:'image/webp', svg:'image/svg+xml',
        mp4:'video/mp4', webm:'video/webm', mkv:'video/webm', mov:'video/quicktime', avi:'video/x-msvideo', m4v:'video/mp4',
        mp3:'audio/mpeg', wav:'audio/wav', ogg:'audio/ogg', m4a:'audio/mp4', flac:'audio/flac',
        doc:'application/msword', docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        xls:'application/vnd.ms-excel', xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        ppt:'application/vnd.ms-powerpoint', pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        odt:'application/vnd.oasis.opendocument.text', ods:'application/vnd.oasis.opendocument.spreadsheet'
      };
      return map[ext] || 'application/octet-stream';
    };

    const getTransferIcon = (url) => {
      const urlLower = url.toLowerCase();
      if (urlLower.includes('mega.nz') || urlLower.includes('mega.co')) return '☁️';
      if (urlLower.includes('drive.google.com') || urlLower.includes('docs.google.com')) return '📁';
      if (urlLower.includes('wetransfer.com')) return '📤';
      if (urlLower.includes('dropbox.com')) return '📦';
      if (urlLower.includes('onedrive') || urlLower.includes('sharepoint')) return '📋';
      if (urlLower.includes('mediafire.com')) return '🔥';
      if (urlLower.includes('github.com')) return '🐙';
      return '🔗';
    };

    // === AUTH & ROLE ===
    const PROFILES_TABLE = 'user_profiles';

    async function checkAuth(){
      try{
        const { data:{ user } } = await supabase.auth.getUser();
        currentUser = user || null;
        if (user) await checkAdminPrivileges();
      }catch(e){ /* ignore */ }
    }
    async function checkAdminPrivileges(){
      try{
        const meta = currentUser?.user_metadata || {};
        const metaRole = String(meta.role || meta.ruolo || meta.profilo || '').toUpperCase();

        let dbRole = ''; let dbStato = '';
        if (currentUser?.id) {
          const { data, error } = await supabase
            .from(PROFILES_TABLE).select('role, stato').eq('user_id', currentUser.id).limit(1).maybeSingle();
          if (!error && data) { dbRole = String(data.role||'').toUpperCase(); dbStato = String(data.stato||'').toUpperCase(); }
        }
        const effRole  = (dbRole || metaRole || 'USER').toUpperCase();
        const effStato = (dbStato || 'ATTIVO').toUpperCase();
        isAdmin = (effStato === 'ATTIVO') && (effRole === 'ADMIN' || effRole === 'DIRIGENTE');
      } finally {
        $('#tabManage')?.classList.toggle('hidden', !isAdmin);
      }
    }
    async function resolveHomePath(){
      let target = 'home.html';
      try{
        if (!currentUser) return target;
        const meta = currentUser.user_metadata || {};
        const metaRole = String(meta.role || meta.ruolo || meta.profilo || '').toUpperCase();
        if (metaRole === 'DIRIGENTE') return 'home_dirigenti.html';
        const { data, error } = await supabase.from(PROFILES_TABLE).select('role').eq('user_id', currentUser.id).limit(1).maybeSingle();
        if (!error && data) { const role = String(data.role||'').toUpperCase(); if (role === 'DIRIGENTE') target='home_dirigenti.html'; }
      }catch(e){}
      return target;
    }

    // === Tabs ===
    function switchTab(tab) {
      activeTab = tab;
      $$('.tab-btn').forEach(b=>b.classList.remove('active'));
      hide($('#filesSection')); hide($('#downloadsSection')); hide($('#manageSection'));
      if (tab==='files'){ $('#tabFiles')?.classList.add('active'); show($('#filesSection')); }
      if (tab==='downloads'){ $('#tabDownloads')?.classList.add('active'); show($('#downloadsSection')); }
      if (tab==='manage'){ $('#tabManage')?.classList.add('active'); show($('#manageSection')); }
    }
    $('#tabFiles')?.addEventListener('click', ()=>switchTab('files'));
    $('#tabDownloads')?.addEventListener('click', ()=>switchTab('downloads'));
    $('#tabManage')?.addEventListener('click', ()=>switchTab('manage'));
    $('#backBtn')?.addEventListener('click', async ()=>{ window.location.href = await resolveHomePath(); });

    // === MEGA ===
    async function loadMega(){
      show($('#loading'));
      try{
        const folder = MegaFile.fromURL(MEGA_FOLDER_URL);
        await new Promise((res, rej)=> folder.loadAttributes(err => err ? rej(err) : res()));
        const flatten = async (node) => {
          if (!node) return []; if (!node.directory) return [node];
          const ch = node.children || []; const out=[]; for (const c of ch) out.push(...await flatten(c)); return out;
        };
        const files = (await flatten(folder)).filter(f => !f.directory);
        allFiles = files.map(f=>{
          const name = f.name || 'file';
          const ext = (name.split('.').pop() || '').toLowerCase();
          const type = detectType(ext);
          const size = Number.isFinite(f.size) ? f.size : NaN;
          return { name, ext, size, type, megaFile: f };
        });
        renderFiles(); updateStats();
      }catch(err){
        console.error('Errore MEGA:', err);
        $('#filesContainer').innerHTML = `
          <div class="glass-card" style="grid-column:1/-1; padding:16px">
            <p style="color:var(--error); font-weight:800">Impossibile leggere la cartella MEGA.</p>
            <p class="muted" style="font-size:14px">Controlla che il link sia pubblico e riprova.</p>
          </div>`;
      }finally{ hide($('#loading')); }
    }

    // === Download links ===
    async function loadDownloadLinks(){
      try{
        const { data, error } = await supabase.from('download_links')
          .select('*').eq('attivo', true).order('order_index', { ascending:true });
        if (error) throw error;
        downloadLinks = data || [];
        renderDownloads();
        updateDownloadStats();   // <— AGGIUNTO
        if (isAdmin) await loadAllLinksForManagement();
      }catch(err){
        console.error('Errore download links:', err);
        $('#downloadsContainer').innerHTML = `
          <div class="glass-card" style="grid-column:1/-1; padding:16px">
            <p style="color:var(--error); font-weight:800">Errore nel caricamento dei link.</p>
            <p class="muted" style="font-size:14px">Riprova più tardi o contatta l'amministratore.</p>
          </div>`;
      }
    }
    async function loadAllLinksForManagement(){
      if (!isAdmin) return;
      try{
        const { data, error } = await supabase.from('download_links').select('*').order('order_index',{ascending:true});
        if (error) throw error;
        renderManagementLinks(data || []);
      }catch(err){
        console.error('Errore gestione:', err);
        $('#manageContainer').innerHTML = `
          <div class="glass-card" style="grid-column:1/-1; padding:16px">
            <p style="color:var(--error); font-weight:800">Errore nel caricamento della gestione.</p>
          </div>`;
      }
    }

    // Aggiorna il contatore dei link download  <— AGGIUNTO
    function updateDownloadStats(){
      const el = document.querySelector('#downloadCount');
      if (el) el.textContent = (Array.isArray(downloadLinks) ? downloadLinks.length : 0) || '--';
    }

    async function saveLink(){
      if (!isAdmin) return;
      const titolo = $('#linkTitolo')?.value.trim();
      const descrizione = $('#linkDescrizione')?.value.trim() || '';
      const url = $('#linkUrl')?.value.trim();
      const tipo = $('#linkTipo')?.value || 'Download';
      const orderIndex = parseInt($('#linkOrder')?.value) || 0;
      const attivo = $('#linkAttivo')?.checked ?? true;
      if (!titolo || !url){ alert('Titolo e URL sono obbligatori'); return; }
      try{
        const payload = { titolo, descrizione: descrizione || null, url, tipo_transfer: tipo, order_index: orderIndex, attivo, updated_at:new Date().toISOString() };
        let result;
        if (editingLinkId){ result = await supabase.from('download_links').update(payload).eq('id', editingLinkId); }
        else { payload.created_at=new Date().toISOString(); result = await supabase.from('download_links').insert([payload]); }
        if (result.error) throw result.error;
        resetForm(); await loadDownloadLinks(); alert(editingLinkId ? 'Link aggiornato!' : 'Link aggiunto!');
      }catch(e){ console.error(e); alert('Errore salvataggio: ' + (e.message||'Sconosciuto')); }
    }
    async function deleteLink(id){
      if (!isAdmin || !confirm('Eliminare questo link?')) return;
      try{ const { error } = await supabase.from('download_links').delete().eq('id', id);
        if (error) throw error; await loadDownloadLinks(); alert('Link eliminato!'); }
      catch(e){ console.error(e); alert('Errore eliminazione: ' + (e.message||'Sconosciuto')); }
    }
    function editLink(link){
      if (!isAdmin) return;
      editingLinkId = link.id;
      $('#linkTitolo').value = link.titolo || '';
      $('#linkDescrizione').value = link.descrizione || '';
      $('#linkUrl').value = link.url || '';
      $('#linkTipo').value = link.tipo_transfer || 'Download';
      $('#linkOrder').value = link.order_index || 0;
      $('#linkAttivo').checked = link.attivo !== false;
      $('#formIcon').textContent = '✏️';
      $('#formTitle').textContent = 'Modifica Link';
      $('#submitBtn').textContent = 'Aggiorna Link';
      show($('#cancelBtn'));
      $('#linkForm').scrollIntoView({behavior:'smooth',block:'start'});
    }
    function resetForm(){
      editingLinkId = null;
      $('#linkForm').reset();
      $('#linkAttivo').checked = true;
      $('#linkOrder').value = 0;
      $('#formIcon').textContent = '➕';
      $('#formTitle').textContent = 'Aggiungi Nuovo Link';
      $('#submitBtn').textContent = 'Salva Link';
      hide($('#cancelBtn'));
    }

    // === Renderers ===
    function renderFiles(){
      const q = ($('#searchInput')?.value || '').trim().toLowerCase();
      const activeType = $$('.filterBtn').find(b=>b.classList.contains('active'))?.dataset.type || 'all';
      const filtered = allFiles.filter(f=>{
        const matchText = !q || f.name.toLowerCase().includes(q) || f.ext.includes(q);
        const matchType = activeType==='all' || f.type===activeType;
        return matchText && matchType;
      });
      const container = $('#filesContainer'); const empty = $('#emptyState');
      if (!filtered.length){ container.innerHTML=''; show(empty); return; }
      hide(empty);
      const iconFor = t => ({doc:'📄',img:'🖼️',vid:'🎬',aud:'🎧',other:'📦'}[t] || '📦');
      container.innerHTML = filtered.map(f=>`
        <button class="file-tile" data-name="${encodeURIComponent(f.name)}" aria-label="Apri ${f.name}">
          <div class="tile-row">
            <div class="tile-ico">${iconFor(f.type)}</div>
            <div style="min-width:0; flex:1">
              <div class="tile-title" title="${f.name}">${f.name}</div>
              <div class="tile-meta">${f.ext.toUpperCase()} • ${humanSize(f.size)}</div>
            </div>
          </div>
        </button>`).join('');
      $$('#filesContainer .file-tile').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = decodeURIComponent(btn.dataset.name);
          const fileObj = allFiles.find(x=>x.name===name);
          if (fileObj) openViewer(fileObj);
        });
      });
    }

    function renderDownloads(){
      const container = $('#downloadsContainer'); const empty = $('#emptyDownloads');
      if (!downloadLinks.length){ container.innerHTML=''; show(empty); return; }
      hide(empty);
      container.innerHTML = downloadLinks.map(link=>`
        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="download-tile">
          <div class="tile-row">
            <div class="tile-ico">🔗</div>
            <div style="min-width:0; flex:1">
              <div class="tile-title" title="${link.titolo}">${link.titolo}</div>
              ${link.descrizione ? `<div class="tile-meta" title="${link.descrizione}">${link.descrizione}</div>` : ''}
              <div class="tile-meta" style="display:flex; justify-content:space-between; align-items:center; margin-top:6px">
                <span style="color:var(--cyan); font-weight:700; font-size:12px">Clicca per scaricare</span>
                <span class="badge badge-green">${link.tipo_transfer || 'Download'}</span>
              </div>
            </div>
          </div>
        </a>`).join('');
    }

    function updateStats(){
      const total = allFiles.length;
      const sizeSum = allFiles.reduce((a,b)=> a + (Number.isFinite(b.size)? b.size : 0), 0);
      $('#statTot').textContent = total || '--';
      $('#statSize').textContent = total ? humanSize(sizeSum) : '--';
    }
    function renderManagementLinks(links){
      if (!isAdmin) return;
      const container = $('#manageContainer'); const empty = $('#emptyManage');
      if (!links.length){ container.innerHTML=''; show(empty); return; }
      hide(empty);
      container.innerHTML = links.map(link=>`
        <div class="file-tile">
          <div class="tile-row">
            <div class="tile-ico">🔗</div>
            <div style="min-width:0; flex:1">
              <div class="tile-title" title="${link.titolo}">${link.titolo}</div>
              ${link.descrizione ? `<div class="tile-meta" title="${link.descrizione}">${link.descrizione}</div>` : ''}
              <div class="tile-meta" style="display:flex; gap:16px; align-items:center; margin-top:6px">
                <span style="color:var(--cyan); font-weight:700">${link.tipo_transfer || 'Download'}</span>
                <span style="color:${link.attivo ? 'var(--success)' : 'var(--error)'}; font-weight:700">${link.attivo ? '✅ Attivo' : '❌ Disattivo'}</span>
                <span class="muted">Ord: ${link.order_index || 0}</span>
              </div>
              <div class="stack" style="gap:8px; margin-top:10px; flex-wrap:wrap">
                <button class="btn btn-success editLinkBtn" data-link='${JSON.stringify(link).replace(/'/g, "&apos;")}'>✏️ Modifica</button>
                <button class="btn btn-primary deleteLinkBtn" data-id="${link.id}">🗑️ Elimina</button>
                <a class="btn btn-ghost" href="${link.url}" target="_blank" rel="noopener noreferrer">🔗 Testa</a>
              </div>
            </div>
          </div>
        </div>`).join('');
      $$('.editLinkBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const linkData = JSON.parse(btn.dataset.link.replace(/&apos;/g, "'"));
          editLink(linkData);
        });
      });
      $$('.deleteLinkBtn').forEach(btn=>{
        btn.addEventListener('click', ()=> deleteLink(parseInt(btn.dataset.id)) );
      });
    }

    // === Viewer ===
    async function openViewer(file){
      const viewer = $('#viewer'), viewerBody = $('#viewerBody'),
            viewerLoading = $('#viewerLoading'), viewerName = $('#viewerName'), viewerMeta = $('#viewerMeta');
      viewer.classList.add('active'); hide(viewerBody); show(viewerLoading);
      viewerName.textContent = file.name; viewerMeta.textContent = `${file.ext.toUpperCase()} • ${humanSize(file.size)}`;
      viewerBody.innerHTML = '';
      if (lastObjectURL){ try{ URL.revokeObjectURL(lastObjectURL); }catch{} lastObjectURL=null; }

      try{
        if (Number.isFinite(file.size) && file.size > PREVIEW_SIZE_LIMIT){
          viewerBody.innerHTML = `<div class="muted" style="text-align:center; padding:20px">
            <p style="font-weight:700; color:var(--primary)">Anteprima disattivata per file di grandi dimensioni.</p>
            <p>Usa "Scarica" per aprirlo in locale.</p></div>`;
          const streamUrl = await ensureDownloadURL(file);
          const btn = $('#downloadBtn'); btn.removeAttribute('download'); btn.href = streamUrl;
        } else {
          const data = await new Promise((res, rej)=> file.megaFile.download((err, bytes)=> err ? rej(err) : res(bytes)));
          const blob = new Blob([data], { type: mimeFromExt(file.ext) });
          const url = URL.createObjectURL(blob); lastObjectURL = url;
          const btn = $('#downloadBtn'); btn.href = url; btn.setAttribute('download', file.name);
          if (file.type==='img'){
            viewerBody.innerHTML = `<img src="${url}" alt="${file.name}">`;
          } else if (file.type==='vid'){
            viewerBody.innerHTML = `<video src="${url}" controls></video>`;
          } else if (file.type==='aud'){
            viewerBody.innerHTML = `<div style="width:100%; display:grid; place-items:center; padding:16px; background:#f1f5f9"><audio src="${url}" controls style="width:min(720px,100%)"></audio></div>`;
          } else if (file.ext==='pdf'){
            viewerBody.innerHTML = `<iframe src="${url}" title="${file.name}" referrerpolicy="no-referrer"></iframe>`;
          } else {
            viewerBody.innerHTML = `<div class="muted" style="text-align:center; padding:20px">
              <p style="font-weight:700; color:var(--primary)">Anteprima non disponibile per questo formato.</p>
              <p>Clicca su "Scarica" per aprire il file.</p></div>`;
          }
        }
      }catch(e){
        console.error('Preview error:', e);
        viewerBody.innerHTML = `<div class="muted" style="text-align:center; padding:20px">
          <p style="font-weight:700; color:var(--error)">Impossibile caricare l'anteprima.</p>
          <p>Prova a scaricare il file.</p></div>`;
        try{
          const streamUrl = await ensureDownloadURL(file);
          const btn = $('#downloadBtn'); btn.removeAttribute('download'); btn.href = streamUrl;
        }catch{}
      }finally{ hide(viewerLoading); show(viewerBody); }
    }
    async function ensureDownloadURL(file){
      return await new Promise((resolve,reject)=>{
        try{ file.megaFile.link((err,url)=> err||!url ? reject(err||new Error('No URL')) : resolve(url) ); }
        catch(e){ reject(e); }
      });
    }
    $('#closeViewer')?.addEventListener('click', ()=>{
      try{ $('#viewerBody video')?.pause(); $('#viewerBody audio')?.pause(); }catch{}
      $('#viewerBody').innerHTML=''; $('#viewer').classList.remove('active');
      if (lastObjectURL){ try{ URL.revokeObjectURL(lastObjectURL); }catch{} lastObjectURL=null; }
    });

    // === Events ===
    $$('.filterBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.filterBtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); renderFiles();
      });
    });
    let searchTimeout; $('#searchInput')?.addEventListener('input', ()=>{
      clearTimeout(searchTimeout); searchTimeout = setTimeout(renderFiles, 250);
    });
    $('#linkForm')?.addEventListener('submit', e=>{ e.preventDefault(); if (isAdmin) saveLink(); });
    $('#cancelBtn')?.addEventListener('click', resetForm);
    $('#refreshLinks')?.addEventListener('click', async ()=>{
      if (isAdmin){ show($('#loading')); await loadDownloadLinks(); hide($('#loading')); }
    });

    // === Init ===
    (async ()=>{
      await checkAuth();
      await Promise.all([loadMega(), loadDownloadLinks()]);
    })();

    // Cleanup
    window.addEventListener('beforeunload', ()=>{ if (lastObjectURL){ try{ URL.revokeObjectURL(lastObjectURL); }catch{} }});
  </script>
</body>
</html>
