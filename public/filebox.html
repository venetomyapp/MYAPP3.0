<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>FileBox - MyApp</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

  <!-- PWA generica + iOS -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MyApp">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:'#1a1a2e', secondary:'#16213e', accent:'#0f3460', aurora:'#e94560',
            cyan:'#00d4ff', magenta:'#ff006e', gold:'#ffd700', teal:'#03dac6',
            dark:'#0a0a23', light:'#f8fafc', muted:'#64748b', success:'#00ea8d',
            warning:'#ffb800', error:'#ff4757',
          },
          fontFamily:{ sans:['Inter','system-ui','sans-serif'] },
          screens:{ xs:'320px', sm:'640px', md:'768px', lg:'1024px', xl:'1280px', '2xl':'1536px' },
          fontSize:{
            'fluid-xs':'clamp(.75rem,2vw,.875rem)','fluid-sm':'clamp(.875rem,2.5vw,1rem)',
            'fluid-base':'clamp(1rem,2.5vw,1.125rem)','fluid-lg':'clamp(1.125rem,3vw,1.25rem)',
            'fluid-xl':'clamp(1.25rem,3.5vw,1.5rem)','fluid-2xl':'clamp(1.5rem,4vw,2rem)',
            'fluid-3xl':'clamp(1.875rem,5vw,2.5rem)','fluid-4xl':'clamp(2.25rem,6vw,3rem)'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --gradient-aurora: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-magic: linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
      --gradient-ocean: linear-gradient(135deg,#16213e 0%,#0f3460 50%,#00d4ff 100%);
      --shadow-glass: 0 8px 32px 0 rgba(31,38,135,.37);
      --border-glass: 1px solid rgba(255,255,255,.18);
    }
    *{scroll-behavior:smooth}
    body{background:var(--gradient-aurora); min-height:100vh; font-family:'Inter',system-ui,sans-serif; overflow-x:hidden; position:relative;}
    body::before{content:''; position:fixed; inset:0; background:var(--gradient-aurora); animation:aurora 20s ease-in-out infinite; z-index:-2;}
    @keyframes aurora{
      0%,100%{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%)}
      25%{background:linear-gradient(135deg,#16213e 0%,#0f3460 25%,#e94560 50%,#00d4ff 75%,#1a1a2e 100%)}
      50%{background:linear-gradient(135deg,#0f3460 0%,#e94560 25%,#00d4ff 50%,#1a1a2e 75%,#16213e 100%)}
      75%{background:linear-gradient(135deg,#e94560 0%,#00d4ff 25%,#1a1a2e 50%,#16213e 75%,#0f3460 100%)}
    }
    .glass-card{ background:rgba(255,255,255,.95); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,.2); box-shadow:var(--shadow-glass); }
    .glass-strong{ background:rgba(255,255,255,.12); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:var(--border-glass); box-shadow:var(--shadow-glass); }
    .text-ultra-visible{ color:#fff; text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1); font-weight:800;}
    .file-tile, .download-tile{ transition:transform .2s ease, box-shadow .2s ease }
    .file-tile:hover, .download-tile:hover{ transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,.15);}
    .fade-in{ animation:fadeIn .6s ease-out both; opacity:0 }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    .loading-skeleton{ background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%); background-size:200% 100%; animation:loading 1.5s infinite; border-radius:12px; }
    @keyframes loading{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .category-filter{ background:rgba(255,255,255,.85); color:#0a0a23; border:1px solid rgba(0,0,0,.06); }
    .category-filter.active{ background:linear-gradient(90deg,#e94560,#ff006e); color:#fff; box-shadow:0 8px 24px rgba(233,69,96,.25); }
    .tab-btn{ background:rgba(255,255,255,.15); color:#fff; border:1px solid rgba(255,255,255,.2); backdrop-filter:blur(10px); }
    .tab-btn.active{ background:rgba(255,255,255,.95); color:#1a1a2e; }
    .download-pulse{ animation:downloadPulse 2s infinite; }
    @keyframes downloadPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    
    /* Mobile optimizations */
    @media (max-width: 640px) {
      .mobile-stack { flex-direction: column !important; }
      .mobile-full { width: 100% !important; }
      .mobile-text-center { text-align: center !important; }
      .mobile-hidden { display: none !important; }
      .mobile-grid-1 { grid-template-columns: 1fr !important; }
      .mobile-p-3 { padding: 0.75rem !important; }
      .mobile-gap-3 { gap: 0.75rem !important; }
      .mobile-text-sm { font-size: 0.875rem !important; }
    }
    
    @media (prefers-reduced-motion:reduce){ 
      *{animation:none!important; transition:none!important} 
      body::before{animation:none} 
      .download-pulse{animation:none}
    }
  </style>
</head>
<body>

  <!-- Header - Mobile Optimized -->
  <header class="w-full px-3 sm:px-4 py-3 sm:py-4 relative z-10">
    <div class="max-w-6xl mx-auto flex justify-center items-center">
      <div class="flex items-center space-x-2 sm:space-x-3">
        <button id="backBtn" class="text-ultra-visible hover:text-cyan transition-colors p-1" aria-label="Indietro">
          <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-cyan to-teal rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 sm:w-6 sm:h-6 text-white" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M10 4H4a2 2 0 0 0-2 2v1h20V7a2 2 0 0 0-2-2h-8l-2-1z"></path>
              <path d="M22 9H2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9z"></path>
            </svg>
          </div>
          <h1 class="text-lg sm:text-xl lg:fluid-xl font-black text-ultra-visible">FileBox</h1>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading overlay -->
  <div id="loading" class="fixed inset-0 bg-primary/90 flex items-center justify-center z-50 hidden">
    <div class="glass-card rounded-xl p-4 sm:p-6 text-center mx-3">
      <div class="animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-aurora mx-auto mb-4"></div>
      <p class="text-aurora font-bold text-sm sm:text-base">Caricamento...</p>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-3 sm:px-4 pb-8 sm:pb-10">
    
    <!-- Tab Navigation -->
    <div class="flex gap-2 mb-4 sm:mb-6 fade-in overflow-x-auto">
      <button id="tabFiles" class="tab-btn active px-3 sm:px-4 py-2 rounded-full font-bold text-xs sm:text-sm whitespace-nowrap flex items-center gap-2">
        <span>üìÅ</span> File Cartella
      </button>
      <button id="tabDownloads" class="tab-btn px-3 sm:px-4 py-2 rounded-full font-bold text-xs sm:text-sm whitespace-nowrap flex items-center gap-2">
        <span>üíæ</span> Download
      </button>
      <button id="tabManage" class="tab-btn px-3 sm:px-4 py-2 rounded-full font-bold text-xs sm:text-sm whitespace-nowrap flex items-center gap-2 hidden">
        <span>‚öôÔ∏è</span> Gestione
      </button>
    </div>

    <!-- Files Section -->
    <div id="filesSection">
      <!-- Intro / Search -->
      <section class="glass-strong rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 text-center fade-in">
        <h2 class="text-ultra-visible text-lg sm:text-xl lg:text-2xl font-extrabold mb-2">Documenti in cartella</h2>
        <p class="text-ultra-visible text-sm sm:fluid-base mb-4">Visualizza e scarica i file senza uscire dalla pagina</p>
        
        <!-- Search and Filters - Mobile Stacked -->
        <div class="grid gap-3 sm:gap-4 mb-4">
          <!-- Search Bar -->
          <div class="glass-card rounded-xl sm:rounded-2xl p-2 sm:p-3">
            <div class="flex items-center space-x-2 sm:space-x-3">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
                <path d="M20 20l-3.5-3.5" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <input id="searchInput" type="text" class="w-full outline-none bg-transparent text-xs sm:text-sm lg:fluid-base text-primary" placeholder="Cerca per nome o estensione..." maxlength="100" autocomplete="off">
            </div>
          </div>
          
          <!-- Filters - Horizontal Scroll on Mobile -->
          <div class="flex gap-2 overflow-x-auto pb-2">
            <button class="filterBtn category-filter active px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap" data-type="all">Tutti</button>
            <button class="filterBtn category-filter px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap" data-type="doc">üìÑ Doc</button>
            <button class="filterBtn category-filter px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap" data-type="img">üñºÔ∏è Img</button>
            <button class="filterBtn category-filter px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap" data-type="vid">üé¨ Video</button>
            <button class="filterBtn category-filter px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-bold whitespace-nowrap" data-type="aud">üéß Audio</button>
          </div>
        </div>

        <!-- Stats -->
        <div class="flex justify-center gap-4 sm:gap-8">
          <div class="text-center">
            <div id="statTot" class="text-lg sm:text-xl lg:fluid-2xl font-black text-ultra-visible">--</div>
            <div class="text-xs sm:fluid-xs text-cyan font-bold">File</div>
          </div>
          <div class="text-center">
            <div id="statSize" class="text-lg sm:text-xl lg:fluid-2xl font-black text-ultra-visible">--</div>
            <div class="text-xs sm:fluid-xs text-cyan font-bold">Dimensione</div>
          </div>
        </div>
      </section>

      <!-- Files Grid -->
      <section id="filesContainer" class="grid mobile-grid-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 fade-in">
        <!-- Loading skeletons -->
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-24 sm:h-28"></div>
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-24 sm:h-28 mobile-hidden"></div>
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-24 sm:h-28 mobile-hidden"></div>
      </section>

      <!-- Empty State -->
      <div id="emptyState" class="text-center py-12 sm:py-16 hidden">
        <div class="w-16 h-16 sm:w-24 sm:h-24 bg-gradient-to-r from-muted to-gray-400 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
          <span class="text-2xl sm:text-4xl">üóÇÔ∏è</span>
        </div>
        <h3 class="text-lg sm:fluid-xl font-black text-ultra-visible mb-4">Nessun file trovato</h3>
        <p class="text-cyan text-sm sm:fluid-base">Prova a cambiare filtri o ricerca</p>
      </div>
    </div>

    <!-- Downloads Section -->
    <div id="downloadsSection" class="hidden">
      <section class="glass-strong rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 text-center fade-in">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-2xl sm:text-3xl download-pulse">üíæ</span>
          <h2 class="text-ultra-visible text-lg sm:text-xl lg:text-2xl font-extrabold">Link Download</h2>
        </div>
        <p class="text-ultra-visible text-sm sm:fluid-base mb-4">Accedi ai link di download condivisi</p>
        <div class="text-center">
          <div id="downloadCount" class="text-lg sm:text-xl lg:fluid-2xl font-black text-ultra-visible">--</div>
          <div class="text-xs sm:fluid-xs text-cyan font-bold">Link disponibili</div>
        </div>
      </section>

      <!-- Downloads Grid -->
      <section id="downloadsContainer" class="grid mobile-grid-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 fade-in">
        <!-- Loading skeletons -->
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-32 sm:h-36"></div>
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-32 sm:h-36 mobile-hidden"></div>
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 loading-skeleton h-32 sm:h-36 mobile-hidden"></div>
      </section>

      <!-- Empty Downloads -->
      <div id="emptyDownloads" class="text-center py-12 sm:py-16 hidden">
        <div class="w-16 h-16 sm:w-24 sm:h-24 bg-gradient-to-r from-muted to-gray-400 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
          <span class="text-2xl sm:text-4xl">üì•</span>
        </div>
        <h3 class="text-lg sm:fluid-xl font-black text-ultra-visible mb-4">Nessun link disponibile</h3>
        <p class="text-cyan text-sm sm:fluid-base">I link di download verranno aggiunti dalla direzione</p>
      </div>
    <!-- Management Section (Admin/Dirigenti only) -->
    <div id="manageSection" class="hidden">
      <section class="glass-strong rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 text-center fade-in">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-2xl sm:text-3xl">‚öôÔ∏è</span>
          <h2 class="text-ultra-visible text-lg sm:text-xl lg:text-2xl font-extrabold">Gestione Download</h2>
        </div>
        <p class="text-ultra-visible text-sm sm:fluid-base mb-4">Aggiungi, modifica ed elimina i link di download</p>
      </section>

      <!-- Add/Edit Form -->
      <section class="glass-card rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 fade-in">
        <h3 class="text-primary text-lg font-bold mb-4 flex items-center gap-2">
          <span id="formIcon">‚ûï</span>
          <span id="formTitle">Aggiungi Nuovo Link</span>
        </h3>
        
        <form id="linkForm" class="space-y-4">
          <input type="hidden" id="editId" value="">
          
          <div>
            <label for="linkTitolo" class="block text-primary font-semibold mb-2 text-sm">Titolo *</label>
            <input type="text" id="linkTitolo" required maxlength="255" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aurora focus:border-aurora outline-none text-sm"
                   placeholder="es. Materiale Corso Base">
          </div>
          
          <div>
            <label for="linkDescrizione" class="block text-primary font-semibold mb-2 text-sm">Descrizione</label>
            <textarea id="linkDescrizione" rows="3" maxlength="500"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aurora focus:border-aurora outline-none text-sm resize-none"
                      placeholder="Descrizione opzionale del contenuto..."></textarea>
          </div>
          
          <div>
            <label for="linkUrl" class="block text-primary font-semibold mb-2 text-sm">URL *</label>
            <input type="url" id="linkUrl" required 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aurora focus:border-aurora outline-none text-sm"
                   placeholder="https://mega.nz/file/...">
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="linkTipo" class="block text-primary font-semibold mb-2 text-sm">Tipo Transfer</label>
              <select id="linkTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aurora focus:border-aurora outline-none text-sm">
                <option value="Download">Download</option>
                <option value="MEGA">MEGA</option>
                <option value="Google Drive">Google Drive</option>
                <option value="WeTransfer">WeTransfer</option>
                <option value="Dropbox">Dropbox</option>
                <option value="OneDrive">OneDrive</option>
                <option value="MediaFire">MediaFire</option>
                <option value="GitHub">GitHub</option>
              </select>
            </div>
            
            <div>
              <label for="linkOrder" class="block text-primary font-semibold mb-2 text-sm">Ordine</label>
              <input type="number" id="linkOrder" min="0" max="999" value="0"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-aurora focus:border-aurora outline-none text-sm">
            </div>
          </div>
          
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="linkAttivo" checked class="w-4 h-4 text-aurora border-gray-300 rounded focus:ring-aurora">
              <span class="text-primary font-medium text-sm">Link attivo</span>
            </label>
          </div>
          
          <div class="flex gap-2 pt-4">
            <button type="submit" id="submitBtn" class="bg-gradient-to-r from-aurora to-magenta text-white px-4 py-2 rounded-lg font-bold text-sm hover:scale-105 transition-transform mobile-full">
              Salva Link
            </button>
            <button type="button" id="cancelBtn" class="bg-gray-100 hover:bg-gray-200 text-primary px-4 py-2 rounded-lg font-bold text-sm mobile-full hidden">
              Annulla
            </button>
          </div>
        </form>
      </section>

      <!-- Links Management Grid -->
      <section class="fade-in">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-ultra-visible text-lg font-bold">Link Esistenti</h3>
          <button id="refreshLinks" class="bg-gradient-to-r from-cyan to-teal text-white px-3 py-2 rounded-lg font-bold text-xs hover:scale-105 transition-transform">
            üîÑ Aggiorna
          </button>
        </div>
        
        <div id="manageContainer" class="grid mobile-grid-1 sm:grid-cols-2 lg:grid-cols-1 gap-3 sm:gap-4">
          <!-- Management cards will be rendered here -->
        </div>
        
        <div id="emptyManage" class="text-center py-12 sm:py-16 hidden">
          <div class="w-16 h-16 sm:w-24 sm:h-24 bg-gradient-to-r from-muted to-gray-400 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
            <span class="text-2xl sm:text-4xl">üìù</span>
          </div>
          <h3 class="text-lg sm:fluid-xl font-black text-ultra-visible mb-4">Nessun link configurato</h3>
          <p class="text-cyan text-sm sm:fluid-base">Aggiungi il primo link usando il form sopra</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal Viewer -->
  <div id="viewer" class="fixed inset-0 bg-black/70 hidden z-50">
    <div class="absolute inset-0 p-2 sm:p-4 flex items-center justify-center">
      <div class="glass-card rounded-xl sm:rounded-2xl w-full max-w-5xl h-[85vh] sm:h-[80vh] flex flex-col">
        <div class="p-2 sm:p-3 flex items-center justify-between border-b border-gray-200 mobile-stack mobile-gap-3">
          <div class="flex items-center gap-2 sm:gap-3 mobile-full">
            <div class="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-gradient-to-r from-cyan to-teal flex items-center justify-center">üìÑ</div>
            <div class="min-w-0 flex-1">
              <div id="viewerName" class="font-bold text-primary text-sm sm:text-base truncate"></div>
              <div id="viewerMeta" class="text-xs sm:text-sm text-muted"></div>
            </div>
          </div>
          <div class="flex items-center gap-2 mobile-full">
            <a id="downloadBtn" class="bg-gradient-to-r from-aurora to-magenta text-white px-2 sm:px-3 py-1 sm:py-2 rounded-full font-bold text-xs sm:text-sm mobile-full mobile-text-center" download>Scarica</a>
            <button id="closeViewer" class="bg-gray-100 hover:bg-gray-200 text-primary px-2 sm:px-3 py-1 sm:py-2 rounded-full font-bold text-xs sm:text-sm">Chiudi</button>
          </div>
        </div>
        <div class="flex-1 relative">
          <div id="viewerLoading" class="absolute inset-0 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-aurora mb-4"></div>
            <p class="text-aurora font-bold text-sm sm:text-base">Caricamento‚Ä¶</p>
          </div>
          <div id="viewerBody" class="w-full h-full hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { File as MegaFile } from 'https://unpkg.com/megajs/dist/main.browser-es.mjs';

    // === CONFIG ===
    const MEGA_FOLDER_URL = 'https://mega.nz/folder/figRhbTT#dw0ZS1lb6sv8l-CHVfNSTA';
    const PREVIEW_SIZE_LIMIT = 100 * 1024 * 1024; // 100MB

    // Supabase
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // State
    let currentUser = null;
    let allFiles = [];
    let downloadLinks = [];
    let lastObjectURL = null;
    let activeTab = 'files';
    let isAdmin = false;
    let editingLinkId = null;

    // Utils
    const $ = s => document.querySelector(s);
    const $ = s => Array.from(document.querySelectorAll(s));
    const humanSize = b => {
      if (!Number.isFinite(b)) return '--';
      const u = ['B','KB','MB','GB','TB']; let i=0; while(b>=1024 && i<u.length-1){ b/=1024; i++; }
      return `${b.toFixed( b<10&&i>0 ? 1 : 0)} ${u[i]}`;
    };

    const EXT_MAP = {
      doc: ['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','odt','ods','csv'],
      img: ['jpg','jpeg','png','gif','webp','svg'],
      vid: ['mp4','webm','mkv','mov','avi','m4v'],
      aud: ['mp3','wav','ogg','m4a','flac']
    };
    
    const detectType = (ext) => {
      ext = ext.toLowerCase();
      if (EXT_MAP.img.includes(ext)) return 'img';
      if (EXT_MAP.vid.includes(ext)) return 'vid';
      if (EXT_MAP.aud.includes(ext)) return 'aud';
      if (EXT_MAP.doc.includes(ext)) return 'doc';
      return 'other';
    };
    
    const mimeFromExt = (ext) => {
      ext = ext.toLowerCase();
      const map = {
        pdf:'application/pdf', txt:'text/plain', csv:'text/csv',
        jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', gif:'image/gif', webp:'image/webp', svg:'image/svg+xml',
        mp4:'video/mp4', webm:'video/webm', mkv:'video/webm', mov:'video/quicktime', avi:'video/x-msvideo', m4v:'video/mp4',
        mp3:'audio/mpeg', wav:'audio/wav', ogg:'audio/ogg', m4a:'audio/mp4', flac:'audio/flac',
        doc:'application/msword', docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        xls:'application/vnd.ms-excel', xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        ppt:'application/vnd.ms-powerpoint', pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        odt:'application/vnd.oasis.opendocument.text', ods:'application/vnd.oasis.opendocument.spreadsheet'
      };
      return map[ext] || 'application/octet-stream';
    };

    // Transfer platform icons
    const getTransferIcon = (url) => {
      const urlLower = url.toLowerCase();
      if (urlLower.includes('mega.nz') || urlLower.includes('mega.co')) return '‚òÅÔ∏è';
      if (urlLower.includes('drive.google.com') || urlLower.includes('docs.google.com')) return 'üìÅ';
      if (urlLower.includes('wetransfer.com')) return 'üì§';
      if (urlLower.includes('dropbox.com')) return 'üì¶';
      if (urlLower.includes('onedrive') || urlLower.includes('sharepoint')) return 'üìã';
      if (urlLower.includes('mediafire.com')) return 'üî•';
      if (urlLower.includes('github.com')) return 'üêô';
      return 'üîó';
    };

    // Tab switching
    function switchTab(tab) {
      activeTab = tab;
      
      // Update tab buttons
      $('.tab-btn').forEach(btn => btn.classList.remove('active'));
      
      // Hide all sections
      hide($('#filesSection'));
      hide($('#downloadsSection'));
      hide($('#manageSection'));
      
      if (tab === 'files') {
        $('#tabFiles').classList.add('active');
        show($('#filesSection'));
      } else if (tab === 'downloads') {
        $('#tabDownloads').classList.add('active');
        show($('#downloadsSection'));
      } else if (tab === 'manage') {
        $('#tabManage').classList.add('active');
        show($('#manageSection'));
      }
    }

    // Tab event listeners with safe binding
    const tabFiles = $('#tabFiles');
    const tabDownloads = $('#tabDownloads');
    const tabManage = $('#tabManage');
    
    if (tabFiles) tabFiles.addEventListener('click', () => switchTab('files'));
    if (tabDownloads) tabDownloads.addEventListener('click', () => switchTab('downloads'));
    if (tabManage) tabManage.addEventListener('click', () => switchTab('manage'));

    // Auth + routing
    async function checkAuth(){
      try{
        const { data:{ user } } = await supabase.auth.getUser();
        currentUser = user || null;
        
        // Check admin privileges
        if (user) {
          await checkAdminPrivileges();
        }
      }catch(e){ /* ignore */ }
    }

    async function checkAdminPrivileges(){
      try{
        // Check user metadata first
        const meta = currentUser.user_metadata || {};
        const rawRole = (meta.profilo || meta.ruolo || meta.role || '').toString().toLowerCase();
        if (rawRole.includes('dirigente') || rawRole.includes('admin')) {
          isAdmin = true;
        } else {
          // Check database profile
          const { data } = await supabase.from('user_profiles').select('ruolo,profilo,tipo').eq('user_id', currentUser.id).maybeSingle();
          if (data){
            const role = (data.ruolo||data.profilo||data.tipo||'').toLowerCase();
            if (role.includes('dirigente') || role.includes('admin')) {
              isAdmin = true;
            }
          }
        }
        
        // Show/hide management tab
        const manageTab = $('#tabManage');
        if (manageTab) {
          if (isAdmin) {
            manageTab.classList.remove('hidden');
          } else {
            manageTab.classList.add('hidden');
          }
        }
      }catch(e){
        console.error('Error checking admin privileges:', e);
      }
    }

    async function resolveHomePath(){
      let target = 'home.html';
      try{
        if (!currentUser) return target;
        const meta = currentUser.user_metadata || {};
        const rawRole = (meta.profilo || meta.ruolo || meta.role || '').toString().toLowerCase();
        if (rawRole.includes('dirigente')) return 'home_dirigenti.html';
        const { data } = await supabase.from('user_profiles').select('ruolo,profilo,tipo').eq('user_id', currentUser.id).maybeSingle();
        if (data){
          const role = (data.ruolo||data.profilo||data.tipo||'').toLowerCase();
          if (role.includes('dirigente')) target = 'home_dirigenti.html';
        }
      }catch(e){}
      return target;
    }

    const backBtn = $('#backBtn');
    if (backBtn) {
      backBtn.addEventListener('click', async ()=> { window.location.href = await resolveHomePath(); });
    }

    // Load MEGA files
    async function loadMega(){
      safeShow($('#loading'));
      try{
        const folder = MegaFile.fromURL(MEGA_FOLDER_URL);
        await new Promise((res, rej)=> folder.loadAttributes(err => err ? rej(err) : res()));

        const flatten = async (node) => {
          if (!node) return [];
          if (!node.directory) return [node];
          const children = node.children || [];
          const out = [];
          for (const ch of children){
            const arr = await flatten(ch);
            out.push(...arr);
          }
          return out;
        };

        const files = (await flatten(folder)).filter(f => !f.directory);

        allFiles = files.map(f=>{
          const name = f.name || 'file';
          const ext = (name.split('.').pop() || '').toLowerCase();
          const type = detectType(ext);
          const size = Number.isFinite(f.size) ? f.size : NaN;
          return { name, ext, size, type, megaFile: f };
        });

        renderFiles();
        updateStats();
      }catch(err){
        console.error('Errore MEGA:', err);
        const container = $('#filesContainer');
        if (container) {
          container.innerHTML = `
            <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-6 col-span-full">
              <p class="text-error font-semibold text-sm sm:text-base">Impossibile leggere la cartella MEGA.</p>
              <p class="text-muted mt-2 text-xs sm:text-sm">Controlla che il link sia pubblico e riprova.</p>
            </div>`;
        }
      }finally{
        safeHide($('#loading'));
      }
    }

    // Load download links
    async function loadDownloadLinks(){
      try{
        const { data, error } = await supabase
          .from('download_links')
          .select('*')
          .eq('attivo', true)
          .order('order_index', { ascending: true });
        
        if (error) throw error;
        
        downloadLinks = data || [];
        renderDownloads();
        updateDownloadStats();
        
        // Load all links for management if admin
        if (isAdmin) {
          await loadAllLinksForManagement();
        }
      }catch(err){
        console.error('Errore download links:', err);
        const container = $('#downloadsContainer');
        if (container) {
          container.innerHTML = `
            <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-6 col-span-full">
              <p class="text-error font-semibold text-sm sm:text-base">Errore nel caricamento dei link.</p>
              <p class="text-muted mt-2 text-xs sm:text-sm">Riprova pi√π tardi o contatta l'amministratore.</p>
            </div>`;
        }
      }
    }

    // Management functions
    async function loadAllLinksForManagement(){
      if (!isAdmin) return;
      
      try{
        const { data, error } = await supabase
          .from('download_links')
          .select('*')
          .order('order_index', { ascending: true });
        
        if (error) throw error;
        
        renderManagementLinks(data || []);
      }catch(err){
        console.error('Errore caricamento gestione:', err);
        const container = $('#manageContainer');
        if (container) {
          container.innerHTML = `
            <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-6 col-span-full">
              <p class="text-error font-semibold text-sm sm:text-base">Errore nel caricamento della gestione.</p>
            </div>`;
        }
      }
    }

    async function saveLink(){
      if (!isAdmin) return;
      
      const linkTitolo = $('#linkTitolo');
      const linkDescrizione = $('#linkDescrizione');
      const linkUrl = $('#linkUrl');
      const linkTipo = $('#linkTipo');
      const linkOrder = $('#linkOrder');
      const linkAttivo = $('#linkAttivo');
      
      if (!linkTitolo || !linkUrl) return;
      
      const titolo = linkTitolo.value.trim();
      const descrizione = linkDescrizione ? linkDescrizione.value.trim() : '';
      const url = linkUrl.value.trim();
      const tipo = linkTipo ? linkTipo.value : 'Download';
      const orderIndex = linkOrder ? parseInt(linkOrder.value) || 0 : 0;
      const attivo = linkAttivo ? linkAttivo.checked : true;
      
      if (!titolo || !url) {
        alert('Titolo e URL sono obbligatori');
        return;
      }
      
      try {
        const linkData = {
          titolo,
          descrizione: descrizione || null,
          url,
          tipo_transfer: tipo,
          order_index: orderIndex,
          attivo,
          updated_at: new Date().toISOString()
        };
        
        let result;
        if (editingLinkId) {
          // Update existing link
          result = await supabase
            .from('download_links')
            .update(linkData)
            .eq('id', editingLinkId);
        } else {
          // Create new link
          linkData.created_at = new Date().toISOString();
          result = await supabase
            .from('download_links')
            .insert([linkData]);
        }
        
        if (result.error) throw result.error;
        
        // Reset form and reload
        resetForm();
        await loadDownloadLinks();
        
        alert(editingLinkId ? 'Link aggiornato con successo!' : 'Link aggiunto con successo!');
      } catch (err) {
        console.error('Errore salvataggio:', err);
        alert('Errore nel salvataggio: ' + (err.message || 'Errore sconosciuto'));
      }
    }

    async function deleteLink(id){
      if (!isAdmin || !confirm('Sei sicuro di voler eliminare questo link?')) return;
      
      try {
        const { error } = await supabase
          .from('download_links')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        await loadDownloadLinks();
        alert('Link eliminato con successo!');
      } catch (err) {
        console.error('Errore eliminazione:', err);
        alert('Errore nell\'eliminazione: ' + (err.message || 'Errore sconosciuto'));
      }
    }

    function editLink(link){
      if (!isAdmin) return;
      
      editingLinkId = link.id;
      const linkTitolo = $('#linkTitolo');
      const linkDescrizione = $('#linkDescrizione');
      const linkUrl = $('#linkUrl');
      const linkTipo = $('#linkTipo');
      const linkOrder = $('#linkOrder');
      const linkAttivo = $('#linkAttivo');
      const formIcon = $('#formIcon');
      const formTitle = $('#formTitle');
      const submitBtn = $('#submitBtn');
      const cancelBtn = $('#cancelBtn');
      
      if (linkTitolo) linkTitolo.value = link.titolo || '';
      if (linkDescrizione) linkDescrizione.value = link.descrizione || '';
      if (linkUrl) linkUrl.value = link.url || '';
      if (linkTipo) linkTipo.value = link.tipo_transfer || 'Download';
      if (linkOrder) linkOrder.value = link.order_index || 0;
      if (linkAttivo) linkAttivo.checked = link.attivo !== false;
      
      if (formIcon) formIcon.textContent = '‚úèÔ∏è';
      if (formTitle) formTitle.textContent = 'Modifica Link';
      if (submitBtn) submitBtn.textContent = 'Aggiorna Link';
      safeShow(cancelBtn);
      
      // Scroll to form
      const linkForm = $('#linkForm');
      if (linkForm) linkForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetForm(){
      editingLinkId = null;
      const linkForm = $('#linkForm');
      const linkAttivo = $('#linkAttivo');
      const linkOrder = $('#linkOrder');
      const formIcon = $('#formIcon');
      const formTitle = $('#formTitle');
      const submitBtn = $('#submitBtn');
      const cancelBtn = $('#cancelBtn');
      
      if (linkForm) linkForm.reset();
      if (linkAttivo) linkAttivo.checked = true;
      if (linkOrder) linkOrder.value = 0;
      
      if (formIcon) formIcon.textContent = '‚ûï';
      if (formTitle) formTitle.textContent = 'Aggiungi Nuovo Link';
      if (submitBtn) submitBtn.textContent = 'Salva Link';
      safeHide(cancelBtn);
    }

    // Render files
    function renderFiles(){
      const searchInput = $('#searchInput');
      const q = searchInput ? searchInput.value.trim().toLowerCase() : '';
      const activeType = $('.filterBtn').find(b=>b.classList.contains('active'))?.dataset.type || 'all';

      const filtered = allFiles.filter(f=>{
        const matchText = !q || f.name.toLowerCase().includes(q) || f.ext.includes(q);
        const matchType = activeType==='all' || f.type===activeType;
        return matchText && matchType;
      });

      const container = $('#filesContainer');
      const emptyState = $('#emptyState');
      
      if (!container) return;

      if (!filtered.length){
        container.innerHTML = '';
        safeShow(emptyState);
        return;
      }
      safeHide(emptyState);

      const iconFor = t => ({ doc:'üìÑ', img:'üñºÔ∏è', vid:'üé¨', aud:'üéß', other:'üì¶' }[t] || 'üì¶');

      container.innerHTML = filtered.map(f=>`
        <button class="file-tile glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 text-left w-full" data-name="${encodeURIComponent(f.name)}" aria-label="Apri ${f.name}">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-gradient-to-r from-cyan to-teal flex items-center justify-center text-lg sm:text-xl flex-shrink-0">${iconFor(f.type)}</div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-primary text-sm sm:text-base truncate" title="${f.name}">${f.name}</div>
              <div class="text-muted text-xs sm:fluid-xs mt-1">${f.ext.toUpperCase()} ‚Ä¢ ${humanSize(f.size)}</div>
            </div>
          </div>
        </button>
      `).join('');

      // Re-bind file tile events
      $('#filesContainer .file-tile').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = decodeURIComponent(btn.dataset.name);
          const fileObj = allFiles.find(x=>x.name===name);
          if (fileObj) openViewer(fileObj);
        });
      });
    }

    // Render downloads
    function renderDownloads(){
      const container = $('#downloadsContainer');
      const emptyDownloads = $('#emptyDownloads');
      
      if (!container) return;
      
      if (!downloadLinks.length){
        container.innerHTML = '';
        safeShow(emptyDownloads);
        return;
      }
      safeHide(emptyDownloads);

      container.innerHTML = downloadLinks.map(link=>`
        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="download-tile glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4 text-left w-full block hover:no-underline">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-gradient-to-r from-aurora to-magenta flex items-center justify-center text-lg sm:text-xl flex-shrink-0">${getTransferIcon(link.url)}</div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-primary text-sm sm:text-base mb-1" title="${link.titolo}">${link.titolo}</div>
              ${link.descrizione ? `<div class="text-muted text-xs sm:text-sm mb-2 line-clamp-2">${link.descrizione}</div>` : ''}
              <div class="flex items-center justify-between">
                <div class="text-xs text-cyan font-medium">Clicca per scaricare</div>
                <div class="bg-gradient-to-r from-success to-teal text-white px-2 py-1 rounded-full text-xs font-bold">
                  ${link.tipo_transfer || 'Download'}
                </div>
              </div>
            </div>
          </div>
        </a>
      `).join('');
    }

    function updateStats(){
      const total = allFiles.length;
      const sizeSum = allFiles.reduce((a,b)=> a + (Number.isFinite(b.size)? b.size : 0), 0);
      $('#statTot').textContent = total || '--';
      $('#statSize').textContent = total ? humanSize(sizeSum) : '--';
    }

    // Render management links
    function renderManagementLinks(links){
      if (!isAdmin) return;
      
      const container = $('#manageContainer');
      if (!links.length){
        container.innerHTML = '';
        show($('#emptyManage'));
        return;
      }
      hide($('#emptyManage'));

      container.innerHTML = links.map(link=>`
        <div class="glass-card rounded-xl sm:rounded-2xl p-3 sm:p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-gradient-to-r from-aurora to-magenta flex items-center justify-center text-lg sm:text-xl flex-shrink-0">${getTransferIcon(link.url)}</div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <div class="font-bold text-primary text-sm sm:text-base truncate" title="${link.titolo}">${link.titolo}</div>
                  ${link.descrizione ? `<div class="text-muted text-xs sm:text-sm mt-1 line-clamp-2">${link.descrizione}</div>` : ''}
                  <div class="flex items-center gap-4 mt-2">
                    <span class="text-xs text-cyan font-medium">${link.tipo_transfer || 'Download'}</span>
                    <span class="text-xs ${link.attivo ? 'text-success' : 'text-error'} font-medium">
                      ${link.attivo ? '‚úÖ Attivo' : '‚ùå Disattivo'}
                    </span>
                    <span class="text-xs text-muted">Ord: ${link.order_index || 0}</span>
                  </div>
                </div>
                ${link.attivo ? '' : '<div class="text-xl opacity-50">üö´</div>'}
              </div>
              <div class="flex gap-2 mt-3">
                <button class="editLinkBtn bg-gradient-to-r from-cyan to-teal text-white px-2 py-1 rounded text-xs font-bold hover:scale-105 transition-transform" data-link='${JSON.stringify(link).replace(/'/g, "&apos;")}'>
                  ‚úèÔ∏è Modifica
                </button>
                <button class="deleteLinkBtn bg-gradient-to-r from-error to-aurora text-white px-2 py-1 rounded text-xs font-bold hover:scale-105 transition-transform" data-id="${link.id}">
                  üóëÔ∏è Elimina
                </button>
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="bg-gradient-to-r from-success to-teal text-white px-2 py-1 rounded text-xs font-bold hover:scale-105 transition-transform">
                  üîó Testa
                </a>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Bind management events
      $('.editLinkBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const linkData = JSON.parse(btn.dataset.link.replace(/&apos;/g, "'"));
          editLink(linkData);
        });
      });

      $('.deleteLinkBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          deleteLink(parseInt(btn.dataset.id));
        });
      });
    }

    // Viewer (same as before but mobile optimized)
    async function openViewer(file){
      const viewer = $('#viewer');
      const viewerBody = $('#viewerBody');
      const viewerLoading = $('#viewerLoading');
      const viewerName = $('#viewerName');
      const viewerMeta = $('#viewerMeta');
      
      safeShow(viewer);
      safeHide(viewerBody);
      safeShow(viewerLoading);
      
      if (viewerName) viewerName.textContent = file.name;
      if (viewerMeta) viewerMeta.textContent = `${file.ext.toUpperCase()} ‚Ä¢ ${humanSize(file.size)}`;
      if (viewerBody) viewerBody.innerHTML = '';

      if (lastObjectURL){
        try { URL.revokeObjectURL(lastObjectURL); } catch {}
        lastObjectURL = null;
      }

      try{
        if (Number.isFinite(file.size) && file.size > PREVIEW_SIZE_LIMIT){
          if (viewerBody) {
            viewerBody.innerHTML = `
              <div class="w-full h-full flex items-center justify-center p-4 sm:p-6 text-center">
                <div>
                  <p class="text-primary font-semibold mb-2 text-sm sm:text-base">Anteprima disattivata per file di grandi dimensioni.</p>
                  <p class="text-muted text-xs sm:text-sm">Usa "Scarica" per aprirlo in locale.</p>
                </div>
              </div>`;
          }
          const streamUrl = await ensureDownloadURL(file);
          const downloadBtn = $('#downloadBtn');
          if (downloadBtn) {
            downloadBtn.removeAttribute('download');
            downloadBtn.href = streamUrl;
          }
        } else {
          const data = await new Promise((res, rej)=> file.megaFile.download((err, bytes)=> err ? rej(err) : res(bytes)));
          const blob = new Blob([data], { type: mimeFromExt(file.ext) });
          const url = URL.createObjectURL(blob);
          lastObjectURL = url;

          const downloadBtn = $('#downloadBtn');
          if (downloadBtn) {
            downloadBtn.href = url;
            downloadBtn.setAttribute('download', file.name);
          }

          if (viewerBody) {
            if (file.type==='img'){
              viewerBody.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-50"><img src="${url}" class="max-w-full max-h-full object-contain" alt="${file.name}"/></div>`;
            } else if (file.type==='vid'){
              viewerBody.innerHTML = `<video src="${url}" controls class="w-full h-full bg-black rounded-b-xl sm:rounded-b-2xl"></video>`;
            } else if (file.type==='aud'){
              viewerBody.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-50 p-4"><audio src="${url}" controls class="w-full max-w-xl"></audio></div>`;
            } else if (file.ext==='pdf'){
              viewerBody.innerHTML = `<iframe src="${url}" class="w-full h-full rounded-b-xl sm:rounded-b-2xl" title="${file.name}" referrerpolicy="no-referrer"></iframe>`;
            } else {
              viewerBody.innerHTML = `
                <div class="w-full h-full flex items-center justify-center p-4 sm:p-6 text-center">
                  <div>
                    <p class="text-primary font-semibold mb-2 text-sm sm:text-base">Anteprima non disponibile per questo formato.</p>
                    <p class="text-muted text-xs sm:text-sm">Clicca su "Scarica" per aprire il file.</p>
                  </div>
                </div>`;
            }
          }
        }
      }catch(e){
        console.error('Preview error:', e);
        if (viewerBody) {
          viewerBody.innerHTML = `
            <div class="w-full h-full flex items-center justify-center p-4 sm:p-6 text-center">
              <div>
                <p class="text-error font-semibold mb-2 text-sm sm:text-base">Impossibile caricare l'anteprima.</p>
                <p class="text-muted text-xs sm:text-sm">Prova a scaricare il file.</p>
              </div>
            </div>`;
        }
        try {
          const streamUrl = await ensureDownloadURL(file);
          const downloadBtn = $('#downloadBtn');
          if (downloadBtn) {
            downloadBtn.removeAttribute('download');
            downloadBtn.href = streamUrl;
          }
        } catch {}
      }finally{
        safeHide(viewerLoading);
        safeShow(viewerBody);
      }
    }

    async function ensureDownloadURL(file){
      return await new Promise((resolve, reject)=>{
        try{
          file.megaFile.link((err, url)=>{
            if (err || !url) return reject(err || new Error('No URL'));
            resolve(url);
          });
        }catch(e){ reject(e); }
      });
    }

    const closeViewer = $('#closeViewer');
    if (closeViewer) {
      closeViewer.addEventListener('click', ()=>{
        try {
          const media = $('#viewerBody video, #viewerBody audio');
          media?.pause?.();
        } catch {}
        const viewerBody = $('#viewerBody');
        if (viewerBody) viewerBody.innerHTML = '';
        safeHide($('#viewer'));
        if (lastObjectURL){
          try { URL.revokeObjectURL(lastObjectURL); } catch {}
          lastObjectURL = null;
        }
      });
    }

    function updateDownloadStats(){
      $('#downloadCount').textContent = downloadLinks.length || '--';
    }

    // Safe DOM utilities
    function safeShow(el) {
      if (el) el.classList.remove('hidden');
    }
    
    function safeHide(el) {
      if (el) el.classList.add('hidden');
    }

    // Event listeners
    $('.filterBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $('.filterBtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderFiles();
      });
    });
    
    let searchTimeout;
    $('#searchInput').addEventListener('input', ()=>{ 
      clearTimeout(searchTimeout); 
      searchTimeout = setTimeout(renderFiles, 250); 
    });

    // Management form events
    $('#linkForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (isAdmin) saveLink();
    });

    $('#cancelBtn').addEventListener('click', resetForm);

    $('#refreshLinks').addEventListener('click', async () => {
      if (isAdmin) {
        show($('#loading'));
        await loadDownloadLinks();
        hide($('#loading'));
      }
    });

    // Initialize
    (async ()=>{
      await checkAuth();
      bindEventListeners();
      await Promise.all([loadMega(), loadDownloadLinks()]);
    })();

    // Cleanup
    window.addEventListener('beforeunload', ()=>{
      if (lastObjectURL){
        try { URL.revokeObjectURL(lastObjectURL); } catch {}
      }
    });
  </script>
</body>
</html>
