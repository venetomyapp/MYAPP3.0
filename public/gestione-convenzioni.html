<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Convenzioni</title>

  <!-- Tailwind (dev). In produzione usa build/CLI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','sans-serif'] },
          colors: { slate:'#0f172a' }
        }
      }
    }
  </script>

  <style>
    body{ background:#f8fafc; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.06); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; font-weight:700; border-radius:10px; padding:.6rem 1rem; }
    .btn-primary{ background:#1d4ed8; color:#fff; }
    .btn-primary:hover{ background:#1e40af; }
    .btn-ghost{ background:#f1f5f9; color:#0f172a; }
    .btn-ghost:hover{ background:#e2e8f0; }
    .btn-danger{ background:#dc2626; color:#fff; }
    .btn-danger:hover{ background:#b91c1c; }
    .badge{ display:inline-block; padding:.2rem .55rem; border-radius:9999px; font-size:.7rem; font-weight:800; }
    .badge-green{ background:#dcfce7; color:#166534; }
    .badge-yellow{ background:#fef9c3; color:#854d0e; }
    .badge-slate{ background:#e2e8f0; color:#0f172a; }
    .badge-red{ background:#fee2e2; color:#991b1b; }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
    .overlay.show{ display:flex; }
    .modal{ background:#fff; border-radius:16px; width:min(980px,94vw); max-height:90vh; overflow:auto; padding:1rem; }
    .label{ font-weight:700; color:#0f172a; font-size:.9rem; }
    .input, .select, .textarea{ width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.6rem .7rem; }
    .textarea{ min-height:120px; }
    .table th,.table td{ padding:.7rem .8rem; }
    .hint{ font-size:.78rem; color:#6b7280; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
    @media (max-width: 640px){ .grid-2{ grid-template-columns: 1fr; } }
  </style>
</head>
<body class="font-inter">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="home_dirigenti.html" class="btn btn-ghost" title="Indietro">
          <span>←</span><span>Indietro</span>
        </a>
        <h1 class="text-xl sm:text-2xl font-black text-slate-900">Gestione Convenzioni</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="newBtn" class="btn btn-primary"><span>+</span><span>Nuova Convenzione</span></button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-3 sm:px-4 py-6">

    <!-- Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-5">
      <div class="card p-4 text-center">
        <div class="text-sm text-slate-600">Totali</div>
        <div id="statTot" class="text-2xl font-black text-slate-900">-</div>
      </div>
      <div class="card p-4 text-center">
        <div class="text-sm text-slate-600">Attive</div>
        <div id="statActive" class="text-2xl font-black text-green-700">-</div>
      </div>
      <div class="card p-4 text-center">
        <div class="text-sm text-slate-600">In evidenza</div>
        <div id="statFeat" class="text-2xl font-black text-amber-600">-</div>
      </div>
      <div class="card p-4 text-center">
        <div class="text-sm text-slate-600">Visualizzazioni</div>
        <div id="statViews" class="text-2xl font-black text-slate-900">-</div>
      </div>
    </section>

    <!-- Filtri -->
    <section class="card p-4 sm:p-6 mb-5">
      <div class="grid sm:grid-cols-3 gap-3">
        <input id="searchInput" class="input" placeholder="Cerca per azienda/descrizione/codice...">
        <select id="statusFilter" class="select">
          <option value="ALL">Tutte</option>
          <option value="ATTIVE">Attive</option>
          <option value="INATTIVE">Inattive</option>
          <option value="SCADUTE">Scadute</option>
          <option value="EVIDENZA">In evidenza</option>
        </select>
        <select id="catFilter" class="select">
          <option value="ALL">Tutte le categorie</option>
          <option>SALUTE</option>
          <option>VIAGGI</option>
          <option>SHOPPING</option>
          <option>SERVIZI</option>
          <option>FORMAZIONE</option>
          <option>TEMPO_LIBERO</option>
          <option>RISTORAZIONE</option>
          <option>AUTOMOTIVE</option>
          <option>ALTRO</option>
        </select>
      </div>
    </section>

    <!-- Lista -->
    <section class="card p-3 sm:p-5">
      <div class="overflow-x-auto">
        <table class="table w-full text-sm">
          <thead class="text-slate-600">
            <tr class="border-b">
              <th class="text-left">Azienda</th>
              <th class="text-left">Categoria</th>
              <th>Sconto</th>
              <th>Attiva</th>
              <th>Evidenza</th>
              <th class="text-left">Validita</th>
              <th>Vis.</th>
              <th class="text-right">Azioni</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden text-center py-10 text-slate-600">
        <div class="text-3xl mb-2">Nessuna convenzione</div>
        <div>Crea o modifica con il pulsante in alto a destra.</div>
      </div>
    </section>
  </main>

  <!-- Modal Edit -->
  <div id="modal" class="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="flex items-center justify-between mb-3">
        <h2 id="modalTitle" class="text-xl font-black text-slate-900">Nuova Convenzione</h2>
        <div class="flex gap-2">
          <button id="deleteBtn" class="btn btn-danger hidden">Elimina</button>
          <button id="closeModal" class="btn btn-ghost">Chiudi</button>
        </div>
      </div>

      <form id="form" class="grid gap-4">
        <input type="hidden" id="convId">

        <!-- Base -->
        <div class="card p-4">
          <div class="grid-2">
            <div>
              <label class="label">Nome azienda *</label>
              <input id="nome_azienda" class="input" required maxlength="100">
            </div>
            <div>
              <label class="label">Categoria *</label>
              <select id="categoria" class="select" required>
                <option value="">Seleziona</option>
                <option>SALUTE</option><option>VIAGGI</option><option>SHOPPING</option>
                <option>SERVIZI</option><option>FORMAZIONE</option><option>TEMPO_LIBERO</option>
                <option>RISTORAZIONE</option><option>AUTOMOTIVE</option><option>ALTRO</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label class="label">Descrizione *</label>
            <textarea id="descrizione" class="textarea" required placeholder="Dettagli dell'offerta..."></textarea>
          </div>
        </div>

        <!-- Offerta -->
        <div class="card p-4">
          <div class="grid-2">
            <div>
              <label class="label">Sconto %</label>
              <input id="sconto_percentuale" class="input" type="number" min="0" max="100" placeholder="Es. 15">
            </div>
            <div>
              <label class="label">Codice sconto</label>
              <input id="codice_sconto" class="input" placeholder="Es. AURORA2025" maxlength="50">
            </div>
          </div>
          <div class="mt-3">
            <label class="label">Condizioni</label>
            <textarea id="condizioni" class="textarea" placeholder="Termini e condizioni"></textarea>
          </div>
        </div>

        <!-- Validità/Visibilità -->
        <div class="card p-4">
          <div class="grid-2">
            <div>
              <label class="label">Valida dal (data)</label>
              <input id="valida_dal" class="input" type="date">
            </div>
            <div>
              <label class="label">Valida fino al (opz.)</label>
              <input id="valida_fino" class="input" type="date">
            </div>
          </div>
          <div class="grid-2 mt-3">
            <div>
              <label class="label">Copertura geografica</label>
              <select id="copertura_geografica" class="select">
                <option>NAZIONALE</option><option>REGIONALE</option><option>LOCALE</option><option>ONLINE</option>
              </select>
            </div>
            <div class="flex gap-6 items-center">
              <label class="flex items-center gap-2"><input id="attiva" type="checkbox"> <span>Attiva</span></label>
              <label class="flex items-center gap-2"><input id="in_evidenza" type="checkbox"> <span>In evidenza</span></label>
            </div>
          </div>
        </div>

        <!-- Collegamenti/Media (solo URL + anteprima live) -->
        <div class="card p-4">
          <div class="grid-2">
            <div>
              <label class="label">Link esterno</label>
              <input id="link_esterno" class="input" type="url" placeholder="https://...">
              <div class="hint mt-1">Se presente, apparirà un link visita sito nella card.</div>
            </div>
            <div>
              <label class="label">URL immagine promozione</label>
              <input id="immagine_url" class="input" type="url" placeholder="https://...">
              <div id="preview_img" class="mt-2"></div>
            </div>
          </div>
          <div class="grid-2 mt-3">
            <div>
              <label class="label">URL logo azienda</label>
              <input id="logo_url" class="input" type="url" placeholder="https://...">
              <div id="preview_logo" class="mt-2"></div>
            </div>
            <div>
              <label class="label">Contatti</label>
              <div class="grid-2">
                <input id="contatto_tel" class="input" placeholder="Telefono">
                <input id="contatto_email" class="input" placeholder="Email">
              </div>
              <div class="mt-3">
                <label class="label">Note interne</label>
                <textarea id="note" class="textarea" placeholder="Note interne"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" id="cancelBtn" class="btn btn-ghost">Annulla</button>
          <button type="submit" class="btn btn-primary">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <!-- App -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase (tuo progetto)
    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk'
    );

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s==null?'':s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const fmtDate = (d)=> d ? new Date(d).toLocaleDateString('it-IT') : '—';
    function today(){ const d = new Date(); d.setHours(0,0,0,0); return d; }

    // Guard
    async function guard(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ window.location.href='auth.html'; return null; }
      const { data: prof } = await supabase
        .from('user_profiles').select('role').eq('user_id', user.id).single();
      const role = prof?.role || 'USER';
      if(!['ADMIN','DIRIGENTE'].includes(role)){
        alert('Accesso negato');
        window.location.href='home.html';
        return null;
      }
      return user;
    }

    // Stato
    let all = [];

    // Load
    async function load(){
      const { data, error } = await supabase
        .from('convenzioni')
        .select('*')
        .order('created_at', { ascending:false });
      if(error){ console.error(error); return; }
      all = data || [];
      updateStats();
      render();
    }

    function updateStats(){
      const tot = all.length;
      const active = all.filter(c => c.attiva && (!c.valida_fino || new Date(c.valida_fino) >= today())).length;
      const feat = all.filter(c => c.in_evidenza).length;
      const views = all.reduce((s,c)=> s + (c.visualizzazioni||0), 0);
      $('statTot').textContent = tot;
      $('statActive').textContent = active;
      $('statFeat').textContent = feat;
      $('statViews').textContent = views.toLocaleString('it-IT');
    }

    function render(){
      const q = $('searchInput').value.toLowerCase().trim();
      const status = $('statusFilter').value;
      const cat = $('catFilter').value;

      let rows = all.slice();

      if(q){
        rows = rows.filter(c =>
          String(c.nome_azienda||'').toLowerCase().includes(q) ||
          String(c.descrizione||'').toLowerCase().includes(q) ||
          String(c.codice_sconto||'').toLowerCase().includes(q) ||
          String(c.condizioni||'').toLowerCase().includes(q)
        );
      }
      if(status==='ATTIVE') rows = rows.filter(c => c.attiva && (!c.valida_fino || new Date(c.valida_fino) >= today()));
      if(status==='INATTIVE') rows = rows.filter(c => !c.attiva);
      if(status==='SCADUTE') rows = rows.filter(c => c.valida_fino && new Date(c.valida_fino) < today());
      if(status==='EVIDENZA') rows = rows.filter(c => c.in_evidenza);
      if(cat!=='ALL') rows = rows.filter(c => c.categoria===cat);

      const body = $('rows');
      if(!rows.length){
        body.innerHTML = '';
        $('emptyState').classList.remove('hidden');
        return;
      }
      $('emptyState').classList.add('hidden');

      const html = rows.map(function(c){
        const att = c.attiva===true;
        const ev = c.in_evidenza===true;
        const scad = c.valida_fino && new Date(c.valida_fino) < today();
        let badgeAtt = att ? '<span class="badge badge-green">Si</span>' : '<span class="badge badge-slate">No</span>';
        if(scad) badgeAtt = '<span class="badge badge-red">Scad.</span>';

        return ''+
        '<tr class="border-b hover:bg-slate-50">'+
          '<td class="text-slate-900 font-semibold">'+esc(c.nome_azienda||'-')+'</td>'+
          '<td>'+esc(c.categoria||'-')+'</td>'+
          '<td class="text-center">'+(c.sconto_percentuale!=null? (esc(c.sconto_percentuale)+'%') : '—')+'</td>'+
          '<td class="text-center">'+badgeAtt+'</td>'+
          '<td class="text-center">'+(ev?'<span class="badge badge-yellow">Si</span>':'<span class="badge badge-slate">No</span>')+'</td>'+
          '<td>'+fmtDate(c.valida_dal)+' — '+fmtDate(c.valida_fino)+'</td>'+
          '<td class="text-center">'+(c.visualizzazioni||0)+'</td>'+
          '<td class="text-right">'+
            '<button class="btn btn-ghost" data-edit="'+esc(c.id)+'">Modifica</button> '+
            (att
              ? '<button class="btn btn-ghost" data-toggle="'+esc(c.id)+'" data-new="0">Disattiva</button>'
              : '<button class="btn btn-ghost" data-toggle="'+esc(c.id)+'" data-new="1">Attiva</button>'
            )+' '+
            (ev
              ? '<button class="btn btn-ghost" data-feat="'+esc(c.id)+'" data-new="0">Rimuovi evidenza</button>'
              : '<button class="btn btn-ghost" data-feat="'+esc(c.id)+'" data-new="1">Metti in evidenza</button>'
            )+
          '</td>'+
        '</tr>';
      }).join('');

      body.innerHTML = html;
    }

    // Filtri live
    $('searchInput').addEventListener('input', render);
    $('statusFilter').addEventListener('change', render);
    $('catFilter').addEventListener('change', render);

    // Azioni lista
    document.addEventListener('click', async function(e){
      const t1 = e.target.closest('[data-edit]');
      if(t1){ const id=t1.getAttribute('data-edit'); openEdit(id); return; }
      const t2 = e.target.closest('[data-toggle]');
      if(t2){ const id=t2.getAttribute('data-toggle'); const nv=t2.getAttribute('data-new')==='1'; await toggleActive(id,nv); return; }
      const t3 = e.target.closest('[data-feat]');
      if(t3){ const id=t3.getAttribute('data-feat'); const nv=t3.getAttribute('data-new')==='1'; await toggleFeat(id,nv); return; }
    });

    // Modal helpers
    function openModal(title, isEdit){
      $('modalTitle').textContent = title || 'Nuova Convenzione';
      $('modal').classList.add('show');
      document.body.style.overflow='hidden';
      $('deleteBtn').classList.toggle('hidden', !isEdit);
    }
    function closeModal(){
      $('modal').classList.remove('show');
      document.body.style.overflow='auto';
      $('form').reset();
      $('convId').value='';
      $('preview_img').innerHTML='';
      $('preview_logo').innerHTML='';
    }
    $('closeModal').addEventListener('click', closeModal);
    $('cancelBtn').addEventListener('click', closeModal);

    // Nuova
    $('newBtn').addEventListener('click', function(){
      $('form').reset();
      $('attiva').checked = true;
      $('in_evidenza').checked = false;
      const d = new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
      $('valida_dal').value = yyyy+'-'+mm+'-'+dd;
      openModal('Nuova Convenzione', false);
    });

    // Anteprima live URL immagini
    function updatePreview(inputId, prevId, maxH){
      const url = $(inputId).value.trim();
      const target = $(prevId);
      if(!url){ target.innerHTML=''; return; }
      const safe = esc(url);
      target.innerHTML = '<img src="'+safe+'" alt="preview" style="max-height:'+maxH+'px" class="rounded border">';
    }
    $('immagine_url').addEventListener('input', ()=>updatePreview('immagine_url','preview_img',128));
    $('logo_url').addEventListener('input', ()=>updatePreview('logo_url','preview_logo',96));

    // Apri per modifica
    function openEdit(id){
      const c = all.find(x=>x.id===id); if(!c) return;
      $('convId').value = c.id;
      $('nome_azienda').value = c.nome_azienda||'';
      $('categoria').value = c.categoria||'ALTRO';
      $('descrizione').value = c.descrizione||'';
      $('sconto_percentuale').value = c.sconto_percentuale!=null ? c.sconto_percentuale : '';
      $('codice_sconto').value = c.codice_sconto||'';
      $('condizioni').value = c.condizioni||'';
      $('valida_dal').value = c.valida_dal || '';
      $('valida_fino').value = c.valida_fino || '';
      $('copertura_geografica').value = c.copertura_geografica || 'NAZIONALE';
      $('link_esterno').value = c.link_esterno || '';
      $('immagine_url').value = c.immagine_url || '';
      $('logo_url').value = c.logo_url || '';
      $('attiva').checked = !!c.attiva;
      $('in_evidenza').checked = !!c.in_evidenza;
      $('contatto_tel').value = c.contatti?.telefono || '';
      $('contatto_email').value = c.contatti?.email || '';
      $('note').value = c.note || '';

      updatePreview('immagine_url','preview_img',128);
      updatePreview('logo_url','preview_logo',96);

      openModal('Modifica Convenzione', true);
    }

    // Salva
    $('form').addEventListener('submit', async function(e){
      e.preventDefault();
      const id = $('convId').value || null;

      const contatti = {};
      if($('contatto_tel').value.trim()) contatti.telefono = $('contatto_tel').value.trim();
      if($('contatto_email').value.trim()) contatti.email = $('contatto_email').value.trim();

      const payload = {
        nome_azienda: $('nome_azienda').value.trim(),
        categoria: $('categoria').value,
        descrizione: $('descrizione').value.trim(),
        sconto_percentuale: $('sconto_percentuale').value ? parseInt($('sconto_percentuale').value,10) : null,
        codice_sconto: $('codice_sconto').value.trim() || null,
        condizioni: $('condizioni').value.trim() || null,
        valida_dal: $('valida_dal').value || null,
        valida_fino: $('valida_fino').value || null,
        copertura_geografica: $('copertura_geografica').value,
        link_esterno: $('link_esterno').value.trim() || null,
        immagine_url: $('immagine_url').value.trim() || null,
        logo_url: $('logo_url').value.trim() || null,
        note: $('note').value.trim() || null,
        attiva: $('attiva').checked,
        in_evidenza: $('in_evidenza').checked,
        contatti: Object.keys(contatti).length ? contatti : null,
        updated_at: new Date().toISOString()
      };

      if(!payload.nome_azienda || !payload.categoria || !payload.descrizione){
        alert('Nome azienda, categoria e descrizione sono obbligatori'); return;
      }

      try{
        if(id){
          const { error } = await supabase.from('convenzioni').update(payload).eq('id', id);
          if(error) throw error;
        }else{
          const { error } = await supabase.from('convenzioni').insert([payload]);
          if(error) throw error;
        }
        closeModal();
        await load();
      }catch(err){
        console.error(err);
        alert('Errore salvataggio: ' + (err?.message||''));
      }
    });

    // Elimina
    $('deleteBtn').addEventListener('click', async function(){
      const id = $('convId').value; if(!id) return;
      if(!confirm('Eliminare definitivamente questa convenzione?')) return;
      try{
        const { error } = await supabase.from('convenzioni').delete().eq('id', id);
        if(error) throw error;
        closeModal();
        await load();
      }catch(err){
        console.error(err);
        alert('Errore eliminazione: ' + (err?.message||''));
      }
    });

    // Toggle attiva / evidenza
    async function toggleActive(id, newVal){
      try{
        const { error } = await supabase.from('convenzioni').update({ attiva:newVal, updated_at:new Date().toISOString() }).eq('id', id);
        if(error) throw error; await load();
      }catch(err){ console.error(err); alert('Errore stato: '+(err?.message||'')); }
    }
    async function toggleFeat(id, newVal){
      try{
        const { error } = await supabase.from('convenzioni').update({ in_evidenza:newVal, updated_at:new Date().toISOString() }).eq('id', id);
        if(error) throw error; await load();
      }catch(err){ console.error(err); alert('Errore evidenza: '+(err?.message||'')); }
    }

    // Bootstrap
    (async function(){
      const u = await guard(); if(!u) return;
      await load();
      setInterval(load, 10*60*1000); // auto refresh ogni 10 min
    })();
  </script>
</body>
</html>
