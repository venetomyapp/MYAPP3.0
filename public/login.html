<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accesso - MyApp</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CONFIGURAZIONE COLORI TAILWIND -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1a1a2e',
            secondary: '#16213e',
            accent: '#0f3460',
            aurora: '#e94560',
            cyan: '#00d4ff',
            magenta: '#ff006e',
            gold: '#ffd700',
            teal: '#03dac6',
            dark: '#0a0a23',
            light: '#f8fafc',
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --gradient-aurora:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-magic:linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
    }
    body{
      background:var(--gradient-aurora);
      background-size:400% 400%;
      animation:aurora 20s ease infinite;
      min-height:100vh;
    }
    @keyframes aurora{
      0%,100%{background-position:0% 50%}
      25%{background-position:100% 50%}
      50%{background-position:100% 100%}
      75%{background-position:0% 100%}
    }
    .auth-container{
      background:rgba(255,255,255,.95);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.3);
      box-shadow:0 25px 50px rgba(0,0,0,.25);
      border-radius:24px;
      max-width:28rem;
      width:100%;
      padding:3rem 2.5rem;
      margin:2rem;
    }
    .auth-header{text-align:center;margin-bottom:2.5rem}
    .auth-logo{font-size:4rem;margin-bottom:1rem;filter:drop-shadow(0 4px 8px rgba(0,0,0,.3))}
    .auth-title{font-size:2.5rem;font-weight:900;color:#1a1a2e;margin-bottom:.5rem;text-shadow:0 2px 4px rgba(0,0,0,.1)}
    .auth-subtitle{color:#64748b;font-size:1.1rem;font-weight:600}
    .auth-tabs{display:flex;background:#f1f5f9;border-radius:12px;padding:4px;margin-bottom:2rem}
    .auth-tab{flex:1;padding:12px 16px;border-radius:8px;font-weight:700;text-align:center;cursor:pointer;transition:.3s;border:none;background:transparent}
    .auth-tab.active{background:#fff;color:#1a1a2e;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .auth-tab:not(.active){color:#64748b}
    .auth-form{display:none}
    .auth-form.active{display:block}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
    .form-group{margin-bottom:1.25rem}
    .form-label{display:block;color:#374151;font-weight:600;margin-bottom:.5rem;font-size:.95rem}
    .form-input{width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;font-weight:500;transition:.2s;background:#fff}
    .form-input:focus{outline:none;border-color:#e94560;box-shadow:0 0 0 3px rgba(233,69,96,.1)}
    .btn-primary{width:100%;background:var(--gradient-magic);color:#fff;border:none;padding:16px 24px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;margin-bottom:1rem}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(233,69,96,.3)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .message{padding:12px 16px;border-radius:8px;margin-bottom:1rem;font-size:14px;font-weight:600;text-align:center;border:2px solid}
    .message-error{background:rgba(220,38,38,.1);color:#dc2626;border-color:rgba(220,38,38,.3)}
    .message-success{background:rgba(22,163,74,.1);color:#16a34a;border-color:rgba(22,163,74,.3)}
    .message-info{background:rgba(37,99,235,.1);color:#2563eb;border-color:rgba(37,99,235,.3)}
    .loading-spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;display:inline-block;margin-right:.5rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-overlay{position:fixed;inset:0;background:rgba(26,26,46,.8);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-content{background:#fff;padding:2rem;border-radius:16px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.25)}
    /* password toggle */
    .input-wrap{position:relative}
    .toggle-visibility{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      padding:.35rem .6rem;border-radius:.5rem;border:1px solid #e5e7eb;background:#fff;
      font-size:.85rem;font-weight:700;color:#374151;cursor:pointer;transition:.15s;
    }
    .toggle-visibility:hover{background:#f8fafc}
    /* privacy row */
    .privacy-row{
      display:flex;gap:.6rem;align-items:flex-start;margin:.5rem 0 1rem 0;
      font-size:.9rem;color:#374151;font-weight:600;line-height:1.35;
    }
    .privacy-row input{margin-top:.15rem}
    @media (max-width:640px){
      .auth-container{padding:2rem 1.5rem;margin:1rem;border-radius:20px;max-width:100%}
      .form-row{grid-template-columns:1fr}
    }
    /* focus super visibile */
    .focus-outline:focus{outline:3px solid #00d4ff;outline-offset:2px}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-content" role="alert" aria-live="polite">
      <div class="loading-spinner" style="width:40px;height:40px;margin:0 auto 1rem;"></div>
      <div class="text-lg font-semibold text-gray-800">Autenticazione in corso...</div>
      <div class="text-sm text-gray-600 mt-2">Attendere prego</div>
    </div>
  </div>

  <div class="auth-container" role="main" aria-labelledby="authTitle">
    <!-- HEADER -->
    <div class="auth-header">
      <div class="auth-logo" aria-hidden="true">üõ°Ô∏è</div>
      <h1 class="auth-title" id="authTitle">Accedi a MyApp</h1>
      <p class="auth-subtitle" id="authSubtitle">Sistema di autenticazione sicuro</p>
    </div>

    <!-- MESSAGGI (ARIA live) -->
    <div id="messageContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- TABS -->
    <div class="auth-tabs" role="tablist" aria-label="Seleziona modalit√† autenticazione">
      <button class="auth-tab active focus-outline" id="loginTab" role="tab" aria-selected="true" aria-controls="loginForm" onclick="switchToLogin()">Accedi</button>
      <button class="auth-tab focus-outline" id="registerTab" role="tab" aria-selected="false" aria-controls="registerForm" onclick="switchToRegister()">Registrati</button>
    </div>

    <!-- FORM LOGIN -->
    <form id="loginForm" class="auth-form active" role="tabpanel" aria-labelledby="loginTab">
      <div class="form-group">
        <label class="form-label" for="loginEmail">Email</label>
        <input type="email" id="loginEmail" class="form-input focus-outline" placeholder="La tua email"
               autocomplete="email" inputmode="email" required />
      </div>

      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <div class="input-wrap">
          <input type="password" id="loginPassword" class="form-input focus-outline pr-24"
                 placeholder="La tua password" autocomplete="current-password" required />
          <button type="button" class="toggle-visibility" aria-label="Mostra/Nascondi password" id="toggleLoginPwd">üëÅÔ∏é</button>
        </div>
      </div>

      <!-- PRIVACY LOGIN -->
      <div class="privacy-row">
        <input type="checkbox" id="loginPrivacy" class="focus-outline" />
        <label for="loginPrivacy">
          Ho letto e accetto l'<a href="privacy.html" target="_blank" class="underline text-aurora hover:opacity-80">Informativa Privacy</a>
        </label>
      </div>

      <button type="submit" id="loginBtn" class="btn-primary focus-outline" disabled>Accedi</button>

      <div class="text-center mt-4">
        <a href="recupero-password.html" class="text-sm font-semibold transition-colors" style="color:#e94560;">
          Password dimenticata?
        </a>
      </div>
    </form>

    <!-- FORM REGISTRAZIONE -->
    <form id="registerForm" class="auth-form" role="tabpanel" aria-labelledby="registerTab">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="registerNome">Nome *</label>
          <input type="text" id="registerNome" class="form-input focus-outline" placeholder="Il tuo nome" autocomplete="given-name" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="registerCognome">Cognome *</label>
          <input type="text" id="registerCognome" class="form-input focus-outline" placeholder="Il tuo cognome" autocomplete="family-name" required />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="registerEmail">Email *</label>
        <input type="email" id="registerEmail" class="form-input focus-outline" placeholder="La tua email" autocomplete="email" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="registerDataNascita">Data di Nascita *</label>
          <input type="date" id="registerDataNascita" class="form-input focus-outline" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="registerLuogoNascita">Luogo di Nascita *</label>
          <input type="text" id="registerLuogoNascita" class="form-input focus-outline" placeholder="Es. Roma (RM)" required />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="registerTelefono">Telefono</label>
        <input type="tel" id="registerTelefono" class="form-input focus-outline" placeholder="Il tuo numero di telefono" autocomplete="tel" />
      </div>

      <div class="form-group">
        <label class="form-label" for="registerPassword">Password *</label>
        <div class="input-wrap">
          <input type="password" id="registerPassword" class="form-input focus-outline pr-24"
                 placeholder="Crea una password sicura" autocomplete="new-password" required />
          <button type="button" class="toggle-visibility" aria-label="Mostra/Nascondi password" id="toggleRegPwd">üëÅÔ∏é</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirmPassword">Conferma Password *</label>
        <div class="input-wrap">
          <input type="password" id="confirmPassword" class="form-input focus-outline pr-24"
                 placeholder="Ripeti la password" autocomplete="new-password" required />
          <button type="button" class="toggle-visibility" aria-label="Mostra/Nascondi password" id="toggleRegConfirmPwd">üëÅÔ∏é</button>
        </div>
      </div>

      <!-- PRIVACY REGISTRAZIONE -->
      <div class="privacy-row">
        <input type="checkbox" id="registerPrivacy" class="focus-outline" />
        <label for="registerPrivacy">
          Ho letto e accetto l'<a href="privacy.html" target="_blank" class="underline text-aurora hover:opacity-80">Informativa Privacy</a>
        </label>
      </div>

      <button type="submit" id="registerBtn" class="btn-primary focus-outline" disabled>Registrati</button>

      <div class="text-center text-sm text-gray-600 mt-4">
        Registrandoti accetti i nostri termini di servizio
      </div>
    </form>

    <!-- LINK -->
    <div class="text-center mt-6">
      <a href="index.html" class="text-sm text-gray-600 hover:text-primary transition-colors focus-outline">‚Üê Torna alla homepage</a>
    </div>
  </div>

  <script>
    // === CONFIGURAZIONE SUPABASE ===
    const SUPABASE_URL = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const REMEMBER_PRIVACY = true; // imposta a false se NON vuoi ricordare l'accettazione

    let supabaseClient;
    let isProcessing = false;

    // === INIZIALIZZAZIONE ===
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üîê AUTH PAGE LOADED - MyApp v5.0+privacy');

      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('‚úÖ Supabase client inizializzato');

      // UI init
      initPasswordToggles();
      initPrivacyGates();
      initDynamicButtonStates();

      // Verifica sessione
      await checkExistingSession();

      // Setup listeners form
      setupFormListeners();

      console.log('‚úÖ Sistema di autenticazione pronto');
    });

    // === SESSIONE ESISTENTE ===
    async function checkExistingSession() {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error) {
          console.warn('‚ö†Ô∏è Errore controllo sessione:', error);
          return;
        }
        if (session?.user) {
          showLoadingOverlay();
          showMessage('Sessione attiva trovata. Reindirizzamento...', 'success');

          const { data: profile } = await supabaseClient
            .from('user_profiles')
            .select('role')
            .eq('user_id', session.user.id)
            .single();

          const redirectUrl = (profile?.role === 'ADMIN' || profile?.role === 'DIRIGENTE')
            ? 'home_dirigenti.html'
            : 'home.html';

          setTimeout(() => { window.location.href = redirectUrl; }, 1200);
        }
      } catch (e) {
        console.error('‚ùå Errore verifica sessione:', e);
      }
    }

    // === LISTENERS FORM ===
    function setupFormListeners() {
      const loginForm = document.getElementById('loginForm');
      if (loginForm) loginForm.addEventListener('submit', handleLogin);

      const registerForm = document.getElementById('registerForm');
      if (registerForm) registerForm.addEventListener('submit', handleRegister);

      // validazione conferma password live
      const confirmPassword = document.getElementById('confirmPassword');
      const registerPassword = document.getElementById('registerPassword');
      if (confirmPassword && registerPassword) {
        confirmPassword.addEventListener('input', function () {
          const same = registerPassword.value === confirmPassword.value;
          this.style.borderColor = same ? '#e5e7eb' : '#dc2626';
          this.style.boxShadow = same ? 'none' : '0 0 0 3px rgba(220,38,38,.1)';
        });
      }
    }

    // === TOGGLE PASSWORD ===
    function initPasswordToggles() {
      const bindToggle = (inputId, btnId) => {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if(!input || !btn) return;
        btn.addEventListener('click', () => {
          const isPwd = input.type === 'password';
          input.type = isPwd ? 'text' : 'password';
          btn.textContent = isPwd ? 'üôà' : 'üëÅÔ∏é';
          input.focus();
        });
      };
      bindToggle('loginPassword','toggleLoginPwd');
      bindToggle('registerPassword','toggleRegPwd');
      bindToggle('confirmPassword','toggleRegConfirmPwd');
    }

    // === PRIVACY CHECK (gating) ===
    function initPrivacyGates() {
      const loginPrivacy = document.getElementById('loginPrivacy');
      const registerPrivacy = document.getElementById('registerPrivacy');

      // precheck da localStorage
      if (REMEMBER_PRIVACY && localStorage.getItem('privacyAccepted') === 'true') {
        if (loginPrivacy) loginPrivacy.checked = true;
        if (registerPrivacy) registerPrivacy.checked = true;
      }

      const onChange = () => {
        if (REMEMBER_PRIVACY) {
          const accepted = (loginPrivacy?.checked || registerPrivacy?.checked) ? 'true' : 'false';
          localStorage.setItem('privacyAccepted', accepted);
        }
        updateButtonsEnabled();
      };

      if (loginPrivacy) loginPrivacy.addEventListener('change', onChange);
      if (registerPrivacy) registerPrivacy.addEventListener('change', onChange);
      updateButtonsEnabled();
    }

    // === DINAMIC ENABLE/DISABLE BOTTONI ===
    function initDynamicButtonStates() {
      const ids = ['loginEmail','loginPassword','registerNome','registerCognome','registerEmail','registerDataNascita','registerLuogoNascita','registerPassword','confirmPassword'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateButtonsEnabled);
      });
      updateButtonsEnabled();
    }

    function updateButtonsEnabled() {
      // login
      const loginEmail = document.getElementById('loginEmail')?.value.trim();
      const loginPassword = document.getElementById('loginPassword')?.value;
      const loginPrivacy = document.getElementById('loginPrivacy')?.checked;
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) loginBtn.disabled = !(loginEmail && loginPassword && loginPrivacy);

      // register (minimo gating privacy + campi base non vuoti)
      const nome = document.getElementById('registerNome')?.value.trim();
      const cognome = document.getElementById('registerCognome')?.value.trim();
      const email = document.getElementById('registerEmail')?.value.trim();
      const dn = document.getElementById('registerDataNascita')?.value;
      const ln = document.getElementById('registerLuogoNascita')?.value.trim();
      const pw = document.getElementById('registerPassword')?.value;
      const cpw = document.getElementById('confirmPassword')?.value;
      const regPrivacy = document.getElementById('registerPrivacy')?.checked;
      const okBase = nome && cognome && email && dn && ln && pw && cpw && (pw === cpw);
      const regBtn = document.getElementById('registerBtn');
      if (regBtn) regBtn.disabled = !(okBase && regPrivacy);
    }

    // === LOGIN ===
    async function handleLogin(e) {
      e.preventDefault();
      if (isProcessing) return;
      isProcessing = true;

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const privacyOk = document.getElementById('loginPrivacy').checked;

      if (!privacyOk) {
        showMessage('Devi accettare l‚ÄôInformativa Privacy per procedere.', 'error');
        isProcessing = false;
        return;
      }
      if (!email || !password) {
        showMessage('Inserisci email e password', 'error');
        isProcessing = false;
        return;
      }

      try {
        showLoadingButton('loginBtn', true);
        showMessage('Accesso in corso...', 'info');

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        if (!data.user) throw new Error('Errore durante l‚Äôautenticazione');

        // profilo per redirect
        const { data: profile, error: profileError } = await supabaseClient
          .from('user_profiles')
          .select('role, full_name')
          .eq('user_id', data.user.id)
          .single();

        if (profileError) {
          showMessage('Profilo non trovato. Contatta l‚Äôamministratore.', 'error');
          await supabaseClient.auth.signOut();
          return;
        }

        showMessage('Login effettuato con successo!', 'success');

        const redirectUrl = (profile?.role === 'ADMIN' || profile?.role === 'DIRIGENTE') ? 'home_dirigenti.html' : 'home.html';
        showLoadingOverlay();
        setTimeout(() => { window.location.href = redirectUrl; }, 1200);

      } catch (err) {
        console.error('‚ùå Errore login:', err);
        let msg = 'Errore durante il login';
        if (err.message?.includes('Invalid login credentials')) msg = 'Email o password non corretti';
        else if (err.message?.includes('Email not confirmed')) msg = 'Email non confermata. Controlla la posta.';
        else if (err.message) msg = err.message;
        showMessage(msg, 'error');
      } finally {
        showLoadingButton('loginBtn', false);
        isProcessing = false;
      }
    }

    // === REGISTRAZIONE ===
    async function handleRegister(e) {
      e.preventDefault();
      if (isProcessing) return;
      isProcessing = true;

      const nome = document.getElementById('registerNome').value.trim();
      const cognome = document.getElementById('registerCognome').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const dataNascita = document.getElementById('registerDataNascita').value;
      const luogoNascita = document.getElementById('registerLuogoNascita').value.trim();
      const telefono = document.getElementById('registerTelefono').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const privacyOk = document.getElementById('registerPrivacy').checked;

      if (!privacyOk) {
        showMessage('Devi accettare l‚ÄôInformativa Privacy per procedere.', 'error');
        isProcessing = false;
        return;
      }
      if (!nome || !cognome || !email || !dataNascita || !luogoNascita || !password) {
        showMessage('Compila tutti i campi obbligatori', 'error');
        isProcessing = false; return;
      }
      if (password !== confirmPassword) {
        showMessage('Le password non coincidono', 'error');
        isProcessing = false; return;
      }
      if (password.length < 6) {
        showMessage('La password deve essere di almeno 6 caratteri', 'error');
        isProcessing = false; return;
      }

      // maggiorenne
      const birth = new Date(dataNascita);
      const now = new Date();
      let age = now.getFullYear() - birth.getFullYear();
      const m = now.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--;
      if (age < 18) {
        showMessage('Devi essere maggiorenne per registrarti', 'error');
        isProcessing = false; return;
      }

      try {
        showLoadingButton('registerBtn', true);
        showMessage('Registrazione in corso...', 'info');

        // Registrazione con metadati incl. privacy
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: `${window.location.origin}/conferma-email.html`,
            data: {
              nome, cognome, data_nascita: dataNascita, luogo_nascita: luogoNascita, telefono,
              privacy_accepted_at: new Date().toISOString()
            }
          }
        });
        if (error) throw error;
        if (!data.user) throw new Error('Errore durante la registrazione');

        // profilo
        const { error: profileError } = await supabaseClient
          .from('user_profiles')
          .insert([{
            user_id: data.user.id,
            email, nome, cognome, full_name: `${nome} ${cognome}`,
            telefono: telefono || null,
            data_nascita: dataNascita,
            luogo_nascita: luogoNascita,
            role: 'USER',
            stato: 'ATTIVO'
          }]);
        if (profileError) console.error('‚ùå Errore creazione profilo:', profileError);

        // tessera
        const numeroTessera = await generateTesseraNumber();
        const { error: tesseraError } = await supabaseClient
          .from('tessere')
          .insert([{
            user_id: data.user.id,
            numero_tessera: numeroTessera,
            nome_completo: `${nome} ${cognome}`,
            email, telefono: telefono || null,
            data_emissione: new Date().toISOString().split('T')[0],
            data_scadenza: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
            stato: 'ATTIVA', tipo: 'STANDARD',
            qr_code_data: `MYAPP-${numeroTessera}-${data.user.id}`
          }]);
        if (tesseraError) console.error('‚ùå Errore creazione tessera:', tesseraError);

        if (data.user.email_confirmed_at) {
          showMessage('Registrazione completata! Reindirizzamento...', 'success');
          setTimeout(()=>{ window.location.href='home.html'; }, 1500);
        } else {
          showMessage('Registrazione completata! Controlla la tua email per confermare l‚Äôaccount.', 'success');
          setTimeout(()=>{ switchToLogin(); }, 2500);
        }

      } catch (err) {
        console.error('‚ùå Errore registrazione:', err);
        let msg = 'Errore durante la registrazione';
        if (err.message?.includes('already registered')) msg = 'Email gi√† registrata. Prova ad effettuare il login';
        else if (err.message?.includes('Password should be at least')) msg = 'La password deve essere di almeno 6 caratteri';
        else if (err.message?.includes('Invalid email')) msg = 'Formato email non valido';
        else if (err.message) msg = err.message;
        showMessage(msg,'error');
      } finally {
        showLoadingButton('registerBtn', false);
        isProcessing = false;
      }
    }

    // === GENERA NUMERO TESSERA ===
    async function generateTesseraNumber(){
      const year = new Date().getFullYear();
      const { count } = await supabaseClient.from('tessere').select('*',{ count:'exact', head:true });
      const nextNumber = (count || 0) + 1;
      return `MYAPP-${year}-${nextNumber.toString().padStart(4,'0')}`;
    }

    // === UI HELPERS ===
    function switchToLogin(){
      document.getElementById('loginTab').classList.add('active');
      document.getElementById('registerTab').classList.remove('active');
      document.getElementById('loginForm').classList.add('active');
      document.getElementById('registerForm').classList.remove('active');
      document.getElementById('authTitle').textContent='Accedi a MyApp';
      document.getElementById('authSubtitle').textContent='Sistema di autenticazione sicuro';
      clearMessages();
      updateButtonsEnabled();
      document.getElementById('loginEmail')?.focus();
    }
    function switchToRegister(){
      document.getElementById('loginTab').classList.remove('active');
      document.getElementById('registerTab').classList.add('active');
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('registerForm').classList.add('active');
      document.getElementById('authTitle').textContent='Registrati a MyApp';
      document.getElementById('authSubtitle').textContent='Crea il tuo account in pochi passi';
      clearMessages();
      updateButtonsEnabled();
      document.getElementById('registerNome')?.focus();
    }
    function showMessage(message,type='info'){
      const container=document.getElementById('messageContainer');
      const el=document.createElement('div');
      el.className=`message message-${type}`;
      el.textContent=message;
      container.innerHTML='';
      container.appendChild(el);
      if(type==='info'||type==='success'){
        setTimeout(()=>{ if(el.parentNode){ el.remove(); } },5000);
      }
    }
    function clearMessages(){ document.getElementById('messageContainer').innerHTML=''; }
    function showLoadingButton(buttonId,loading){
      const btn=document.getElementById(buttonId);
      if(!btn) return;
      if(loading){ btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span>Caricamento...'; }
      else{ btn.disabled=false; btn.textContent = (buttonId==='loginBtn')?'Accedi':'Registrati'; }
    }
    function showLoadingOverlay(){ document.getElementById('loadingOverlay').style.display='flex'; }
  </script>
</body>
</html>
