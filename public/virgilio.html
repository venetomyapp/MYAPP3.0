<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virgilio - MyApp</title>

  <!-- Favicon: robottino -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23e94560'/%3E%3Ccircle cx='22' cy='26' r='3' fill='white'/%3E%3Ccircle cx='42' cy='26' r='3' fill='white'/%3E%3Crect x='28' y='35' width='8' height='4' rx='2' fill='white'/%3E%3Cpath d='M20 45 Q32 50 44 45' stroke='white' stroke-width='2' fill='none'/%3E%3Crect x='15' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3Crect x='43' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3C/svg%3E">

  <!-- Tailwind (ok per test/dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a1a2e',
              secondary: '#16213e',
              accent: '#0f3460',
              aurora: '#e94560',
              cyan: '#00d4ff',
              magenta: '#ff006e',
              gold: '#ffd700',
              teal: '#03dac6',
              dark: '#0a0a23',
              light: '#f8fafc'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root{
      --gradient-bg: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --header-h: 56px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--gradient-bg);
      background-size:400% 400%;
      animation:grad 30s linear infinite;
      color:#111827;
      -webkit-font-smoothing:antialiased;
    }
    @keyframes grad{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

    .glass{background:rgba(255,255,255,.1);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12)}
    .card{background:#fff;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.12)}
    .chat-shell{height:calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bot) - 1rem)}

    @media (prefers-color-scheme:dark){
      .bot{background:#2d3748;color:#e2e8f0}
      .input{background:#2d3748;border-color:#475569;color:#e2e8f0}
      .status{background:#1f2937;color:#94a3b8}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="glass sticky top-0 z-40" style="height:var(--header-h);padding-top:var(--safe-top)">
    <div class="max-w-4xl mx-auto px-3 h-full flex items-center justify-between">
      <button onclick="history.back()" class="rounded-xl px-3 py-2 text-white hover:text-aurora transition">
        ‚Üê Indietro
      </button>
      <h1 class="text-white font-bold">Virgilio</h1>
      <div class="flex gap-2">
        <button id="clearChatBtn" class="text-sm rounded-md bg-white/90 px-3 py-1 hover:bg-white">üóëÔ∏è Pulisci</button>
        <button onclick="showHelp()" class="text-sm rounded-md bg-white/90 px-3 py-1 hover:bg-white">‚ùì Aiuto</button>
      </div>
    </div>
  </header>

  <!-- Loading overlay -->
  <div id="loading" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
    <div class="bg-white rounded-lg p-6 text-center shadow-xl">
      <div class="w-6 h-6 border-2 border-black/20 border-t-black rounded-full animate-spin mx-auto mb-3"></div>
      <p>Caricamento Virgilio‚Ä¶</p>
    </div>
  </div>

  <!-- Chat -->
  <main class="py-2">
    <div class="max-w-4xl mx-auto px-2">
      <div class="card chat-shell overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-aurora to-cyan text-white px-4 py-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-white/20 grid place-items-center text-xl">ü§ñ</div>
            <div>
              <div class="font-bold text-xl leading-tight">Virgilio</div>
              <div class="text-xs opacity-90">Assistente sindacale AI ‚Ä¢ Ricerca web (fonti istituzionali)</div>
            </div>
          </div>
        </div>

        <!-- Alerts -->
        <div id="alertContainer" class="px-3 pt-2"></div>

        <!-- Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto px-3 py-3 space-y-3">
          <div class="flex items-start gap-2">
            <div class="w-9 h-9 rounded-full bg-cyan grid place-items-center">ü§ñ</div>
            <div class="bot rounded-xl px-3 py-2 bg-gray-50 shadow-sm">
              <div>
                Ciao! Sono <strong>Virgilio</strong>. Posso aiutarti su disciplina, COM/TUOM, ferie/permessi, concorsi, licenze e molto altro.
                <br>Scrivi: <em>‚Äúdirigenti veneto‚Äù</em>, <em>‚Äúdirigenti provinciali Treviso‚Äù</em>, <em>‚Äúultime novit√† contratto 2025‚Äù</em>‚Ä¶
              </div>
              <div class="text-xs opacity-70 mt-1">Ora</div>
            </div>
          </div>
        </div>

        <!-- Typing -->
        <div id="typingIndicator" class="hidden px-3 pb-1">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-full bg-cyan grid place-items-center">ü§ñ</div>
            <div class="rounded-xl px-3 py-2 bg-gray-100">
              <span class="inline-block w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span>
              <span class="inline-block w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:.15s] ml-1"></span>
              <span class="inline-block w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:.3s] ml-1"></span>
            </div>
          </div>
        </div>

        <!-- Input -->
        <div class="border-t bg-gray-50 p-2">
          <div class="flex gap-2">
            <textarea id="messageInput" class="input w-full rounded-lg border-2 border-gray-200 px-3 py-2 resize-none min-h-[44px] max-h-[120px] outline-none focus:border-aurora" placeholder="‚ú® Scrivi la tua domanda‚Ä¶" rows="1" maxlength="500"></textarea>
            <button id="sendButton" class="rounded-lg bg-gradient-to-r from-aurora to-cyan text-white w-12 h-12 grid place-items-center disabled:opacity-50">‚û§</button>
          </div>
        </div>

        <!-- Status -->
        <div class="status border-t text-xs px-3 py-2 flex justify-between items-center">
          <div class="flex items-center gap-2"><span id="statusDot" class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span><span id="statusText">Connesso</span></div>
          <div>Token: <span id="tokenCount">0</span> ‚Ä¢ Caratteri: <span id="charCount">0</span>/500</div>
        </div>
      </div>
    </div>
  </main>

  <!-- App -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // üîê Supabase (pubblici/anon ‚Äî ok nel client)
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

    // üß† Config API (same-origin su Vercel)
    const CHATBOT_CONFIG = {
      apiEndpoint: '/api/chat',
      apiEndpointLocal: 'http://localhost:3001/api/chat',
      maxTokens: 650,
      temperature: 0.3,
      model: 'gpt-4o-mini',
      maxHistory: 10,
      retryAttempts: 3,
      retryDelay: 900
    };

    // Stato
    let conversationHistory = [];
    let isProcessing = false;
    let totalTokensUsed = 0;
    let dirigenti = [];

    // DOM
    const messagesContainer = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const tokenCount = document.getElementById('tokenCount');
    const charCount = document.getElementById('charCount');
    const alertContainer = document.getElementById('alertContainer');
    const loading = document.getElementById('loading');

    // Utils UI
    const showAlert=(msg,type='info')=>{
      const el=document.createElement('div');
      el.className='rounded-lg px-3 py-2 text-sm '+(type==='error'?'bg-red-50 text-red-700 border border-red-200':type==='success'?'bg-green-50 text-green-700 border border-green-200':'bg-blue-50 text-blue-700 border border-blue-200');
      el.textContent=msg; alertContainer.appendChild(el); setTimeout(()=>el.remove(),4500);
    };
    const updateConnectionStatus=(ok)=>{ statusDot.className='inline-block w-2 h-2 rounded-full '+(ok?'bg-emerald-500':'bg-red-500'); statusText.textContent= ok?'Connesso':'Offline'; };
    const syncOnlineStatus=()=>updateConnectionStatus(navigator.onLine);
    window.addEventListener('online',syncOnlineStatus); window.addEventListener('offline',syncOnlineStatus);
    const updateCharCount=()=>{ const c = messageInput.value.length; charCount.textContent=c; };
    const updateSendButton=()=>{ sendButton.disabled = !messageInput.value.trim() || isProcessing; };
    const autoResize=()=>{ messageInput.style.height='auto'; messageInput.style.height=Math.min(messageInput.scrollHeight,120)+'px'; };
    const scrollBottom=()=>{ messagesContainer.scrollTop=messagesContainer.scrollHeight; };
    const showTyping=()=>{ typingIndicator.classList.remove('hidden'); scrollBottom(); };
    const hideTyping=()=> typingIndicator.classList.add('hidden');
    const timeNow=()=> new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

    // Rendering messaggi
    function addMessage(content, type='bot', hasWeb=false){
      const wrap=document.createElement('div');
      wrap.className='flex items-start gap-2';
      const avatar=document.createElement('div');
      avatar.className='w-9 h-9 rounded-full grid place-items-center text-base '+(type==='user'?'bg-gradient-to-br from-aurora to-magenta text-white':'bg-cyan');
      avatar.textContent = type==='user'?'üë§':'‚ÑπÔ∏è';
      if(type==='bot') avatar.textContent='ü§ñ';

      const bubble=document.createElement('div');
      bubble.className='rounded-xl px-3 py-2 shadow-sm '+(type==='user'?'bg-gradient-to-r from-aurora to-magenta text-white':'bot bg-gray-50');
      if(hasWeb && type==='bot'){
        bubble.innerHTML=`<div class="inline-block text-[11px] font-semibold px-2 py-0.5 rounded-full bg-cyan/20 text-cyan-900 mb-1">üåê Ricerca Web</div><br>`+content+`<div class="text-xs opacity-70 mt-2">${timeNow()}</div>`;
      }else{
        bubble.innerHTML=content+`<div class="text-xs opacity-70 mt-2">${timeNow()}</div>`;
      }
      wrap.appendChild(avatar); wrap.appendChild(bubble);
      messagesContainer.appendChild(wrap);
      scrollBottom();
    }

    // HELP
    window.showHelp = function(){
      addMessage(
        'üÜò <strong>Aiuto</strong><br><br>'+
        'Esempi:<br>‚Ä¢ <em>dirigenti veneto</em> (mostra solo <strong>regionali</strong>)<br>'+
        '‚Ä¢ <em>dirigenti provinciali Treviso</em><br>'+
        '‚Ä¢ <em>ultime novit√† contratto 2025</em>', 'system'
      );
    };

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Dirigenti: normalizzazione / dedup / parsing ‚Äî‚Äî‚Äî‚Äî‚Äî
    const norm = s => (s||'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim();

    const EMAIL_FIXES = [
      [/@carabinieri\.nsc\b/i, '@carabinierinsc.it'],
      [/@carabinieri\.nsc\.it\b/i, '@carabinierinsc.it'],
      [/@carabinierinsc\.it\.it\b/i, '@carabinierinsc.it']
    ];
    const normalizeEmail = e => {
      let x=(e||'').trim(); EMAIL_FIXES.forEach(([r,rep])=> x=x.replace(r,rep)); return x.toLowerCase();
    };
    const sanitizeTelHref = t => (t||'').toString().replace(/[^\d+]/g,'');
    const cleanTelText = t => (t||'').toString().replace(/\s+/g,' ').trim();

    function dedupeDirigenti(list){
      const seen=new Set();
      return list.filter(d=>{
        const key=[norm(d.nome_cognome||d.nome||''), normalizeEmail(d.email||''), sanitizeTelHref(d.telefono||d.tel||'')].join('|');
        if(seen.has(key)) return false; seen.add(key); return true;
      });
    }

    const VENETO_PROV = ['belluno','padova','rovigo','treviso','venezia','verona','vicenza'];
    const guessProvincia = d => {
      const p = d.provincia || '';
      if(p) return p;
      const inRole = norm(d.ruolo||'');
      const hit = VENETO_PROV.find(pr => inRole.includes(pr));
      return hit ? hit.charAt(0).toUpperCase()+hit.slice(1) : '';
    };
    const guessRegione = d => d.regione || ((/veneto/i.test(d.ruolo||'')) ? 'Veneto' : '');

    function sortDirigenti(a,b){
      const level = s => /regional/i.test(s||'') ? 0 : /provincial/i.test(s||'') ? 1 : 2;
      const la=level(a.ruolo), lb=level(b.ruolo);
      if(la!==lb) return la-lb;
      const pa=norm(guessProvincia(a)||'zzz'), pb=norm(guessProvincia(b)||'zzz');
      if(pa!==pb) return pa.localeCompare(pb,'it');
      return (a.nome_cognome||'').localeCompare(b.nome_cognome||'','it');
    }

    function renderDirigenti(list, title='Dirigenti'){
      if(!list.length){ addMessage('Nessun risultato per questa selezione.', 'system'); return; }
      const rows=list.map(d=>{
        const nome = (d.nome_cognome || d.nome || '').trim();
        const ruolo = d.ruolo || '';
        const email = normalizeEmail(d.email || '');
        const telHref = sanitizeTelHref(d.telefono||d.tel||'');
        const telTxt = cleanTelText(d.telefono||d.tel||'');
        const prov = guessProvincia(d);
        const reg = guessRegione(d);
        return `‚Ä¢ <strong>${nome}</strong> ‚Äî ${ruolo}${reg?` (${reg})`:''}${prov?` ‚Äî ${prov}`:''} ‚Äî ${email?`<a href="mailto:${email}">${email}</a>`:''} ${telHref?`‚Äî <a href="tel:${telHref}">${telTxt||telHref}</a>`:''}`;
      }).join('<br><br>');
      addMessage(`<strong>${title}</strong><br><br>${rows}`, 'system');
    }

    function parseDirigentiQuery(t){
      const q=norm(t);
      if(!/\bdirigent/i.test(q)) return null;
      const mReg = q.match(/\b(veneto|lombardia|lazio|sicilia|puglia|piemonte|toscana|calabria|campania|emilia|friuli|liguria|marche|molise|sardegna|umbria|abruzzo|basilicata|trentino|aosta)\b/);
      const regione = mReg ? (mReg[1][0].toUpperCase()+mReg[1].slice(1)) : (/\bveneto\b/.test(q)?'Veneto':'');
      const mProv = q.match(/\b(belluno|padova|rovigo|treviso|venezia|verona|vicenza)\b/);
      const provincia = mProv ? (mProv[1][0].toUpperCase()+mProv[1].slice(1)) : '';
      let livello = '';
      if(/\bprovinciali?\b/.test(q)) livello='provinciale';
      if(/\bregional[ei]?\b/.test(q)) livello='regionale';
      return {livello, regione, provincia};
    }

    // Caricamento dirigenti
    async function loadDirigenti(){
      try{
        const { data, error } = await supabase.from('organico_dirigentisindacali').select('*').order('id',{ascending:true});
        if(error) throw error;
        dirigenti = data || [];
        console.log('‚úÖ Dirigenti caricati:', dirigenti.length);
      }catch(e){
        console.error('‚ùå Errore dirg:', e);
        dirigenti = []; // no fallback hardcoded per evitare dati obsoleti
      }
    }

    // Auth: SOLO loggati
    async function requireAuth(){
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session){ window.location.href='../login.html'; return null; }
        console.log('‚úÖ Utente autenticato:', session.user.email);
        return session.user;
      }catch(e){
        console.error('Auth err', e);
        window.location.href='../login.html';
        return null;
      }
    }

    // Send
    async function sendMessage(){
      const text = messageInput.value.trim();
      if(!text || isProcessing) return;
      isProcessing = true; updateSendButton();

      addMessage(text, 'user');
      conversationHistory.push({ role:'user', content:text });
      messageInput.value=''; updateCharCount(); autoResize();

      // ‚Äî‚Äî BLOCCO ‚ÄúDIRIGENTI‚Äù con logica migliorata
      const qInfo = parseDirigentiQuery(text);
      if(qInfo){
        const { livello, regione, provincia } = qInfo;

        if(!dirigenti.length){
          addMessage('Elenco dirigenti non disponibile in questo momento. Riprova pi√π tardi.', 'system');
          isProcessing=false; updateSendButton(); return;
        }
        if (!livello && !regione && !provincia){
          addMessage('Vuoi i contatti <strong>regionali</strong> o di una <strong>provincia</strong>? (es. "dirigenti provinciali Treviso")', 'system');
          isProcessing=false; updateSendButton(); return;
        }
        if ((livello==='provincale' || /provincia/i.test(text)) && !provincia){
          addMessage('Per i dirigenti <strong>provinciali</strong>, indica la <strong>provincia</strong> (es. "Treviso").', 'system');
          isProcessing=false; updateSendButton(); return;
        }

        let results;
        if (provincia){
          results = dirigenti.filter(d =>
            /provincial/i.test(d.ruolo||'') &&
            (!regione || norm(guessRegione(d)).includes(norm(regione))) &&
            ( norm(guessProvincia(d)).includes(norm(provincia)) )
          );
        } else if (regione && !livello){ // ‚Äúdirigenti veneto‚Äù => SOLO regionali
          results = dirigenti.filter(d =>
            /regional/i.test(d.ruolo||'') &&
            norm(guessRegione(d)).includes(norm(regione))
          );
        } else { // filtri diretti se specifica livello
          results = dirigenti.filter(d =>
            (!livello || (/regional/i.test(d.ruolo||'') && livello==='regionale') || (/provincial/i.test(d.ruolo||'') && livello==='provinciale')) &&
            (!regione || norm(guessRegione(d)).includes(norm(regione))) &&
            (!provincia || norm(guessProvincia(d)).includes(norm(provincia)))
          );
        }

        results = dedupeDirigenti(results).sort(sortDirigenti);

        let header='Dirigenti';
        if (provincia) header += ` provinciali ‚Äî Provincia di ${provincia}`;
        else if (regione && !livello) header += ` ‚Äî ${regione} (Regionali)`;
        else if (regione && livello) header += ` ${livello} ‚Äî ${regione}`;

        renderDirigenti(results.slice(0,30), header);
        if(regione && !livello && !provincia){
          addMessage('Vuoi vedere anche i <strong>provinciali</strong>? Scrivi: <em>‚Äúdirigenti provinciali Treviso‚Äù</em>.', 'system');
        }
        isProcessing=false; updateSendButton(); return;
      }
      // ‚Äî‚Äî FINE BLOCCO ‚ÄúDIRIGENTI‚Äù

      showTyping();
      try{
        let { data:{ session } } = await supabase.auth.getSession();
        if(!session) throw new Error('Sessione scaduta');

        const apiEndpoint = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? CHATBOT_CONFIG.apiEndpointLocal : CHATBOT_CONFIG.apiEndpoint;
        const needsWebSearch = /(?:\bultim[eaie]\b|\bnews\b|aggiornamenti|oggi|attuale|corrente|novit[√†a]|contratto\s*2025|aumenti|stipendio\s*2025)/i.test(text);

        const body = {
          messages: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory),
          model: CHATBOT_CONFIG.model,
          max_tokens: CHATBOT_CONFIG.maxTokens,
          temperature: CHATBOT_CONFIG.temperature,
          system_context: 'Sei Virgilio, assistente AI del Sindacato Carabinieri. Rispondi con rigore e cita le fonti ufficiali.',
          enable_web_search: needsWebSearch,
          web_search_query: needsWebSearch ? text : null
        };

        let lastErr=null;
        for(let i=0;i<CHATBOT_CONFIG.retryAttempts;i++){
          try{
            const r = await fetch(apiEndpoint,{
              method:'POST',
              headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
              body: JSON.stringify(body)
            });
            if(r.status===401 && i<CHATBOT_CONFIG.retryAttempts-1){
              const { data, error } = await supabase.auth.refreshSession();
              if(error || !data?.session) throw new Error('Token non valido o scaduto');
              session = data.session; continue;
            }
            if(!r.ok){
              const j = await r.json().catch(()=>null);
              throw new Error(j?.error || ('HTTP '+r.status));
            }
            const data = await r.json();
            const msg = data?.choices?.[0]?.message?.content || 'Nessuna risposta.';
            const hasWeb = !!data.web_search_performed;
            addMessage(msg, 'bot', hasWeb);
            conversationHistory.push({ role:'assistant', content: msg });
            if(data.usage){ totalTokensUsed += (data.usage.total_tokens || 0); tokenCount.textContent = totalTokensUsed.toLocaleString(); }
            lastErr=null; break;
          }catch(e){
            lastErr=e;
            await new Promise(r=>setTimeout(r, CHATBOT_CONFIG.retryDelay*(i+1)));
          }
        }
        if(lastErr) throw lastErr;
        syncOnlineStatus();
      }catch(e){
        console.error('Errore invio:', e);
        conversationHistory.pop();
        showAlert(/scadut/i.test(e.message)?'Sessione scaduta, riaccedi':
                  /invalid|expired|401/i.test(e.message)?'Token non valido o scaduto':
                  /network|fetch/i.test(e.message)?'Problema di rete, riprova':
                  e.message || 'Errore di connessione','error');
        syncOnlineStatus();
      }finally{
        hideTyping();
        isProcessing=false; updateSendButton(); messageInput.focus();
      }
    }

    // Check proxy rapido
    async function checkProxy(){
      try{
        const r = await fetch('/api/chat',{method:'OPTIONS'});
        if(r.status!==200 && r.status!==405) showAlert('Attenzione: /api/chat non √® raggiungibile ('+r.status+').','error');
      }catch{ showAlert('Impossibile contattare /api/chat (controlla il deploy).','error'); }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      loading.classList.remove('hidden');
      try{
        syncOnlineStatus();

        // SOLO UTENTI LOGGATI
        const user = await requireAuth();
        if(!user) return;

        await checkProxy();
        await loadDirigenti();

        messageInput.addEventListener('input', ()=>{ updateCharCount(); updateSendButton(); autoResize(); });
        messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
        sendButton.addEventListener('click', sendMessage);

        document.getElementById('clearChatBtn').addEventListener('click', ()=>{
          if(confirm('Vuoi davvero cancellare la conversazione?')){
            conversationHistory=[]; totalTokensUsed=0; tokenCount.textContent='0';
            [...messagesContainer.querySelectorAll('div')].forEach((el,i)=>{ if(i>0) el.remove(); });
            showAlert('Chat cancellata!','success');
          }
        });

        messageInput.focus(); updateSendButton();
        console.log('ü§ñ‚ú® Virgilio inizializzato!');
      }catch(e){
        console.error('Init err:', e);
        showAlert('Errore di inizializzazione. Ricarica la pagina.','error');
      }finally{
        loading.classList.add('hidden');
      }
    });

    // Error handlers
    window.addEventListener('error', e=>{ console.error('Errore JS:', e.error); showAlert('Si √® verificato un errore imprevisto','error'); });
    window.addEventListener('unhandledrejection', e=>{ console.error('Promise rejected:', e.reason); showAlert('Errore di rete o server','error'); });
  </script>
</body>
</html>
