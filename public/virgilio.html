<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virgilio - MyApp</title>

  <!-- Favicon: robottino -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23e94560'/%3E%3Ccircle cx='22' cy='26' r='4' fill='white'/%3E%3Ccircle cx='42' cy='26' r='4' fill='white'/%3E%3Crect x='26' y='36' width='12' height='5' rx='2.5' fill='white'/%3E%3Crect x='15' y='12' width='6' height='9' rx='3' fill='%2300d4ff'/%3E%3Crect x='43' y='12' width='6' height='9' rx='3' fill='%2300d4ff'/%3E%3C/svg%3E">

  <!-- Tailwind (ok per test/dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a1a2e',
              secondary: '#16213e',
              accent: '#0f3460',
              aurora: '#e94560',
              cyan: '#00d4ff',
              magenta: '#ff006e',
              gold: '#ffd700',
              teal: '#03dac6',
              dark: '#0a0a23',
              light: '#f8fafc'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root{
      --gradient-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
      --shadow-elevated: 0 10px 30px rgba(0,0,0,.18);
      --header-h: 60px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }
    *{margin:0; padding:0; box-sizing:border-box}
    html,body{height:100%}
    body{
      background: var(--gradient-bg);
      background-size: 400% 400%;
      animation: bgShift 28s ease-in-out infinite;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#111827;
      overflow-x:hidden;
    }
    @keyframes bgShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

    .header{
      position: sticky; top:0; z-index:40; height:var(--header-h);
      padding-top: var(--safe-top);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.15);
    }
    .back-button{
      width:42px; height:42px; border-radius:12px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.25);
      color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .back-button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.18) }

    .chat-shell{
      max-width: 980px; width: 100%;
      margin: 12px auto;
      padding: 0 10px;
    }
    .chat{
      background: #fff; border-radius: 18px; overflow: hidden; box-shadow: var(--shadow-elevated);
      display:flex; flex-direction:column; min-height: calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bot) - 24px);
    }
    .chat-head{
      background: linear-gradient(135deg, #e94560, #00d4ff);
      color:#fff; padding: 18px 16px; text-align:center;
    }
    .chat-log{
      flex:1; overflow-y:auto; padding: 14px; scroll-behavior:smooth; -webkit-overflow-scrolling:touch;
    }
    .chat-log::-webkit-scrollbar{width:6px}
    .chat-log::-webkit-scrollbar-thumb{background:#e94560; border-radius:3px}
    .msg{display:flex; gap:10px; margin: 12px 0; animation: fade .2s ease}
    @keyframes fade{from{opacity:0; transform: translateY(6px)}to{opacity:1; transform:none}}
    .msg .avatar{
      width:40px; height:40px; min-width:40px; min-height:40px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; color:#fff; font-size:18px;
    }
    .avatar-bot{ background: linear-gradient(135deg,#00d4ff,#03dac6)}
    .avatar-user{ background: linear-gradient(135deg,#e94560,#ff006e)}
    .avatar-sys{ background: linear-gradient(135deg,#ffd700,#ff8c00)}
    .bubble{
      max-width: 78%;
      background:#f8f9fb; border-radius: 14px; padding: 12px 14px; line-height:1.55; font-size: 0.98rem;
    }
    .bubble .time{opacity:.65; font-size:.78rem; margin-top:6px}
    .bubble.user{ background: linear-gradient(135deg,#e94560,#ff006e); color:#fff; border-bottom-right-radius:6px }
    .bubble.bot{ background:#f8f9fb; color:#1f2937; border-bottom-left-radius:6px }
    .bubble.sys{ background: linear-gradient(135deg,#ffd700,#ff8c00); color:#fff; border-bottom-left-radius:6px }
    .row-user{ flex-direction: row-reverse }

    .typing{ display:flex; gap:10px; align-items:center; margin: 6px 0 14px }
    .dots{ display:flex; gap:5px; background:#f8f9fb; padding:10px 14px; border-radius: 14px; border-bottom-left-radius: 6px }
    .dot{ width:8px; height:8px; border-radius:50%; background:#9aa3af; animation: bounce 1.3s infinite }
    .dot:nth-child(2){ animation-delay:.25s } .dot:nth-child(3){ animation-delay:.5s }
    @keyframes bounce{ 0%,60%,100%{transform:none} 30%{transform: translateY(-8px)} }

    .chat-input{
      border-top: 1px solid #e5e7eb; background:#f9fafb; padding: 10px; padding-bottom: calc(10px + var(--safe-bot));
    }
    .input-wrap{ display:flex; gap:10px; align-items:flex-end }
    textarea{
      flex:1; border:2px solid #e5e7eb; border-radius: 12px; padding: 12px;
      font: inherit; min-height: 48px; max-height: 120px; resize: none; outline: none; background: #fff;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    textarea:focus{ border-color:#e94560; box-shadow: 0 0 0 3px rgba(233,69,96,.12) }
    .send{
      width:48px; height:48px; min-width:48px; min-height:48px; border-radius: 12px; border: none; cursor: pointer;
      background: linear-gradient(135deg, #e94560, #00d4ff); color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 22px rgba(233,69,96,.28); transition: transform .12s ease, box-shadow .12s ease;
    }
    .send:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none }
    .send:not(:disabled):hover{ transform: translateY(-1px) }

    .status{
      display:flex; justify-content:space-between; align-items:center; font-size:.85rem; color:#6b7280;
      border-top:1px solid #e5e7eb; background:#f9fafb; padding: 8px 12px;
    }
    .dot-status{ width:10px; height:10px; border-radius:50%; background:#10b981 }
    .dot-status.off{ background:#ef4444 }

    .alert{ margin: 10px; padding: 10px; border-radius: 12px; font-weight: 600 }
    .alert.error{ background:#fef2f2; color:#b91c1c; border: 1px solid #fecaca }
    .alert.info{ background:#eef2ff; color:#1d4ed8; border: 1px solid #bfdbfe }

    .cta{ display:inline-block; margin-top:8px; padding: 8px 12px; border-radius: 10px; font-weight:700; text-decoration:none;
      background: #111827; color:#fff }
    .cta:hover{ filter:brightness(1.05) }

    @media (max-width: 780px){
      .bubble{ max-width: 88% }
      .chat-shell{ padding: 0 6px }
    }
    @media (max-width: 480px){
      :root{ --header-h: 54px }
      .chat{ border-radius: 14px }
      .bubble{ font-size: .95rem; padding: 10px 12px }
      .chat-head{ padding: 14px 10px }
    }
    @media (prefers-color-scheme: dark){
      .chat{ background:#0f172a; color:#e2e8f0 }
      .chat-head{ background: linear-gradient(135deg,#0ea5e9,#e11d48) }
      .bubble.bot{ background:#1f2937; color:#e5e7eb }
      .chat-input{ background:#0b1220; border-top-color:#132036 }
      textarea{ background:#0f172a; color:#e5e7eb; border-color:#1e293b }
      .status{ background:#0b1220; border-top-color:#132036; color:#9ca3af }
      .cta{ background:#e94560 }
    }
    *:focus-visible{ outline: 2px solid #e94560; outline-offset: 2px }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="max-w-5xl mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button class="back-button" onclick="history.back()" title="Torna indietro" aria-label="Torna indietro">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <h1 class="text-white font-semibold text-lg">Virgilio</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="clearBtn" class="px-3 py-2 text-sm rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20">üóëÔ∏è Pulisci</button>
        <button id="helpBtn"  class="px-3 py-2 text-sm rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20">‚ùì Aiuto</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="chat-shell">
    <section class="chat" role="application" aria-label="Chat Virgilio">
      <div class="chat-head">
        <div class="flex items-center justify-center gap-3">
          <span class="w-12 h-12 rounded-full bg-white/25 flex items-center justify-center text-2xl">ü§ñ</span>
          <div>
            <div class="text-xl font-bold">Virgilio</div>
            <div class="opacity-90 text-sm">Assistente sindacale AI ‚Ä¢ Ricerca web</div>
          </div>
        </div>
      </div>

      <div id="alertBox" class="px-3"></div>

      <div id="log" class="chat-log" role="log" aria-live="polite">
        <div class="msg">
          <div class="avatar avatar-bot">ü§ñ</div>
          <div class="bubble bot">
            Ciao! Sono <strong>Virgilio</strong>. Fai una domanda su contratti, diritti, concorsi, disciplina, ferie e molto altro.
            <div class="time">Ora</div>
          </div>
        </div>
      </div>

      <div id="typing" class="typing hidden">
        <div class="avatar avatar-bot">ü§ñ</div>
        <div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      </div>

      <div class="chat-input">
        <div class="input-wrap">
          <textarea id="input" rows="1" maxlength="600" placeholder="‚ú® Scrivi la tua domanda‚Ä¶"></textarea>
          <button id="send" class="send" disabled title="Invia" aria-label="Invia">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2L12 3 3 21l9-2zm0-0v-8"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="status">
        <div class="flex items-center gap-2"><span id="net" class="dot-status"></span><span id="netText">Connesso</span></div>
        <div class="opacity-80">Token: <span id="tk">0</span> ‚Ä¢ Caratteri: <span id="cc">0</span>/600</div>
      </div>
    </section>
  </main>

  <!-- App -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === CONFIG ===
    const SUPABASE_URL = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

    const API_CHAT = '/api/chat';
    const DIRIGENTI_PAGE = 'https://myapp31-j287nk69t-myapp30s-projects.vercel.app/dirigenti.html';

    // === STATE ===
    let isBusy = false;
    let history = [];
    let totalTokens = 0;

    // === DOM ===
    const $log = document.getElementById('log');
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');
    const $typing = document.getElementById('typing');
    const $alert = document.getElementById('alertBox');
    const $tk = document.getElementById('tk');
    const $cc = document.getElementById('cc');
    const $net = document.getElementById('net');
    const $netText = document.getElementById('netText');
    const $clear = document.getElementById('clearBtn');
    const $help = document.getElementById('helpBtn');

    // === UTIL ===
    const esc = (t) => {
      const d = document.createElement('div'); d.textContent = t; return d.innerHTML;
    };
    const fmt = (t) => esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
    const now = () => new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});

    function setOnline(ok){ $net.classList.toggle('off', !ok); $netText.textContent = ok ? 'Connesso' : 'Offline' }
    addEventListener('online', ()=>setOnline(true));
    addEventListener('offline', ()=>setOnline(false));
    setOnline(navigator.onLine);

    function showAlert(msg, type='info'){
      const el = document.createElement('div');
      el.className = `alert ${type}`;
      el.innerHTML = esc(msg);
      $alert.appendChild(el);
      setTimeout(()=> el.remove(), 4500);
    }

    function addMsg(text, role='bot'){
      const row = document.createElement('div');
      row.className = 'msg ' + (role==='user'?'row-user':'');
      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role==='user'?'avatar-user': role==='system'?'avatar-sys':'avatar-bot');
      avatar.textContent = role==='user'?'üë§' : role==='system'?'‚ÑπÔ∏è':'ü§ñ';
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role==='user'?'user': role==='system'?'sys':'bot');
      bubble.innerHTML = `<div>${role==='user'?esc(text):fmt(text)}</div><div class="time">${now()}</div>`;
      row.appendChild(avatar); row.appendChild(bubble);
      $log.appendChild(row);
      $log.scrollTop = $log.scrollHeight;
    }

    function typing(show){ $typing.classList.toggle('hidden', !show); if(show) $log.scrollTop = $log.scrollHeight; }
    function updateCounts(){ const c = $input.value.length; $cc.textContent = c; $send.disabled = !c || isBusy }

    // === LOGIN GATE ===
    async function ensureLoggedIn(){
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session){
        showAlert('Devi effettuare l‚Äôaccesso per usare Virgilio. Reindirizzamento‚Ä¶', 'error');
        location.href = '../login.html';
        throw new Error('Not authenticated');
      }
      return session;
    }

    // === HARD RULE: richieste "dirigenti" -> link e basta ===
    function isDirigentiQuery(text){
      return /dirigent/i.test(text) || /(contatti|referenti).*(sindacal|dirigent)/i.test(text);
    }
    function answerWithDirigentiLink(){
      const msg = `Per l‚Äôelenco aggiornato dei dirigenti visita la pagina ufficiale:<br>
      <a class="cta" href="${DIRIGENTI_PAGE}" target="_blank" rel="noopener">Apri la pagina Dirigenti</a>`;
      addMsg(msg, 'system');
    }

    // === SEND ===
    async function send(){
      const text = $input.value.trim();
      if(!text || isBusy) return;

      isBusy = true; updateCounts();

      addMsg(text, 'user');
      history.push({ role:'user', content:text });
      $input.value=''; updateCounts();

      // Se √® una richiesta sui dirigenti ‚Üí rispondi solo con il link e STOP
      if (isDirigentiQuery(text)) {
        answerWithDirigentiLink();
        isBusy = false; updateCounts(); return;
      }

      typing(true);
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session) throw new Error('Sessione scaduta');

        const payload = {
          messages: history.slice(-12),
          model: 'gpt-4o-mini',
          max_tokens: 650,
          temperature: 0.3,
          system_context: 'Sei Virgilio, assistente sindacale. Rispondi in italiano in modo chiaro, cita fonti ufficiali quando presenti.'
        };

        const r = await fetch(API_CHAT, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer ' + session.access_token
          },
          body: JSON.stringify(payload)
        });

        if(!r.ok){
          let msg = 'Errore server ('+r.status+')';
          try{ const j = await r.json(); if(j?.error) msg = j.error }catch{}
          throw new Error(msg);
        }
        const j = await r.json();
        const content = j?.choices?.[0]?.message?.content || 'Nessuna risposta.';
        addMsg(content, 'bot');
        history.push({ role:'assistant', content });

        if (j?.usage?.total_tokens){ totalTokens += j.usage.total_tokens; $tk.textContent = totalTokens.toLocaleString('it-IT') }
      }catch(e){
        console.error(e);
        showAlert(e.message || 'Errore di rete', 'error');
      }finally{
        typing(false);
        isBusy = false; updateCounts(); $input.focus();
      }
    }

    // === INIT ===
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        await ensureLoggedIn();
      }catch{ return }

      // wire
      $input.addEventListener('input', ()=>{
        // autoresize
        $input.style.height = 'auto';
        $input.style.height = Math.min($input.scrollHeight, 120) + 'px';
        updateCounts();
      });
      $input.addEventListener('keydown', e=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });
      $send.addEventListener('click', send);

      $clear.addEventListener('click', ()=>{
        if(confirm('Vuoi cancellare la conversazione?')){
          history = []; totalTokens = 0; $tk.textContent = '0';
          [...$log.querySelectorAll('.msg')].slice(1).forEach(n=>n.remove()); // lascia il messaggio di benvenuto
          showAlert('Chat cancellata ‚úÖ','info');
        }
      });

      $help.addEventListener('click', ()=>{
        addMsg(
          'Suggerimenti: chiedi su ferie, malattia, disciplina, concorsi, pensioni, TULPS, CdS, COM/TUOM. ' +
          'Per l‚Äôelenco dirigenti usa: ‚Äúdirigenti veneto‚Äù, ‚Äúdirigenti Treviso‚Äù, ecc. ' +
          'Ti risponder√≤ con il link ufficiale alla pagina Dirigenti.',
          'system'
        );
      });

      // ping rapido del proxy (facoltativo)
      try {
        const opt = await fetch(API_CHAT, { method:'OPTIONS' });
        if (opt.status !== 200 && opt.status !== 405) {
          showAlert('Attenzione: /api/chat non √® raggiungibile ('+opt.status+').', 'error');
        }
      } catch {
        showAlert('Impossibile contattare /api/chat (controlla il deploy).', 'error');
      }

      $input.focus(); updateCounts();
      console.log('ü§ñ‚ú® Virgilio pronto.');
    });

    // error surfaces
    addEventListener('error', (e)=>{ console.error(e.error || e.message); showAlert('Si √® verificato un errore inatteso','error') });
    addEventListener('unhandledrejection', (e)=>{ console.error(e.reason); showAlert('Errore di rete o server','error') });
  </script>
</body>
</html>
