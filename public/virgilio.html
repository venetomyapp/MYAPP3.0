<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0"/>
  <title>Virgilio - MyApp</title>

  <!-- Favicon: robottino -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23e94560'/%3E%3Ccircle cx='22' cy='26' r='3' fill='white'/%3E%3Ccircle cx='42' cy='26' r='3' fill='white'/%3E%3Crect x='28' y='35' width='8' height='4' rx='2' fill='white'/%3E%3Cpath d='M20 45 Q32 50 44 45' stroke='white' stroke-width='2' fill='none'/%3E%3Crect x='15' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3Crect x='43' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3C/svg%3E">

  <!-- Tailwind (dev/test) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              aurora: '#e94560'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root{
      --gradient: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --header-h: 60px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{
      min-height:100vh;background:var(--gradient);background-size:400% 400%;
      animation:bg 30s ease infinite;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
    }
    @keyframes bg{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .header{position:sticky;top:0;height:var(--header-h);padding-top:var(--safe-top);
      background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.12);z-index:50}
    .chat{background:#fff;border-radius:18px;box-shadow:0 8px 25px rgba(0,0,0,.15);
      max-width:960px;margin:.75rem auto;height:calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1.5rem);
      display:flex;flex-direction:column;overflow:hidden}
    .msgs{flex:1;overflow:auto;padding:1rem}
    .row{display:flex;gap:.75rem;margin-bottom:1rem;animation:fade .2s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .av{width:38px;height:38px;border-radius:9999px;display:grid;place-items:center;color:#fff;flex:0 0 38px}
    .av-bot{background:linear-gradient(135deg,#00d4ff,#03dac6)}
    .av-user{background:linear-gradient(135deg,#e94560,#ff006e)}
    .bub{max-width:78%;padding:1rem;border-radius:14px}
    .b-bot{background:#f8fbff;border:1px solid #e5e7eb}
    .b-user{background:linear-gradient(135deg,#e94560,#ff006e);color:#fff;margin-left:auto}
    .time{font-size:.75rem;opacity:.6;margin-top:.35rem}
    .cta{display:inline-block;background:#111827;color:#fff!important;padding:.75rem 1rem;border-radius:.75rem;
      font-weight:700;margin-top:.5rem;text-decoration:none}
    .cta:hover{opacity:.9}
    .dots{display:flex;gap:.4rem}
    .dot{width:8px;height:8px;border-radius:9999px;background:#9ca3af;animation:b 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{transform:none}40%{transform:translateY(-6px)}}
    .input-area{background:#f9fafb;border-top:1px solid #e5e7eb;padding:1rem}
    .input-container{display:flex;gap:.5rem;align-items:flex-end}
    .input-field{flex:1;border:2px solid #e5e7eb;border-radius:12px;padding:12px 16px;outline:none;resize:none;
      font-size:14px;transition:border-color 0.2s ease;max-height:120px;min-height:44px}
    .input-field:focus{border-color:#e94560;box-shadow:0 0 0 3px rgba(233,69,96,0.1)}
    .send-btn{background:linear-gradient(135deg,#e94560,#ff006e);color:white;border:none;border-radius:10px;
      padding:12px 20px;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .send-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(233,69,96,0.3)}
    .send-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .connection-status{padding:8px 16px;font-size:12px;color:#6b7280;border-top:1px solid #e5e7eb;
      display:flex;justify-content:space-between;align-items:center;background:#f9fafb}
    .status-indicator{display:inline-flex;align-items:center;gap:4px}
    .status-dot{width:6px;height:6px;border-radius:50%;background:#10b981}
    .status-dot.offline{background:#ef4444}
    .status-dot.connecting{background:#f59e0b;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @media (max-width:640px){.chat{margin:.5rem;height:calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1rem)}.bub{max-width:90%}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="max-w-5xl mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button onclick="history.back()" class="rounded-xl px-2 py-2 border border-white/30 text-white hover:bg-white/10" type="button" aria-label="Indietro">‚üµ</button>
        <h1 class="text-white font-semibold">Virgilio</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="clear" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">üóëÔ∏è Pulisci</button>
        <button id="help" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">‚ùì Aiuto</button>
        <button onclick="window.location.href='home.html'" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">üè† Home</button>
      </div>
    </div>
  </header>

  <main class="py-3">
    <div class="chat">
      <!-- Header del bot -->
      <div class="bg-gradient-to-r from-aurora to-cyan-400 text-white px-4 py-4 text-center">
        <div class="flex items-center justify-center gap-3">
          <div class="w-11 h-11 bg-white/25 rounded-full grid place-items-center text-2xl">ü§ñ</div>
          <div class="text-left">
            <div class="font-bold text-xl">Virgilio</div>
            <div class="text-sm opacity-90">Assistente sindacale AI</div>
          </div>
        </div>
      </div>

      <!-- Area messaggi -->
      <div id="msgs" class="msgs" role="log" aria-live="polite">
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot">
            Ciao! Sono <strong>Virgilio</strong>, l'assistente AI del SIM Carabinieri. Posso aiutarti con domande su contratti, diritti sindacali, disciplina, ferie, concorsi e molto altro.
            <div class="time" id="welcome-time">Caricamento...</div>
          </div>
        </div>
      </div>

      <!-- Indicatore di digitazione -->
      <div id="typing" class="px-4 py-2 hidden">
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
        </div>
      </div>

      <!-- Area input -->
      <div class="input-area">
        <div class="input-container">
          <textarea 
            id="messageInput" 
            class="input-field" 
            placeholder="‚ú® Scrivi la tua domanda su sindacato, contratti, diritti..."
            rows="1"
            maxlength="500"></textarea>
          <button id="sendBtn" class="send-btn" disabled>Invia</button>
        </div>
      </div>

      <!-- Status bar -->
      <div class="connection-status">
        <div class="status-indicator">
          <div id="statusDot" class="status-dot"></div>
          <span id="statusText">Connesso</span>
        </div>
        <div class="text-right">
          <span>Caratteri: <span id="charCount">0</span>/500</span>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configurazione
    const BOTPRESS_API_URL = 'https://api.botpress.cloud/v1/chat/messages';
    const BOT_ID = 'your-bot-id'; // Sostituire con l'ID reale del bot
    const BOTPRESS_TOKEN = 'your-bot-token'; // Sostituire con il token reale

    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk',
      { auth: { persistSession: true, autoRefreshToken: true } }
    );

    // Elementi DOM
    const msgs = document.getElementById('msgs');
    const typing = document.getElementById('typing');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const charCount = document.getElementById('charCount');
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const helpBtn = document.getElementById('help');
    const clearBtn = document.getElementById('clear');

    let isProcessing = false;
    let conversationId = null;

    // Utility functions
    const timeNow = () => new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
    
    function setStatus(status, text) {
      statusDot.className = `status-dot ${status}`;
      statusText.textContent = text;
    }

    function addMessage(content, isUser = false, isHTML = false) {
      const row = document.createElement('div');
      row.className = 'row';
      
      const avatar = document.createElement('div');
      avatar.className = `av ${isUser ? 'av-user' : 'av-bot'}`;
      avatar.textContent = isUser ? 'üë§' : 'ü§ñ';
      
      const bubble = document.createElement('div');
      bubble.className = `bub ${isUser ? 'b-user' : 'b-bot'}`;
      
      if (isHTML) {
        bubble.innerHTML = content;
      } else {
        bubble.textContent = content;
      }
      
      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = timeNow();
      bubble.appendChild(time);
      
      row.appendChild(avatar);
      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function setTyping(show) {
      typing.classList.toggle('hidden', !show);
      if (show) msgs.scrollTop = msgs.scrollHeight;
    }

    // Botpress API integration
    async function sendToBotpress(message) {
      try {
        setStatus('connecting', 'Inviando...');
        
        const response = await fetch(BOTPRESS_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${BOTPRESS_TOKEN}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            botId: BOT_ID,
            message: {
              type: 'text',
              payload: { text: message }
            },
            conversationId: conversationId || undefined
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        // Store conversation ID for future messages
        if (data.conversationId && !conversationId) {
          conversationId = data.conversationId;
        }

        setStatus('', 'Connesso');
        return data.responses || [];
        
      } catch (error) {
        console.error('Botpress API Error:', error);
        setStatus('offline', 'Errore connessione');
        throw error;
      }
    }

    // Event handlers
    messageInput.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = length;
      sendBtn.disabled = length === 0 || isProcessing;
      
      // Auto-resize textarea
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || isProcessing) return;

      isProcessing = true;
      sendBtn.disabled = true;
      
      // Add user message
      addMessage(message, true);
      
      // Clear input
      messageInput.value = '';
      charCount.textContent = '0';
      messageInput.style.height = 'auto';

      try {
        setTyping(true);
        
        const responses = await sendToBotpress(message);
        
        setTyping(false);
        
        // Handle bot responses
        if (responses.length > 0) {
          responses.forEach(response => {
            if (response.type === 'text') {
              addMessage(response.payload.text, false, true);
            }
          });
        } else {
          addMessage('Mi dispiace, non sono riuscito a elaborare la tua richiesta. Riprova.', false);
        }
        
      } catch (error) {
        setTyping(false);
        addMessage('Si √® verificato un errore di connessione. Verifica la tua connessione internet e riprova.', false);
      } finally {
        isProcessing = false;
        sendBtn.disabled = messageInput.value.trim() === '';
        messageInput.focus();
      }
    }

    helpBtn.addEventListener('click', function() {
      addMessage('Posso aiutarti con: contratti di lavoro, diritti sindacali, disciplina, ferie e permessi, stipendi, concorsi, pensioni, normative e regolamenti. Prova a chiedermi: "Come funzionano i permessi per malattia?" oppure "Quali sono i miei diritti sindacali?"', false);
    });

    clearBtn.addEventListener('click', function() {
      if (!confirm('Vuoi cancellare tutta la conversazione?')) return;
      
      // Clear messages except welcome
      msgs.innerHTML = `
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot">
            Ciao! Sono <strong>Virgilio</strong>, l'assistente AI del SIM Carabinieri. Posso aiutarti con domande su contratti, diritti sindacali, disciplina, ferie, concorsi e molto altro.
            <div class="time">${timeNow()}</div>
          </div>
        </div>
      `;
      
      // Reset conversation
      conversationId = null;
    });

    // Authentication check
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'ofline.html';
        return false;
      }
      return true;
    }

    // Connection status monitoring
    window.addEventListener('online', () => setStatus('', 'Connesso'));
    window.addEventListener('offline', () => setStatus('offline', 'Offline'));

    // Initialize
    document.getElementById('welcome-time').textContent = timeNow();
    messageInput.focus();
    
    // Check authentication
    checkAuth();
  </script>
</body>
</html>
