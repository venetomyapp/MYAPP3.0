<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0"/>
  <title>Virgilio - MyApp</title>

  <!-- Favicon: robottino -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23e94560'/%3E%3Ccircle cx='22' cy='26' r='3' fill='white'/%3E%3Ccircle cx='42' cy='26' r='3' fill='white'/%3E%3Crect x='28' y='35' width='8' height='4' rx='2' fill='white'/%3E%3Cpath d='M20 45 Q32 50 44 45' stroke='white' stroke-width='2' fill='none'/%3E%3Crect x='15' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3Crect x='43' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3C/svg%3E">

  <!-- Tailwind (dev/test) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              aurora: '#e94560'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root{
      --gradient: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --header-h: 60px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{
      min-height:100vh;background:var(--gradient);background-size:400% 400%;
      animation:bg 30s ease infinite;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
    }
    @keyframes bg{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .header{position:sticky;top:0;height:var(--header-h);padding-top:var(--safe-top);
      background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.12)}
    .chat{background:#fff;border-radius:18px;box-shadow:0 8px 25px rgba(0,0,0,.15);
      max-width:960px;margin:.75rem auto;height:calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1.5rem);
      display:flex;flex-direction:column;overflow:hidden}
    .msgs{flex:1;overflow:auto;padding:1rem}
    .row{display:flex;gap:.75rem;margin-bottom:1rem;animation:fade .2s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .av{width:38px;height:38px;border-radius:9999px;display:grid;place-items:center;color:#fff;flex:0 0 38px}
    .av-bot{background:linear-gradient(135deg,#00d4ff,#03dac6)}
    .av-user{background:linear-gradient(135deg,#e94560,#ff006e)}
    .bub{max-width:78%;padding:1rem;border-radius:14px}
    .b-bot{background:#f8fbff}
    .b-user{background:linear-gradient(135deg,#e94560,#ff006e);color:#fff;margin-left:auto}
    .time{font-size:.75rem;opacity:.6;margin-top:.35rem}
    .cta{display:inline-block;background:#111827;color:#fff!important;padding:.75rem 1rem;border-radius:.75rem;
      font-weight:700;margin-top:.5rem;text-decoration:none}
    .cta:hover{opacity:.9}
    .dots{display:flex;gap:.4rem}
    .dot{width:8px;height:8px;border-radius:9999px;background:#9ca3af;animation:b 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{transform:none}40%{transform:translateY(-6px)}}
    @media (max-width:640px){.chat{margin:.5rem;height:calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1rem)}.bub{max-width:90%}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="max-w-5xl mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button onclick="history.back()" class="rounded-xl px-2 py-2 border border-white/30 text-white hover:bg-white/10" type="button" aria-label="Indietro">‚üµ</button>
        <h1 class="text-white font-semibold">Virgilio</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="test-r2" class="px-3 py-1.5 rounded-lg bg-yellow-500/20 text-white text-sm border border-yellow-500/30 hover:bg-yellow-500/30" type="button">üß™ Test R2</button>
        <button id="clear" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">üóëÔ∏è Pulisci</button>
        <button id="help" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">‚ùì Aiuto</button>
      </div>
    </div>
  </header>

  <main class="py-3">
    <div class="chat">
      <div class="bg-gradient-to-r from-aurora to-cyan-400 text-white px-4 py-4 text-center">
        <div class="flex items-center justify-center gap-3">
          <div class="w-11 h-11 bg-white/25 rounded-full grid place-items-center text-2xl">ü§ñ</div>
          <div class="text-left">
            <div class="font-bold text-xl">Virgilio</div>
            <div class="text-sm opacity-90">Assistente sindacale AI</div>
          </div>
        </div>
      </div>

      <div id="msgs" class="msgs" role="log" aria-live="polite">
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot">
            Ciao! Sono <strong>Virgilio</strong>. Fai una domanda su contratti, diritti, concorsi, disciplina, ferie e molto altro.
            <div class="time">Ora</div>
          </div>
        </div>
      </div>

      <!-- typing -->
      <div id="typing" class="px-4 py-2 hidden">
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
        </div>
      </div>

      <!-- Input -->
      <div class="p-3 border-t bg-gray-50">
        <div class="max-w-3xl mx-auto flex gap-2">
          <textarea id="inp" rows="1" maxlength="500" class="flex-1 rounded-xl border px-3 py-2 outline-none focus:ring-2 focus:ring-aurora" placeholder="‚ú® Scrivi la tua domanda‚Ä¶"></textarea>
          <button id="send" class="rounded-xl bg-aurora text-white px-4 py-2 font-semibold disabled:opacity-50" disabled>Invia</button>
        </div>
      </div>

      <div class="px-4 py-2 text-xs text-gray-500 border-t flex items-center justify-between">
        <div id="conn">Connesso</div>
        <div>Token: <span id="tok">0</span> ‚Ä¢ Caratteri: <span id="chars">0</span>/500</div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase (login obbligatorio)
    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk',
      { auth: { persistSession:true, autoRefreshToken:true } }
    );

    const API_CHAT = '/api/chat';
    const DIRIGENTI_URL = `${window.location.origin}/dirigenti.html`;

    const msgs = document.getElementById('msgs');
    const typing = document.getElementById('typing');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    const tok = document.getElementById('tok');
    const chars = document.getElementById('chars');
    const conn = document.getElementById('conn');
    const help = document.getElementById('help');
    const clear = document.getElementById('clear');
    const testR2 = document.getElementById('test-r2');

    let isProcessing=false, totalTokens=0, history=[];

    // ===== DEBUG PANEL =====
    function addDebugMessage(message, type = 'info') {
      const debugRow = document.createElement('div');
      debugRow.className = 'row';
      const debugAv = document.createElement('div');
      debugAv.className = 'av av-bot';
      debugAv.textContent = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîç';
      debugAv.style.background = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#6b7280';
      
      const debugBub = document.createElement('div');
      debugBub.className = 'bub b-bot';
      debugBub.style.background = '#f3f4f6';
      debugBub.style.fontSize = '0.8rem';
      debugBub.style.fontFamily = 'monospace';
      debugBub.innerHTML = `<strong>[DEBUG]</strong> ${message}<div class="time">${timeNow()}</div>`;
      
      debugRow.appendChild(debugAv);
      debugRow.appendChild(debugBub);
      msgs.appendChild(debugRow);
      msgs.scrollTop = msgs.scrollHeight;
    }

    // ===== INTEGRAZIONE R2 - INIZIO =====
    
    // Ricerca nei documenti R2
    async function searchR2Documents(query) {
      try {
        const url = `/api/search?q=${encodeURIComponent(query)}`;
        addDebugMessage(`üåê Chiamata: ${url}`);
        
        const response = await fetch(url);
        addDebugMessage(`üì° Status: ${response.status} ${response.statusText}`);
        
        const data = await response.json();
        addDebugMessage(`üì¶ Dati ricevuti: ${JSON.stringify(data).substring(0, 200)}...`);
        
        if (!response.ok) {
          addDebugMessage(`‚ùå Errore API: ${data.error || 'Errore sconosciuto'}`, 'error');
          return null;
        }
        
        return data;
      } catch (e) {
        addDebugMessage(`‚ùå Errore rete: ${e.message}`, 'error');
        return null;
      }
    }

    // Legge documento specifico
    async function readR2Document(fileName) {
      try {
        const url = `/api/read?key=${encodeURIComponent(fileName)}`;
        addDebugMessage(`üìñ Leggo: ${url}`);
        
        const response = await fetch(url);
        addDebugMessage(`üì° Read Status: ${response.status}`);
        
        const data = await response.json();
        
        if (!response.ok) {
          addDebugMessage(`‚ùå Errore lettura: ${data.error}`, 'error');
          return null;
        }
        
        addDebugMessage(`‚úÖ File letto: ${data.content?.length || 0} caratteri`, 'success');
        return data;
      } catch (e) {
        addDebugMessage(`‚ùå Errore rete lettura: ${e.message}`, 'error');
        return null;
      }
    }

    // Ricerca web di fallback
    async function searchWeb(query) {
      try {
        const response = await fetch('/api/web-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query + ' sindacato carabinieri normativa' })
        });
        if (!response.ok) return null;
        const data = await response.json();
        return data;
      } catch (e) {
        console.error('Errore ricerca web:', e);
        return null;
      }
    }

    // Rileva se la domanda richiede ricerca documenti
    function needsDocumentSearch(text) {
      const keywords = [
        'decreto', 'legge', 'normativa', 'regolamento', 'circolare',
        'disposizione', 'ordinanza', 'delibera', 'documento', 'testo',
        'veterano', 'missioni', 'internazionali', 'difesa', 'articolo',
        'comma', 'capitolo', 'sezione', 'allegato', 'status'
      ];
      const textLower = text.toLowerCase();
      const matches = keywords.filter(keyword => textLower.includes(keyword));
      
      const needsSearch = matches.length > 0;
      addDebugMessage(`üîç Rilevazione ricerca documenti: "${text}" ‚Üí ${needsSearch ? 'S√å' : 'NO'}`);
      if (matches.length > 0) {
        addDebugMessage(`üéØ Keywords trovate: ${matches.join(', ')}`);
      }
      
      return needsSearch;
    }

    // Estrae parole chiave per la ricerca
    function extractSearchKeywords(text) {
      const stopWords = ['il', 'la', 'di', 'che', 'e', 'un', 'una', 'per', 'del', 'dei', 'cosa', 'come', 'quando', 'dove', 'perch√©'];
      return text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 2 && !stopWords.includes(word))
        .slice(0, 3);
    }

    // Cerca nei documenti R2 e in rete se necessario
    async function prepareDocumentContext(userMessage) {
      const keywords = extractSearchKeywords(userMessage);
      let documentContext = '';
      let sourceInfo = '';
      let foundInDocuments = false;
      
      addDebugMessage(`Inizio ricerca documenti per: "${userMessage}"`);
      addDebugMessage(`Keywords estratte: ${keywords.join(', ')}`);
      
      // Prima cerca nei documenti R2
      for (const keyword of keywords) {
        addDebugMessage(`üîç Cerco "${keyword}" in R2...`);
        
        try {
          const searchResult = await searchR2Documents(keyword);
          addDebugMessage(`Risposta API search: ${searchResult ? 'OK' : 'NULL'}`);
          
          if (searchResult?.results?.length > 0) {
            foundInDocuments = true;
            addDebugMessage(`‚úÖ Trovati ${searchResult.results.length} documenti`, 'success');
            
            for (const result of searchResult.results.slice(0, 3)) {
              addDebugMessage(`üìÑ Documento: ${result.key} (${result.size} bytes)`);
              
              // Per file di testo, leggi il contenuto
              if (result.key.endsWith('.txt') || result.key.endsWith('.md')) {
                addDebugMessage(`üìñ Tento lettura contenuto TXT...`);
                try {
                  const doc = await readR2Document(result.key);
                  if (doc?.content) {
                    const content = doc.content.substring(0, 1200);
                    documentContext += `\n\n--- DOCUMENTO: ${result.key} ---\n${content}`;
                    sourceInfo += `üìÑ ${result.key}\n`;
                    addDebugMessage(`‚úÖ Letto contenuto TXT (${doc.content.length} caratteri)`, 'success');
                  } else {
                    addDebugMessage(`‚ùå Contenuto TXT vuoto`, 'error');
                  }
                } catch (readError) {
                  addDebugMessage(`‚ùå Errore lettura TXT: ${readError.message}`, 'error');
                }
              } 
              // Per PDF, usa solo il nome e snippet dalla ricerca
              else if (result.key.endsWith('.pdf')) {
                documentContext += `\n\n--- DOCUMENTO PDF: ${result.key} ---\n`;
                documentContext += `Contenuto rilevante: ${result.snippet || 'Documento ufficiale disponibile'}`;
                sourceInfo += `üìÑ ${result.key} (PDF)\n`;
                addDebugMessage(`üìã PDF trovato e aggiunto al context`, 'success');
              }
              // Altri tipi di file
              else {
                documentContext += `\n\n--- DOCUMENTO: ${result.key} ---\n`;
                documentContext += `Documento ufficiale disponibile: ${result.snippet || 'Contenuto specifico disponibile'}`;
                sourceInfo += `üìÑ ${result.key}\n`;
                addDebugMessage(`üìã Altro documento aggiunto al context`, 'success');
              }
            }
            break; // Usa solo il primo keyword che trova risultati
          } else {
            addDebugMessage(`‚ùå Nessun risultato per "${keyword}"`);
          }
        } catch (searchError) {
          addDebugMessage(`‚ùå Errore ricerca "${keyword}": ${searchError.message}`, 'error');
        }
      }
      
      // Se non trova nei documenti, cerca in rete
      if (!foundInDocuments) {
        addDebugMessage(`üåê Nessun documento R2 trovato, provo ricerca web...`);
        try {
          const webResult = await searchWeb(userMessage);
          if (webResult?.results?.length > 0) {
            documentContext += '\n\n--- INFORMAZIONI WEB ---\n';
            webResult.results.slice(0, 2).forEach(result => {
              documentContext += `${result.title}: ${result.snippet}\n`;
            });
            sourceInfo = 'Fonte: Ricerca web';
            addDebugMessage(`‚úÖ Trovati ${webResult.results.length} risultati web`, 'success');
          } else {
            addDebugMessage(`‚ùå Nessun risultato web trovato`);
          }
        } catch (webError) {
          addDebugMessage(`‚ùå Errore ricerca web: ${webError.message}`, 'error');
        }
      }
      
      const finalContext = documentContext.trim();
      addDebugMessage(`üìù Context finale: ${finalContext ? `${finalContext.length} caratteri` : 'VUOTO'}`);
      addDebugMessage(`üìä foundInDocuments: ${foundInDocuments}`);
      
      return { context: finalContext, sourceInfo, foundInDocuments };
    }

    // ===== INTEGRAZIONE R2 - FINE =====

    function addBubble(html, who='bot', {raw=false}={}){
      const row = document.createElement('div');
      row.className='row';
      const av=document.createElement('div');
      av.className=`av ${who==='user'?'av-user':'av-bot'}`;
      av.textContent = who==='user'?'üë§':'ü§ñ';
      const bub=document.createElement('div');
      bub.className=`bub ${who==='user'?'b-user':'b-bot'}`;
      if(raw){ bub.innerHTML=html } else { bub.textContent=html }
      const t=document.createElement('div'); t.className='time'; t.textContent=timeNow();
      bub.appendChild(t);
      row.appendChild(av); row.appendChild(bub);
      msgs.appendChild(row); msgs.scrollTop = msgs.scrollHeight;
    }
    function setTyping(v){ typing.classList.toggle('hidden', !v); msgs.scrollTop=msgs.scrollHeight; }
    function setConn(v){ conn.textContent = v ? 'Connesso' : 'Offline'; }
    window.addEventListener('online',()=>setConn(true));
    window.addEventListener('offline',()=>setConn(false));

    // CTA Dirigenti come MESSAGGIO BOT (avatar ü§ñ, bubble chiara)
    function addDirigentiCTA(){
      const html = `
        <p>Per l'elenco aggiornato dei dirigenti del Sindacato Carabinieri, apri la pagina ufficiale:</p>
        <p><a class="cta" href="${DIRIGENTI_URL}" target="_blank" rel="noopener">Apri la pagina Dirigenti</a></p>
      `;
      addBubble(html,'bot',{raw:true});
    }

    function isDirigentiQuery(text){
      const x=(text||'').toLowerCase();
      return /\bdirigent/i.test(x) || /contatti.*dirigent/i.test(x);
    }

    help.addEventListener('click',()=>{
      addBubble('Posso aiutarti su: disciplina, ferie/permessi, stipendi, concorsi, pensioni, codici e regolamenti. Scrivi: "Come funzionano i permessi per malattia?"','bot');
      
      // Test rapido degli endpoint
      setTimeout(async () => {
        addBubble('üîç Test veloce connessione documenti...', 'bot');
        
        try {
          const listTest = await fetch('/api/list');
          const listData = await listTest.json();
          
          if (listTest.ok && listData.files) {
            addBubble(`‚úÖ Connessione OK! Trovati ${listData.files.length} documenti disponibili: ${listData.files.map(f => f.key).join(', ')}`, 'bot');
            
            // Test ricerca
            const searchTest = await fetch('/api/search?q=veterano');
            const searchData = await searchTest.json();
            
            if (searchTest.ok) {
              addBubble(`üîç Test ricerca "veterano": ${searchData.results?.length || 0} risultati trovati`, 'bot');
              if (searchData.results?.length > 0) {
                addBubble(`üìÑ Documenti: ${searchData.results.map(r => r.key).join(', ')}`, 'bot');
              }
            } else {
              addBubble(`‚ùå Errore test ricerca: ${searchData.error}`, 'bot');
            }
          } else {
            addBubble(`‚ùå Errore connessione: ${listData.error}`, 'bot');
          }
        } catch (e) {
          addBubble(`‚ùå Errore test: ${e.message}`, 'bot');
        }
    // Test completo R2
    testR2.addEventListener('click', async () => {
      addDebugMessage('üöÄ INIZIO TEST COMPLETO R2');
      
      // Test 1: Lista file
      addDebugMessage('üìã Test 1: Lista file...');
      try {
        const listResponse = await fetch('/api/list');
        const listData = await listResponse.json();
        
        if (listResponse.ok && listData.files) {
          addDebugMessage(`‚úÖ Lista OK: ${listData.files.length} file`, 'success');
          listData.files.forEach(file => {
            addDebugMessage(`  üìÑ ${file.key} (${file.size} bytes)`);
          });
        } else {
          addDebugMessage(`‚ùå Lista FAIL: ${listData.error}`, 'error');
          return;
        }
      } catch (e) {
        addDebugMessage(`‚ùå Lista ERROR: ${e.message}`, 'error');
        return;
      }
      
      // Test 2: Ricerca "veterano"
      addDebugMessage('üîç Test 2: Ricerca "veterano"...');
      try {
        const searchResponse = await fetch('/api/search?q=veterano');
        const searchData = await searchResponse.json();
        
        if (searchResponse.ok) {
          addDebugMessage(`‚úÖ Ricerca OK: ${searchData.results?.length || 0} risultati`, 'success');
          if (searchData.results?.length > 0) {
            searchData.results.forEach(result => {
              addDebugMessage(`  üìÑ ${result.key} - ${result.snippet?.substring(0, 50)}...`);
            });
            
            // Test 3: Lettura primo file TXT trovato
            const txtFile = searchData.results.find(r => r.key.endsWith('.txt'));
            if (txtFile) {
              addDebugMessage(`üìñ Test 3: Lettura file ${txtFile.key}...`);
              try {
                const readResponse = await fetch(`/api/read?key=${encodeURIComponent(txtFile.key)}`);
                const readData = await readResponse.json();
                
                if (readResponse.ok && readData.content) {
                  addDebugMessage(`‚úÖ Lettura OK: ${readData.content.length} caratteri`, 'success');
                  addDebugMessage(`  üìù Primi 100 caratteri: "${readData.content.substring(0, 100)}..."`);
                } else {
                  addDebugMessage(`‚ùå Lettura FAIL: ${readData.error}`, 'error');
                }
              } catch (e) {
                addDebugMessage(`‚ùå Lettura ERROR: ${e.message}`, 'error');
              }
            } else {
              addDebugMessage(`‚ÑπÔ∏è Nessun file TXT trovato per test lettura`);
            }
          }
        } else {
          addDebugMessage(`‚ùå Ricerca FAIL: ${searchData.error}`, 'error');
        }
      } catch (e) {
        addDebugMessage(`‚ùå Ricerca ERROR: ${e.message}`, 'error');
      }
      
      addDebugMessage('üèÅ TEST COMPLETO TERMINATO');
    });

    clear.addEventListener('click',()=>{
      if(!confirm('Cancellare la conversazione?')) return;
      msgs.innerHTML='';
      msgs.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="av av-bot">ü§ñ</div>
          <div class="bub b-bot">
            Ciao! Sono <strong>Virgilio</strong>. Fai una domanda su contratti, diritti, concorsi, disciplina, ferie e molto altro.
            <div class="time">${timeNow()}</div>
          </div>
        </div>
      `);
      history=[]; totalTokens=0; tok.textContent='0';
    });

    inp.addEventListener('input',()=>{
      chars.textContent=inp.value.length;
      sendBtn.disabled = !inp.value.trim() || isProcessing;
      inp.style.height='auto'; inp.style.height=Math.min(inp.scrollHeight,120)+'px';
    });
    inp.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
    sendBtn.addEventListener('click',send);

    async function mustBeLoggedIn(){
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session){ window.location.href = '../login.html'; return null; }
      return session;
    }

    async function send(){
      const text = inp.value.trim();
      if(!text || isProcessing) return;

      isProcessing=true; sendBtn.disabled=true;
      addBubble(text,'user');
      history.push({role:'user',content:text});
      inp.value=''; chars.textContent='0'; inp.style.height='auto';

      if(isDirigentiQuery(text)){
        addDirigentiCTA();
        isProcessing=false; sendBtn.disabled=false; return;
      }

      const session = await mustBeLoggedIn(); if(!session) return;

      // ===== INTEGRAZIONE R2 - MODIFICA ALLA FUNZIONE SEND =====
      
      let systemContext = 'Sei Virgilio, assistente AI del Sindacato Carabinieri. ISTRUZIONI OBBLIGATORIE:\n\n1. Rispondi SEMPRE in modo BREVE e GENERICO (massimo 2-3 frasi)\n2. NON fornire troppi dettagli specifici nella prima risposta\n3. Dai una risposta generale che stimoli l\'interazione\n4. Se usi documenti, menziona solo che "abbiamo documentazione specifica" senza dettagli\n5. NON includere mai l\'invito ai dirigenti nella risposta principale';
      
      addDebugMessage(`üí¨ Messaggio utente: "${text}"`);
      
      // Se la domanda riguarda documenti, cerca in R2 e web
      const needsSearch = needsDocumentSearch(text);
      if (needsSearch) {
        addDebugMessage(`üîç Attivazione ricerca documenti...`);
        const { context: documentContext, sourceInfo, foundInDocuments } = await prepareDocumentContext(text);
        
        if (documentContext) {
          if (foundInDocuments) {
            systemContext += '\n\nHai accesso a documenti ufficiali su questo argomento. Dai una risposta GENERALE e BREVE senza entrare nei dettagli specifici:\n' + documentContext;
            systemContext += '\n\nIMPORTANTE: Menziona solo che "esistono normative specifiche" senza citare articoli o dettagli.';
            addDebugMessage(`‚úÖ Context documenti ufficiali aggiunto (${documentContext.length} caratteri)`, 'success');
          } else {
            systemContext += '\n\nInformazioni generali disponibili. Rispondi in modo GENERICO:\n' + documentContext;
            systemContext += '\n\nIMPORTANTE: Non dare troppi dettagli, stimola l\'utente a chiedere di pi√π.';
            addDebugMessage(`‚ÑπÔ∏è Context web aggiunto (${documentContext.length} caratteri)`);
          }
        } else {
          addDebugMessage(`‚ùå Nessun context trovato`, 'error');
        }
      } else {
        addDebugMessage(`‚ÑπÔ∏è Nessuna ricerca documenti necessaria`);
      }

      const body = {
        messages: history.slice(-10),
        model: 'gpt-4o-mini',
        max_tokens: 600,
        temperature: 0.3,
        system_context: systemContext
      };

      setTyping(true);
      try{
        const r = await fetch(API_CHAT,{
          method:'POST',
          headers:{'Content-Type':'application/json', Authorization:'Bearer '+session.access_token},
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!r.ok){
          addBubble(j?.error || `Errore ${r.status}. Riprova tra poco.`,'bot');
          addDebugMessage(`‚ùå Errore API Chat: ${j?.error || r.status}`, 'error');
        }else{
          let msg = j?.choices?.[0]?.message?.content || 'Nessuna risposta.';
          
          addDebugMessage(`‚úÖ Risposta AI ricevuta (${msg.length} caratteri)`, 'success');
          
          // Aggiungi la risposta principale
          addBubble(msg,'bot',{raw:true});
          history.push({role:'assistant',content:msg});
          
          // Aggiungi automaticamente la seconda bolla con invito ai dirigenti
          setTimeout(() => {
            const followUpMsg = `
              üí° <strong>Vuoi sapere di pi√π sull'argomento?</strong><br>
              Non perdere l'occasione di contattare il tuo dirigente di zona!<br>
              <a class="cta" href="${DIRIGENTI_URL}" target="_blank" rel="noopener">Vai alla sezione Richieste</a>
            `;
            addBubble(followUpMsg, 'bot', {raw: true});
          }, 1500);
          
          if(j?.usage?.total_tokens){ totalTokens+=j.usage.total_tokens; tok.textContent=totalTokens.toLocaleString(); }
        }
      }catch(e){
        console.error(e);
        addBubble('Problema di rete. Verifica la connessione e riprova.','bot');
        addDebugMessage(`‚ùå Errore rete: ${e.message}`, 'error');
      }finally{
        setTyping(false); isProcessing=false; sendBtn.disabled=false; inp.focus();
      }
    }

    // Init: richiede login ma non stampa messaggi "di servizio"
    (async ()=>{ await mustBeLoggedIn(); })();
  </script>
</body>
</html>
      try{
        const r = await fetch(API_CHAT,{
          method:'POST',
          headers:{'Content-Type':'application/json', Authorization:'Bearer '+session.access_token},
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!r.ok){
          addBubble(j?.error || `Errore ${r.status}. Riprova tra poco.`,'bot');
        }else{
          let msg = j?.choices?.[0]?.message?.content || 'Nessuna risposta.';
          
          // Aggiungi la risposta principale
          addBubble(msg,'bot',{raw:true});
          history.push({role:'assistant',content:msg});
          
          // Aggiungi automaticamente la seconda bolla con invito ai dirigenti
          setTimeout(() => {
            const followUpMsg = `
              üí° <strong>Vuoi sapere di pi√π sull'argomento?</strong><br>
              Non perdere l'occasione di contattare il tuo dirigente di zona!<br>
              <a class="cta" href="${DIRIGENTI_URL}" target="_blank" rel="noopener">Vai alla sezione Richieste</a>
            `;
            addBubble(followUpMsg, 'bot', {raw: true});
          }, 1500);
          
          if(j?.usage?.total_tokens){ totalTokens+=j.usage.total_tokens; tok.textContent=totalTokens.toLocaleString(); }
        }
      }catch(e){
        console.error(e);
        addBubble('Problema di rete. Verifica la connessione e riprova.','bot');
      }finally{
        setTyping(false); isProcessing=false; sendBtn.disabled=false; inp.focus();
      }
    }

    // Init: richiede login ma non stampa messaggi "di servizio"
    (async ()=>{ await mustBeLoggedIn(); })();
  </script>
</body>
</html>
