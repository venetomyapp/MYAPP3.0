<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0"/>
  <title>Virgilio - MyApp by SIM Carabinieri</title>

  <!-- Favicon: robottino -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23e94560'/%3E%3Ccircle cx='22' cy='26' r='3' fill='white'/%3E%3Ccircle cx='42' cy='26' r='3' fill='white'/%3E%3Crect x='28' y='35' width='8' height='4' rx='2' fill='white'/%3E%3Cpath d='M20 45 Q32 50 44 45' stroke='white' stroke-width='2' fill='none'/%3E%3Crect x='15' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3Crect x='43' y='12' width='6' height='8' rx='3' fill='%2300d4ff'/%3E%3C/svg%3E">

  <!-- Tailwind (dev/test) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              aurora: '#e94560'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root{
      --gradient: linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --header-h: 60px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body{
      min-height:100vh;background:var(--gradient);background-size:400% 400%;
      animation:bg 30s ease infinite;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif
    }
    @keyframes bg{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .header{position:sticky;top:0;height:var(--header-h);padding-top:var(--safe-top);
      background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.12);z-index:1000}
    
    /* Container principale della chat */
    .chat-container {
      max-width: 960px;
      margin: 0.75rem auto;
      height: calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1.5rem);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
      background: white;
      position: relative;
    }

    /* Header personalizzato di Virgilio */
    .virgilio-header {
      background: linear-gradient(135deg, #e94560 0%, #00d4ff 100%);
      color: white;
      padding: 1rem;
      text-align: center;
      border-radius: 18px 18px 0 0;
      z-index: 10;
      position: relative;
    }

    /* Area del widget Botpress */
    .botpress-area {
      flex: 1;
      position: relative;
      background: white;
      border-radius: 0 0 18px 18px;
      overflow: hidden;
    }

    @media (max-width:640px){
      .chat-container {
        margin: 0.5rem;
        height: calc(100vh - var(--header-h) - var(--safe-top) - var(--safe-bottom) - 1rem);
      }
    }

    /* STILI PER INTEGRARE BOTPRESS */
    
    /* Forza il widget a riempire l'area disponibile */
    #bp-widget,
    #bp-widget .bpw-layout,
    #bp-widget .bpw-chat-container {
      position: static !important;
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }

    /* NASCONDE GLI ELEMENTI INDESIDERATI */
    #bp-widget .bpw-header,
    #bp-widget .bpw-chat-header,
    #bp-widget .bpw-header-container {
      display: none !important;
    }

    #bp-widget .bpw-header-share,
    #bp-widget .bpw-sidebar,
    #bp-widget button[title*="share" i],
    #bp-widget button[aria-label*="share" i],
    #bp-widget [class*="share"],
    #bp-widget .bpw-header-actions {
      display: none !important;
      visibility: hidden !important;
    }

    /* PERSONALIZZA LO STILE DEI MESSAGGI */
    
    /* Area messaggi */
    #bp-widget .bpw-chat-container,
    #bp-widget .bpw-conversation-container,
    #bp-widget .bpw-messages-container {
      background: white !important;
      padding: 16px !important;
      margin: 0 !important;
    }

    /* Messaggi utente */
    #bp-widget .bpw-from-user .bpw-chat-bubble,
    #bp-widget .bpw-message-user {
      background: linear-gradient(135deg, #e94560 0%, #ff006e 80%) !important;
      color: white !important;
      border-radius: 18px 18px 6px 18px !important;
      border: none !important;
      box-shadow: 0 4px 12px rgba(233, 69, 96, 0.25) !important;
      font-weight: 500 !important;
      padding: 12px 16px !important;
    }

    /* Messaggi bot */
    #bp-widget .bpw-from-bot .bpw-chat-bubble,
    #bp-widget .bpw-message-bot {
      background: #f8fbff !important;
      color: #374151 !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 18px 18px 18px 6px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
      padding: 12px 16px !important;
    }

    /* Area input */
    #bp-widget .bpw-composer,
    #bp-widget .bpw-chat-composer {
      background: #f9fafb !important;
      border: none !important;
      border-top: 1px solid #e5e7eb !important;
      padding: 16px !important;
      margin: 0 !important;
    }

    #bp-widget .bpw-composer-inner {
      background: white !important;
      border: 2px solid #e5e7eb !important;
      border-radius: 12px !important;
      transition: border-color 0.2s ease !important;
      overflow: hidden !important;
    }

    #bp-widget .bpw-composer-inner:focus-within {
      border-color: #e94560 !important;
      box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1) !important;
    }

    /* Campo di input */
    #bp-widget .bpw-composer-textarea,
    #bp-widget .bpw-composer input,
    #bp-widget textarea,
    #bp-widget input[type="text"] {
      background: transparent !important;
      border: none !important;
      color: #374151 !important;
      font-size: 14px !important;
      padding: 12px 16px !important;
      outline: none !important;
      font-family: inherit !important;
    }

    #bp-widget .bpw-composer-textarea::placeholder,
    #bp-widget .bpw-composer input::placeholder,
    #bp-widget textarea::placeholder,
    #bp-widget input::placeholder {
      color: #9ca3af !important;
    }

    /* Pulsante di invio */
    #bp-widget .bpw-send-button,
    #bp-widget .bpw-composer-send,
    #bp-widget button[type="submit"] {
      background: linear-gradient(135deg, #e94560 0%, #ff006e 80%) !important;
      border: none !important;
      border-radius: 10px !important;
      color: white !important;
      padding: 10px 16px !important;
      font-weight: 600 !important;
      margin: 4px !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
    }

    #bp-widget .bpw-send-button:hover,
    #bp-widget .bpw-composer-send:hover,
    #bp-widget button[type="submit"]:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3) !important;
    }

    #bp-widget .bpw-send-button:disabled,
    #bp-widget .bpw-composer-send:disabled,
    #bp-widget button:disabled {
      opacity: 0.5 !important;
      transform: none !important;
      cursor: not-allowed !important;
    }

    /* Quick replies */
    #bp-widget .bpw-quick-reply,
    #bp-widget .bpw-keyboard-quick-reply {
      background: #f3f4f6 !important;
      border: 1px solid #d1d5db !important;
      border-radius: 8px !important;
      color: #374151 !important;
      padding: 8px 12px !important;
      margin: 4px !important;
      font-size: 13px !important;
      transition: all 0.2s ease !important;
      cursor: pointer !important;
    }

    #bp-widget .bpw-quick-reply:hover,
    #bp-widget .bpw-keyboard-quick-reply:hover {
      background: #e94560 !important;
      color: white !important;
      border-color: #e94560 !important;
    }

    /* Indicatore di digitazione */
    #bp-widget .bpw-typing-indicator,
    #bp-widget .bpw-typing-bubble {
      background: #f8fbff !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 16px !important;
      padding: 12px 16px !important;
    }

    /* Scrollbar personalizzata */
    #bp-widget .bpw-chat-container::-webkit-scrollbar,
    #bp-widget .bpw-messages-container::-webkit-scrollbar {
      width: 6px !important;
    }

    #bp-widget .bpw-chat-container::-webkit-scrollbar-thumb,
    #bp-widget .bpw-messages-container::-webkit-scrollbar-thumb {
      background: #d1d5db !important;
      border-radius: 3px !important;
    }

    #bp-widget .bpw-chat-container::-webkit-scrollbar-thumb:hover,
    #bp-widget .bpw-messages-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af !important;
    }

    /* Nasconde il floating button se presente */
    #bp-widget .bpw-floating-button,
    #bp-widget .bpw-toggle-button {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #bp-widget .bpw-composer {
        padding: 12px !important;
      }
      
      #bp-widget .bpw-messages-container {
        padding: 12px !important;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="max-w-5xl mx-auto px-4 h-full flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button onclick="history.back()" class="rounded-xl px-2 py-2 border border-white/30 text-white hover:bg-white/10" type="button" aria-label="Indietro">⟵</button>
        <h1 class="text-white font-semibold">Virgilio</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="help" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">❓ Aiuto</button>
        <button onclick="window.location.href='home.html'" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm border border-white/20 hover:bg-white/20" type="button">🏠 Home</button>
      </div>
    </div>
  </header>

  <main class="py-3">
    <div class="chat-container">
      <!-- Header informativo di Virgilio -->
      <div class="virgilio-header">
        <div class="flex items-center justify-center gap-3">
          <div class="w-11 h-11 bg-white/25 rounded-full grid place-items-center text-2xl">🤖</div>
          <div class="text-left">
            <div class="font-bold text-xl">Virgilio</div>
            <div class="text-sm opacity-90">Assistente sindacale AI del SIM Carabinieri</div>
          </div>
        </div>
      </div>

      <!-- Area del widget Botpress -->
      <div class="botpress-area" id="botpress-container">
        <!-- Il widget sarà inserito qui -->
      </div>
    </div>
  </main>

  <!-- Script Botpress -->
  <script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
  <script src="https://files.bpcontent.cloud/2025/08/31/12/20250831122850-F6HD8P79.js" defer></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase auth
    const supabase = createClient(
      'https://pvzdilkozpspsnepedqc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk',
      { auth: { persistSession: true, autoRefreshToken: true } }
    );

    let cleanupInterval;

    // Inizializza Botpress quando è pronto
    function initializeBotpress() {
      if (window.botpressWebChat) {
        try {
          window.botpressWebChat.init({
            composerPlaceholder: "✨ Scrivi la tua domanda su sindacato, contratti, diritti...",
            botConversationDescription: "Assistente sindacale AI del SIM Carabinieri",
            showShareButton: false,
            enableShare: false,
            showCloseButton: false,
            showConversationDeletion: false,
            enableTranscriptDownload: false,
            stylesheet: `
              .bpw-layout { 
                border-radius: 0 !important; 
                box-shadow: none !important;
                border: none !important;
              }
              .bpw-header { display: none !important; }
              .bpw-from-user .bpw-chat-bubble { 
                background: linear-gradient(135deg, #e94560 0%, #ff006e 80%) !important; 
                color: white !important;
              }
            `
          });

          console.log('Botpress inizializzato con successo');

          // Sposta il widget nel container appropriato
          setTimeout(() => {
            moveWidget();
            startCleanup();
          }, 1000);

        } catch (error) {
          console.error('Errore inizializzazione Botpress:', error);
        }
      } else {
        // Riprova dopo un secondo se Botpress non è ancora pronto
        setTimeout(initializeBotpress, 1000);
      }
    }

    function moveWidget() {
      const widget = document.querySelector('#bp-widget');
      const container = document.getElementById('botpress-container');
      
      if (widget && container) {
        // Rimuovi il widget dalla posizione originale e spostalo nel container
        container.appendChild(widget);
        
        // Applica stili per l'integrazione
        widget.style.position = 'static';
        widget.style.width = '100%';
        widget.style.height = '100%';
        widget.style.border = 'none';
        widget.style.borderRadius = '0';
        widget.style.boxShadow = 'none';
        
        console.log('Widget spostato nel container');
      }
    }

    function startCleanup() {
      // Rimuove elementi indesiderati ogni secondo per i primi 10 secondi
      let attempts = 0;
      cleanupInterval = setInterval(() => {
        attempts++;
        
        // Rimuovi pulsanti share e sidebar
        const shareElements = document.querySelectorAll('#bp-widget [class*="share"], #bp-widget button[title*="share"], #bp-widget .bpw-sidebar');
        shareElements.forEach(el => {
          el.style.display = 'none';
          el.remove();
        });

        // Nascondi header del widget
        const headers = document.querySelectorAll('#bp-widget .bpw-header, #bp-widget .bpw-chat-header');
        headers.forEach(header => {
          header.style.display = 'none';
        });

        // Ferma il cleanup dopo 10 tentativi
        if (attempts >= 10) {
          clearInterval(cleanupInterval);
          console.log('Cleanup completato');
        }
      }, 1000);
    }

    // Event listeners
    document.getElementById('help').addEventListener('click', function() {
      // Invia un messaggio di aiuto al bot
      if (window.botpressWebChat && window.botpressWebChat.sendEvent) {
        window.botpressWebChat.sendEvent({
          type: 'proactive-trigger',
          channel: 'web',
          payload: { text: 'Aiuto: mostra le tue funzionalità' }
        });
      } else {
        alert('Posso aiutarti con: contratti, diritti sindacali, disciplina, ferie, permessi, concorsi, pensioni e molto altro. Scrivi la tua domanda nella chat!');
      }
    });

    // Verifica autenticazione
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'ofline.html';
        return false;
      }
      return true;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (cleanupInterval) {
        clearInterval(cleanupInterval);
      }
    });

    // Inizializza tutto
    checkAuth().then(isAuthenticated => {
      if (isAuthenticated) {
        // Aspetta che i script Botpress siano caricati
        setTimeout(initializeBotpress, 500);
      }
    });
  </script>
</body>
</html>
