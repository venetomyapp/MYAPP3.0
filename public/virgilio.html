<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Virgilio - MyApp</title>

  <!-- Manifest (opzionale: commenta se non hai il file pubblico) -->
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <meta name="theme-color" content="#1a1a2e">
  <meta name="background-color" content="#1a1a2e">

  <!-- Favicon inline per evitare 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%23e94560'/%3E%3Ctext x='32' y='41' font-size='36' text-anchor='middle' fill='white'%3EV%3C/text%3E%3C/svg%3E">

  <!-- Tailwind (ok per dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a1a2e',
              secondary: '#16213e',
              accent: '#0f3460',
              aurora: '#e94560',
              cyan: '#00d4ff',
              magenta: '#ff006e',
              gold: '#ffd700',
              teal: '#03dac6',
              dark: '#0a0a23',
              light: '#f8fafc'
            }
          }
        }
      };
    }
  </script>

  <style>
    :root {
      --gradient-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
      --shadow-elevated: 0 8px 25px rgba(0,0,0,.15);
      --header-height: 60px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--gradient-bg);
      background-size: 400% 400%;
      animation: gradientShift 30s ease infinite;
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

    .header { background: rgba(255,255,255,.1); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.1); position: sticky; top: 0; z-index: 40; height: var(--header-height) }
    .back-button { display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; background: rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); color:#fff; cursor:pointer; transition:all .2s }
    .back-button:hover { background: rgba(255,255,255,.2); border-color: rgba(233,69,96,.5); color:#e94560; transform: translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.1) }
    .back-button:active { transform: scale(.95) }

    .chat-container { background:#fff; border-radius:20px; box-shadow: var(--shadow-elevated); width:100%; max-width:900px; margin:1rem auto; overflow:hidden; height: calc(100vh - var(--header-height) - 2rem); display:flex; flex-direction:column }
    .chat-header { background: linear-gradient(135deg, #e94560, #00d4ff); color:#fff; padding:1.5rem; text-align:center; flex-shrink:0 }
    .chat-messages { flex:1; overflow-y:auto; padding:1rem; scroll-behavior:smooth; -webkit-overflow-scrolling:touch }
    .chat-messages::-webkit-scrollbar{ width:4px } .chat-messages::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:2px } .chat-messages::-webkit-scrollbar-thumb{ background:#e94560; border-radius:2px }

    .message { margin-bottom:1rem; animation: fadeIn .3s ease-out }
    @keyframes fadeIn { from{opacity:0; transform: translateY(10px)} to{opacity:1; transform:none} }
    .message-bot, .message-system { display:flex; align-items:flex-start; gap:.75rem }
    .message-user { display:flex; align-items:flex-start; gap:.75rem; flex-direction: row-reverse }

    .avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; min-width:40px; min-height:40px }
    .avatar-bot{ background: linear-gradient(135deg, #00d4ff, #03dac6) }
    .avatar-user{ background: linear-gradient(135deg, #e94560, #ff006e) }
    .avatar-system{ background: linear-gradient(135deg, #ffd700, #ff8c00) }

    .message-content { max-width:75%; padding:1rem 1.25rem; border-radius:16px; font-size:.95rem; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word }
    .content-bot { background:#f8f9fa; color:#2d3748; border-bottom-left-radius:6px }
    .content-user { background: linear-gradient(135deg, #e94560, #ff006e); color:#fff; border-bottom-right-radius:6px }
    .content-system { background: linear-gradient(135deg, #ffd700, #ff8c00); color:#fff; border-bottom-left-radius:6px }
    .message-time { font-size:.75rem; opacity:.7; margin-top:.5rem }

    .typing-indicator{ display:flex; align-items:center; gap:.75rem; padding:1rem 0 }
    .typing-dots{ display:flex; gap:4px; padding:1rem 1.25rem; background:#f8f9fa; border-radius:16px; border-bottom-left-radius:6px }
    .typing-dot{ width:8px; height:8px; background:#6b7280; border-radius:50%; animation:typingBounce 1.5s infinite }
    .typing-dot:nth-child(2){ animation-delay:.3s } .typing-dot:nth-child(3){ animation-delay:.6s }
    @keyframes typingBounce { 0%,60%,100%{transform:none} 30%{transform: translateY(-10px)} }

    .chat-input-area{ padding:1rem; border-top:1px solid #e5e7eb; background:#f8f9fa; flex-shrink:0 }
    .input-wrapper{ display:flex; gap:.75rem; align-items:flex-end }
    .chat-input{ flex:1; border:2px solid #e5e7eb; border-radius:12px; padding:.75rem 1rem; font-size:1rem; resize:none; outline:none; transition:border-color .2s; min-height:44px; max-height:120px; font-family:inherit; -webkit-appearance:none; appearance:none }
    .chat-input:focus{ border-color:#e94560 }
    .send-button{ background: linear-gradient(135deg, #e94560, #00d4ff); color:#fff; border:none; border-radius:12px; padding:.75rem; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .2s; min-width:44px; min-height:44px }
    .send-button:hover:not(:disabled){ transform: translateY(-2px); box-shadow:0 4px 12px rgba(233,69,96,.3) }
    .send-button:active:not(:disabled){ transform: scale(.95) }
    .send-button:disabled{ opacity:.5; cursor:not-allowed; transform:none }

    .loading-spinner{ width:20px; height:20px; border:2px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation: spin 1s linear infinite }
    @keyframes spin { to{ transform: rotate(360deg) } }

    .status-bar{ background:#f8f9fa; padding:.5rem 1rem; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; font-size:.8rem; color:#6b7280; flex-shrink:0 }
    .connection-status{ display:flex; align-items:center; gap:.5rem }
    .status-dot{ width:8px; height:8px; border-radius:50%; background:#10b981 }
    .status-dot.disconnected{ background:#ef4444 }

    .action-button{ background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:.5rem 1rem; font-size:.85rem; font-weight:500; color:#374151; cursor:pointer; transition:all .2s; min-height:36px; display:flex; align-items:center; justify-content:center }
    .action-button:hover{ background:#f3f4f6; border-color:#e94560; color:#e94560 }
    .action-button:active{ transform: scale(.98) }
    .action-button.primary{ background: linear-gradient(135deg, #e94560, #00d4ff); color:#fff; border:none }
    .action-button.primary:hover{ transform: translateY(-1px); box-shadow:0 4px 12px rgba(233,69,96,.3) }

    .alert{ padding:1rem; border-radius:12px; margin:1rem; font-weight:500 }
    .alert-error{ background:#fef2f2; color:#dc2626; border:1px solid #fecaca }
    .alert-success{ background:#f0fdf4; color:#16a34a; border:1px solid #bbf7d0 }
    .alert-info{ background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe }

    .web-search-badge{ background: linear-gradient(135deg, #00d4ff, #03dac6); color:#fff; font-size:.75rem; font-weight:600; padding:.25rem .75rem; border-radius:12px; display:inline-block; margin-bottom:.5rem }

    @media (min-width:1200px){ .chat-container{ max-width:1000px } }
    @media (max-width:1024px) and (min-width:769px){ .chat-container{ margin:1rem; height: calc(100vh - var(--header-height) - 2rem) } .message-content{ max-width:80% } }
    @media (max-width:768px) and (min-width:481px){
      .chat-container{ margin:.75rem; border-radius:16px; height: calc(100vh - var(--header-height) - 1.5rem) }
      .chat-header{ padding:1.25rem } .chat-header h1{ font-size:1.5rem }
      .message-content{ max-width:85% } .avatar{ width:36px; height:36px; min-width:36px; min-height:36px; font-size:1.1rem }
    }
    @media (max-width:480px){
      :root{ --header-height:56px }
      .header{ height:var(--header-height); padding:.5rem 1rem }
      .chat-container{ margin:.5rem; border-radius:12px; height: calc(100vh - var(--header-height) - 1rem) }
      .chat-header{ padding:1rem .75rem } .chat-header h1{ font-size:1.3rem } .chat-header p{ font-size:.85rem }
      .chat-messages{ padding:.75rem } .message-content{ max-width:90%; padding:.75rem 1rem; font-size:.9rem }
      .avatar{ width:32px; height:32px; min-width:32px; min-height:32px; font-size:1rem }
      .chat-input-area{ padding:.75rem } .chat-input{ font-size:16px; padding:.8rem }
      .send-button{ width:48px; height:48px; min-width:48px; min-height:48px }
      .status-bar{ padding:.4rem .75rem; font-size:.75rem }
    }
    @media (prefers-color-scheme:dark){
      .content-bot{ background:#2d3748; color:#e2e8f0 }
      .chat-input-area{ background:#1a202c } .status-bar{ background:#1a202c; color:#a0aec0 }
    }
    *:focus-visible{ outline:2px solid #e94560; outline-offset:2px }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <button onclick="history.back()" class="back-button" title="Torna indietro" type="button" aria-label="Torna alla pagina precedente">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-white font-bold text-lg">Virgilio</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="clearChatBtn" class="action-button text-sm" type="button">🗑️ Pulisci</button>
        <button onclick="showHelp()" class="action-button text-sm" type="button">❓ Aiuto</button>
      </div>
    </div>
  </header>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="status" aria-live="polite">
    <div class="bg-white rounded-lg p-6 text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-700 font-medium">Caricamento Virgilio...</p>
    </div>
  </div>

  <!-- Main Chat -->
  <main class="py-6">
    <div class="chat-container">
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="flex items-center justify-center gap-3 mb-2">
          <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <span class="text-2xl" aria-hidden="true">🤖</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Virgilio</h1>
            <p class="text-sm opacity-90">Il tuo assistente sindacale AI</p>
          </div>
        </div>
        <div class="text-sm opacity-80">
          Chiedi informazioni su contratti, diritti e procedure • Ricerca web integrata 🌐
        </div>
      </div>

      <!-- Alerts -->
      <div id="alertContainer" aria-live="polite"></div>

      <!-- Messages -->
      <div id="chatMessages" class="chat-messages" role="log" aria-live="polite" aria-relevant="additions">
        <div class="message message-bot">
          <div class="avatar avatar-bot">🤖</div>
          <div class="message-content content-bot">
            <div>
              Ciao! Sono <strong>Virgilio</strong> ✨, il tuo assistente sindacale AI di nuova generazione.
              <br><br>
              <strong>🎯 Le mie specializzazioni principali:</strong><br><br>
              📋 <strong>Contratto di Lavoro</strong> — Normative, diritti e doveri dei Carabinieri<br>
              🏥 <strong>Permessi per Malattia</strong> — Procedure, certificazioni e tempistiche<br>
              🏖️ <strong>Ferie e Permessi</strong> — Regolamenti, richieste e diritti alle vacanze<br>
              💰 <strong>Stipendio e Aumenti</strong> — Progressioni, indennità e trattamento economico<br>
              👥 <strong>Dirigenti Sindacali</strong> — Contatti regionali e provinciali<br>
              📝 <strong>Procedure Legali</strong> — Disciplinari, ricorsi e tutele legali<br><br>
              🌐 <strong>Novità:</strong> Posso effettuare ricerche web in tempo reale per informazioni sempre aggiornate!
              <br><br>
              <strong>💬 Come posso aiutarti oggi?</strong><br>
              • "Come funzionano i permessi per malattia?"<br>
              • "Dimmi tutto sul contratto di lavoro"<br>
              • "Chi sono i dirigenti sindacali?"<br>
              • "Informazioni su stipendio e aumenti"
            </div>
            <div class="message-time">Ora</div>
          </div>
        </div>
      </div>

      <!-- Typing -->
      <div id="typingIndicator" class="typing-indicator hidden" aria-hidden="true">
        <div class="avatar avatar-bot">🤖</div>
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>

      <!-- Input -->
      <div class="chat-input-area">
        <div class="input-wrapper">
          <textarea id="messageInput" class="chat-input" placeholder="✨ Scrivi la tua domanda..." rows="1" maxlength="500" aria-label="Scrivi il messaggio"></textarea>
          <button id="sendButton" class="send-button" disabled type="button" aria-label="Invia messaggio">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Status -->
      <div class="status-bar">
        <div class="connection-status">
          <div id="statusDot" class="status-dot"></div>
          <span id="statusText">Connesso</span>
        </div>
        <div>Token: <span id="tokenCount">0</span> • Caratteri: <span id="charCount">0</span>/500</div>
      </div>
    </div>
  </main>

  <!-- App JS (senza backtick per evitare errori di encoding) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ⚙️ Supabase (dati presi dal file che hai condiviso)
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

    // 🔌 Chatbot config: usa il PROXY same-origin su Vercel (/api/chat)
    const CHATBOT_CONFIG = {
      apiEndpoint: '/api/chat',                               // <— proxy Vercel
      apiEndpointLocal: 'http://localhost:3001/api/chat',     // per test locale diretto
      maxTokens: 500,
      temperature: 0.7,
      model: 'gpt-4o-mini',
      maxHistory: 10,
      retryAttempts: 3,
      retryDelay: 1000
    };

    // Stato
    let currentUser = null;
    let conversationHistory = [];
    let isProcessing = false;
    let totalTokensUsed = 0;
    let dirigenti = [];

    // DOM
    const messagesContainer = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const tokenCount = document.getElementById('tokenCount');
    const charCount = document.getElementById('charCount');
    const alertContainer = document.getElementById('alertContainer');

    // Utils
    function showAlert(message, type) {
      if (!type) type = 'info';
      const el = document.createElement('div');
      el.className = 'alert alert-' + type;
      el.textContent = message;
      alertContainer.appendChild(el);
      setTimeout(function(){ el.remove(); }, 5000);
    }
    function updateConnectionStatus(connected) {
      if (connected) { statusDot.className = 'status-dot'; statusText.textContent = 'Connesso'; }
      else { statusDot.className = 'status-dot disconnected'; statusText.textContent = 'Offline'; }
    }
    function syncOnlineStatus(){ updateConnectionStatus(navigator.onLine); }
    window.addEventListener('online', syncOnlineStatus);
    window.addEventListener('offline', syncOnlineStatus);

    function updateCharCount(){ const c = messageInput.value.length; charCount.textContent = c; charCount.style.color = c>400 ? '#ef4444':'#6b7280'; }
    function updateSendButton(){ const has = messageInput.value.trim().length>0; sendButton.disabled = !has || isProcessing; }
    function autoResizeTextarea(){ messageInput.style.height='auto'; messageInput.style.height = Math.min(messageInput.scrollHeight,120) + 'px'; }
    function scrollToBottom(){ messagesContainer.scrollTop = messagesContainer.scrollHeight; }
    function showTyping(){ typingIndicator.classList.remove('hidden'); scrollToBottom(); }
    function hideTyping(){ typingIndicator.classList.add('hidden'); }
    function formatTime(){ return new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}); }
    function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
    function formatMessage(t){
      return escapeHtml(t)
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>')
        .replace(/\n/g,'<br>');
    }

    // Add message
    function addMessage(content, type, hasWebSearch){
      if(!type) type='bot';
      const m = document.createElement('div');
      m.className = 'message message-' + type;

      let badge = '';
      if (hasWebSearch && type === 'bot') { badge = '<div class="web-search-badge">🌐 Ricerca Web</div>'; }

      if (type === 'user') {
        m.innerHTML =
          '<div class="avatar avatar-user">👤</div>' +
          '<div class="message-content content-user">' +
            '<div>' + escapeHtml(content) + '</div>' +
            '<div class="message-time">' + formatTime() + '</div>' +
          '</div>';
      } else if (type === 'system') {
        const safe = formatMessage(content); // ✅ sanitizzato
        m.innerHTML =
          '<div class="avatar avatar-system">ℹ️</div>' +
          '<div class="message-content content-system">' +
            '<div>' + safe + '</div>' +
            '<div class="message-time">' + formatTime() + '</div>' +
          '</div>';
      } else {
        m.innerHTML =
          '<div class="avatar avatar-bot">🤖</div>' +
          '<div class="message-content content-bot">' +
            badge +
            '<div>' + formatMessage(content) + '</div>' +
            '<div class="message-time">' + formatTime() + '</div>' +
          '</div>';
      }
      messagesContainer.appendChild(m);
      scrollToBottom();
    }

    // Dirigenti
    async function loadDirigenti(){
      try{
        const { data, error } = await supabase
          .from('organico_dirigentisindacali')  // se passi a una view pubblica, cambia qui
          .select('*')
          .order('id', { ascending: true });
        if(error) throw error;
        dirigenti = data || [];
        console.log('✅ Dirigenti caricati:', dirigenti.length);
      }catch(err){
        console.error('❌ Errore caricamento dirigenti:', err);
        dirigenti = [
          { nome_cognome:'Antonio Grande', ruolo:'Segretario Generale Regionale - Veneto', email:'veneto@carabinierinsic.it', telefono:'3351470886' }
        ];
      }
    }

    // Auth
    async function verificaAutenticazione(){
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session){
          console.log('❌ Nessuna sessione attiva');
          window.location.href = '../login.html';
          return null;
        }
        console.log('✅ Utente autenticato:', session.user.email);
        return session.user;
      }catch(err){
        console.error('❌ Errore verifica auth:', err);
        window.location.href = '../login.html';
        return null;
      }
    }

    // Help
    window.showHelp = function(){
      var help =
        '🆘 <strong>Aiuto Virgilio</strong><br><br>' +
        '<strong>Comandi disponibili:</strong><br>' +
        '• Usa i pulsanti rapidi per domande frequenti<br>' +
        '• Scrivi domande in linguaggio naturale<br>' +
        '• Chiedi informazioni su contratti e diritti<br>' +
        '• Per dirigenti sindacali scrivi "dirigenti"<br><br>' +
        '<strong>Contatti di emergenza:</strong><br>' +
        '📞 Telefono: 06-123456789<br>' +
        '📧 Email: assistenza@sindacato.it<br><br>' +
        '<em>Virgilio è sempre qui per aiutarti! ✨</em>';
      addMessage(help, 'system');
    };

    // Send
    async function sendMessage(){
      const message = messageInput.value.trim();
      if(!message || isProcessing) return;

      isProcessing = true; updateSendButton();

      addMessage(message, 'user');
      conversationHistory.push({ role:'user', content: message });

      messageInput.value=''; updateCharCount(); updateSendButton(); autoResizeTextarea();

      // comando locale: dirigenti
      if(/^\s*(dirigenti|contatti\s+dirigenti)\s*$/i.test(message)){
        if(dirigenti && dirigenti.length){
          var list = dirigenti.slice(0,12).map(function(d){
            var nome = escapeHtml(d.nome_cognome||'');
            var ruolo = escapeHtml(d.ruolo||'');
            var email = escapeHtml(d.email||'');
            var tel = escapeHtml(d.telefono||'');
            return '• <strong>' + nome + '</strong> — ' + ruolo + '<br>Email: ' + email + ' — Tel: ' + tel;
          }).join('<br><br>');
          addMessage(list, 'system');
        } else {
          addMessage('Nessun dirigente trovato al momento. Riprova più tardi.', 'system');
        }
        isProcessing=false; updateSendButton(); return;
      }

      showTyping();

      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session){ throw new Error('Sessione scaduta'); }

        const apiEndpoint =
          (window.location.hostname==='localhost' || window.location.hostname==='127.0.0.1')
          ? CHATBOT_CONFIG.apiEndpointLocal
          : CHATBOT_CONFIG.apiEndpoint;

        const needsWebSearch = /(?:\bultim[eaie]\b|\bnews\b|aggiornamenti|oggi|attuale|corrente|novit[àa]|contratto 2025|aumenti|stipendio 2025)/i.test(message);

        const requestBody = {
          messages: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory),
          model: CHATBOT_CONFIG.model,
          max_tokens: CHATBOT_CONFIG.maxTokens,
          temperature: CHATBOT_CONFIG.temperature,
          system_context: 'Sei Virgilio, assistente AI del Sindacato Carabinieri. Rispondi in modo conciso e professionale.',
          enable_web_search: needsWebSearch,
          web_search_query: needsWebSearch ? message : null
        };

        let lastError = null;
        for(let attempt=0; attempt<CHATBOT_CONFIG.retryAttempts; attempt++){
          try{
            const resp = await fetch(apiEndpoint, {
              method:'POST',
              headers:{
                'Content-Type':'application/json',
                'Authorization':'Bearer ' + session.access_token
              },
              body: JSON.stringify(requestBody)
            });
            if(!resp.ok){
              let msg = 'HTTP ' + resp.status;
              try{
                const j = await resp.json();
                if(j && j.error) msg = j.error;
              }catch(_){}
              throw new Error(msg);
            }
            const data = await resp.json();
            if(!data.choices || !data.choices[0] || !data.choices[0].message){
              throw new Error('Risposta API non valida');
            }

            const botResponse = data.choices[0].message.content;
            const hasWebSearch = !!data.web_search_performed;

            addMessage(botResponse, 'bot', hasWebSearch);
            conversationHistory.push({ role:'assistant', content: botResponse });

            if(data.usage){
              totalTokensUsed += (data.usage.total_tokens || 0);
              tokenCount.textContent = totalTokensUsed.toLocaleString();
            }
            lastError = null;
            break;
          }catch(err){
            lastError = err;
            console.warn('Tentativo fallito:', err.message);
            if(attempt < CHATBOT_CONFIG.retryAttempts-1){
              await new Promise(function(r){ setTimeout(r, CHATBOT_CONFIG.retryDelay*(attempt+1)); });
            }
          }
        }
        if(lastError) throw lastError;
        syncOnlineStatus();
      }catch(err){
        console.error('Errore invio:', err);
        conversationHistory.pop();
        let msg = 'Errore di connessione';
        if(/scadut/i.test(err.message)) msg = 'Sessione scaduta, riaccedi';
        else if(/network|fetch/i.test(err.message)) msg = 'Problema di rete, riprova';
        else if(/500/.test(err.message)) msg = 'Servizio temporaneamente non disponibile';
        else if(err.message) msg = err.message;
        showAlert(msg, 'error');
        syncOnlineStatus();
      }finally{
        hideTyping();
        isProcessing=false; updateSendButton(); messageInput.focus();
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async function(){
      document.getElementById('loading').classList.remove('hidden');
      try{
        syncOnlineStatus();

        currentUser = await verificaAutenticazione();
        if(!currentUser) return;

        await loadDirigenti();

        messageInput.addEventListener('input', function(){ updateCharCount(); updateSendButton(); autoResizeTextarea(); });
        messageInput.addEventListener('keypress', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
        sendButton.addEventListener('click', sendMessage);

        document.getElementById('clearChatBtn').addEventListener('click', function(){
          if(confirm('Vuoi davvero cancellare tutta la conversazione?')){
            conversationHistory=[]; totalTokensUsed=0; tokenCount.textContent='0';
            const msgs = messagesContainer.querySelectorAll('.message');
            msgs.forEach(function(msg, i){ if(i>0) msg.remove(); });
            showAlert('Chat cancellata con successo! ✨', 'success');
          }
        });

        messageInput.focus();
        updateSendButton();
        console.log('🤖✨ Virgilio inizializzato!');
      }catch(err){
        console.error('Errore init:', err);
        showAlert('Errore di inizializzazione. Ricarica la pagina.', 'error');
      }finally{
        document.getElementById('loading').classList.add('hidden');
      }
    });

    // Error handlers
    window.addEventListener('error', function (e){ console.error('Errore JS:', e.error); showAlert('Si è verificato un errore imprevisto', 'error'); });
    window.addEventListener('unhandledrejection', function (e){ console.error('Promise rejected:', e.reason); showAlert('Errore di rete o server', 'error'); });
  </script>
</body>
</html>
