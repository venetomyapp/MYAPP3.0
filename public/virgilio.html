<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ‚öôÔ∏è Supabase
  const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
  const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } });

  // üîå Chatbot config: proxy same-origin su Vercel
  const CHATBOT_CONFIG = {
    apiEndpoint: '/api/chat',
    apiEndpointLocal: 'http://localhost:3001/api/chat',
    maxTokens: 650,
    temperature: 0.3,
    model: 'gpt-4o-mini',
    maxHistory: 12,
    retryAttempts: 3,
    retryDelay: 1000
  };

  // üìö Policy di ricerca (istituzionale, IT, ultimi 2-3 anni)
  const SEARCH_CONSTRAINTS = {
    search_language: 'it',
    search_domains: [
      'carabinieri.it','difesa.it','gazzettaufficiale.it','giustizia.it','governo.it',
      'interno.gov.it','mit.gov.it','inpa.gov.it','concorsi.difesa.it',
      'altalex.com','diritto.it','cortedicassazione.it','consigliodistato.it'
    ],
    search_exclude_domains: ['wikipedia.org','facebook.com','x.com','twitter.com','instagram.com','forum.','blog.'],
    search_timeframe: '3y',          // ultimi 3 anni
    search_filetypes: ['pdf','doc','docx'],
    require_citations: true
  };

  // ‚úâÔ∏è Nota finale per licenze/istanze
  const CLOSING_NOTE =
    'Puoi verificare tutti i dettagli consultando direttamente la fonte ufficiale indicata. ' +
    'Per questa pratica ti consiglio di contattare il dirigente di zona: specifica se regionale o provinciale e di quale provincia. ' +
    'Puoi inviare subito la tua richiesta tramite questo link: https://myapp31.vercel.app/richieste.html\n\n' +
    'Per problemi in dettaglio contatta il tuo dirigente di zona.';

  // Rileva intent ‚Äúlicenze/istanze‚Äù
  function isLicenzeIstanzeTopic(text) {
    return /licenz|istanza|permess|conged|matern|patern|porto\s*(d['‚Äô]|\s)?armi|tulps|autorizz|pratica/i.test(text || '');
  }

  // Stato
  let currentUser = null;
  let conversationHistory = [];
  let isProcessing = false;
  let totalTokensUsed = 0;
  let dirigenti = [];

  // DOM
  const messagesContainer = document.getElementById('chatMessages');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const typingIndicator = document.getElementById('typingIndicator');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const tokenCount = document.getElementById('tokenCount');
  const charCount = document.getElementById('charCount');
  const alertContainer = document.getElementById('alertContainer');

  // Utils UI
  function showAlert(message, type) {
    if (!type) type = 'info';
    const el = document.createElement('div');
    el.className = 'alert alert-' + type;
    el.textContent = message;
    alertContainer.appendChild(el);
    setTimeout(() => el.remove(), 5000);
  }
  function updateConnectionStatus(connected) {
    if (connected) { statusDot.className = 'status-dot'; statusText.textContent = 'Connesso'; }
    else { statusDot.className = 'status-dot disconnected'; statusText.textContent = 'Offline'; }
  }
  function syncOnlineStatus(){ updateConnectionStatus(navigator.onLine); }
  window.addEventListener('online', syncOnlineStatus);
  window.addEventListener('offline', syncOnlineStatus);

  function updateCharCount(){ const c = messageInput.value.length; charCount.textContent = c; charCount.style.color = c>400 ? '#ef4444':'#6b7280'; }
  function updateSendButton(){ const has = messageInput.value.trim().length>0; sendButton.disabled = !has || isProcessing; }
  function autoResizeTextarea(){ messageInput.style.height='auto'; messageInput.style.height = Math.min(messageInput.scrollHeight,120) + 'px'; }
  function scrollToBottom(){ messagesContainer.scrollTop = messagesContainer.scrollHeight; }
  function showTyping(){ typingIndicator.classList.remove('hidden'); scrollToBottom(); }
  function hideTyping(){ typingIndicator.classList.add('hidden'); }
  function formatTime(){ return new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}); }
  function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
  function formatMessage(t){
    return escapeHtml(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
  }

  function addMessage(content, type, hasWebSearch){
    if(!type) type='bot';
    const m = document.createElement('div');
    m.className = 'message message-' + type;
    let badge = (hasWebSearch && type === 'bot') ? '<div class="web-search-badge">üåê Ricerca Web</div>' : '';
    if (type === 'user') {
      m.innerHTML =
        '<div class="avatar avatar-user">üë§</div>' +
        '<div class="message-content content-user">' +
          '<div>' + escapeHtml(content) + '</div>' +
          '<div class="message-time">' + formatTime() + '</div>' +
        '</div>';
    } else if (type === 'system') {
      const safe = formatMessage(content);
      m.innerHTML =
        '<div class="avatar avatar-system">‚ÑπÔ∏è</div>' +
        '<div class="message-content content-system">' +
          '<div>' + safe + '</div>' +
          '<div class="message-time">' + formatTime() + '</div>' +
        '</div>';
    } else {
      m.innerHTML =
        '<div class="avatar avatar-bot">ü§ñ</div>' +
        '<div class="message-content content-bot">' +
          badge +
          '<div>' + formatMessage(content) + '</div>' +
          '<div class="message-time">' + formatTime() + '</div>' +
        '</div>';
    }
    messagesContainer.appendChild(m);
    scrollToBottom();
  }

  // Dirigenti
  async function loadDirigenti(){
    try{
      const { data, error } = await supabase
        .from('organico_dirigentisindacali')
        .select('*')
        .order('id', { ascending: true });
      if(error) throw error;
      dirigenti = data || [];
      console.log('‚úÖ Dirigenti caricati:', dirigenti.length);
    }catch(err){
      console.error('‚ùå Errore caricamento dirigenti:', err);
      dirigenti = [
        { nome_cognome:'Antonio Grande', ruolo:'Segretario Generale Regionale - Veneto', email:'veneto@carabinierinsic.it', telefono:'3351470886' }
      ];
    }
  }

  // Auth
  async function verificaAutenticazione(){
    try{
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session){
        console.log('‚ùå Nessuna sessione attiva');
        window.location.href = '../login.html';
        return null;
      }
      console.log('‚úÖ Utente autenticato:', session.user.email);
      return session.user;
    }catch(err){
      console.error('‚ùå Errore verifica auth:', err);
      window.location.href = '../login.html';
      return null;
    }
  }

  // Help
  window.showHelp = function(){
    const help =
      'üÜò <strong>Aiuto Virgilio</strong><br><br>' +
      '<strong>Comandi disponibili:</strong><br>' +
      '‚Ä¢ Usa i pulsanti rapidi per domande frequenti<br>' +
      '‚Ä¢ Scrivi domande in linguaggio naturale<br>' +
      '‚Ä¢ Chiedi informazioni su contratti e diritti<br>' +
      '‚Ä¢ Per dirigenti sindacali scrivi "dirigenti"<br><br>' +
      '<strong>Contatti di emergenza:</strong><br>' +
      'üìû Telefono: 06-123456789<br>' +
      'üìß Email: assistenza@sindacato.it<br><br>' +
      '<em>Virgilio √® sempre qui per aiutarti! ‚ú®</em>';
    addMessage(help, 'system');
  };

  async function tentaRefreshSessione(){
    try {
      const { data, error } = await supabase.auth.refreshSession();
      if (error) throw error;
      return data?.session;
    } catch {
      return null;
    }
  }

  // üîé Self-check ENV sul server con Authorization
  async function infraCheck() {
    try {
      const { data:{ session } } = await supabase.auth.getSession();
      const token = session?.access_token;
      const r = await fetch('/api/whoami', { headers: token ? { Authorization: 'Bearer ' + token } : {} });
      const j = await r.json();
      console.log('[WHOAMI]', r.status, j);
      if (!j?.env?.SUPABASE_URL || !j?.env?.SUPABASE_ANON_KEY) {
        showAlert('Server: variabili Supabase mancanti in questo deploy.', 'error');
      }
    } catch (e) {
      console.warn('whoami check failed', e);
    }
  }

  // ‚úâÔ∏è Send
  async function sendMessage(){
    const message = messageInput.value.trim();
    if(!message || isProcessing) return;

    isProcessing = true; updateSendButton();

    addMessage(message, 'user');
    conversationHistory.push({ role:'user', content: message });

    messageInput.value=''; updateCharCount(); updateSendButton(); autoResizeTextarea();

    // comando locale: dirigenti
    if(/^\s*(dirigenti|contatti\s+dirigenti)\s*$/i.test(message)){
      if(dirigenti && dirigenti.length){
        const list = dirigenti.slice(0,12).map(d => {
          const nome = escapeHtml(d.nome_cognome||'');
          const ruolo = escapeHtml(d.ruolo||'');
          const email = escapeHtml(d.email||'');
          const tel = escapeHtml(d.telefono||'');
          return `‚Ä¢ <strong>${nome}</strong> ‚Äî ${ruolo}<br>Email: ${email} ‚Äî Tel: ${tel}`;
        }).join('<br><br>');
        addMessage(list, 'system');
      } else {
        addMessage('Nessun dirigente trovato al momento. Riprova pi√π tardi.', 'system');
      }
      isProcessing=false; updateSendButton(); return;
    }

    showTyping();

    try{
      let { data:{ session } } = await supabase.auth.getSession();
      if(!session){ throw new Error('Sessione scaduta'); }

      const apiEndpoint =
        (window.location.hostname==='localhost' || window.location.hostname==='127.0.0.1')
        ? CHATBOT_CONFIG.apiEndpointLocal
        : CHATBOT_CONFIG.apiEndpoint;

      // trigger ricerca web anche su parole chiave classiche
      const needsWebSearch =
        /(?:\bultim[eaie]\b|\bnews\b|aggiornamenti|oggi|attuale|corrente|novit[√†a]|contratto\s*202[4-6]|aumenti|stipendio\s*202[4-6]|bando|concorso|circolare|gazzetta)/i
        .test(message);

      const requestBody = {
        messages: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory),
        model: CHATBOT_CONFIG.model,
        max_tokens: CHATBOT_CONFIG.maxTokens,
        temperature: CHATBOT_CONFIG.temperature,
        system_context:
          'Sei Virgilio, assistente AI del Sindacato Carabinieri. ' +
          'Rispondi in italiano, tono istituzionale, conciso e puntuale. ' +
          'Cita sempre la fonte ufficiale con link diretto quando fai riferimento a norme o atti. ' +
          'Se non trovi la norma esatta, indica la procedura per reperirla su siti istituzionali.',
        enable_web_search: needsWebSearch,
        web_search_query: needsWebSearch ? message : null,

        // policy di ricerca
        ...SEARCH_CONSTRAINTS
      };

      // üîß DEBUG utile
      console.log('[DEBUG] origin:', location.origin);
      console.log('[DEBUG] endpoint:', apiEndpoint);
      console.log('[DEBUG] web?', needsWebSearch);

      let lastError = null;
      for(let attempt=0; attempt<CHATBOT_CONFIG.retryAttempts; attempt++){
        try{
          const resp = await fetch(apiEndpoint, {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer ' + session.access_token
            },
            body: JSON.stringify(requestBody)
          });

          if(resp.status === 401 && attempt < CHATBOT_CONFIG.retryAttempts-1){
            const refreshed = await tentaRefreshSessione();
            if (refreshed) { session = refreshed; continue; }
          }

          if(!resp.ok){
            let msg = 'HTTP ' + resp.status;
            try{
              const j = await resp.json();
              if(j && j.error) msg = j.error;
            }catch{}
            throw new Error(msg);
          }

          const data = await resp.json();
          if(!data.choices?.[0]?.message){
            throw new Error('Risposta API non valida');
          }

          let botResponse = data.choices[0].message.content || '';
          const hasWebSearch = !!data.web_search_performed;

          // aggiunta nota finale per licenze/istanze
          if (isLicenzeIstanzeTopic(message)) {
            botResponse = botResponse + '\n\n' + CLOSING_NOTE;
          }

          addMessage(botResponse, 'bot', hasWebSearch);
          conversationHistory.push({ role:'assistant', content: botResponse });

          if(data.usage?.total_tokens){
            totalTokensUsed += data.usage.total_tokens;
            tokenCount.textContent = totalTokensUsed.toLocaleString();
          }
          lastError = null;
          break;
        }catch(err){
          lastError = err;
          console.warn('Tentativo fallito:', err.message);
          if(attempt < CHATBOT_CONFIG.retryAttempts-1){
            await new Promise(r => setTimeout(r, CHATBOT_CONFIG.retryDelay*(attempt+1)));
          }
        }
      }
      if(lastError) throw lastError;
      syncOnlineStatus();
    }catch(err){
      console.error('Errore invio:', err);
      conversationHistory.pop();
      let msg = 'Errore di connessione';
      if(/scadut/i.test(err.message)) msg = 'Sessione scaduta, riaccedi';
      else if(/invalid|expired|401/i.test(err.message)) msg = 'Token non valido o scaduto';
      else if(/network|fetch/i.test(err.message)) msg = 'Problema di rete, riprova';
      else if(/500/.test(err.message)) msg = 'Servizio temporaneamente non disponibile';
      else if(err.message) msg = err.message;
      showAlert(msg, 'error');
      syncOnlineStatus();
    }finally{
      hideTyping();
      isProcessing=false; updateSendButton(); messageInput.focus();
    }
  }

  // Check proxy /api/chat all'avvio + infraCheck
  async function checkProxy(){
    try {
      const r = await fetch('/api/chat', { method:'OPTIONS' });
      if (r.status !== 200 && r.status !== 405) {
        showAlert('Attenzione: /api/chat non √® raggiungibile ('+r.status+').', 'error');
      }
    } catch {
      showAlert('Impossibile contattare /api/chat (controlla il deploy).', 'error');
    }
  }

  // Init
  document.addEventListener('DOMContentLoaded', async function(){
    document.getElementById('loading').classList.remove('hidden');
    try{
      syncOnlineStatus();

      await checkProxy();
      currentUser = await verificaAutenticazione();
      if(!currentUser) return;

      await infraCheck();     // <‚Äî verifica ENV server con Authorization
      await loadDirigenti();

      messageInput.addEventListener('input', () => { updateCharCount(); updateSendButton(); autoResizeTextarea(); });
      messageInput.addEventListener('keypress', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
      sendButton.addEventListener('click', sendMessage);

      // clear chat
      document.getElementById('clearChatBtn').addEventListener('click', function(){
        if(confirm('Vuoi davvero cancellare tutta la conversazione?')){
          conversationHistory=[]; totalTokensUsed=0; tokenCount.textContent='0';
          const msgs = messagesContainer.querySelectorAll('.message');
          msgs.forEach((msg, i) => { if(i>0) msg.remove(); });
          showAlert('Chat cancellata con successo! ‚ú®', 'success');
        }
      });

      messageInput.focus();
      updateSendButton();
      console.log('ü§ñ‚ú® Virgilio inizializzato!');
    }catch(err){
      console.error('Errore init:', err);
      showAlert('Errore di inizializzazione. Ricarica la pagina.', 'error');
    }finally{
      document.getElementById('loading').classList.add('hidden');
    }
  });

  // Error handlers
  window.addEventListener('error', e => { console.error('Errore JS:', e.error); showAlert('Si √® verificato un errore imprevisto', 'error'); });
  window.addEventListener('unhandledrejection', e => { console.error('Promise rejected:', e.reason); showAlert('Errore di rete o server', 'error'); });
</script>
