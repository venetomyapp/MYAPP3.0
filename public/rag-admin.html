<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard RAG (kDrive)</title>
  <style>
    /* --- STYLES identici al tuo file (omessi per brevit√†) --- */
    /* incolla qui i tuoi <style> esistenti: non ho cambiato nulla */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Admin Dashboard RAG</h1>
      <p>Gestione Documenti kDrive Infomaniak ‚Ä¢ Sistema Virgilio AI</p>
    </div>

    <div class="dashboard">
      <!-- Login Card -->
      <div class="card">
        <h3>üîê Autenticazione</h3>
        <div class="login-form">
          <div class="form-group">
            <label for="apiUrl">URL API Base</label>
            <input type="url" id="apiUrl" placeholder="https://your-app.vercel.app" />
          </div>

          <!-- Tab selector -->
          <div style="display:flex;gap:10px;margin-bottom:15px;">
            <button type="button" class="auth-tab active" onclick="switchAuthTab('email')" id="emailTab">üìß Email/Password</button>
            <button type="button" class="auth-tab" onclick="switchAuthTab('token')" id="tokenTab">üîë Token JWT</button>
            <button type="button" class="auth-tab" onclick="switchAuthTab('demo')" id="demoTab">üöÄ Demo Mode</button>
          </div>

          <!-- Email/Password Login -->
          <div id="emailAuth" class="auth-section">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" placeholder="admin@example.com"/>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" placeholder="Password"/>
            </div>
            <button class="btn btn-primary" onclick="loginWithEmail()">
              <span id="emailSpinner" class="spinner hidden"></span>
              Accedi con Email
            </button>
          </div>

          <!-- Token Login -->
          <div id="tokenAuth" class="auth-section hidden">
            <div class="form-group">
              <label for="token">Token JWT</label>
              <input type="password" id="token" placeholder="eyJhbGciOiJIUzI1NiIs..."/>
            </div>
            <button class="btn btn-primary" onclick="loginWithToken()">
              <span id="tokenSpinner" class="spinner hidden"></span>
              Accedi con Token
            </button>
          </div>

          <!-- Demo Mode (nascosto in prod) -->
          <div id="demoAuth" class="auth-section hidden">
            <div class="status info"><span>‚ÑπÔ∏è</span><span>Modalit√† demo - solo per sviluppo locale</span></div>
            <button class="btn btn-success" onclick="loginDemo()">
              <span id="demoSpinner" class="spinner hidden"></span>
              üöÄ Accesso Demo
            </button>
          </div>

          <div id="loginStatus" class="hidden"></div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="card">
        <h3>‚ö° Azioni kDrive</h3>

        <!-- NUOVO: campo Share URL -->
        <div class="form-group">
          <label for="shareUrl">kDrive Share URL</label>
          <input type="url" id="shareUrl"
                 placeholder="https://kdrive.infomaniak.com/app/share/..."
                 value="https://kdrive.infomaniak.com/app/share/1781004/feb4c14d-870c-48be-b6d3-46e9b6f94be8"/>
        </div>

        <div style="display:flex;flex-direction:column;gap:15px;margin-top:6px;">
          <button class="btn btn-success" onclick="discoverKDriveDocuments()" disabled id="discoverBtn">
            <span id="discoverSpinner" class="spinner hidden"></span>
            üîç Scopri Documenti kDrive
          </button>

          <button class="btn btn-warning" onclick="processKDriveDocuments()" disabled id="processBtn">
            <span id="processSpinner" class="spinner hidden"></span>
            üöÄ Processa Nuovi Documenti
          </button>
        </div>
        <div id="actionStatus" class="hidden"></div>
      </div>

      <!-- Statistics Card -->
      <div class="card">
        <h3>üìä Statistiche kDrive</h3>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number" id="kdrive-docs-count">-</div>
            <div class="stat-label">Documenti kDrive</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="total-chunks">-</div>
            <div class="stat-label">Chunks Totali</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="last-update">-</div>
            <div class="stat-label">Ultimo Aggiornamento</div>
          </div>
        </div>
        <div id="statsStatus" class="hidden"></div>
      </div>

      <!-- Status Card -->
      <div class="card">
        <h3>üéõÔ∏è Stato Sistema</h3>
        <div id="systemStatus">
          <div class="status info"><span>‚ÑπÔ∏è</span><span>Sistema in attesa di autenticazione...</span></div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="card log-container">
        <div style="color:#63b3ed;font-weight:bold;margin-bottom:15px;">üìù Log Attivit√† Sistema kDrive</div>
        <div id="activityLog"><div class="log-entry">Sistema avviato in attesa di login...</div></div>
      </div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    // Disattiva la demo di default. Riattivala solo in sviluppo locale.
    const ENABLE_DEMO =
      (location.hostname === 'localhost' || location.hostname.startsWith('127.')) &&
      (localStorage.getItem('enable_demo') === '1');

    let apiUrl = '';
    let authToken = '';
    let isAuthenticated = false;

    /* ====== UTIL ====== */
    function updateApiUrl() {
      apiUrl = (document.getElementById('apiUrl').value || '').trim();
      if (!apiUrl) return;
      if (!apiUrl.startsWith('http')) apiUrl = 'https://' + apiUrl;
      if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
      localStorage.setItem('apiUrl', apiUrl);
    }

    function showStatus(element, type, message) {
      element.className = `status ${type}`;
      element.innerHTML = `<span>${getStatusIcon(type)}</span><span>${message}</span>`;
      element.classList.remove('hidden');
    }
    function getStatusIcon(type) {
      return { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' }[type] || 'üìù';
    }
    function updateSystemStatus(type, message) {
      const systemStatus = document.getElementById('systemStatus');
      systemStatus.innerHTML = `<div class="status ${type}"><span>${getStatusIcon(type)}</span><span>${message}</span></div>`;
    }
    function logActivity(message, type='info') {
      const log = document.getElementById('activityLog');
      const timestamp = new Date().toLocaleTimeString('it-IT');
      const div = document.createElement('div');
      div.className = `log-entry ${type}`;
      div.textContent = `[${timestamp}] ${message}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }
    function enableActions() {
      document.getElementById('discoverBtn').disabled = false;
      document.getElementById('processBtn').disabled = false;
    }
    function switchAuthTab(tabType) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      const tabBtn = document.getElementById(tabType + 'Tab');
      if (tabBtn) tabBtn.classList.add('active');
      document.querySelectorAll('.auth-section').forEach(s => s.classList.add('hidden'));
      document.getElementById(tabType + 'Auth').classList.remove('hidden');
      document.getElementById('loginStatus').classList.add('hidden');
    }

    /* ====== AUTH ====== */
    async function loginWithEmail() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const emailSpinner = document.getElementById('emailSpinner');
      const loginStatus = document.getElementById('loginStatus');
      updateApiUrl();

      if (!email || !password) {
        showStatus(loginStatus, 'error', 'Email e password richiesti');
        return;
      }

      emailSpinner.classList.remove('hidden');
      try {
        const r = await fetch(`${apiUrl}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!r.ok) throw new Error(`Login failed: ${r.status}`);
        const data = await r.json();
        if (!data.access_token) throw new Error('Token mancante nella risposta');

        authToken = data.access_token;
        localStorage.setItem('authToken', authToken);
        isAuthenticated = true;

        showStatus(loginStatus, 'success', 'Login riuscito!');
        enableActions();
        updateSystemStatus('success', 'Sistema autenticato via email');
        logActivity('‚úÖ Login effettuato con email/password', 'success');
        await loadStatistics();
      } catch (e) {
        showStatus(loginStatus, 'error', `Errore login: ${e.message}`);
        logActivity(`‚ùå Errore login email: ${e.message}`, 'error');
      } finally {
        emailSpinner.classList.add('hidden');
      }
    }

    async function loginWithToken() {
      const tokenInput = document.getElementById('token');
      const tokenSpinner = document.getElementById('tokenSpinner');
      const loginStatus = document.getElementById('loginStatus');

      authToken = tokenInput.value.trim();
      if (!authToken) {
        showStatus(loginStatus, 'error', 'Token richiesto');
        return;
      }
      updateApiUrl();

      tokenSpinner.classList.remove('hidden');
      try {
        const r = await fetch(`${apiUrl}/api/auth/verify`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type':'application/json' }
        });
        if (!r.ok) throw new Error(`Token verification failed: ${r.status}`);
        const data = await r.json();

        localStorage.setItem('authToken', authToken);
        isAuthenticated = true;

        showStatus(loginStatus, 'success', 'Autenticazione token riuscita!');
        enableActions();
        updateSystemStatus('success', `Sistema autenticato via ${data.token_type || 'token'}`);
        logActivity('‚úÖ Login effettuato con token JWT', 'success');
        await loadStatistics();
      } catch (e) {
        showStatus(loginStatus, 'error', `Errore token: ${e.message}`);
        logActivity(`‚ùå Errore login token: ${e.message}`, 'error');
      } finally {
        tokenSpinner.classList.add('hidden');
      }
    }

    async function loginDemo() {
      if (!ENABLE_DEMO) {
        updateSystemStatus('warning', 'Demo disabilitata in produzione');
        logActivity('‚ö†Ô∏è Demo Mode disabilitata', 'warning');
        return;
      }
      const demoSpinner = document.getElementById('demoSpinner');
      const loginStatus = document.getElementById('loginStatus');
      updateApiUrl();
      demoSpinner.classList.remove('hidden');

      try {
        const r = await fetch(`${apiUrl}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'demo@virgilio.ai', password: 'demo123' })
        });
        if (!r.ok) throw new Error('Demo login API non disponibile');

        const data = await r.json();
        authToken = data.access_token;
        localStorage.setItem('authToken', authToken);
        isAuthenticated = true;

        showStatus(loginStatus, 'success', 'üöÄ Demo attivata (sviluppo locale)');
        enableActions();
        updateSystemStatus('success', 'Sistema in modalit√† demo');
        logActivity('üöÄ Modalit√† demo attivata con token reale', 'success');
        await loadStatistics();
      } catch (e) {
        showStatus(loginStatus, 'error', `‚ùå Errore demo: ${e.message}`);
        logActivity(`‚ùå Errore modalit√† demo: ${e.message}`, 'error');
      } finally {
        demoSpinner.classList.add('hidden');
      }
    }

    /* ====== KDRIVE ====== */
    async function discoverKDriveDocuments() {
      if (!isAuthenticated) return alert('Effettua prima il login');

      const discoverBtn = document.getElementById('discoverBtn');
      const discoverSpinner = document.getElementById('discoverSpinner');
      const actionStatus = document.getElementById('actionStatus');
      const shareUrl = (document.getElementById('shareUrl').value || '').trim();

      if (!shareUrl) {
        showStatus(actionStatus, 'warning', 'Inserisci il kDrive Share URL');
        return;
      }

      localStorage.setItem('shareUrl', shareUrl);
      discoverBtn.disabled = true;
      discoverSpinner.classList.remove('hidden');
      actionStatus.classList.add('hidden');
      logActivity('üîç Avvio discovery documenti kDrive...', 'info');

      try {
        updateApiUrl();
        const url = `${apiUrl}/api/sync/discover-kdrive?share_url=${encodeURIComponent(shareUrl)}`;

        const r = await fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` } });
        if (!r.ok) throw new Error(`API Error ${r.status}: ${(await r.text()).slice(0,200)}`);

        const data = await r.json();
        if (!data.success) throw new Error(data.message || 'Discovery fallito');

        const s = data.statistics || {};
        showStatus(actionStatus, 'success',
          `üéâ Discovery completato: ${s.total_discovered || 0} documenti, ${s.new_files || 0} nuovi`);
        logActivity(`‚úÖ Discovery kDrive completato: ${s.total_discovered || 0} documenti`, 'success');
        logActivity(`üìÑ Nuovi file da processare: ${s.new_files || 0}`, 'info');
        logActivity(`üîß Metodo discovery: ${s.discovery_method || 'unknown'}`, 'info');
        logActivity(`‚è±Ô∏è Tempo discovery: ${s.discovery_time_ms || 0}ms`, 'info');

        document.getElementById('kdrive-docs-count').textContent = s.total_discovered || 0;
        updateSystemStatus('success', `Discovery completato sulla share kDrive`);

        if (s.new_files > 0) logActivity(`üöÄ ${s.new_files} file pronti per il processing`, 'info');
        if (data.files?.length) logActivity(`üìÇ File trovati: ${data.files.map(f=>f.name).join(', ')}`, 'info');

      } catch (e) {
        showStatus(actionStatus, 'error', `‚ùå Errore discovery: ${e.message}`);
        logActivity(`‚ùå Errore discovery kDrive: ${e.message}`, 'error');
        updateSystemStatus('error', 'Errore durante discovery kDrive');
      } finally {
        discoverBtn.disabled = false;
        discoverSpinner.classList.add('hidden');
        actionStatus.classList.remove('hidden');
      }
    }

    async function processKDriveDocuments() {
      if (!isAuthenticated) return alert('Effettua prima il login');

      const processBtn = document.getElementById('processBtn');
      const processSpinner = document.getElementById('processSpinner');
      const actionStatus = document.getElementById('actionStatus');
      const shareUrl = (document.getElementById('shareUrl').value || '').trim();

      if (!shareUrl) {
        showStatus(actionStatus, 'warning', 'Inserisci il kDrive Share URL');
        return;
      }

      logActivity('üîç Ricerca file kDrive da processare...', 'info');

      try {
        updateApiUrl();

        // 1) refresh discovery (stessa share)
        const d = await fetch(`${apiUrl}/api/sync/discover-kdrive?share_url=${encodeURIComponent(shareUrl)}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!d.ok) throw new Error(`Discovery API error: ${d.status}`);
        const discoverData = await d.json();
        if (!discoverData.success) throw new Error(discoverData.message || 'Impossibile ottenere lista file');

        const newFiles = discoverData.files?.filter(f => f.needs_processing) || [];
        if (newFiles.length === 0) {
          showStatus(actionStatus, 'warning', '‚ö†Ô∏è Nessun nuovo file da processare');
          logActivity('‚ö†Ô∏è Nessun nuovo file kDrive trovato da processare', 'warning');
          return;
        }

        processBtn.disabled = true;
        processSpinner.classList.remove('hidden');
        actionStatus.classList.add('hidden');

        logActivity(`üöÄ Avvio processing ${newFiles.length} file kDrive...`, 'info');
        logActivity(`üìÇ File da processare: ${newFiles.map(f => f.name).join(', ')}`, 'info');

        // 2) processing
        const pr = await fetch(`${apiUrl}/api/sync/process-kdrive`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type':'application/json' },
          body: JSON.stringify({ files: newFiles.map(f => f.name), source: 'dashboard-kdrive', share_url: shareUrl })
        });
        if (!pr.ok) throw new Error(`Processing API error ${pr.status}: ${(await pr.text()).slice(0,200)}`);

        const processData = await pr.json();
        if (!processData.success) throw new Error(processData.message || 'Processing fallito');

        const s = processData.statistics || {};
        showStatus(actionStatus, 'success',
          `üéâ Processing completato: ${s.files_processed}/${s.files_requested} file, ${s.total_chunks_saved} chunks`);

        logActivity(`‚úÖ Processing kDrive completato: ${s.files_processed} file processati`, 'success');
        logActivity(`üìö Chunks creati: ${s.total_chunks_saved}`, 'success');

        if (processData.results?.length) {
          processData.results.forEach(r => {
            if (r.success) logActivity(`‚úÖ ${r.filename}: ${r.chunks_saved} chunks`, 'success');
            else logActivity(`‚ùå ${r.filename}: ${r.error}`, 'error');
          });
        }

        const current = parseInt(document.getElementById('total-chunks').textContent) || 0;
        document.getElementById('total-chunks').textContent = current + (s.total_chunks_saved || 0);
        updateSystemStatus('success', `Processing completato: ${s.total_chunks_saved} nuovi chunks creati`);
        await loadStatistics();

      } catch (e) {
        showStatus(actionStatus, 'error', `‚ùå Errore processing: ${e.message}`);
        logActivity(`‚ùå Errore processing kDrive: ${e.message}`, 'error');
        updateSystemStatus('error', 'Errore durante processing kDrive');
      } finally {
        processBtn.disabled = false;
        processSpinner.classList.add('hidden');
        actionStatus.classList.remove('hidden');
      }
    }

    /* ====== STATS ====== */
    async function loadStatistics() {
      if (!isAuthenticated) return;
      try {
        updateApiUrl();
        const r = await fetch(`${apiUrl}/api/documents/count`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) throw new Error(`API stats error: ${r.status}`);
        const data = await r.json();
        if (!data.success) throw new Error(data.message || 'Statistiche non disponibili');

        document.getElementById('total-chunks').textContent = data.total || 0;
        document.getElementById('last-update').textContent = new Date().toLocaleDateString('it-IT');
        logActivity(`üìä Statistiche caricate: ${data.total || 0} chunks`, 'info');

        if (data.platforms) {
          const p = Object.entries(data.platforms).map(([k,v]) => `${k}: ${v}`).join(', ');
          logActivity(`üìä Piattaforme: ${p}`, 'info');
        }
      } catch (e) {
        logActivity(`‚ùå Errore caricamento statistiche: ${e.message}`, 'error');
      }
    }

    /* ====== BOOT ====== */
    document.addEventListener('DOMContentLoaded', () => {
      // Prefill da localStorage
      const savedApi = localStorage.getItem('apiUrl');
      if (savedApi) document.getElementById('apiUrl').value = savedApi;

      const savedShare = localStorage.getItem('shareUrl');
      if (savedShare) document.getElementById('shareUrl').value = savedShare;

      // Demo disabilitata in prod
      if (!ENABLE_DEMO) {
        document.getElementById('demoTab').classList.add('hidden');
        document.getElementById('demoAuth').classList.add('hidden');
      }

      // Tab di default: EMAIL (no auto-demo)
      switchAuthTab('email');

      logActivity('üöÄ Dashboard kDrive avviata (modalit√† reale)', 'info');
      logActivity('üîó Inserisci API URL, fai login e usa la tua Share kDrive', 'info');
      updateSystemStatus('info', 'In attesa di autenticazione...');
    });
  </script>
</body>
</html>
