<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard RAG (kDrive)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .card h3 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #68d391;
        }

        .status.error {
            background: #fff5f5;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.warning {
            background: #fffbeb;
            color: #744210;
            border: 1px solid #f6e05e;
        }

        .status.info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #63b3ed;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #5a67d8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5a67d8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        .log-container {
            grid-column: 1 / -1;
            max-height: 400px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #fed7d7;
        }

        .log-entry.success {
            color: #c6f6d5;
        }

        .log-entry.warning {
            color: #faf089;
        }

        .hidden {
            display: none !important;
        }

        .auth-tab {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: #5a67d8;
            color: white;
            border-color: #5a67d8;
        }

        .auth-tab:hover:not(.active) {
            border-color: #5a67d8;
            background: #f7fafc;
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Admin Dashboard RAG</h1>
            <p>Gestione Documenti kDrive Infomaniak ‚Ä¢ Sistema Virgilio AI</p>
        </div>

        <div class="dashboard">
            <!-- Login Card -->
            <div class="card">
                <h3>üîê Autenticazione</h3>
                <div class="login-form">
                    <div class="form-group">
                        <label for="apiUrl">URL API Base</label>
                        <input type="url" id="apiUrl" value="https://myapp31.vercel.app" placeholder="https://your-app.vercel.app">
                    </div>
                    
                    <!-- Tab selector -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="auth-tab active" onclick="switchAuthTab('email')" id="emailTab">
                            üìß Email/Password
                        </button>
                        <button type="button" class="auth-tab" onclick="switchAuthTab('token')" id="tokenTab">
                            üîë Token JWT
                        </button>
                        <button type="button" class="auth-tab" onclick="switchAuthTab('demo')" id="demoTab">
                            üöÄ Demo Mode
                        </button>
                    </div>

                    <!-- Email/Password Login -->
                    <div id="emailAuth" class="auth-section">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" placeholder="admin@example.com">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" placeholder="Password">
                        </div>
                        <button class="btn btn-primary" onclick="loginWithEmail()">
                            <span id="emailSpinner" class="spinner hidden"></span>
                            Accedi con Email
                        </button>
                    </div>

                    <!-- Token Login -->
                    <div id="tokenAuth" class="auth-section hidden">
                        <div class="form-group">
                            <label for="token">Token Supabase JWT</label>
                            <input type="password" id="token" placeholder="eyJhbGciOiJIUzI1NiIs...">
                        </div>
                        <button class="btn btn-primary" onclick="loginWithToken()">
                            <span id="tokenSpinner" class="spinner hidden"></span>
                            Accedi con Token
                        </button>
                    </div>

                    <!-- Demo Mode -->
                    <div id="demoAuth" class="auth-section hidden">
                        <div class="status info">
                            <span>‚ÑπÔ∏è</span>
                            <span>Modalit√† demo - accesso diretto per testing</span>
                        </div>
                        <button class="btn btn-success" onclick="loginDemo()">
                            <span id="demoSpinner" class="spinner hidden"></span>
                            üöÄ Accesso Demo
                        </button>
                    </div>

                    <div id="loginStatus" class="hidden"></div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card">
                <h3>‚ö° Azioni kDrive</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-success" onclick="discoverKDriveDocuments()" disabled id="discoverBtn">
                        <span id="discoverSpinner" class="spinner hidden"></span>
                        üîç Scopri Documenti kDrive
                    </button>
                    
                    <button class="btn btn-warning" onclick="processKDriveDocuments()" disabled id="processBtn">
                        <span id="processSpinner" class="spinner hidden"></span>
                        üöÄ Processa Nuovi Documenti
                    </button>
                </div>
                <div id="actionStatus" class="hidden"></div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h3>üìä Statistiche kDrive</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="kdrive-docs-count">-</div>
                        <div class="stat-label">Documenti kDrive</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-chunks">-</div>
                        <div class="stat-label">Chunks Totali</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="last-update">-</div>
                        <div class="stat-label">Ultimo Aggiornamento</div>
                    </div>
                </div>
                <div id="statsStatus" class="hidden"></div>
            </div>

            <!-- Status Card -->
            <div class="card">
                <h3>üéõÔ∏è Stato Sistema</h3>
                <div id="systemStatus">
                    <div class="status info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Sistema in attesa di autenticazione...</span>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card log-container">
                <div style="color: #63b3ed; font-weight: bold; margin-bottom: 15px;">üìù Log Attivit√† Sistema kDrive</div>
                <div id="activityLog">
                    <div class="log-entry">Sistema avviato in attesa di login...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiUrl = '';
        let authToken = '';
        let isAuthenticated = false;

        // Configurazione
        function updateApiUrl() {
            apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl.startsWith('http')) {
                apiUrl = 'https://' + apiUrl;
            }
            if (apiUrl.endsWith('/')) {
                apiUrl = apiUrl.slice(0, -1);
            }
        }

        // Switch authentication tabs
        function switchAuthTab(tabType) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabType + 'Tab').classList.add('active');
            
            // Show/hide auth sections
            document.querySelectorAll('.auth-section').forEach(section => section.classList.add('hidden'));
            document.getElementById(tabType + 'Auth').classList.remove('hidden');
            
            // Clear previous status
            document.getElementById('loginStatus').classList.add('hidden');
        }

        // Login with Email/Password
        async function loginWithEmail() {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const emailSpinner = document.getElementById('emailSpinner');
            const loginStatus = document.getElementById('loginStatus');

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            updateApiUrl();

            if (!email || !password) {
                showStatus(loginStatus, 'error', 'Email e password richiesti');
                return;
            }

            emailSpinner.classList.remove('hidden');

            try {
                const response = await fetch(`${apiUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.access_token) {
                        authToken = data.access_token;
                        isAuthenticated = true;
                        showStatus(loginStatus, 'success', 'Login con email riuscito!');
                        enableActions();
                        updateSystemStatus('success', 'Sistema autenticato via email');
                        logActivity('‚úÖ Login effettuato con email/password', 'success');
                        await loadStatistics();
                        return;
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Errore sconosciuto' }));
                    throw new Error(errorData.error || `Login failed: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Email login error:', error);
                showStatus(loginStatus, 'error', `Errore login: ${error.message}`);
                logActivity(`‚ùå Errore login email: ${error.message}`, 'error');
            } finally {
                emailSpinner.classList.add('hidden');
            }
        }

        // Login with JWT Token  
        async function loginWithToken() {
            const tokenInput = document.getElementById('token');
            const tokenSpinner = document.getElementById('tokenSpinner');
            const loginStatus = document.getElementById('loginStatus');

            authToken = tokenInput.value.trim();
            updateApiUrl();

            if (!authToken) {
                showStatus(loginStatus, 'error', 'Token richiesto');
                return;
            }

            tokenSpinner.classList.remove('hidden');

            try {
                const response = await fetch(`${apiUrl}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    isAuthenticated = true;
                    showStatus(loginStatus, 'success', 'Autenticazione token riuscita!');
                    enableActions();
                    updateSystemStatus('success', `Sistema autenticato via ${data.token_type || 'token'}`);
                    logActivity('‚úÖ Login effettuato con token JWT', 'success');
                    await loadStatistics();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Token non valido' }));
                    throw new Error(errorData.error || `Token verification failed: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Token login error:', error);
                showStatus(loginStatus, 'error', `Errore token: ${error.message}`);
                logActivity(`‚ùå Errore login token: ${error.message}`, 'error');
            } finally {
                tokenSpinner.classList.add('hidden');
            }
        }

        // Demo Mode Login (Client-side only)
        async function loginDemo() {
            const demoSpinner = document.getElementById('demoSpinner');
            const loginStatus = document.getElementById('loginStatus');

            updateApiUrl();
            demoSpinner.classList.remove('hidden');

            try {
                // Demo mode gets a real demo token from the API
                const response = await fetch(`${apiUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: 'demo@virgilio.ai', 
                        password: 'demo123' 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    isAuthenticated = true;
                    
                    showStatus(loginStatus, 'success', 'üöÄ Modalit√† demo attivata!');
                    enableActions();
                    updateSystemStatus('success', 'Sistema in modalit√† demo - kDrive reale');
                    logActivity('üöÄ Modalit√† demo attivata con token reale', 'success');
                    logActivity('‚úÖ Ready per kDrive discovery/processing reale', 'success');
                    
                    await loadStatistics();
                } else {
                    throw new Error('Demo login API non disponibile');
                }

            } catch (error) {
                console.error('Demo login error:', error);
                showStatus(loginStatus, 'error', `‚ùå Errore demo: ${error.message}`);
                logActivity(`‚ùå Errore modalit√† demo: ${error.message}`, 'error');
                updateSystemStatus('error', 'Demo mode non disponibile');
            } finally {
                demoSpinner.classList.add('hidden');
            }
        }

        // Legacy login function (removed)
        // async function login() { ... }

        // Enable actions after login
        function enableActions() {
            document.getElementById('discoverBtn').disabled = false;
            document.getElementById('processBtn').disabled = false;
        }

        // Discover kDrive documents (API reale)
        async function discoverKDriveDocuments() {
            if (!isAuthenticated) {
                alert('Effettua prima il login');
                return;
            }

            const discoverBtn = document.getElementById('discoverBtn');
            const discoverSpinner = document.getElementById('discoverSpinner');
            const actionStatus = document.getElementById('actionStatus');

            discoverBtn.disabled = true;
            discoverSpinner.classList.remove('hidden');
            actionStatus.classList.add('hidden');

            logActivity('üîç Avvio discovery documenti kDrive...', 'info');

            try {
                updateApiUrl();
                
                const response = await fetch(`${apiUrl}/api/sync/discover-kdrive`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`API Error ${response.status}: ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.success) {
                    const stats = data.statistics || {};
                    showStatus(actionStatus, 'success', 
                        `üéâ Discovery completato: ${stats.total_discovered || 0} documenti trovati, ${stats.new_files || 0} nuovi`);
                    
                    logActivity(`‚úÖ Discovery kDrive completato: ${stats.total_discovered || 0} documenti`, 'success');
                    logActivity(`üìÑ Nuovi file da processare: ${stats.new_files || 0}`, 'info');
                    logActivity(`üîß Metodo discovery: ${stats.discovery_method || 'unknown'}`, 'info');
                    logActivity(`‚è±Ô∏è Tempo discovery: ${stats.discovery_time_ms || 0}ms`, 'info');
                    
                    // Update statistics
                    document.getElementById('kdrive-docs-count').textContent = stats.total_discovered || 0;
                    
                    updateSystemStatus('success', 
                        `Discovery completato: ${stats.total_discovered || 0} documenti kDrive trovati`);
                    
                    // Enable process button if new files found
                    if (stats.new_files > 0) {
                        document.getElementById('processBtn').style.background = 
                            'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                        logActivity(`üöÄ ${stats.new_files} file pronti per il processing`, 'info');
                    }
                    
                    // Log details about files found
                    if (data.files && data.files.length > 0) {
                        logActivity(`üìÇ File trovati: ${data.files.map(f => f.name).join(', ')}`, 'info');
                    }
                } else {
                    throw new Error(data.message || 'Discovery fallito');
                }
                
            } catch (error) {
                console.error('Discovery error:', error);
                showStatus(actionStatus, 'error', `‚ùå Errore discovery: ${error.message}`);
                logActivity(`‚ùå Errore discovery kDrive: ${error.message}`, 'error');
                updateSystemStatus('error', 'Errore durante discovery kDrive');
                
                // Log suggestions for fixing
                if (error.message.includes('404')) {
                    logActivity('üí° Suggerimento: Verifica che il file /api/sync/discover-kdrive.js esista', 'warning');
                } else if (error.message.includes('401')) {
                    logActivity('üí° Suggerimento: Verifica token di autenticazione', 'warning');
                } else if (error.message.includes('500')) {
                    logActivity('üí° Suggerimento: Controlla i log del server per errori interni', 'warning');
                }
            } finally {
                discoverBtn.disabled = false;
                discoverSpinner.classList.add('hidden');
                actionStatus.classList.remove('hidden');
            }
        }

        // Process kDrive documents (API reale)
        async function processKDriveDocuments() {
            if (!isAuthenticated) {
                alert('Effettua prima il login');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            const processSpinner = document.getElementById('processSpinner');
            const actionStatus = document.getElementById('actionStatus');

            logActivity('üîç Ricerca file kDrive da processare...', 'info');
            
            try {
                updateApiUrl();
                
                // First, get list of files to process
                const discoverResponse = await fetch(`${apiUrl}/api/sync/discover-kdrive`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!discoverResponse.ok) {
                    throw new Error(`Discovery API error: ${discoverResponse.status}`);
                }

                const discoverData = await discoverResponse.json();
                
                if (!discoverData.success) {
                    throw new Error(discoverData.message || 'Impossibile ottenere lista file');
                }

                const newFiles = discoverData.files?.filter(f => f.needs_processing) || [];
                
                if (newFiles.length === 0) {
                    showStatus(actionStatus, 'warning', '‚ö†Ô∏è Nessun nuovo file da processare');
                    logActivity('‚ö†Ô∏è Nessun nuovo file kDrive trovato da processare', 'warning');
                    logActivity('üí° Esegui prima il discovery per trovare nuovi file', 'info');
                    return;
                }

                processBtn.disabled = true;
                processSpinner.classList.remove('hidden');
                actionStatus.classList.add('hidden');

                logActivity(`üöÄ Avvio processing ${newFiles.length} file kDrive...`, 'info');
                logActivity(`üìÇ File da processare: ${newFiles.map(f => f.name).join(', ')}`, 'info');

                // Process files via API
                const processResponse = await fetch(`${apiUrl}/api/sync/process-kdrive`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: newFiles.map(f => f.name),
                        source: 'dashboard-kdrive'
                    })
                });

                if (!processResponse.ok) {
                    const errorText = await processResponse.text().catch(() => 'Unknown error');
                    throw new Error(`Processing API error ${processResponse.status}: ${errorText.substring(0, 200)}`);
                }

                const processData = await processResponse.json();

                if (processData.success) {
                    const stats = processData.statistics || {};
                    showStatus(actionStatus, 'success', 
                        `üéâ Processing completato: ${stats.files_processed}/${stats.files_requested} file, ${stats.total_chunks_saved} chunks`);
                    
                    logActivity(`‚úÖ Processing kDrive completato: ${stats.files_processed} file processati`, 'success');
                    logActivity(`üìö Chunks creati: ${stats.total_chunks_saved}`, 'success');
                    
                    // Log details about each processed file
                    if (processData.results && processData.results.length > 0) {
                        processData.results.forEach(result => {
                            if (result.success) {
                                logActivity(`‚úÖ ${result.filename}: ${result.chunks_saved} chunks`, 'success');
                            } else {
                                logActivity(`‚ùå ${result.filename}: ${result.error}`, 'error');
                            }
                        });
                    }
                    
                    // Update statistics
                    const currentChunks = parseInt(document.getElementById('total-chunks').textContent) || 0;
                    document.getElementById('total-chunks').textContent = currentChunks + (stats.total_chunks_saved || 0);
                    
                    updateSystemStatus('success', 
                        `Processing completato: ${stats.total_chunks_saved} nuovi chunks creati`);
                    
                    await loadStatistics();
                } else {
                    throw new Error(processData.message || 'Processing fallito');
                }
                
            } catch (error) {
                console.error('Processing error:', error);
                showStatus(actionStatus, 'error', `‚ùå Errore processing: ${error.message}`);
                logActivity(`‚ùå Errore processing kDrive: ${error.message}`, 'error');
                updateSystemStatus('error', 'Errore durante processing kDrive');
                
                // Log suggestions for fixing
                if (error.message.includes('404')) {
                    logActivity('üí° Suggerimento: Verifica che il file /api/sync/process-kdrive.js esista', 'warning');
                } else if (error.message.includes('401')) {
                    logActivity('üí° Suggerimento: Verifica token di autenticazione', 'warning');
                } else if (error.message.includes('500')) {
                    logActivity('üí° Suggerimento: Controlla i log del server e configurazione OPENAI_API_KEY', 'warning');
                }
            } finally {
                processBtn.disabled = false;
                processSpinner.classList.add('hidden');
                actionStatus.classList.remove('hidden');
            }
        }

        // Load statistics (API reale)
        async function loadStatistics() {
            if (!isAuthenticated) return;

            try {
                updateApiUrl();
                
                const docsResponse = await fetch(`${apiUrl}/api/documents/count`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!docsResponse.ok) {
                    throw new Error(`API stats error: ${docsResponse.status}`);
                }

                const docsData = await docsResponse.json();
                
                if (docsData.success) {
                    document.getElementById('total-chunks').textContent = docsData.total || 0;
                    
                    const lastUpdate = new Date().toLocaleDateString('it-IT');
                    document.getElementById('last-update').textContent = lastUpdate;
                    
                    logActivity(`üìä Statistiche caricate: ${docsData.total || 0} chunks`, 'info');
                    
                    // Log additional statistics if available
                    if (docsData.platforms) {
                        const platforms = Object.entries(docsData.platforms)
                            .map(([platform, count]) => `${platform}: ${count}`)
                            .join(', ');
                        logActivity(`üìä Piattaforme: ${platforms}`, 'info');
                    }
                    
                    if (docsData.recent_files && docsData.recent_files.length > 0) {
                        logActivity(`üìä File recenti: ${docsData.recent_files.length} trovati`, 'info');
                    }
                } else {
                    throw new Error(docsData.message || 'Statistiche non disponibili');
                }
                
            } catch (error) {
                console.error('Stats error:', error);
                logActivity(`‚ùå Errore caricamento statistiche: ${error.message}`, 'error');
                
                // Don't use demo statistics - just show error
                if (error.message.includes('404')) {
                    logActivity('üí° Suggerimento: Crea il file /api/documents/count.js', 'warning');
                } else if (error.message.includes('401')) {
                    logActivity('üí° Suggerimento: Verifica token di autenticazione', 'warning');
                } else if (error.message.includes('500')) {
                    logActivity('üí° Suggerimento: Verifica configurazione Supabase nel file API', 'warning');
                }
            }
        }

        // Utility functions
        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.innerHTML = `<span>${getStatusIcon(type)}</span><span>${message}</span>`;
            element.classList.remove('hidden');
        }

        function getStatusIcon(type) {
            switch(type) {
                case 'success': return '‚úÖ';
                case 'error': return '‚ùå';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return '‚ÑπÔ∏è';
                default: return 'üìù';
            }
        }

        function updateSystemStatus(type, message) {
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.innerHTML = `<div class="status ${type}"><span>${getStatusIcon(type)}</span><span>${message}</span></div>`;
        }

        function logActivity(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString('it-IT');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logActivity('üöÄ Dashboard kDrive Sistema REALE avviata', 'info');
            logActivity('üîó Connessione: kDrive Infomaniak Share', 'info');
            logActivity('‚ö° Sistema configurato per API REALI - NO SIMULAZIONI', 'success');
            logActivity('', 'info');
            logActivity('üéØ MODALIT√Ä DI AUTENTICAZIONE:', 'info');
            logActivity('', 'info');
            logActivity('   üöÄ DEMO MODE (RACCOMANDATO):', 'success');
            logActivity('      ‚úÖ Usa credenziali demo@virgilio.ai / demo123', 'success');
            logActivity('      ‚úÖ Ottiene token reale dal sistema', 'success');
            logActivity('      ‚úÖ Testa API kDrive reali', 'success');
            logActivity('', 'info');
            logActivity('   üìß EMAIL/PASSWORD:', 'info');
            logActivity('      ‚úÖ admin@virgilio.ai / virgilio2024', 'info');
            logActivity('      ‚úÖ admin@example.com / admin123', 'info');
            logActivity('      ‚úÖ test@test.com / test123', 'info');
            logActivity('      ‚úÖ qualsiasi-email / demo123', 'info');
            logActivity('', 'info');
            logActivity('   üîë TOKEN JWT:', 'info');
            logActivity('      üî• Incolla il tuo SUPABASE_ANON_KEY', 'info');
            logActivity('      üî• Oppure SUPABASE_SERVICE_ROLE_KEY', 'info');
            logActivity('', 'info');
            logActivity('üìã REQUISITI PER IL FUNZIONAMENTO:', 'warning');
            logActivity('   ‚úÖ File /api/auth/verify.js', 'warning');
            logActivity('   ‚úÖ File /api/auth/login.js', 'warning');
            logActivity('   ‚úÖ File /api/documents/count.js', 'warning');
            logActivity('   ‚úÖ File /api/sync/discover-kdrive.js', 'warning');
            logActivity('   ‚úÖ File /api/sync/process-kdrive.js', 'warning');
            logActivity('   ‚úÖ Variabili ENV: SUPABASE_URL, SUPABASE_ANON_KEY', 'warning');
            logActivity('   ‚úÖ Variabili ENV: OPENAI_API_KEY', 'warning');
            logActivity('', 'info');
            logActivity('üéØ PER INIZIARE: Clicca "üöÄ Demo Mode" ‚Üí "Accesso Demo"', 'success');
            
            // Set default tab to demo mode
            switchAuthTab('demo');
        });
    </script>
</body>
</html>
