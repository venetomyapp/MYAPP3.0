<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Convenzioni - MyApp Aurora Boreale 2025</title>

  <!-- PWA Meta -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MyApp">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:'#1a1a2e',secondary:'#16213e',accent:'#0f3460',aurora:'#e94560',
            cyan:'#00d4ff',magenta:'#ff006e',gold:'#ffd700',teal:'#03dac6',
            dark:'#0a0a23',light:'#f8fafc',muted:'#64748b',success:'#00ea8d',
            warning:'#ffb800',error:'#ff4757',
          },
          fontFamily:{ sans:['Inter','system-ui','sans-serif'] },
          screens:{ xs:'320px',sm:'640px',md:'768px',lg:'1024px',xl:'1280px','2xl':'1536px','3xl':'1920px','4xl':'2560px' },
          fontSize:{
            'fluid-xs':'clamp(0.75rem,2vw,.875rem)',
            'fluid-sm':'clamp(.875rem,2.5vw,1rem)',
            'fluid-base':'clamp(1rem,2.5vw,1.125rem)',
            'fluid-lg':'clamp(1.125rem,3vw,1.25rem)',
            'fluid-xl':'clamp(1.25rem,3.5vw,1.5rem)',
            'fluid-2xl':'clamp(1.5rem,4vw,2rem)',
            'fluid-3xl':'clamp(1.875rem,5vw,2.5rem)',
            'fluid-4xl':'clamp(2.25rem,6vw,3rem)',
            'fluid-5xl':'clamp(2.5rem,7vw,4rem)',
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --gradient-aurora:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-cyber:linear-gradient(135deg,#0a0a23 0%,#1a1a2e 50%,#00d4ff 100%);
      --gradient-magic:linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
      --gradient-ocean:linear-gradient(135deg,#16213e 0%,#0f3460 50%,#00d4ff 100%);
      --shadow-aurora:0 10px 40px rgba(233,69,96,.3);
      --shadow-cyber:0 10px 40px rgba(0,212,255,.3);
      --shadow-glass:0 8px 32px rgba(31,38,135,.37);
      --border-glass:1px solid rgba(255,255,255,.18);
    }
    *{scroll-behavior:smooth}
    body{background:var(--gradient-aurora);min-height:100vh;font-family:'Inter',system-ui,sans-serif;font-feature-settings:'cv02','cv03','cv04','cv11';overflow-x:hidden;position:relative}
    body::before{content:'';position:fixed;inset:0;background:var(--gradient-aurora);animation:aurora 20s ease-in-out infinite;z-index:-2}
    @keyframes aurora{
      0%,100%{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%)}
      25%{background:linear-gradient(135deg,#16213e 0%,#0f3460 25%,#e94560 50%,#00d4ff 75%,#1a1a2e 100%)}
      50%{background:linear-gradient(135deg,#0f3460 0%,#e94560 25%,#00d4ff 50%,#1a1a2e 75%,#16213e 100%)}
      75%{background:linear-gradient(135deg,#e94560 0%,#00d4ff 25%,#1a1a2e 50%,#16213e 75%,#0f3460 100%)}
    }
    .text-ultra-visible{color:#fff;text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1);font-weight:800}
    .text-shadow-strong{ text-shadow:0 6px 20px rgba(0,0,0,.8),0 2px 8px rgba(0,0,0,.9) }
    .glass-strong{ background:rgba(255,255,255,.12); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:var(--border-glass); box-shadow:var(--shadow-glass) }
    .glass-card{ background:rgba(255,255,255,.95); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,.2); box-shadow:0 8px 32px rgba(0,0,0,.1) }
    .convenzione-card{ background:rgba(255,255,255,.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.2); border-radius:24px; padding:clamp(1.5rem,4vw,2rem); transition:all .4s cubic-bezier(.4,0,.2,1); border-left:4px solid transparent; position:relative; overflow:hidden }
    .convenzione-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-magic);transform:scaleX(0);transition:transform .4s}
    .convenzione-card:hover::before{transform:scaleX(1)}
    .convenzione-card:hover{ transform:translateY(-16px) scale(1.03); box-shadow:0 30px 80px rgba(0,0,0,.15); border-left-color:#00d4ff }
    .category-filter{ transition:all .3s ease; backdrop-filter:blur(10px); border:var(--border-glass) }
    .category-filter.active{ background:var(--gradient-magic); color:#fff; box-shadow:var(--shadow-aurora) }
    .category-filter:not(.active){ background:rgba(255,255,255,.1); color:#fff }
    .category-filter:not(.active):hover{ background:rgba(255,255,255,.2); transform:scale(1.05) }
    .search-box{ background:rgba(255,255,255,.95); backdrop-filter:blur(16px); border:2px solid rgba(255,255,255,.3); transition:all .3s }
    .search-box:focus{ outline:none; border-color:#00d4ff; box-shadow:0 0 0 3px rgba(0,212,255,.1); background:rgba(255,255,255,.98) }
    .discount-badge{ background:var(--gradient-magic); color:#fff; box-shadow:0 4px 15px rgba(233,69,96,.4) }
    .service-icon{ width:clamp(60px,8vw,80px); height:clamp(60px,8vw,80px); background:var(--gradient-ocean); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:clamp(1.5rem,4vw,2rem); margin-right:1rem; box-shadow:var(--shadow-cyber); position:relative; overflow:hidden }
    .floating-icons{ position:absolute; opacity:.06; font-size:clamp(1.5rem,4vw,3rem); pointer-events:none; filter:drop-shadow(0 0 10px rgba(255,255,255,.3)) }
    .floating-icons:nth-child(1){ top:10%; left:8% } .floating-icons:nth-child(2){ top:20%; right:12% }
    .floating-icons:nth-child(3){ bottom:35%; left:15% } .floating-icons:nth-child(4){ bottom:25%; right:8% }
    .floating-icons:nth-child(5){ top:45%; left:5% } .floating-icons:nth-child(6){ top:65%; right:6% }
    .loading-skeleton{ background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%); background-size:200% 100%; animation:loading 1.5s infinite; border-radius:12px }
    @keyframes loading{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .fade-in{ animation:fadeIn .8s ease-out forwards; opacity:0 }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(30px)} to{opacity:1; transform:translateY(0)} }
    @media (max-width:480px){ .convenzione-card{ padding:1.2rem; margin-bottom:1rem } .category-filter{ font-size:12px; padding:8px 12px } }
  </style>
</head>
<body class="relative overflow-x-hidden">
  <!-- Background emojis -->
  <div class="floating-icons">üè™</div>
  <div class="floating-icons">üí∞</div>
  <div class="floating-icons">üéØ</div>
  <div class="floating-icons">üì±</div>
  <div class="floating-icons">üè•</div>
  <div class="floating-icons">üöó</div>

  <!-- Header -->
  <header class="w-full px-4 py-4 relative z-10">
    <div class="max-w-md mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <button id="backBtn" class="text-ultra-visible hover:text-cyan transition-colors" aria-label="Indietro">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <div class="flex items-center space-x-2">
          <div class="w-10 h-10 bg-gradient-to-r from-cyan to-teal rounded-full flex items-center justify-center">
            <img src="/icons/deals.svg" alt="Deals" class="w-6 h-6" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <span class="text-white font-bold fluid-sm hidden">üè™</span>
          </div>
          <h1 class="fluid-xl font-black text-ultra-visible text-shadow-strong">Convenzioni</h1>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button id="logoutBtn" class="bg-gradient-to-r from-error to-aurora text-white fluid-sm px-3 py-2 rounded-full font-bold transition-all hover:scale-105 shadow-lg hidden">Logout</button>
      </div>
    </div>
  </header>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-primary bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="glass-card rounded-lg p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-aurora mx-auto mb-4"></div>
      <p class="text-aurora font-bold">Caricamento convenzioni...</p>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-md mx-auto px-4 pb-10">
    <!-- Hero -->
    <div class="glass-strong rounded-3xl p-6 mb-6 text-center fade-in">
      <div class="w-20 h-20 bg-gradient-to-r from-magenta to-aurora rounded-full flex items-center justify-center mx-auto mb-6">
        <img src="/icons/discount.svg" alt="Discount" class="w-10 h-10" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <span class="text-white text-4xl hidden">üè™</span>
      </div>
      <h2 class="text-center text-ultra-visible text-shadow-strong mb-4 text-2xl font-extrabold">Convenzioni Esclusive</h2>
      <p class="text-ultra-visible fluid-base text-shadow-strong mb-6">Vantaggi riservati agli iscritti del Sindacato Carabinieri</p>
      <div class="flex justify-center space-x-8">
        <div class="text-center">
          <div id="totalConvenzioni" class="fluid-2xl font-black text-ultra-visible text-shadow-strong">--</div>
          <div class="fluid-xs text-cyan font-bold">Convenzioni Attive</div>
        </div>
        <div class="text-center">
          <div id="risparmioMedio" class="fluid-2xl font-black text-ultra-visible text-shadow-strong">--</div>
          <div class="fluid-xs text-cyan font-bold">Sconto Medio</div>
        </div>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-6 fade-in">
      <div class="glass-card rounded-2xl p-4">
        <div class="flex items-center space-x-3">
          <img src="/icons/search.svg" alt="Search" class="w-5 h-5 text-muted" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <svg class="w-5 h-5 text-muted hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input id="searchInput" type="text" class="search-box flex-1 bg-transparent border-0 text-primary placeholder-muted fluid-base font-medium" placeholder="Cerca per nome, categoria, condizioni..." maxlength="100"/>
        </div>
      </div>
    </div>

    <!-- Filters: categorie schema -->
    <div class="mb-8 fade-in">
      <div class="flex space-x-2 overflow-x-auto pb-2">
        <button class="category-filter active flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="all">Tutte</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="SALUTE">üè• Salute</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="VIAGGI">‚úàÔ∏è Viaggi</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="SHOPPING">üõçÔ∏è Shopping</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="SERVIZI">üß∞ Servizi</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="FORMAZIONE">üéì Formazione</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="TEMPO_LIBERO">üéØ Tempo Libero</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="RISTORAZIONE">üçΩÔ∏è Ristorazione</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="AUTOMOTIVE">üöó Automotive</button>
        <button class="category-filter flex-shrink-0 px-4 py-3 rounded-full fluid-sm font-bold" data-category="ALTRO">üè™ Altro</button>
      </div>
    </div>

    <!-- List -->
    <div id="convenzioniContainer" class="space-y-6 fade-in">
      <div class="loading-skeleton-card glass-card rounded-2xl p-4">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 loading-skeleton rounded-lg"></div>
          <div class="flex-1">
            <div class="w-3/4 h-4 loading-skeleton rounded mb-2"></div>
            <div class="w-1/2 h-3 loading-skeleton rounded mb-2"></div>
            <div class="w-1/3 h-3 loading-skeleton rounded"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty -->
    <div id="emptyState" class="text-center py-16 hidden">
      <div class="w-24 h-24 bg-gradient-to-r from-muted to-gray-400 rounded-full flex items-center justify-center mx-auto mb-6">
        <span class="text-4xl">üîç</span>
      </div>
      <h3 class="fluid-xl font-black text-ultra-visible text-shadow-strong mb-4">Nessuna convenzione trovata</h3>
      <p class="text-cyan fluid-base text-shadow-strong">Prova a modificare i filtri di ricerca</p>
    </div>

    <!-- Load more -->
    <div id="loadMoreContainer" class="mt-8 text-center hidden">
      <button id="loadMoreBtn" class="glass-strong text-ultra-visible px-8 py-4 rounded-full font-bold hover:bg-opacity-30 transition-all fluid-base">
        Carica altre convenzioni
      </button>
    </div>
  </main>

  <!-- RIMOSSI: bottone contatto + bottom bar -->

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase (tuoi dati)
    const supabaseUrl = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Stato
    let convenzioni = [];
    let filteredConvenzioni = [];
    let currentCategory = 'all';
    let currentUser = null;
    let offset = 0;
    const limit = 20;

    // Utils UI
    const showLoading = ()=> document.getElementById('loading').classList.remove('hidden');
    const hideLoading = ()=> document.getElementById('loading').classList.add('hidden');
    const today = new Date().toISOString().slice(0,10);

    // Auth + routing back
    async function checkAuth(){
      try{
        const { data:{ user } } = await supabase.auth.getUser();
        currentUser = user || null;
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) (user ? logoutBtn.classList.remove('hidden') : logoutBtn.classList.add('hidden'));
      }catch(e){ /* ignore */ }
    }
    async function resolveHomePath(){
      let target = 'home.html';
      try{
        if (!currentUser) return target;
        const meta = currentUser.user_metadata || {};
        const rawRole = (meta.profilo || meta.ruolo || meta.role || '').toString().toLowerCase();
        if (rawRole.includes('dirigente')) return 'home_dirigenti.html';
        // fallback opzionale su tabella profili
        const { data, error } = await supabase.from('profili').select('ruolo, profilo, tipo').eq('user_id', currentUser.id).maybeSingle();
        if (!error && data){
          const role = (data.ruolo || data.profilo || data.tipo || '').toString().toLowerCase();
          if (role.includes('dirigente')) target = 'home_dirigenti.html';
        }
      }catch(e){/* ok */}
      return target;
    }
    async function handleBack(){ window.location.href = await resolveHomePath(); }
    async function logout(){
      if (confirm('Sei sicuro di voler uscire?')){
        try{ await supabase.auth.signOut(); location.href='login.html'; }catch(e){ console.error(e); }
      }
    }

    // Query convenzioni (schema reale)
    async function caricaConvenzioni(loadMore=false){
      try{
        if (!loadMore){ showLoading(); offset = 0; hideSkeletons(); }

        let query = supabase
          .from('convenzioni')
          .select('*')
          .eq('attiva', true)
          .lte('valida_dal', today)
          .or(`valida_fino.is.null,valida_fino.gte.${today}`)
          .order('in_evidenza', { ascending:false })
          .order('created_at', { ascending:false })
          .range(offset, offset + limit - 1);

        if (currentCategory !== 'all') query = query.eq('categoria', currentCategory);

        const { data, error } = await query;
        if (error) throw error;

        convenzioni = loadMore ? [...convenzioni, ...(data||[])] : (data||[]);
        filteredConvenzioni = [...convenzioni];
        renderConvenzioni();
        updateStats();

        const loadMoreContainer = document.getElementById('loadMoreContainer');
        if (data && data.length === limit){ loadMoreContainer.classList.remove('hidden'); offset += limit; }
        else { loadMoreContainer.classList.add('hidden'); }

      }catch(err){
        console.error('Errore caricamento:', err.message);
        renderDemoConvenzioni();
      }finally{ hideLoading(); }
    }

    function hideSkeletons(){
      document.querySelectorAll('.loading-skeleton-card').forEach(el => el.style.display='none');
    }

    // Icone per categorie
    const catIcon = {
      'SALUTE':'üè•','VIAGGI':'‚úàÔ∏è','SHOPPING':'üõçÔ∏è','SERVIZI':'üß∞','FORMAZIONE':'üéì',
      'TEMPO_LIBERO':'üéØ','RISTORAZIONE':'üçΩÔ∏è','AUTOMOTIVE':'üöó','ALTRO':'üè™'
    };

    function renderConvenzioni(){
      const container = document.getElementById('convenzioniContainer');
      const emptyState = document.getElementById('emptyState');

      if (!filteredConvenzioni.length){
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');

      const html = filteredConvenzioni.map(conv=>{
        const sconto = conv.sconto_percentuale ?? null;
        const icona = catIcon[conv.categoria] || 'üè™';
        const validita = conv.valida_fino ? `Fino al ${new Date(conv.valida_fino).toLocaleDateString('it-IT')}` : 'Validit√† corrente';
        const copertura = conv.copertura_geografica || 'NAZIONALE';
        const inEvidenza = conv.in_evidenza ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-gold/20 text-gold font-extrabold align-middle">‚≠ê In evidenza</span>` : '';

        return `
          <div class="convenzione-card fade-in">
            <div class="flex items-start space-x-4">
              <div class="service-icon">
                ${conv.logo_url ? `<img src="${conv.logo_url}" alt="${conv.nome_azienda||''}" class="w-full h-full object-cover rounded-lg">` : `<span class="text-white">${icona}</span>`}
              </div>
              <div class="flex-1">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="font-black text-primary fluid-lg">${conv.nome_azienda||'Azienda'}</h3>
                  <div class="flex items-center gap-2">
                    ${sconto ? `<span class="discount-badge fluid-xs font-black px-3 py-1 rounded-full">-${sconto}%</span>` : ''}
                  </div>
                </div>

                <p class="text-muted fluid-sm mb-3 line-clamp-3">${conv.descrizione||''}</p>

                <div class="flex flex-wrap items-center gap-2 mb-4">
                  <span class="bg-cyan/10 text-cyan fluid-xs px-3 py-1 rounded-full font-bold border border-cyan/20">${(conv.categoria||'ALTRO').replace(/_/g,' ')}</span>
                  <span class="bg-teal/10 text-teal fluid-xs px-3 py-1 rounded-full font-bold border border-teal/20">${copertura}</span>
                  <span class="bg-accent/10 text-accent fluid-xs px-3 py-1 rounded-full font-bold border border-accent/20">${validita}</span>
                  ${inEvidenza}
                </div>

                ${conv.condizioni ? `<details class="mb-3">
                  <summary class="cursor-pointer fluid-xs text-primary font-bold">Condizioni</summary>
                  <div class="fluid-xs text-muted mt-1">${conv.condizioni}</div>
                </details>` : ''}

                <div class="flex items-center justify-between">
                  ${conv.codice_sconto ? `
                    <button class="bg-gradient-to-r from-cyan to-teal text-white fluid-xs px-4 py-2 rounded-full hover:scale-105 transition-all font-bold" data-copy="${conv.codice_sconto}">
                      Copia codice
                    </button>
                  ` : `<span class="fluid-xs text-muted"></span>`}
                  ${conv.link_esterno ? `
                    <a href="${conv.link_esterno}" target="_blank" rel="noopener" data-track="${conv.id}" class="bg-gradient-to-r from-aurora to-magenta text-white fluid-xs px-4 py-2 rounded-full hover:scale-105 transition-all font-bold">
                      Vai al sito ‚Üí
                    </a>
                  ` : `
                    <button class="bg-gradient-to-r from-aurora to-magenta text-white fluid-xs px-4 py-2 rounded-full opacity-60 cursor-not-allowed">Nessun link</button>
                  `}
                </div>
              </div>
            </div>
          </div>`;
      }).join('');

      container.innerHTML = html;

      // Stagger animation
      setTimeout(()=>{ document.querySelectorAll('.convenzione-card').forEach((c,i)=> c.style.animationDelay=`${i*0.1}s`); },100);
    }

    function updateStats(){
      const total = convenzioni.length;
      const avg = (()=> {
        const vals = convenzioni.map(c=> c.sconto_percentuale).filter(Number.isFinite);
        if (!vals.length) return null;
        const sum = vals.reduce((a,b)=>a+b,0);
        return Math.round(sum/vals.length);
      })();
      document.getElementById('totalConvenzioni').textContent = total || '--';
      document.getElementById('risparmioMedio').textContent = (avg!=null) ? `${avg}%` : '--';
    }

    // Fallback demo
    function renderDemoConvenzioni(){
      const demo = [
        { id:'1', nome_azienda:'Ristorante Da Mario', descrizione:'Cucina tradizionale italiana', categoria:'RISTORAZIONE', sconto_percentuale:15, link_esterno:'#', copertura_geografica:'NAZIONALE', in_evidenza:true },
        { id:'2', nome_azienda:'Farmacia Centrale', descrizione:'Benessere & salute', categoria:'SALUTE', sconto_percentuale:10, link_esterno:'#', copertura_geografica:'LOCALE' }
      ];
      convenzioni = demo; filteredConvenzioni = [...demo];
      renderConvenzioni(); updateStats();
    }

    // Ricerca + filtri
    function filterConvenzioni(){
      const q = document.getElementById('searchInput').value.toLowerCase().trim();
      filteredConvenzioni = convenzioni.filter(conv=>{
        const matchesSearch = !q ||
          (conv.nome_azienda||'').toLowerCase().includes(q) ||
          (conv.descrizione||'').toLowerCase().includes(q) ||
          (conv.categoria||'').toLowerCase().includes(q) ||
          (conv.copertura_geografica||'').toLowerCase().includes(q) ||
          (conv.condizioni||'').toLowerCase().includes(q) ||
          (conv.codice_sconto||'').toLowerCase().includes(q);
        const matchesCategory = currentCategory==='all' || conv.categoria===currentCategory;
        return matchesSearch && matchesCategory;
      });
      renderConvenzioni();
    }
    let searchTimeout; const debouncedSearch = ()=>{ clearTimeout(searchTimeout); searchTimeout=setTimeout(filterConvenzioni,300); };
    function setupFilters(){
      const buttons = document.querySelectorAll('.category-filter');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          caricaConvenzioni();
        });
      });
    }

    // Tracking click + copia codice (delegation)
    async function incrementVisualizzazioni(id){
      try{
        const current = convenzioni.find(c=>c.id===id)?.visualizzazioni || 0;
        await supabase.from('convenzioni').update({ visualizzazioni: current + 1 }).eq('id', id);
      }catch(e){ /* pu√≤ fallire per RLS: ok ignorare */ }
    }
    document.getElementById('convenzioniContainer').addEventListener('click', async (e)=>{
      const a = e.target.closest('a[data-track]');
      if (a){ const id = a.getAttribute('data-track'); incrementVisualizzazioni(id); }
      const copyBtn = e.target.closest('button[data-copy]');
      if (copyBtn){
        const code = copyBtn.getAttribute('data-copy');
        try{ await navigator.clipboard.writeText(code); copyBtn.textContent='Copiato!'; setTimeout(()=>copyBtn.textContent='Copia codice',1500); }catch(_){}
      }
    });

    // Listeners
    document.getElementById('searchInput').addEventListener('input', debouncedSearch);
    document.getElementById('loadMoreBtn').addEventListener('click', ()=>caricaConvenzioni(true));
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('backBtn').addEventListener('click', handleBack);

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      await checkAuth();
      setupFilters();
      await caricaConvenzioni();
    });
  </script>
</body>
</html>
