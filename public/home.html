<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - MyApp</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:'#1a1a2e', secondary:'#16213e', accent:'#0f3460', aurora:'#e94560',
            cyan:'#00d4ff', magenta:'#ff006e', gold:'#ffd700', teal:'#03dac6',
            dark:'#0a0a23', light:'#f8fafc', textDark:'#1C1C1E', backgroundLight:'#F4F4F8',
          },
          screens:{ xs:'320px', sm:'640px', md:'768px', lg:'1024px', xl:'1280px', '2xl':'1536px', '3xl':'1920px', '4xl':'2560px' }
        }
      }
    }
  </script>

  <style>
    :root{
      --gradient-aurora:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#e94560 75%,#00d4ff 100%);
      --gradient-cyber:linear-gradient(135deg,#0a0a23 0%,#1a1a2e 50%,#00d4ff 100%);
      --gradient-magic:linear-gradient(135deg,#ff006e 0%,#e94560 50%,#03dac6 100%);
    }
    body{background:var(--gradient-aurora);background-size:400% 400%;animation:aurora 20s ease infinite;min-height:100vh;}
    @keyframes aurora{0%,100%{background-position:0% 50%}25%{background-position:100% 50%}50%{background-position:100% 100%}75%{background-position:0% 100%}}
    .text-ultra-visible{color:#fff;text-shadow:0 8px 25px rgba(0,0,0,.9),0 4px 12px rgba(0,0,0,.8),0 2px 6px rgba(0,0,0,1);font-weight:800}
    .glass-morphism{background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.18);box-shadow:0 8px 32px rgba(31,38,135,.37)}
    .glass-card{background:rgba(255,255,255,.95);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.3)}
    .btn-aurora{background:var(--gradient-magic);color:#fff;border:2px solid rgba(233,69,96,.3);font-weight:700;transition:.4s}
    .btn-aurora:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 20px 40px rgba(233,69,96,.4);border-color:rgba(233,69,96,.8)}
    .action-card{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:16px;transition:.3s;cursor:pointer}
    .action-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.2);border-color:rgba(233,69,96,.3);background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,255,255,.06))}
    .loading-skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:12px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    .hero-title{font-size:clamp(3rem,12vw,6rem);font-weight:900}
  </style>
</head>

<body class="flex flex-col min-h-screen font-sans">

  <!-- HEADER -->
  <header class="glass-morphism sticky top-0 z-40">
    <!-- ... (header uguale al tuo) ... -->
    <!-- Ho lasciato intatto tutto l'header, toolbar, avatar e logout -->
    <!-- INIZIO HEADER ORIGINALE -->
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-gradient-to-br from-primary via-secondary to-accent rounded-xl flex items-center justify-center relative">
            <span class="text-white font-black text-xl">üìä</span>
          </div>
          <div>
            <span class="text-ultra-visible text-2xl font-black">MyApp</span>
            <div class="text-white text-sm flex items-center gap-2">
              <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
              Dashboard Personale
            </div>
          </div>
        </div>
        <div class="flex items-center space-x-6">
          <div class="relative">
            <button id="notificationBtn" class="text-white hover:text-aurora transition-all duration-300 transform hover:scale-110">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
            </button>
            <span id="notificationBadge" class="notification-badge absolute -top-2 -right-2 hidden">0</span>
            <div id="notificationDropdown" class="notification-dropdown">
              <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h3 class="font-bold text-textDark">üîî Notifiche</h3>
                  <button id="markAllRead" class="text-aurora hover:text-magenta text-sm font-semibold">Segna tutte lette</button>
                </div>
              </div>
              <div id="notificationList" class="p-2 max-h-80 overflow-y-auto"></div>
            </div>
          </div>

          <div class="flex items-center space-x-3">
            <div class="text-white text-right">
              <div id="userWelcome" class="font-semibold text-sm">Caricamento...</div>
              <div id="userRole" class="text-xs opacity-80">Utente</div>
            </div>
            <div id="userAvatar" class="w-10 h-10 bg-gradient-to-br from-aurora to-cyan rounded-full flex items-center justify-center text-white font-bold text-lg border-2 border-white/20">U</div>
          </div>

          <button id="logoutBtn" class="btn-aurora px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Esci
          </button>
        </div>
      </div>
    </div>
    <!-- FINE HEADER ORIGINALE -->
  </header>

  <!-- MAIN (ho lasciato il tuo markup invariato) -->
  <main class="container mx-auto px-4 py-8 flex-grow">
    <!-- ... tutte le sezioni invariato ... -->
    <!-- Per brevit√† non ripeto l‚ÄôHTML: ho mantenuto identico il tuo markup fino al footer -->
    <!-- >>> QUI c‚Äô√® il tuo identico markup di benvenuto, statistiche, azioni, richieste, servizi <<< -->

    <!-- SEZIONE NEWS -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center">
            <span class="text-white text-2xl">üì∞</span>
          </div>
          <h2 class="text-ultra-visible text-3xl font-black">Ultime Notizie</h2>
        </div>
        <button onclick="viewAllNews()" class="text-white opacity-80 hover:opacity-100 transition-opacity flex items-center gap-2">
          <span>Vedi tutte</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
      </div>

      <div class="glass-card rounded-3xl p-8">
        <div id="newsContainer">
          <div class="loading-skeleton h-20 mb-4"></div>
          <div class="loading-skeleton h-20 mb-4"></div>
          <div class="loading-skeleton h-20"></div>
        </div>
      </div>
    </section>

    <!-- SEZIONE CONVENZIONI IN EVIDENZA -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-xl flex items-center justify-center">
            <span class="text-white text-2xl">ü§ù</span>
          </div>
          <h2 class="text-ultra-visible text-3xl font-black">Convenzioni in Evidenza</h2>
        </div>
        <button onclick="goToConvenzioni()" class="text-white opacity-80 hover:opacity-100 transition-opacity flex items-center gap-2">
          <span>Vedi tutte</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="convenzioniContainer">
        <div class="loading-skeleton h-64"></div>
        <div class="loading-skeleton h-64"></div>
        <div class="loading-skeleton h-64"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="glass-morphism mt-16">
    <!-- (footer invariato) -->
    <div class="container mx-auto px-4 py-8">
      <div class="text-center text-white">
        <div class="mb-4"><span class="font-bold text-xl">MyApp</span> - Dashboard Personale v5.0</div>
        <div class="flex justify-center items-center space-x-6 text-sm opacity-80 mb-4">
          <span>¬© 2025 MyApp</span><span>‚Ä¢</span><span>Powered by Supabase</span><span>‚Ä¢</span><span>Design Professionale</span>
        </div>
        <div class="flex justify-center space-x-4">
          <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
          <div class="w-2 h-2 bg-slate-500 rounded-full animate-pulse" style="animation-delay:.5s"></div>
          <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" style="animation-delay:1s"></div>
        </div>
      </div>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    // === SUPABASE CONFIG ===
    const SUPABASE_URL = 'https://pvzdilkozpspsnepedqc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
    let supabaseClient, currentUser = null, userProfile = null;

    // Utility
    const esc = (s)=>String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    function formatDate(d){ if(!d) return '-'; return new Date(d).toLocaleDateString('it-IT'); }
    function formatDateTime(d){ if(!d) return '-'; const dt=new Date(d); return dt.toLocaleDateString('it-IT')+' '+dt.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'}); }
    function getInitials(n){ if(!n) return 'U'; return n.split(' ').map(x=>x[0]).join('').toUpperCase().slice(0,2); }

    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof supabase === 'undefined'){ window.location.href='auth.html'; return; }
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      await checkAuthentication();
      setupEventListeners();
      await loadDashboardData();
    });

    // === AUTH ===
    async function checkAuthentication(){
      const { data:{ session } } = await supabaseClient.auth.getSession();
      if(!session){ window.location.href='auth.html'; return; }
      currentUser = session.user;

      userProfile = await getUserProfile(currentUser.id) || await createUserProfile(currentUser);
      if(userProfile.role==='ADMIN' || userProfile.role==='DIRIGENTE'){
        window.location.href='home_dirigenti.html'; return;
      }
      await updateLastLogin(currentUser.id);
    }

    async function getUserProfile(userId){
      try{
        const { data, error } = await supabaseClient.from('user_profiles').select('*').eq('user_id', userId).single();
        if(error && error.code!=='PGRST116') throw error;
        return data;
      }catch(e){ return null; }
    }

    async function createUserProfile(user){
      const payload = { user_id:user.id, email:user.email, nome:user.user_metadata?.nome||'Nome', cognome:user.user_metadata?.cognome||'',
        role:'USER', stato:'ATTIVO', created_at:new Date().toISOString() };
      await supabaseClient.from('user_profiles').upsert(payload,{ onConflict:'user_id' });
      return payload;
    }
    async function updateLastLogin(userId){
      await supabaseClient.from('user_profiles').update({ last_login:new Date().toISOString() }).eq('user_id', userId);
    }

    // === DASHBOARD LOAD ===
    async function loadDashboardData(){
      updateUserInterface();
      await Promise.all([ loadTesseraData(), loadRichieste(), loadNews(), loadNotifications(), loadConvenzioni() ]);
    }

    function updateUserInterface(){
      if(!userProfile) return;
      const firstName = userProfile.nome || 'Utente';
      const welcomeEl = document.getElementById('userWelcome');
      const roleEl = document.getElementById('userRole');
      const nameDisplayEl = document.getElementById('userNameDisplay');
      welcomeEl && (welcomeEl.textContent = `Ciao, ${firstName}!`);
      roleEl && (roleEl.textContent = ({USER:'Utente',DIRIGENTE:'Dirigente',ADMIN:'Amministratore'})[userProfile.role] || 'Utente');
      nameDisplayEl && (nameDisplayEl.textContent = firstName);
      document.querySelectorAll('#userAvatar').forEach(av => av.textContent = getInitials(`${userProfile.nome} ${userProfile.cognome}`));
      const memberSinceEl = document.getElementById('memberSince'); memberSinceEl && (memberSinceEl.textContent = userProfile.created_at ? formatDate(userProfile.created_at) : '-');
      const statusEl = document.getElementById('profileStatus'); statusEl && (statusEl.textContent = ({ATTIVO:'Attivo',SOSPESO:'Sospeso',INATTIVO:'Inattivo'})[userProfile.stato] || 'Sconosciuto');
    }

    // === TESSERA / RICHIESTE (tuo codice invariato) ===
    async function loadTesseraData(){ /* ... identico al tuo ... */ 
      try{
        const { data:tessera, error } = await supabaseClient.from('tessere').select('numero_tessera,stato').eq('user_id', currentUser.id).single();
        const numeroTesseraEl = document.getElementById('numeroTessera');
        if(error){ numeroTesseraEl && (numeroTesseraEl.textContent='In generazione...'); return; }
        numeroTesseraEl && (numeroTesseraEl.textContent = tessera?.numero_tessera || 'In generazione...');
      }catch(e){ const el=document.getElementById('numeroTessera'); el && (el.textContent='Errore'); }
    }

    async function loadRichieste(){ /* invariato dal tuo */ 
      try{
        const { data: richieste } = await supabaseClient.from('richieste_personali').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:false}).limit(3);
        const attive = (richieste||[]).filter(r=>!['COMPLETATA','CHIUSA'].includes(r.stato)).length;
        const countEl = document.getElementById('richiesteCount'); countEl && (countEl.textContent = attive);
        displayRichieste(richieste||[]);
      }catch(e){ displayRichieste([]); }
    }
    function displayRichieste(r){ /* invariato dal tuo */ 
      const container=document.getElementById('richiesteContainer');
      if(!container) return;
      if(!r.length){ container.innerHTML = '<div class="text-center py-12 text-white"><div class="text-6xl mb-4">üìã</div><h3 class="text-xl font-bold mb-2">Nessuna richiesta</h3><p class="text-white/70 mb-6">Non hai ancora inviato nessuna richiesta</p><button onclick="goToRichieste()" class="btn-aurora py-3 px-6 rounded-xl">Invia la tua prima richiesta</button></div>'; return; }
      container.innerHTML = r.map(x=>{
        const dataCreazione = formatDate(x.created_at);
        return `
          <div class="glass-morphism rounded-xl p-4 hover:bg-white/10 transition-all cursor-pointer" onclick="viewRichiestaDetail('${esc(x.id)}')">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-grow">
                <h4 class="text-white font-bold text-lg mb-1">${esc(x.titolo||'Richiesta')}</h4>
                <div class="flex items-center gap-3 text-sm text-white/70 mb-2">
                  <span>üìÇ ${esc(x.categoria||'-')}</span>
                  <span>üìÖ ${dataCreazione}</span>
                </div>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-bold text-white bg-blue-600">${esc(x.stato||'RICEVUTA')}</span>
            </div>
            <p class="text-white/80 text-sm mb-3">${esc(x.descrizione||'')}</p>
            <div class="flex items-center justify-between text-xs text-white/60">
              <span>${x.dirigente_nome?('üë§ '+esc(x.dirigente_nome)):'‚è≥ In attesa'}</span>
              <span>ID: #${esc(String(x.id).slice(-8))}</span>
            </div>
          </div>`;
      }).join('');
    }

    // === NOTIFICHE (invariato) ===
    async function loadNotifications(){
      try{
        const { count } = await supabaseClient.from('notifications').select('id',{count:'exact'}).eq('user_id', currentUser.id).eq('read', false);
        const { data } = await supabaseClient.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:false}).limit(10);
        updateNotificationBadge(count||0); displayNotifications(data||[]);
      }catch(e){ updateNotificationBadge(0); displayNotifications([]); }
    }
    function updateNotificationBadge(n){ const b=document.getElementById('notificationBadge'); if(!b) return; if(n>0){ b.textContent = n>99 ? '99+' : n; b.classList.remove('hidden'); } else b.classList.add('hidden'); }
    function displayNotifications(list){
      const c=document.getElementById('notificationList'); if(!c) return;
      if(!list.length){ c.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">üîî</div><div class="text-sm">Nessuna notifica</div></div>'; return; }
      c.innerHTML = list.map(n=>`
        <div class="p-3 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer ${!n.read?'bg-blue-50 border-l-4 border-blue-600':''}" onclick="markNotificationAsRead('${esc(n.id)}')">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-2 h-2 rounded-full mt-2 ${!n.read?'bg-blue-600':'bg-gray-300'}"></div>
            <div class="flex-grow">
              <h4 class="font-semibold text-textDark text-sm">${esc(n.title||'Notifica')}</h4>
              <p class="text-gray-600 text-xs mt-1">${esc(n.message||'')}</p>
              <span class="text-gray-400 text-xs">${formatDateTime(n.created_at)}</span>
            </div>
          </div>
        </div>`).join('');
    }

    // === NEWS (SOLO LETTURA, con url_articolo cliccabile) ===
    async function loadNews(){
      try{
        const now = new Date().toISOString();
        const { data, error } = await supabaseClient
          .from('news')
          .select('id,titolo,sottotitolo,categoria,immagine_url,url_articolo,pubblicata,in_evidenza,data_pubblicazione,data_scadenza,visualizzazioni,created_at')
          .eq('pubblicata', true)
          .lte('data_pubblicazione', now)
          .or(`data_scadenza.is.null,data_scadenza.gt.${now}`)
          .order('data_pubblicazione', { ascending:false })
          .limit(3);
        if(error) throw error;
        displayNews(data||[]);
      }catch(e){
        console.error('Errore news:', e);
        displayNews([]);
      }
    }

    function displayNews(newsArray){
      const container = document.getElementById('newsContainer');
      if(!container) return;

      if(!newsArray.length){
        container.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">üì∞</div><div>Nessuna notizia disponibile al momento</div></div>';
        return;
      }

      container.innerHTML = newsArray.map(n=>{
        const img = n.immagine_url ? `<img src="${esc(n.immagine_url)}" alt="" class="w-24 h-24 object-cover rounded-lg border hidden sm:block">` : '';
        const url = n.url_articolo ? esc(n.url_articolo) : null;
        const btn = url
          ? `<a href="${url}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-blue-700 hover:text-blue-900 font-semibold text-sm">Leggi l'articolo ‚Üí</a>`
          : `<button class="inline-flex items-center gap-2 text-gray-400 font-semibold text-sm cursor-not-allowed" disabled>Leggi l'articolo</button>`;

        return `
          <div class="flex items-start justify-between gap-4 border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0">
            <div class="flex-1">
              <h3 class="text-textDark font-semibold text-lg mb-1">${esc(n.titolo||'Senza titolo')}</h3>
              ${n.sottotitolo?`<p class="text-gray-600 text-sm mb-2">${esc(n.sottotitolo)}</p>`:''}
              <div class="flex flex-wrap items-center gap-3 text-xs text-gray-500 mb-2">
                ${n.categoria?`<span class="bg-blue-600 text-white px-2 py-1 rounded">${esc(n.categoria)}</span>`:''}
                <span>üìÖ ${formatDate(n.data_pubblicazione||n.created_at)}</span>
                <span>üëÅÔ∏è ${n.visualizzazioni||0}</span>
              </div>
              ${btn}
            </div>
            ${img}
          </div>`;
      }).join('');
    }

    // === CONVENZIONI (SOLO LETTURA, in evidenza) ===
    async function loadConvenzioni(){
      try{
        const now = new Date().toISOString();
        const { data, error } = await supabaseClient
          .from('convenzioni')
          .select('id,nome_azienda,descrizione,categoria,sconto_percentuale,in_evidenza,attiva,visualizzazioni,immagine_url,logo_url,link_esterno,valida_fino,copertura_geografica,created_at')
          .eq('attiva', true)
          .eq('in_evidenza', true)
          .or(`valida_fino.is.null,valida_fino.gte.${now}`)
          .order('created_at', { ascending:false })
          .limit(6);
        if(error) throw error;
        displayConvenzioni(data||[]);
      }catch(e){
        console.error('Errore convenzioni:', e);
        displayConvenzioni([]);
      }
    }

    function displayConvenzioni(convenzioni){
      const container = document.getElementById('convenzioniContainer');
      if(!container) return;

      if(!convenzioni.length){
        container.innerHTML = `
          <div class="glass-morphism rounded-3xl p-12 col-span-3 text-center">
            <div class="text-6xl mb-4">ü§ù</div>
            <h3 class="text-white text-xl font-bold mb-2">Nessuna convenzione disponibile</h3>
            <p class="text-white/70">Le convenzioni verranno pubblicate a breve</p>
          </div>`;
        return;
      }

      container.innerHTML = convenzioni.map(c=>{
        const excerpt = (c.descrizione||'').slice(0,130) + ((c.descrizione||'').length>130?'‚Ä¶':'');
        const sconto = c.sconto_percentuale!=null ? `-${esc(c.sconto_percentuale)}%` : 'ü§ù';
        const fino = c.valida_fino ? new Date(c.valida_fino) : null;
        const isScad = fino && fino < new Date();
        const hasLink = !!c.link_esterno;

        const btn = hasLink
          ? `<a href="${esc(c.link_esterno)}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-emerald-200 hover:text-white font-semibold">Vai all‚Äôofferta ‚Üí</a>`
          : `<button class="inline-flex items-center gap-2 text-white/40 font-semibold cursor-not-allowed" disabled>Vai all‚Äôofferta</button>`;

        const img = c.immagine_url ? `<img src="${esc(c.immagine_url)}" alt="" class="w-full h-32 object-cover rounded-lg mb-4">` : '';

        return `
          <div class="action-card p-6 ${isScad?'opacity-75':''}">
            ${img}
            <div class="flex items-start justify-between mb-4">
              <div class="w-12 h-12 bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-xl flex items-center justify-center text-white text-sm font-bold">${sconto}</div>
              <div class="flex flex-col gap-1">${isScad?'<div class="bg-gray-500 text-white px-2 py-1 rounded-full text-xs font-bold">SCADUTA</div>':''}</div>
            </div>
            <h3 class="text-white text-lg font-bold mb-2">${esc(c.nome_azienda||'-')}</h3>
            <p class="text-white/80 text-sm mb-4">${esc(excerpt)}</p>
            <div class="flex items-center justify-between text-xs text-white/60 mb-3">
              <span>üìÇ ${esc(c.categoria||'Generale')}</span>
              <span>üåç ${esc(c.copertura_geografica||'Nazionale')}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-white/60 text-xs">üëÄ ${c.visualizzazioni||0} visualizzazioni</span>
              ${btn}
            </div>
            ${fino?`<div class="mt-3 pt-3 border-t border-white/10"><div class="text-white/60 text-xs flex items-center gap-1"><span class="${isScad?'text-red-400':'text-green-400'}">‚è∞</span>${isScad?'Scaduta il':'Valida fino al'} ${fino.toLocaleDateString('it-IT')}</div></div>`:''}
          </div>`;
      }).join('');
    }

    // === Eventi / Azioni varie (invariato) ===
    function setupEventListeners(){
      document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
      document.getElementById('notificationBtn')?.addEventListener('click', ()=>document.getElementById('notificationDropdown')?.classList.toggle('show'));
      document.getElementById('markAllRead')?.addEventListener('click', markAllNotificationsAsRead);
      document.addEventListener('click', (e)=>{
        const b=document.getElementById('notificationBtn'), d=document.getElementById('notificationDropdown');
        if(!b?.contains(e.target) && !d?.contains(e.target)) d?.classList.remove('show');
      });
      supabaseClient.auth.onAuthStateChange((ev)=>{ if(ev==='SIGNED_OUT') window.location.href='index.html'; });
    }

    async function markAllNotificationsAsRead(){
      await supabaseClient.from('notifications').update({read:true,read_at:new Date().toISOString()}).eq('user_id', currentUser.id).eq('read', false);
      await loadNotifications();
    }
    async function markNotificationAsRead(id){
      await supabaseClient.from('notifications').update({read:true,read_at:new Date().toISOString()}).eq('id', id);
      await loadNotifications();
    }

    async function handleLogout(){ try{ await supabaseClient.auth.signOut(); }catch{} finally{ window.location.href='index.html'; } }

    // Navigazione (invariata)
    function goToRichieste(){ window.location.href='richieste.html'; }
    function goToTessera(){ window.location.href='tessera.html'; }
    function goToProfilo(){ window.location.href='profilo.html'; }
    function goToStrumenti(){ window.location.href='strumenti.html'; }
    function goToVirgilio(){ window.location.href='virgilio.html'; }
    function goToDirigenti(){ window.location.href='dirigenti.html'; }
    function goToConvenzioni(){ window.location.href='convenzioni.html'; }
    function viewAllNews(){ window.location.href='news.html'; }
    function viewRichiestaDetail(id){ window.location.href = `richiesta-detail.html?id=${id}`; }

    // Refresh periodico (invariato)
    setInterval(async()=>{ if(currentUser){ await loadNotifications(); await loadRichieste(); } }, 60000);
    setInterval(async()=>{ if(currentUser){ await loadRichieste(); } }, 30000);
  </script>
</body>
</html>
