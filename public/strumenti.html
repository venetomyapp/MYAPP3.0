<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Strumenti MyApp</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">

    <!-- Icone Standard -->
    <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/public/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/public/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/public/icons/icon-512x512.png">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Strumenti MyApp">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Android Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Strumenti MyApp">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    
    <!-- Preconnect per performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://pvzdilkozpspsnepedqc.supabase.co">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js per i grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF per export PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- Touch gestures library -->
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#0f3460',
                        aurora: '#e94560',
                        cyan: '#00d4ff',
                        magenta: '#ff006e',
                        gold: '#ffd700',
                        teal: '#03dac6',
                        dark: '#0a0a23',
                        light: '#f8fafc',
                        success: '#10b981'
                    },
                    screens: {
                        'xs': '320px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                        '2xl': '1536px',
                        '3xl': '1920px',
                        '4xl': '2560px'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-gold: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
        }

        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fade-in { from { opacity: 0; transform: translateY(30px);} to { opacity:1; transform: translateY(0);} }
        @keyframes shimmer { 0%{background-position:-200% 0;} 100%{background-position:200% 0;} }
        @keyframes glow { 0%,100%{ box-shadow:0 0 20px rgba(233,69,96,.4);} 50%{ box-shadow:0 0 40px rgba(233,69,96,.8), 0 0 60px rgba(0,212,255,.4);} }
        @keyframes slideInFromLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideInFromRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .fade-in { animation: fade-in .6s ease-out forwards; }
        .slide-left { animation: slideInFromLeft 0.3s ease-out; }
        .slide-right { animation: slideInFromRight 0.3s ease-out; }
        .text-ultra-visible { color:#fff; text-shadow:0 8px 25px rgba(0,0,0,.9), 0 4px 12px rgba(0,0,0,.8), 0 2px 6px rgba(0,0,0,1); font-weight:800; }

        .hero-title { font-size: clamp(2.5rem, 8vw, 5rem); font-weight:900; line-height:1.1; }
        .section-title { font-size: clamp(1.75rem, 6vw, 3rem); font-weight:900; line-height:1.2; }
        .hero-subtitle { font-size: clamp(1.125rem, 4vw, 1.5rem); font-weight:600; line-height:1.4; }

        .glass-morphism { background: rgba(255,255,255,.08); backdrop-filter: blur(12px); border:1px solid rgba(255,255,255,.18); box-shadow:0 8px 32px rgba(31,38,135,.37); }
        .glass-strong { background: rgba(255,255,255,.12); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,.25); }
        .glass-card { background: rgba(255,255,255,.95); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.3); box-shadow:0 20px 40px rgba(0,0,0,.1); }

        .btn-aurora { background: var(--gradient-magic); color:#fff; border:2px solid rgba(233,69,96,.3); transition: all .4s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden; min-height:44px; }
        .btn-aurora::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); transition:left .5s; }
        .btn-aurora:hover::before { left:100%; }
        .btn-aurora:hover { transform: translateY(-3px) scale(1.05); box-shadow:0 15px 35px rgba(233,69,96,.4); border-color: rgba(233,69,96,.6); }

        .btn-cyber { background: var(--gradient-cyber); border:2px solid rgba(0,212,255,.3); color:#fff; transition: all .4s cubic-bezier(.4,0,.2,1); min-height:44px; }
        .btn-cyber:hover { transform: translateY(-3px) scale(1.05); box-shadow:0 15px 35px rgba(0,212,255,.4); border-color: rgba(0,212,255,.6); }

        .btn-secondary { background:#fff; color:#1a1a2e; border:2px solid rgba(255,255,255,.8); transition: all .3s; min-height:44px; }
        .btn-secondary:hover { background: rgba(255,255,255,.9); transform: translateY(-2px); box-shadow:0 10px 25px rgba(0,0,0,.15); }

        .btn-gold { background: var(--gradient-gold); border:2px solid rgba(255,215,0,.3); color:#1a1a2e; transition: all .4s cubic-bezier(.4,0,.2,1); min-height:44px; font-weight:900; }
        .btn-gold:hover { transform: translateY(-3px) scale(1.05); box-shadow:0 15px 35px rgba(255,215,0,.4); border-color: rgba(255,215,0,.6); }
        .btn-success { background: var(--gradient-success); border:2px solid rgba(16,185,129,.3); color:#fff; transition: all .4s cubic-bezier(.4,0,.2,1); min-height:44px; }
        .btn-success:hover { transform: translateY(-3px) scale(1.05); box-shadow:0 15px 35px rgba(16,185,129,.4); border-color: rgba(16,185,129,.6); }

        /* MOBILE-OPTIMIZED CALENDAR */
        .calendar { 
            display:grid; 
            grid-template-columns: repeat(7,1fr); 
            gap:1px; 
            background: rgba(255,255,255,.1); 
            border-radius:16px; 
            overflow:hidden; 
            backdrop-filter: blur(10px); 
            border:1px solid rgba(255,255,255,.2); 
            touch-action: pan-y;
        }
        .calendar-day { 
            background: rgba(255,255,255,.9); 
            padding:.375rem; 
            text-align:center; 
            cursor:pointer; 
            transition: all .3s cubic-bezier(.4,0,.2,1); 
            min-height:50px; 
            display:flex; 
            flex-direction:column; 
            justify-content:center; 
            align-items:center; 
            position:relative; 
            font-size:.7rem; 
            border:1px solid rgba(255,255,255,.3);
            touch-action: manipulation;
        }
        .calendar-day:active { background: rgba(255,255,255,.8); transform: scale(0.95); }
        .calendar-day.header { background: var(--gradient-cyber); color:#fff; font-weight:900; cursor:default; min-height:35px; text-shadow: 0 2px 8px rgba(0,0,0,.5); }
        .calendar-day.header:hover, .calendar-day.header:active { transform:none; }
        .calendar-day.turno-mattina { background: linear-gradient(135deg,#fef3c7,#fbbf24); color:#92400e; border-left:4px solid #f59e0b; box-shadow:0 4px 15px rgba(245,158,11,.3);}
        .calendar-day.turno-pomeriggio { background: linear-gradient(135deg,#fed7aa,#fb923c); color:#9a3412; border-left:4px solid #ea580c; box-shadow:0 4px 15px rgba(234,88,12,.3);}
        .calendar-day.turno-sera { background: linear-gradient(135deg,#fca5a5,#ef4444); color:#991b1b; border-left:4px solid #dc2626; box-shadow:0 4px 15px rgba(220,38,38,.3);}
        .calendar-day.turno-notte { background: linear-gradient(135deg,#c7d2fe,#6366f1); color:#3730a3; border-left:4px solid #4f46e5; box-shadow:0 4px 15px rgba(79,70,229,.3);}
        .calendar-day.turno-riposo { background: linear-gradient(135deg,#d1fae5,#10b981); color:#065f46; border-left:4px solid #10b981; box-shadow:0 4px 15px rgba(16,185,129,.3);}
        .calendar-day.vuoto { background: rgba(249,250,251,.8); color:#6b7280; border-left:none;}
        .calendar-day.licenza { background: linear-gradient(135deg,#e0e7ff,#8b5cf6); color:#3730a3; border-left:4px solid #6366f1; box-shadow:0 4px 15px rgba(99,102,241,.3);}
        .calendar-day.oggi { background: var(--gradient-magic)!important; color:#fff!important; box-shadow:0 0 20px rgba(233,69,96,.6), 0 4px 15px rgba(233,69,96,.4)!important; border-left:4px solid #fff!important; animation: glow 2s ease-in-out infinite alternate; }
        .turno-label { font-size:.55rem; font-weight:700; margin-top:.125rem; text-shadow:0 1px 3px rgba(0,0,0,.3); }

        .edit-button { position:absolute; top:1px; right:1px; background: rgba(0,0,0,.7); color:#fff; border:none; border-radius:50%; width:14px; height:14px; font-size:.45rem; cursor:pointer; opacity:0; transition:all .3s; backdrop-filter: blur(5px); z-index:10; }
        .calendar-day:hover .edit-button, .calendar-day:active .edit-button { opacity:1; transform: scale(1.1); }

        /* MOBILE-OPTIMIZED MODAL */
        .modal { 
            display:none; 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100vh; 
            background: rgba(0,0,0,.8); 
            backdrop-filter: blur(8px); 
            z-index:1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal.active { display:flex; align-items:flex-start; justify-content:center; padding:1rem 0; }
        .modal-content { 
            background: rgba(255,255,255,.95); 
            backdrop-filter: blur(20px); 
            border-radius:20px; 
            padding:1.5rem; 
            width:calc(100% - 2rem); 
            max-width:500px; 
            max-height:calc(100vh - 4rem); 
            overflow-y:auto; 
            border:1px solid rgba(255,255,255,.3); 
            box-shadow:0 25px 50px rgba(0,0,0,.25);
            margin: 2rem auto;
            position: relative;
        }

        /* MOBILE-OPTIMIZED NAVIGATION */
        .tool-nav-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .tool-nav-container::-webkit-scrollbar { display: none; }
        .tool-nav-grid { 
            display: flex; 
            gap: 0.75rem; 
            padding: 0.5rem; 
            width: max-content;
            min-width: 100%;
        }
        .tool-nav-btn { 
            transition: all .4s cubic-bezier(.4,0,.2,1); 
            background: rgba(255,255,255,.1); 
            backdrop-filter: blur(10px); 
            border:1px solid rgba(255,255,255,.2); 
            color:#fff; 
            font-weight:700; 
            text-shadow:0 2px 8px rgba(0,0,0,.5); 
            min-height:44px; 
            white-space: nowrap;
            flex: 0 0 auto;
            min-width: 100px;
            padding: 0.75rem 1rem;
        }
        .tool-nav-btn.active { 
            background: var(--gradient-magic)!important; 
            color:#fff!important; 
            transform: translateY(-2px) scale(1.02); 
            box-shadow:0 10px 25px rgba(233,69,96,.4); 
            border:2px solid rgba(233,69,96,.6); 
        }
        .tool-nav-btn:hover:not(.active) { background: rgba(255,255,255,.15); transform: translateY(-1px); box-shadow:0 6px 15px rgba(255,255,255,.1); }

        .action-buttons { display:flex; gap:6px; margin-top:6px; }
        .action-btn { padding:8px 12px; border-radius:8px; border:none; font-size:.75rem; cursor:pointer; transition:all .3s cubic-bezier(.4,0,.2,1); font-weight:600; min-height:36px; }
        .edit-btn { background: var(--gradient-cyber); color:#fff; border:1px solid rgba(0,212,255,.3); }
        .edit-btn:hover, .edit-btn:active { transform: translateY(-2px) scale(1.05); box-shadow:0 8px 20px rgba(0,212,255,.4); }
        .delete-btn { background: linear-gradient(135deg,#ef4444,#dc2626); color:#fff; border:1px solid rgba(239,68,68,.3); }
        .delete-btn:hover, .delete-btn:active { transform: translateY(-2px) scale(1.05); box-shadow:0 8px 20px rgba(239,68,68,.4); }

        .tool-section { display:none; }
        .tool-section.active { display:block; }

        input, select, textarea { 
            background: rgba(255,255,255,.9)!important; 
            backdrop-filter: blur(10px); 
            border:1px solid rgba(255,255,255,.3)!important; 
            border-radius:12px!important; 
            transition: all .3s!important; 
            min-height:44px; 
            font-size: 16px !important; /* Prevents zoom on iOS */
        }
        input:focus, select:focus, textarea:focus { 
            background: rgba(255,255,255,.95)!important; 
            border-color:#e94560!important; 
            box-shadow:0 0 20px rgba(233,69,96,.3)!important; 
            outline:none!important; 
        }

        .card-hover { transition: all .4s cubic-bezier(.4,0,.2,1); }
        .card-hover:hover, .card-hover:active { transform: translateY(-4px) scale(1.01); box-shadow:0 15px 30px rgba(0,0,0,.15); }

        .stats-item { background: rgba(255,255,255,.1); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.2); border-radius:12px; padding:1rem; transition: all .3s; }
        .stats-item:hover, .stats-item:active { background: rgba(255,255,255,.15); transform: translateY(-2px); }

        .utility-card { background: rgba(255,255,255,.1); backdrop-filter: blur(12px); border:1px solid rgba(255,255,255,.2); transition: all .4s cubic-bezier(.4,0,.2,1); }
        .utility-card:hover, .utility-card:active { background: rgba(255,255,255,.15); transform: translateY(-3px); box-shadow:0 15px 30px rgba(0,0,0,.15); }

        /* Calcoli & Report styles */
        .calc-card { background: rgba(255,255,255,.95); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.3); border-radius:24px; transition: all .4s cubic-bezier(.4,0,.2,1); }
        .calc-card:hover, .calc-card:active { transform: translateY(-4px) scale(1.01); box-shadow:0 15px 30px rgba(0,0,0,.15); }
        .stat-value { font-size: clamp(1.5rem, 4vw, 2.5rem); font-weight:900; }
        .stat-label { font-size: clamp(0.875rem, 2vw, 1.125rem); font-weight:600; opacity:0.8; }
        .progress-bar { background: rgba(255,255,255,.2); height:8px; border-radius:4px; overflow:hidden; }
        .progress-fill { background: var(--gradient-magic); height:100%; transition: width 1s ease-out; }
        .chart-container { position:relative; height:250px; }
        .calculation-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1.5rem; }
        .report-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem; }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .hero-title { font-size: clamp(2rem,6vw,3.5rem); }
            .section-title { font-size: clamp(1.5rem,5vw,2.5rem); }
            .modal-content { padding:1rem; margin: 1rem; width: calc(100% - 2rem); }
            .calculation-grid { grid-template-columns: 1fr; gap: 1rem; }
            .report-grid { grid-template-columns: 1fr; gap: 1rem; }
            .chart-container { height: 200px; }
            .tool-nav-btn { min-width: 80px; padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        }
        @media (max-width: 480px) {
            .calendar-day { padding:.25rem; min-height:45px; font-size:.65rem; }
            .calendar { gap:1px; }
            .modal-content { padding:0.75rem; }
            .tool-nav-btn { min-width: 70px; padding: 0.5rem; font-size: 0.8rem; }
            .hero-title { font-size: clamp(1.75rem,5vw,2.5rem); }
        }

        /* Touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .calendar-day:hover { transform: none; box-shadow: none; }
            .calendar-day:active { transform: scale(0.95); }
            .btn-aurora:hover, .btn-cyber:hover, .btn-secondary:hover { transform: none; }
            .card-hover:hover { transform: none; }
        }

        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; }
        }
        @media (prefers-color-scheme: dark) {
            .glass-card { background: rgba(255,255,255,.05); color:#fff; }
        }
        .btn-aurora:focus, .btn-cyber:focus, .btn-secondary:focus, .tool-nav-btn:focus, .action-btn:focus { outline:2px solid #00d4ff; outline-offset:2px; }
        @media (prefers-contrast: high) {
            .text-ultra-visible { text-shadow:none; color:#fff; }
            .glass-card { background: rgba(255,255,255,.98); border:2px solid #1a1a2e; }
        }

        /* Loading states */
        .loading { opacity: 0.6; pointer-events: none; }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #e94560;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Swipe indicators */
        .swipe-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .swipe-left { left: 10px; }
        .swipe-right { right: 10px; }
        .swipe-indicator.show { opacity: 1; }
    </style>
</head>
<body class="font-inter">
    <!-- Main Content -->
    <main class="min-h-screen px-4 py-8 max-w-6xl mx-auto">
        
        <!-- Back Button -->
        <div class="mb-6">
            <button onclick="navigateBack()" class="flex items-center gap-3 text-ultra-visible hover:text-cyan transition-all duration-300 transform hover:scale-110 group">
                <svg class="w-8 h-8 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span class="text-lg font-bold">Indietro</span>
            </button>
        </div>

        <!-- Hero Section -->
        <div class="text-center mb-12 fade-in">
            <div class="w-24 h-24 bg-gradient-to-br from-aurora to-cyan rounded-full mx-auto mb-8 flex items-center justify-center shadow-2xl">
                <span class="text-4xl text-white mx-auto">üõ†Ô∏è</span>
            </div>
            <h1 class="hero-title text-ultra-visible mb-6">Strumenti MyApp</h1>
            <p class="hero-subtitle text-ultra-visible opacity-90 max-w-3xl mx-auto">
                Gestisci i tuoi turni, licenze e strumenti di lavoro
            </p>
        </div>

        <!-- Menu Strumenti Mobile-Optimized -->
        <div class="glass-strong rounded-3xl p-4 md:p-8 mb-8 fade-in">
            <div class="tool-nav-container">
                <div class="tool-nav-grid">
                    <button onclick="showTool('turni', this)" class="tool-nav-btn active rounded-2xl font-black text-sm md:text-lg"> üóìÔ∏è Turni </button>
                    <button onclick="showTool('licenze', this)" class="tool-nav-btn rounded-2xl font-black text-sm md:text-lg"> üèñÔ∏è Licenze </button>
                    <button onclick="showTool('recuperi', this)" class="tool-nav-btn rounded-2xl font-black text-sm md:text-lg"> üîÑ Recuperi </button>
                    <button onclick="showTool('calcoli', this)" class="tool-nav-btn rounded-2xl font-black text-sm md:text-lg"> üí∞ Calcoli </button>
                    <button onclick="showTool('report', this)" class="tool-nav-btn rounded-2xl font-black text-sm md:text-lg"> üìä Report </button>
                    <button onclick="showTool('utilita', this)" class="tool-nav-btn rounded-2xl font-black text-sm md:text-lg"> ‚öôÔ∏è Utilit√† </button>
                </div>
            </div>
        </div>

        <!-- Sezione Turni -->
        <div id="turni-section" class="tool-section active">
            <div class="glass-strong rounded-3xl p-4 md:p-8 mb-8 card-hover fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 md:mb-8 gap-4">
                    <h3 class="text-xl md:text-2xl font-black text-primary" id="licenza-modal-title">üèñÔ∏è Programma Licenza</h3>
                <button onclick="closeLicenzaModal()" class="text-gray-500 hover:text-aurora text-3xl font-bold transition-colors" aria-label="Chiudi">&times;</button>
            </div>
            <form id="licenzaForm" class="space-y-6">
                <input type="hidden" name="licenza_id" id="licenza-id">
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üéØ Tipo</label>
                    <select name="tipo_licenza" class="w-full p-4 text-base md:text-lg font-semibold" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="ordinaria">üèñÔ∏è Licenza Ordinaria</option>
                        <option value="straordinaria">‚≠ê Licenza Straordinaria</option>
                        <option value="speciale">üéØ Licenza Speciale</option>
                        <option value="permesso">üìã Permesso</option>
                        <option value="riposo_settimanale">üõèÔ∏è Riposo Settimanale</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìÖ Data Inizio</label>
                        <input name="data_inizio" type="date" class="w-full p-4 text-base md:text-lg font-semibold" required>
                    </div>
                    <div>
                        <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìÖ Data Fine</label>
                        <input name="data_fine" type="date" class="w-full p-4 text-base md:text-lg font-semibold" required>
                    </div>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìù Note (opzionale)</label>
                    <textarea name="note" rows="3" class="w-full p-4 text-base md:text-lg" placeholder="Eventuali note..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="flex-1 btn-aurora py-4 px-6 rounded-2xl font-black text-base md:text-lg" id="licenza-submit-btn"> ‚úÖ Programma </button>
                    <button type="button" onclick="closeLicenzaModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 px-6 rounded-2xl font-black text-base md:text-lg hover:from-gray-600 hover:to-gray-700 transition-all"> ‚ùå Annulla </button>
                </div>
                <div id="licenza-delete-section" class="hidden">
                    <button type="button" onclick="deleteLicenzaFromModal()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 px-6 rounded-2xl font-black text-base md:text-lg hover:from-red-600 hover:to-red-700 transition-all"> üóëÔ∏è Elimina Licenza </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL RECUPERO -->
    <div id="recuperoModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-black text-primary" id="recupero-modal-title">üîÑ Registra Recupero</h3>
                <button onclick="closeRecuperoModal()" class="text-gray-500 hover:text-aurora text-3xl font-bold transition-colors" aria-label="Chiudi">&times;</button>
            </div>
            <form id="recuperoForm" class="space-y-6">
                <input type="hidden" name="recupero_id" id="recupero-id">
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üéØ Tipo Recupero</label>
                    <select name="tipo_recupero" class="w-full p-4 text-base md:text-lg font-semibold" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="festivit√†">üéÑ Festivit√†</option>
                        <option value="settimana_del">üìÖ Settimana del...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìÖ Data</label>
                    <input name="data_maturazione" type="date" class="w-full p-4 text-base md:text-lg font-semibold" required>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìù Descrizione</label>
                    <textarea name="descrizione" rows="3" class="w-full p-4 text-base md:text-lg" placeholder="Descrivi il motivo del recupero..." required></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="flex-1 btn-cyber py-4 px-6 rounded-2xl font-black text-base md:text-lg" id="recupero-submit-btn"> ‚úÖ Registra </button>
                    <button type="button" onclick="closeRecuperoModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 px-6 rounded-2xl font-black text-base md:text-lg hover:from-gray-600 hover:to-gray-700 transition-all"> ‚ùå Annulla </button>
                </div>
                <div id="recupero-delete-section" class="hidden">
                    <button type="button" onclick="deleteRecuperoFromModal()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 px-6 rounded-2xl font-black text-base md:text-lg hover:from-red-600 hover:to-red-700 transition-all"> üóëÔ∏è Elimina Recupero </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ======================= CONFIGURAZIONE SUPABASE =======================
        const SUPABASE_URL = "https://pvzdilkozpspsnepedqc.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk";

        if (typeof window.supabase === 'undefined') {
            console.error('‚ùå Supabase non caricato'); 
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true }
        });

        // ======================= VARIABILI GLOBALI =======================
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentUser = null;
        let turniData = [];
        let licenzeData = [];
        let recuperiData = [];
        let editingTurno = null;
        let editingLicenza = null;
        let editingRecupero = null;
        let chartsInstances = {};
        let swipeThreshold = 50;
        let touchStartX = 0;
        let touchEndX = 0;

        // ======================= MOBILE GESTURES =======================
        function initializeTouchGestures() {
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) return;

            // Touch events for calendar swipe
            calendarContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            calendarContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

            // Tool navigation swipe
            const toolNavContainer = document.querySelector('.tool-nav-container');
            if (toolNavContainer) {
                let isScrolling = false;
                toolNavContainer.addEventListener('scroll', () => {
                    isScrolling = true;
                    setTimeout(() => isScrolling = false, 100);
                });
            }
        }

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            const swipeLeftIndicator = document.getElementById('swipe-left');
            const swipeRightIndicator = document.getElementById('swipe-right');

            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0) {
                    // Swipe right - previous month
                    showSwipeIndicator(swipeLeftIndicator);
                    previousMonth();
                } else {
                    // Swipe left - next month
                    showSwipeIndicator(swipeRightIndicator);
                    nextMonth();
                }
            }
        }

        function showSwipeIndicator(indicator) {
            if (!indicator) return;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 500);
        }

        // ======================= NAVIGAZIONE STRUMENTI =======================
        function showTool(toolName, btn) {
            // Add loading state
            if (btn) btn.classList.add('loading');
            
            document.querySelectorAll('.tool-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            document.querySelectorAll('.tool-nav-btn').forEach(b => {
                b.classList.remove('active', 'loading');
            });
            
            const targetSection = document.getElementById(toolName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                // Add slide animation
                targetSection.classList.add('slide-right');
                setTimeout(() => {
                    targetSection.classList.add('active');
                    targetSection.classList.remove('slide-right');
                }, 50);
            }
            
            if (btn) {
                btn.classList.add('active');
                btn.classList.remove('loading');
            }
            
            // Load data when opening sections
            if (toolName === 'turni') loadUserData();
            if (toolName === 'calcoli' || toolName === 'report') {
                updateCalculations();
                if (chartsInstances.turni) {
                    setTimeout(() => updateCharts(), 100);
                }
            }

            // Scroll to top on mobile
            if (window.innerWidth <= 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ======================= RUOLO E BACK NAV =======================
        async function getUserRole() {
            try {
                if (!currentUser) {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) return null;
                    currentUser = session.user;
                }
                const { data: prof, error } = await supabase
                    .from('user_profiles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();
                if (!error && prof && prof.role) return ('' + prof.role).toUpperCase();
            } catch (e) {
                console.warn('Ruolo da user_profiles non disponibile:', e);
            }
            try {
                const roleMeta = currentUser?.user_metadata?.role || currentUser?.app_metadata?.role;
                if (roleMeta) return ('' + roleMeta).toUpperCase();
            } catch (e) {}
            return null;
        }

        async function navigateBack() {
            try {
                const role = await getUserRole();
                if (role === 'DIRIGENTE' || role === 'ADMIN') {
                    window.location.href = 'home_dirigenti.html';
                } else {
                    window.location.href = 'home.html';
                }
            } catch (e) {
                console.error('Errore navigazione back:', e);
                window.location.href = 'home.html';
            }
        }

        // ======================= SESSIONE & DATI =======================
        async function initializeUser() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) { 
                    window.location.href = 'login-minimal.html'; 
                    return; 
                }
                currentUser = session.user;
                console.log('‚úÖ Utente autenticato:', currentUser.id);
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                showNotification('‚ùå Errore nel caricamento', 'error');
                window.location.href = 'login-minimal.html';
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            showLoadingState(true);
            try {
                await Promise.all([loadTurniFromDB(), loadLicenzeFromDB(), loadRecuperiFromDB()]);
            } finally {
                showLoadingState(false);
            }
        }

        function showLoadingState(isLoading) {
            const turniSection = document.getElementById('turni-section');
            if (turniSection) {
                if (isLoading) {
                    turniSection.classList.add('loading');
                } else {
                    turniSection.classList.remove('loading');
                }
            }
        }

        // ======================= TURNI =======================
        async function loadTurniFromDB() {
            try {
                console.log(`üîÑ Caricamento turni per ${currentMonth + 1}/${currentYear}...`);
                const { data: turni, error } = await supabase
                    .from('turni')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('data_turno', `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-01`)
                    .lt('data_turno', `${currentYear}-${String(currentMonth + 2).padStart(2,'0')}-01`)
                    .order('data_turno', { ascending: true });

                if (error) throw error;
                turniData = turni || [];
                console.log(`‚úÖ Caricati ${turniData.length} turni`);
                updateCalendar(); 
                updateStats();
                updateCalculations();
            } catch (error) {
                console.error('‚ùå Errore caricamento turni:', error);
                turniData = []; 
                updateCalendar(); 
                updateStats();
                showNotification('‚ö†Ô∏è Errore caricamento turni', 'error');
            }
        }

        async function saveTurnoDB(turnoData) {
            try {
                showLoadingState(true);
                if (editingTurno) {
                    const { data, error } = await supabase
                        .from('turni')
                        .update({ 
                            data_turno: turnoData.data, 
                            tipo_turno: turnoData.tipo, 
                            note: turnoData.note || '' 
                        })
                        .eq('id', editingTurno.id)
                        .eq('user_id', currentUser.id)
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Turno aggiornato!', 'success');
                } else {
                    const { data, error } = await supabase
                        .from('turni')
                        .upsert(
                            { 
                                user_id: currentUser.id, 
                                data_turno: turnoData.data, 
                                tipo_turno: turnoData.tipo, 
                                note: turnoData.note || '' 
                            },
                            { onConflict: 'user_id,data_turno' }
                        )
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Turno salvato!', 'success');
                }
                await loadTurniFromDB();
                return true;
            } catch (error) {
                console.error('Errore salvataggio turno:', error);
                showNotification('‚ùå Errore nel salvataggio', 'error');
                return false;
            } finally {
                showLoadingState(false);
            }
        }

        async function deleteTurno() {
            if (!editingTurno) return;
            if (!confirm('Sei sicuro di voler eliminare questo turno?')) return;
            try {
                showLoadingState(true);
                const { error } = await supabase
                    .from('turni')
                    .delete()
                    .eq('id', editingTurno.id)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                showNotification('‚úÖ Turno eliminato!', 'success');
                closeTurnoModal(); 
                await loadTurniFromDB();
            } catch (error) {
                console.error('Errore eliminazione turno:', error);
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        // ======================= LICENZE =======================
        async function loadLicenzeFromDB() {
            try {
                const { data: licenze, error } = await supabase
                    .from('licenze')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('data_inizio', { ascending: false });
                if (error) throw error;
                licenzeData = licenze || [];
                updateLicenzeList(); 
                updateCalendar();
            } catch (error) {
                console.error('Errore caricamento licenze:', error);
                licenzeData = []; 
                updateLicenzeList(); 
                updateCalendar();
                showNotification('‚ö†Ô∏è Errore caricamento licenze', 'error');
            }
        }

        async function saveLicenzaDB(licenzaData) {
            try {
                showLoadingState(true);
                if (editingLicenza) {
                    const { data, error } = await supabase
                        .from('licenze')
                        .update({
                            tipo_licenza: licenzaData.tipo,
                            data_inizio: licenzaData.dataInizio,
                            data_fine: licenzaData.dataFine,
                            giorni_totali: calculateDaysBetween(licenzaData.dataInizio, licenzaData.dataFine),
                            note: licenzaData.note || ''
                        })
                        .eq('id', editingLicenza.id)
                        .eq('user_id', currentUser.id)
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Licenza aggiornata!', 'success');
                } else {
                    const { data, error } = await supabase
                        .from('licenze')
                        .insert({
                            user_id: currentUser.id,
                            tipo_licenza: licenzaData.tipo,
                            data_inizio: licenzaData.dataInizio,
                            data_fine: licenzaData.dataFine,
                            giorni_totali: calculateDaysBetween(licenzaData.dataInizio, licenzaData.dataFine),
                            note: licenzaData.note || ''
                        })
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Licenza programmata!', 'success');
                }
                const dataInizio = new Date(licenzaData.dataInizio);
                if (dataInizio.getMonth() !== currentMonth || dataInizio.getFullYear() !== currentYear) {
                    currentMonth = dataInizio.getMonth(); 
                    currentYear = dataInizio.getFullYear();
                    await loadTurniFromDB();
                }
                await loadLicenzeFromDB();
                return true;
            } catch (error) {
                console.error('Errore salvataggio licenza:', error);
                showNotification('‚ùå Errore nel salvataggio', 'error');
                return false;
            } finally {
                showLoadingState(false);
            }
        }

        async function deleteLicenza(licenzaId) {
            if (!confirm('Eliminare questa licenza?')) return;
            try {
                showLoadingState(true);
                const { error } = await supabase
                    .from('licenze')
                    .delete()
                    .eq('id', licenzaId)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                showNotification('‚úÖ Licenza eliminata!', 'success');
                await loadLicenzeFromDB();
            } catch (error) {
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        async function deleteLicenzaFromModal() {
            if (!editingLicenza) return;
            if (!confirm('Sei sicuro di voler eliminare questa licenza?')) return;
            try {
                showLoadingState(true);
                const { error } = await supabase
                    .from('licenze')
                    .delete()
                    .eq('id', editingLicenza.id)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                showNotification('‚úÖ Licenza eliminata!', 'success');
                closeLicenzaModal(); 
                await loadLicenzeFromDB();
            } catch (error) {
                console.error('Errore eliminazione licenza:', error);
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        function editLicenza(licenzaId) {
            const licenza = licenzeData.find(l => l.id === licenzaId);
            if (!licenza) return;
            editingLicenza = licenza;
            const form = document.getElementById('licenzaForm');
            form.licenza_id.value = licenza.id;
            form.tipo_licenza.value = licenza.tipo_licenza;
            form.data_inizio.value = licenza.data_inizio;
            form.data_fine.value = licenza.data_fine;
            form.note.value = licenza.note || '';
            document.getElementById('licenza-modal-title').textContent = '‚úèÔ∏è Modifica Licenza';
            document.getElementById('licenza-submit-btn').textContent = '‚úÖ Aggiorna';
            document.getElementById('licenza-delete-section').classList.remove('hidden');
            openLicenzaModal();
        }

        // ======================= RECUPERI =======================
        async function loadRecuperiFromDB() {
            try {
                const { data: recuperi, error } = await supabase
                    .from('recuperi')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('data_maturazione', { ascending: false });
                if (error) throw error;
                recuperiData = recuperi || [];
                updateRecuperiList();
            } catch (error) {
                console.error('Errore caricamento recuperi:', error);
                recuperiData = []; 
                updateRecuperiList();
                showNotification('‚ö†Ô∏è Errore caricamento recuperi', 'error');
            }
        }

        async function saveRecuperoDB(recuperoData) {
            try {
                showLoadingState(true);
                if (editingRecupero) {
                    const { data, error } = await supabase
                        .from('recuperi')
                        .update({
                            tipo_recupero: recuperoData.tipo,
                            data_maturazione: recuperoData.dataMaturazione,
                            descrizione: recuperoData.descrizione
                        })
                        .eq('id', editingRecupero.id)
                        .eq('user_id', currentUser.id)
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Recupero aggiornato!', 'success');
                } else {
                    const { data, error } = await supabase
                        .from('recuperi')
                        .insert({
                            user_id: currentUser.id,
                            tipo_recupero: recuperoData.tipo,
                            data_maturazione: recuperoData.dataMaturazione,
                            descrizione: recuperoData.descrizione
                        })
                        .select();
                    if (error) throw error;
                    showNotification('‚úÖ Recupero registrato!', 'success');
                }
                await loadRecuperiFromDB();
                return true;
            } catch (error) {
                console.error('Errore salvataggio recupero:', error);
                showNotification('‚ùå Errore nel salvataggio', 'error');
                return false;
            } finally {
                showLoadingState(false);
            }
        }

        async function deleteRecupero(recuperoId) {
            if (!confirm('Eliminare questo recupero?')) return;
            try {
                showLoadingState(true);
                const { error } = await supabase
                    .from('recuperi')
                    .delete()
                    .eq('id', recuperoId)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                showNotification('‚úÖ Recupero eliminato!', 'success');
                await loadRecuperiFromDB();
            } catch (error) {
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        async function deleteRecuperoFromModal() {
            if (!editingRecupero) return;
            if (!confirm('Sei sicuro di voler eliminare questo recupero?')) return;
            try {
                showLoadingState(true);
                const { error } = await supabase
                    .from('recuperi')
                    .delete()
                    .eq('id', editingRecupero.id)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                showNotification('‚úÖ Recupero eliminato!', 'success');
                closeRecuperoModal(); 
                await loadRecuperiFromDB();
            } catch (error) {
                console.error('Errore eliminazione recupero:', error);
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        function editRecupero(recuperoId) {
            const recupero = recuperiData.find(r => r.id === recuperoId);
            if (!recupero) return;
            editingRecupero = recupero;
            const form = document.getElementById('recuperoForm');
            form.recupero_id.value = recupero.id;
            form.tipo_recupero.value = recupero.tipo_recupero;
            form.data_maturazione.value = recupero.data_maturazione;
            form.descrizione.value = recupero.descrizione || '';
            document.getElementById('recupero-modal-title').textContent = '‚úèÔ∏è Modifica Recupero';
            document.getElementById('recupero-submit-btn').textContent = '‚úÖ Aggiorna';
            document.getElementById('recupero-delete-section').classList.remove('hidden');
            openRecuperoModal();
        }

        // ======================= CALENDARIO & STATS =======================
        function isDateInLicenza(dateStr) {
            return licenzeData.some(licenza => {
                const dataInizio = new Date(licenza.data_inizio);
                const dataFine = new Date(licenza.data_fine);
                const dataCheck = new Date(dateStr);
                return dataCheck >= dataInizio && dataCheck <= dataFine && 
                       licenza.stato !== 'rifiutata' && licenza.stato !== 'annullata';
            });
        }

        function getLicenzaForDate(dateStr) {
            return licenzeData.find(licenza => {
                const dataInizio = new Date(licenza.data_inizio);
                const dataFine = new Date(licenza.data_fine);
                const dataCheck = new Date(dateStr);
                return dataCheck >= dataInizio && dataCheck <= dataFine && 
                       licenza.stato !== 'rifiutata' && licenza.stato !== 'annullata';
            });
        }

        function getTurnoLabel(tipo) { 
            return ({
                mattina:'Mattina',
                pomeriggio:'Pomeriggio',
                sera:'Sera',
                notte:'Notte',
                riposo:'Riposo'
            })[tipo] || ''; 
        }

        function getLicenzaShortName(t){ 
            return ({
                ordinaria:'Licenza',
                straordinaria:'Lic. Str.',
                speciale:'Lic. Sp.',
                permesso:'Permesso',
                riposo_settimanale:'Riposo S.'
            })[t] || 'Licenza'; 
        }

        function getLicenzaIcon(t){ 
            return ({
                ordinaria:'üèñÔ∏è',
                straordinaria:'‚≠ê',
                speciale:'üéØ',
                permesso:'üìã',
                riposo_settimanale:'üõèÔ∏è'
            })[t] || 'üìÖ'; 
        }

        function getLicenzaName(t){ 
            return ({
                ordinaria:'Licenza Ordinaria',
                straordinaria:'Licenza Straordinaria',
                speciale:'Licenza Speciale',
                permesso:'Permesso',
                riposo_settimanale:'Riposo Settimanale'
            })[t] || 'Licenza'; 
        }

        function getRecuperoIcon(t){ 
            return ({
                'festivit√†':'üéÑ',
                'settimana_del':'üìÖ'
            })[t] || 'üìÖ'; 
        }

        function getRecuperoName(t){ 
            return ({
                'festivit√†':'Festivit√†',
                'settimana_del':'Settimana del...'
            })[t] || 'Recupero'; 
        }

        function formatDate(s){ 
            return new Date(s).toLocaleDateString('it-IT'); 
        }

        function calculateDaysBetween(a,b){ 
            const s=new Date(a), e=new Date(b); 
            return Math.ceil((e-s)/(1000*3600*24))+1; 
        }

        function updateCalendar() {
            console.log('üñºÔ∏è Aggiornamento calendario...');
            const monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
            const calendarTitle = document.getElementById('calendar-title');
            if (calendarTitle) calendarTitle.innerHTML = `üìÖ ${monthNames[currentMonth]} ${currentYear}`;

            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) return;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();

            let calendarHTML = `
                <div class="calendar-day header">Lun</div>
                <div class="calendar-day header">Mar</div>
                <div class="calendar-day header">Mer</div>
                <div class="calendar-day header">Gio</div>
                <div class="calendar-day header">Ven</div>
                <div class="calendar-day header">Sab</div>
                <div class="calendar-day header">Dom</div>
            `;

            for (let i = 1; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }

            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const turno = turniData.find(t => t.data_turno === dateStr);
                const isToday = isCurrentMonth && today.getDate() === day;
                const licenza = getLicenzaForDate(dateStr);

                let turnoClass = 'vuoto';
                let turnoLabel = '';
                let extraInfo = '';

                if (isToday) { 
                    turnoClass = 'oggi'; 
                    turnoLabel = 'OGGI'; 
                }
                else if (licenza) {
                    turnoClass = 'licenza';
                    turnoLabel = getLicenzaShortName(licenza.tipo_licenza);
                    if (turno) extraInfo = `<div class="turno-info text-xs">‚è∞ ${getTurnoLabel(turno.tipo_turno)}</div>`;
                } else if (turno) {
                    turnoClass = `turno-${turno.tipo_turno}`;
                    turnoLabel = getTurnoLabel(turno.tipo_turno);
                }

                calendarHTML += `
                    <div class="calendar-day ${turnoClass}" onclick="openDayModal('${dateStr}', ${turno ? `'${turno.id}'` : 'null'})">
                        <button class="edit-button" onclick="event.stopPropagation(); editDayTurno('${dateStr}', ${turno ? `'${turno.id}'` : 'null'})" aria-label="Modifica">‚úèÔ∏è</button>
                        <strong>${day}</strong>
                        <div class="turno-label">${turnoLabel}</div>
                        ${extraInfo}
                    </div>
                `;
            }
            calendarContainer.innerHTML = calendarHTML;
        }

        function updateLicenzeList() {
            const licenzeList = document.getElementById('licenze-list');
            if (!licenzeList) return;
            if (licenzeData.length === 0) {
                licenzeList.innerHTML = '<p class="text-gray-500 text-base md:text-lg text-center font-semibold">Nessuna licenza programmata</p>';
                return;
            }
            licenzeList.innerHTML = licenzeData.slice(0, 5).map(licenza => `
                <div class="bg-gradient-to-r from-white/80 to-white/60 backdrop-blur-md p-4 rounded-2xl border border-white/30 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-black text-gray-900 text-base md:text-lg flex items-center">
                                <span class="mr-3 text-xl md:text-2xl">${getLicenzaIcon(licenza.tipo_licenza)}</span>
                                ${getLicenzaName(licenza.tipo_licenza)}
                            </div>
                            <div class="text-sm md:text-base text-gray-600 font-semibold">
                                ${formatDate(licenza.data_inizio)} - ${formatDate(licenza.data_fine)}
                            </div>
                            ${licenza.note ? `<div class="text-sm md:text-base text-gray-500 mt-2 font-medium">${licenza.note}</div>` : ''}
                        </div>
                        <div class="action-buttons ml-3">
                            <button onclick="editLicenza('${licenza.id}')" class="action-btn edit-btn" aria-label="Modifica licenza">‚úèÔ∏è</button>
                            <button onclick="deleteLicenza('${licenza.id}')" class="action-btn delete-btn" aria-label="Elimina licenza">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRecuperiList() {
            const recuperiList = document.getElementById('recuperi-list');
            if (!recuperiList) return;
            if (recuperiData.length === 0) {
                recuperiList.innerHTML = '<p class="text-gray-500 text-base md:text-lg text-center font-semibold">Nessun recupero registrato</p>';
                return;
            }
            recuperiList.innerHTML = recuperiData.slice(0, 5).map(recupero => `
                <div class="bg-gradient-to-r from-white/80 to-white/60 backdrop-blur-md p-4 rounded-2xl border border-white/30 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-black text-gray-900 text-base md:text-lg flex items-center">
                                <span class="mr-3 text-xl md:text-2xl">${getRecuperoIcon(recupero.tipo_recupero)}</span>
                                ${getRecuperoName(recupero.tipo_recupero)}
                            </div>
                            <div class="text-sm md:text-base text-gray-600 font-semibold">${formatDate(recupero.data_maturazione)}</div>
                            <div class="text-sm md:text-base text-gray-500 font-medium">${recupero.descrizione}</div>
                        </div>
                        <div class="action-buttons ml-3">
                            <button onclick="editRecupero('${recupero.id}')" class="action-btn edit-btn" aria-label="Modifica recupero">‚úèÔ∏è</button>
                            <button onclick="deleteRecupero('${recupero.id}')" class="action-btn delete-btn" aria-label="Elimina recupero">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            if (!turniData) return;
            const stats = {
                mattina: turniData.filter(t => t.tipo_turno === 'mattina').length,
                pomeriggio: turniData.filter(t => t.tipo_turno === 'pomeriggio').length,
                sera: turniData.filter(t => t.tipo_turno === 'sera').length,
                notte: turniData.filter(t => t.tipo_turno === 'notte').length,
                riposo: turniData.filter(t => t.tipo_turno === 'riposo').length,
                licenze: licenzeData.filter(l => {
                    const di = new Date(l.data_inizio), df = new Date(l.data_fine);
                    const start = new Date(currentYear, currentMonth, 1), end = new Date(currentYear, currentMonth + 1, 0);
                    return di <= end && df >= start;
                }).length
            };
            
            const elements = ['mattina', 'pomeriggio', 'sera', 'notte', 'riposo', 'licenze'];
            elements.forEach(type => {
                const el = document.getElementById(`stat-${type}`);
                if (el) el.textContent = stats[type];
            });
        }

        // ======================= CALCOLI AUTOMATICI =======================
        function updateCalculations() {
            calcolaStraordinario();
            calcolaLicenze();
            calcolaIndennita();
            calcolaRecuperi();
            updateReportData();
        }

        function calcolaStraordinario() {
            // Calcolo base ore straordinario
            const turniMese = turniData.length;
            const oreStraordinario = Math.max(0, (turniMese * 8) - 160); // Assumendo 8h per turno e 160h standard mensili
            
            const element = document.getElementById('ore-straordinario');
            const progressElement = document.getElementById('progress-straordinario');
            const percentualeElement = document.getElementById('percentuale-straordinario');
            
            if (element) element.textContent = oreStraordinario;
            if (progressElement) {
                const percentage = Math.min(100, (oreStraordinario / 80) * 100);
                progressElement.style.width = `${percentage}%`;
                if (percentualeElement) percentualeElement.textContent = `${Math.round(percentage)}%`;
            }
        }

        function calcolaLicenze() {
            // Calcolo licenze utilizzate nell'anno
            const annoCorrente = new Date().getFullYear();
            const licenzeAnno = licenzeData.filter(l => 
                new Date(l.data_inizio).getFullYear() === annoCorrente
            );
            
            const ordinarie = licenzeAnno.filter(l => l.tipo_licenza === 'ordinaria')
                                       .reduce((acc, l) => acc + (l.giorni_totali || 0), 0);
            const speciali = licenzeAnno.filter(l => l.tipo_licenza === 'speciale' || l.tipo_licenza === 'straordinaria')
                                      .reduce((acc, l) => acc + (l.giorni_totali || 0), 0);
            
            const ordinariesResidue = Math.max(0, 32 - ordinarie);
            const specialiResidue = Math.max(0, 15 - speciali);
            
            const elementOrdinarie = document.getElementById('licenze-ordinarie');
            const elementSpeciali = document.getElementById('licenze-speciali');
            const progressLicenze = document.getElementById('progress-licenze');
            
            if (elementOrdinarie) elementOrdinarie.textContent = ordinariesResidue;
            if (elementSpeciali) elementSpeciali.textContent = specialiResidue;
            if (progressLicenze) {
                const percentualeUtilizzo = ((ordinarie + speciali) / 47) * 100;
                progressLicenze.style.width = `${Math.min(100, percentualeUtilizzo)}%`;
            }
        }

        function calcolaIndennita() {
            const turniNotte = turniData.filter(t => t.tipo_turno === 'notte').length;
            const turniFestivi = 0; // Da implementare logica festivi
            const importoIndennita = (turniNotte * 25) + (turniFestivi * 35); // Valori esempio
            
            const elementNotte = document.getElementById('turni-notte');
            const elementFestivi = document.getElementById('turni-festivi');
            const elementImporto = document.getElementById('importo-indennita');
            
            if (elementNotte) elementNotte.textContent = turniNotte;
            if (elementFestivi) elementFestivi.textContent = turniFestivi;
            if (elementImporto) elementImporto.textContent = importoIndennita.toFixed(2);
        }

        function calcolaRecuperi() {
            const recuperiFestivita = recuperiData.filter(r => r.tipo_recupero === 'festivit√†').length;
            const recuperiSettimana = recuperiData.filter(r => r.tipo_recupero === 'settimana_del').length;
            const oreTotali = (recuperiFestivita * 8) + (recuperiSettimana * 40);
            
            const elementOre = document.getElementById('ore-recupero');
            const elementFestivita = document.getElementById('recuperi-festivit√†');
            const elementSettimana = document.getElementById('recuperi-settimana');
            
            if (elementOre) elementOre.textContent = oreTotali;
            if (elementFestivita) elementFestivita.textContent = `${recuperiFestivita * 8}h`;
            if (elementSettimana) elementSettimana.textContent = `${recuperiSettimana * 40}h`;
        }

        // ======================= REPORT DATA =======================
        function updateReportData() {
            const turniTotali = turniData.length;
            const oreTotali = turniTotali * 8; // Assumendo 8h per turno
            const straordinario = Math.max(0, oreTotali - 160);
            const licenzeUsate = licenzeData.filter(l => {
                const anno = new Date().getFullYear();
                return new Date(l.data_inizio).getFullYear() === anno;
            }).length;
            
            // Report mensile
            const elementTurni = document.getElementById('report-turni');
            const elementOre = document.getElementById('report-ore');
            const elementStraordinario = document.getElementById('report-straordinario');
            const elementLicenzeUsate = document.getElementById('report-licenze-usate');
            
            if (elementTurni) elementTurni.textContent = turniTotali;
            if (elementOre) elementOre.textContent = oreTotali;
            if (elementStraordinario) elementStraordinario.textContent = `${straordinario}h`;
            if (elementLicenzeUsate) elementLicenzeUsate.textContent = licenzeUsate;
            
            // Report annuale (simulato)
            const elementGiorniAnno = document.getElementById('report-giorni-anno');
            const elementOreAnno = document.getElementById('report-ore-anno');
            const elementLicenzeAnno = document.getElementById('report-licenze-anno');
            const elementPerformance = document.getElementById('report-performance');
            
            if (elementGiorniAnno) elementGiorniAnno.textContent = turniTotali * 12; // Simulato
            if (elementOreAnno) elementOreAnno.textContent = oreTotali * 12; // Simulato
            if (elementLicenzeAnno) elementLicenzeAnno.textContent = licenzeUsate;
            if (elementPerformance) elementPerformance.textContent = '98%'; // Simulato
        }

        // ======================= CHARTS =======================
        function updateCharts() {
            const canvas = document.getElementById('chartTurniMensili');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartsInstances.turni) {
                chartsInstances.turni.destroy();
            }
            
            const turniStats = {
                mattina: turniData.filter(t => t.tipo_turno === 'mattina').length,
                pomeriggio: turniData.filter(t => t.tipo_turno === 'pomeriggio').length,
                sera: turniData.filter(t => t.tipo_turno === 'sera').length,
                notte: turniData.filter(t => t.tipo_turno === 'notte').length,
                riposo: turniData.filter(t => t.tipo_turno === 'riposo').length
            };
            
            chartsInstances.turni = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mattina', 'Pomeriggio', 'Sera', 'Notte', 'Riposo'],
                    datasets: [{
                        data: Object.values(turniStats),
                        backgroundColor: [
                            '#fbbf24',
                            '#fb923c',
                            '#ef4444',
                            '#6366f1',
                            '#10b981'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // ======================= EXPORT FUNCTIONS =======================
        function exportPDF(tipo) {
            if (typeof jsPDF === 'undefined') {
                showNotification('‚ùå Libreria PDF non disponibile', 'error');
                return;
            }
            
            showNotification('üìÑ Generazione PDF in corso...', 'info');
            
            setTimeout(() => {
                try {
                    const doc = new jsPDF();
                    const today = new Date().toLocaleDateString('it-IT');
                    
                    doc.setFontSize(20);
                    doc.text(`Report ${tipo === 'mensile' ? 'Mensile' : 'Annuale'} - MyApp`, 20, 30);
                    doc.setFontSize(12);
                    doc.text(`Generato il: ${today}`, 20, 45);
                    
                    if (tipo === 'mensile') {
                        doc.text(`Turni effettuati: ${turniData.length}`, 20, 65);
                        doc.text(`Ore totali: ${turniData.length * 8}`, 20, 80);
                        doc.text(`Licenze utilizzate: ${licenzeData.length}`, 20, 95);
                    } else {
                        doc.text(`Report annuale completo`, 20, 65);
                        doc.text(`Giorni lavorati: ${turniData.length * 12}`, 20, 80);
                        doc.text(`Performance: 98%`, 20, 95);
                    }
                    
                    doc.save(`report-${tipo}-${today.replace(/\//g, '-')}.pdf`);
                    showNotification('‚úÖ PDF generato con successo!', 'success');
                } catch (error) {
                    console.error('Errore generazione PDF:', error);
                    showNotification('‚ùå Errore nella generazione PDF', 'error');
                }
            }, 1000);
        }

        function exportExcel(tipo) {
            showNotification('üìä Export Excel in corso...', 'info');
            
            setTimeout(() => {
                try {
                    let csvContent = '';
                    const today = new Date().toLocaleDateString('it-IT');
                    
                    if (tipo === 'turni') {
                        csvContent = 'Data,Tipo,Note\n';
                        turniData.forEach(turno => {
                            csvContent += `${formatDate(turno.data_turno)},${getTurnoLabel(turno.tipo_turno)},${turno.note || ''}\n`;
                        });
                    } else if (tipo === 'licenze') {
                        csvContent = 'Tipo,Data Inizio,Data Fine,Giorni,Note\n';
                        licenzeData.forEach(licenza => {
                            csvContent += `${getLicenzaName(licenza.tipo_licenza)},${formatDate(licenza.data_inizio)},${formatDate(licenza.data_fine)},${licenza.giorni_totali || 0},${licenza.note || ''}\n`;
                        });
                    } else {
                        csvContent = 'Tipo,Data,Descrizione\n';
                        csvContent += 'TURNI\n';
                        turniData.forEach(turno => {
                            csvContent += `Turno,${formatDate(turno.data_turno)},${getTurnoLabel(turno.tipo_turno)}\n`;
                        });
                        csvContent += '\nLICENZE\n';
                        licenzeData.forEach(licenza => {
                            csvContent += `Licenza,${formatDate(licenza.data_inizio)},${getLicenzaName(licenza.tipo_licenza)}\n`;
                        });
                    }
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `export-${tipo}-${today.replace(/\//g, '-')}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('‚úÖ Export completato!', 'success');
                } catch (error) {
                    console.error('Errore export:', error);
                    showNotification('‚ùå Errore nell\'export', 'error');
                }
            }, 500);
        }

        // ======================= CALENDAR NAVIGATION =======================
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadTurniFromDB();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadTurniFromDB();
        }

        // ======================= MODAL HELPERS =======================
        function openTurnoModal(){ 
            document.getElementById('turnoModal').classList.add('active'); 
            // Prevent body scroll on mobile
            document.body.style.overflow = 'hidden';
        }
        
        function closeTurnoModal(){ 
            document.getElementById('turnoModal').classList.remove('active'); 
            document.body.style.overflow = '';
            resetTurnoModal(); 
        }
        
        function resetTurnoModal(){
            editingTurno = null;
            const form = document.getElementById('turnoForm'); 
            form.reset(); 
            form.turno_id.value = '';
            document.getElementById('turno-modal-title').textContent = '‚ú® Programma Turno';
            document.getElementById('turno-submit-btn').textContent = '‚úÖ Salva Turno';
            document.getElementById('turno-delete-section').classList.add('hidden');
        }

        function openLicenzaModal(){ 
            document.getElementById('licenzaModal').classList.add('active'); 
            document.body.style.overflow = 'hidden';
        }
        
        function closeLicenzaModal(){ 
            document.getElementById('licenzaModal').classList.remove('active'); 
            document.body.style.overflow = '';
            resetLicenzaModal(); 
        }
        
        function resetLicenzaModal(){
            editingLicenza = null;
            const form = document.getElementById('licenzaForm'); 
            form.reset(); 
            form.licenza_id.value = '';
            document.getElementById('licenza-modal-title').textContent = 'üèñÔ∏è Programma Licenza';
            document.getElementById('licenza-submit-btn').textContent = '‚úÖ Programma';
            document.getElementById('licenza-delete-section').classList.add('hidden');
        }

        function openRecuperoModal(){ 
            document.getElementById('recuperoModal').classList.add('active'); 
            document.body.style.overflow = 'hidden';
        }
        
        function closeRecuperoModal(){ 
            document.getElementById('recuperoModal').classList.remove('active'); 
            document.body.style.overflow = '';
            resetRecuperoModal(); 
        }
        
        function resetRecuperoModal(){
            editingRecupero = null;
            const form = document.getElementById('recuperoForm'); 
            form.reset(); 
            form.recupero_id.value = '';
            document.getElementById('recupero-modal-title').textContent = 'üîÑ Registra Recupero';
            document.getElementById('recupero-submit-btn').textContent = '‚úÖ Registra';
            document.getElementById('recupero-delete-section').classList.add('hidden');
        }

        function openDayModal(dateStr, turnoId) {
            if (turnoId && turnoId !== 'null') {
                editDayTurno(dateStr, turnoId);
            } else {
                const form = document.getElementById('turnoForm');
                form.data_turno.value = dateStr; 
                form.tipo_turno.value = '';
                openTurnoModal();
            }
        }

        function editDayTurno(dateStr, turnoId) {
            if (turnoId && turnoId !== 'null') {
                const turno = turniData.find(t => t.id === turnoId);
                if (turno) {
                    editingTurno = turno;
                    const form = document.getElementById('turnoForm');
                    form.turno_id.value = turno.id;
                    form.data_turno.value = turno.data_turno;
                    form.tipo_turno.value = turno.tipo_turno;
                    form.note.value = turno.note || '';
                    document.getElementById('turno-modal-title').textContent = '‚úèÔ∏è Modifica Turno';
                    document.getElementById('turno-submit-btn').textContent = '‚úÖ Aggiorna';
                    document.getElementById('turno-delete-section').classList.remove('hidden');
                    openTurnoModal();
                }
            } else {
                const form = document.getElementById('turnoForm');
                form.data_turno.value = dateStr; 
                form.tipo_turno.value = '';
                openTurnoModal();
            }
        }

        // ======================= NOTIFICHE & ANIMAZIONI =======================
        function showNotification(message, type='info') {
            const notification = document.createElement('div');
            const colors = { 
                success:'bg-gradient-to-r from-green-500 to-green-600', 
                error:'bg-gradient-to-r from-red-500 to-red-600', 
                info:'bg-gradient-to-r from-blue-500 to-blue-600' 
            };
            notification.className = `fixed top-6 right-6 ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-transform duration-500 font-bold text-base md:text-lg backdrop-blur-md border border-white/20`;
            notification.textContent = message; 
            document.body.appendChild(notification);
            setTimeout(()=>notification.classList.remove('translate-x-full'),100);
            setTimeout(()=>{ 
                notification.classList.add('translate-x-full'); 
                setTimeout(()=>notification.remove(),500); 
            },4000);
        }

        function initializeAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { 
                    if (entry.isIntersecting) entry.target.classList.add('fade-in'); 
                });
            }, { threshold: .1, rootMargin: '0px 0px -50px 0px' });
            
            document.querySelectorAll('.card-hover, .utility-card, .calc-card').forEach(el => {
                observer.observe(el);
            });
        }

        // ======================= INIT =======================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inizializzazione MyApp Strumenti...');
            
            initializeAnimations();
            initializeTouchGestures();
            
            await initializeUser();
            if (currentUser) { 
                updateCalendar(); 
                await loadUserData(); 
            }

            // Submit Turno
            const turnoForm = document.getElementById('turnoForm');
            if (turnoForm) {
                turnoForm.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('[type="submit"]');
                    submitBtn.classList.add('loading');
                    
                    const fd = new FormData(e.target);
                    const turnoData = { 
                        data: fd.get('data_turno'), 
                        tipo: fd.get('tipo_turno'), 
                        note: fd.get('note') 
                    };
                    
                    if (!turnoData.data || !turnoData.tipo) { 
                        showNotification('‚ùå Compila tutti i campi obbligatori', 'error'); 
                        submitBtn.classList.remove('loading');
                        return; 
                    }
                    
                    const ok = await saveTurnoDB(turnoData); 
                    if (ok) closeTurnoModal();
                    submitBtn.classList.remove('loading');
                });
                console.log('‚úÖ Event listener turno aggiunto');
            }

            // Submit Licenza
            const licenzaForm = document.getElementById('licenzaForm');
            if (licenzaForm) {
                licenzaForm.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('[type="submit"]');
                    submitBtn.classList.add('loading');
                    
                    const fd = new FormData(e.target);
                    const licenzaData = { 
                        tipo: fd.get('tipo_licenza'), 
                        dataInizio: fd.get('data_inizio'), 
                        dataFine: fd.get('data_fine'), 
                        note: fd.get('note') 
                    };
                    
                    if (!licenzaData.tipo || !licenzaData.dataInizio || !licenzaData.dataFine) { 
                        showNotification('‚ùå Compila tutti i campi obbligatori', 'error'); 
                        submitBtn.classList.remove('loading');
                        return; 
                    }
                    
                    if (new Date(licenzaData.dataInizio) > new Date(licenzaData.dataFine)) {
                        showNotification('‚ùå La data di fine deve essere successiva a quella di inizio', 'error');
                        submitBtn.classList.remove('loading');
                        return;
                    }
                    
                    const ok = await saveLicenzaDB(licenzaData); 
                    if (ok) closeLicenzaModal();
                    submitBtn.classList.remove('loading');
                });
                console.log('‚úÖ Event listener licenza aggiunto');
            }

            // Submit Recupero
            const recuperoForm = document.getElementById('recuperoForm');
            if (recuperoForm) {
                recuperoForm.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('[type="submit"]');
                    submitBtn.classList.add('loading');
                    
                    const fd = new FormData(e.target);
                    const recuperoData = { 
                        tipo: fd.get('tipo_recupero'), 
                        dataMaturazione: fd.get('data_maturazione'), 
                        descrizione: fd.get('descrizione') 
                    };
                    
                    if (!recuperoData.tipo || !recuperoData.dataMaturazione || !recuperoData.descrizione) { 
                        showNotification('‚ùå Compila tutti i campi obbligatori', 'error'); 
                        submitBtn.classList.remove('loading');
                        return; 
                    }
                    
                    const ok = await saveRecuperoDB(recuperoData); 
                    if (ok) closeRecuperoModal();
                    submitBtn.classList.remove('loading');
                });
                console.log('‚úÖ Event listener recupero aggiunto');
            }

            // Close modal click-out
            document.addEventListener('click', function(e) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                        if (modal.id === 'turnoModal') resetTurnoModal();
                        if (modal.id === 'licenzaModal') resetLicenzaModal();
                        if (modal.id === 'recuperoModal') resetRecuperoModal();
                    }
                });
            });

            // ESC chiude modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        activeModal.classList.remove('active');
                        document.body.style.overflow = '';
                        if (activeModal.id === 'turnoModal') resetTurnoModal();
                        if (activeModal.id === 'licenzaModal') resetLicenzaModal();
                        if (activeModal.id === 'recuperoModal') resetRecuperoModal();
                    }
                }
            });

            // Keyboard navigation for accessibility
            document.addEventListener('keydown', function(e) {
                if (e.target.classList.contains('calendar-day') && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    e.target.click();
                }
            });

            // Handle orientation changes on mobile
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (chartsInstances.turni) {
                        chartsInstances.turni.resize();
                    }
                    updateCalendar();
                }, 500);
            });

            // Service Worker registration for PWA
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registrato');
                } catch (error) {
                    console.log('‚ö†Ô∏è Service Worker non disponibile:', error);
                }
            }

            // Initialize charts when in report section
            if (document.querySelector('.tool-nav-btn.active')?.textContent.includes('Report')) {
                setTimeout(() => updateCharts(), 500);
            }

            console.log('üéâ Inizializzazione MyApp completata');
        });

        // ======================= OFFLINE HANDLING =======================
        window.addEventListener('online', function() {
            showNotification('üåê Connessione ripristinata', 'success');
            if (currentUser) loadUserData();
        });

        window.addEventListener('offline', function() {
            showNotification('üì± Modalit√† offline attiva', 'info');
        });

        // ======================= ERROR HANDLING =======================
        window.addEventListener('error', function(e) {
            console.error('Errore globale:', e.error);
            showNotification('‚ö†Ô∏è Si √® verificato un errore', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejectedtion:', e.reason);
            showNotification('‚ö†Ô∏è Errore di connessione', 'error');
        });

        // ======================= PERFORMANCE MONITORING =======================
        function trackPerformance() {
            if ('performance' in window) {
                window.addEventListener('load', function() {
                    setTimeout(() => {
                        const perf = performance.getEntriesByType('navigation')[0];
                        console.log(`üìä Performance: ${Math.round(perf.loadEventEnd - perf.loadEventStart)}ms`);
                    }, 0);
                });
            }
        }

        trackPerformance();

        // Export funzioni globali per compatibilit√†
        window.showTool = showTool;
        window.openTurnoModal = openTurnoModal;
        window.closeTurnoModal = closeTurnoModal;
        window.openLicenzaModal = openLicenzaModal;
        window.closeLicenzaModal = closeLicenzaModal;
        window.openRecuperoModal = openRecuperoModal;
        window.closeRecuperoModal = closeRecuperoModal;
        window.openDayModal = openDayModal;
        window.editDayTurno = editDayTurno;
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.deleteLicenza = deleteLicenza;
        window.deleteRecupero = deleteRecupero;
        window.editLicenza = editLicenza;
        window.editRecupero = editRecupero;
        window.deleteTurno = deleteTurno;
        window.deleteLicenzaFromModal = deleteLicenzaFromModal;
        window.deleteRecuperoFromModal = deleteRecuperoFromModal;
        window.calcolaStraordinario = calcolaStraordinario;
        window.calcolaLicenze = calcolaLicenze;
        window.calcolaIndennita = calcolaIndennita;
        window.calcolaRecuperi = calcolaRecuperi;
        window.exportPDF = exportPDF;
        window.exportExcel = exportExcel;
        window.navigateBack = navigateBack;

        console.log('üåê Funzioni globali MyApp esportate');
    </script>
</body>
</html>ultra-visible" id="calendar-title">üìÖ Calendario Turni</h3>
                    <div class="flex gap-3">
                        <button onclick="previousMonth()" class="btn-cyber px-4 md:px-6 py-3 rounded-xl font-bold text-base md:text-lg"> ‚Üê Prec </button>
                        <button onclick="nextMonth()" class="btn-cyber px-4 md:px-6 py-3 rounded-xl font-bold text-base md:text-lg"> Succ ‚Üí </button>
                    </div>
                </div>
                
                <!-- Swipe indicators for mobile -->
                <div class="relative">
                    <div class="swipe-indicator swipe-left" id="swipe-left">‚Üê</div>
                    <div class="swipe-indicator swipe-right" id="swipe-right">‚Üí</div>
                    <div class="calendar mb-6" id="calendar-container"></div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 md:gap-3 text-xs md:text-sm text-center">
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-yellow-200 to-yellow-400 rounded border-l-4 border-yellow-500"></div><span class="text-ultra-visible font-bold">Mattina</span></div>
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-orange-200 to-orange-400 rounded border-l-4 border-orange-500"></div><span class="text-ultra-visible font-bold">Pomeriggio</span></div>
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-red-200 to-red-400 rounded border-l-4 border-red-500"></div><span class="text-ultra-visible font-bold">Sera</span></div>
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-blue-200 to-blue-400 rounded border-l-4 border-blue-500"></div><span class="text-ultra-visible font-bold">Notte</span></div>
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-green-200 to-green-400 rounded border-l-4 border-green-500"></div><span class="text-ultra-visible font-bold">Riposo</span></div>
                    <div class="flex items-center justify-center space-x-2 stats-item"><div class="w-3 h-3 md:w-4 md:h-4 bg-gradient-to-r from-indigo-200 to-indigo-400 rounded border-l-4 border-indigo-500"></div><span class="text-ultra-visible font-bold">Licenza</span></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üóìÔ∏è Nuovo Turno</h3>
                    <button onclick="openTurnoModal()" class="w-full btn-aurora font-black py-4 px-6 rounded-2xl text-base md:text-lg mb-6"> ‚ú® Programma Turno </button>
                    <div class="mt-6 text-sm md:text-base text-gray-700 bg-gradient-to-r from-cyan/20 to-aurora/20 p-4 rounded-xl border border-cyan/30">
                        <strong class="text-aurora">üí° Suggerimento:</strong> Tocca un giorno del calendario per modificarlo
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üìä Statistiche Mese</h3>
                    <div class="space-y-3 text-base md:text-lg" id="stats-container">
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Turni Mattina:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-mattina">0</span></div>
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Turni Pomeriggio:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-pomeriggio">0</span></div>
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Turni Sera:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-sera">0</span></div>
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Turni Notte:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-notte">0</span></div>
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Giorni Riposo:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-riposo">0</span></div>
                        <div class="flex justify-between stats-item"><span class="font-bold text-gray-700">Licenze:</span><span class="font-black text-aurora text-lg md:text-xl" id="stat-licenze">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Licenze -->
        <div id="licenze-section" class="tool-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üèñÔ∏è Nuova Licenza</h3>
                    <button onclick="openLicenzaModal()" class="w-full btn-aurora font-black py-4 px-6 rounded-2xl text-base md:text-lg mb-6"> ‚ú® Programma Licenza/Permesso </button>
                </div>

                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üìã Licenze Programmate</h3>
                    <div class="space-y-4 max-h-72 overflow-y-auto" id="licenze-list">
                        <p class="text-gray-500 text-base md:text-lg text-center font-semibold">Nessuna licenza programmata</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Recuperi -->
        <div id="recuperi-section" class="tool-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üîÑ Nuovo Recupero</h3>
                    <button onclick="openRecuperoModal()" class="w-full btn-cyber font-black py-4 px-6 rounded-2xl text-base md:text-lg mb-6"> ‚ú® Registra Recupero </button>
                </div>

                <div class="glass-card rounded-3xl p-6 md:p-8 card-hover fade-in">
                    <h3 class="text-lg md:text-xl font-black text-primary mb-6">üìä Recuperi Registrati</h3>
                    <div class="space-y-4 max-h-72 overflow-y-auto" id="recuperi-list">
                        <p class="text-gray-500 text-base md:text-lg text-center font-semibold">Nessun recupero registrato</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Calcoli Automatici -->
        <div id="calcoli-section" class="tool-section">
            <div class="calculation-grid mb-8">
                <!-- Ore Straordinario -->
                <div class="calc-card p-6 md:p-8 fade-in">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-gold to-yellow-600 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">‚è∞</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-primary">Ore Straordinario</h3>
                            <p class="text-gray-600 font-semibold">Calcolo automatico mensile</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-700">Ore Accumulate:</span>
                            <span class="stat-value text-gold" id="ore-straordinario">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-straordinario" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Limite mensile: 80h</span>
                            <span id="percentuale-straordinario">0%</span>
                        </div>
                        <button onclick="calcolaStraordinario()" class="w-full btn-gold py-3 px-6 rounded-xl font-bold">
                            üîÑ Ricalcola
                        </button>
                    </div>
                </div>

                <!-- Licenze Residue -->
                <div class="calc-card p-6 md:p-8 fade-in">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-teal to-green-600 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">üèñÔ∏è</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-primary">Licenze Residue</h3>
                            <p class="text-gray-600 font-semibold">Giorni disponibili anno</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="stat-value text-teal" id="licenze-ordinarie">32</div>
                                <div class="stat-label text-gray-600">Ordinarie</div>
                            </div>
                            <div class="text-center">
                                <div class="stat-value text-teal" id="licenze-speciali">15</div>
                                <div class="stat-label text-gray-600">Speciali</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-gradient-to-r from-teal to-green-400" id="progress-licenze" style="width: 68%"></div>
                        </div>
                        <button onclick="calcolaLicenze()" class="w-full btn-success py-3 px-6 rounded-xl font-bold">
                            üîÑ Aggiorna
                        </button>
                    </div>
                </div>

                <!-- Indennit√† Turni -->
                <div class="calc-card p-6 md:p-8 fade-in">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-aurora to-red-600 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">üåô</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-primary">Indennit√† Turni</h3>
                            <p class="text-gray-600 font-semibold">Notturni e festivi</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="stat-value text-aurora" id="turni-notte">0</div>
                                <div class="stat-label text-gray-600">Notte</div>
                            </div>
                            <div class="text-center">
                                <div class="stat-value text-aurora" id="turni-festivi">0</div>
                                <div class="stat-label text-gray-600">Festivi</div>
                            </div>
                        </div>
                        <div class="text-center p-3 bg-gradient-to-r from-aurora/20 to-red-200 rounded-xl">
                            <div class="text-lg font-black text-aurora">‚Ç¨ <span id="importo-indennita">0,00</span></div>
                            <div class="text-sm text-gray-600">Indennit√† mese corrente</div>
                        </div>
                        <button onclick="calcolaIndennita()" class="w-full btn-aurora py-3 px-6 rounded-xl font-bold">
                            üí∂ Calcola
                        </button>
                    </div>
                </div>

                <!-- Recuperi Maturati -->
                <div class="calc-card p-6 md:p-8 fade-in">
                    <div class="flex items-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-cyan to-blue-600 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">üîÑ</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-primary">Recuperi Maturati</h3>
                            <p class="text-gray-600 font-semibold">Ore da recuperare</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="stat-value text-cyan" id="ore-recupero">0</div>
                            <div class="stat-label text-gray-600">Ore totali</div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-center p-2 bg-blue-50 rounded-lg">
                                <div class="font-bold text-blue-600" id="recuperi-festivit√†">0h</div>
                                <div class="text-gray-600">Festivit√†</div>
                            </div>
                            <div class="text-center p-2 bg-blue-50 rounded-lg">
                                <div class="font-bold text-blue-600" id="recuperi-settimana">0h</div>
                                <div class="text-gray-600">Settimana</div>
                            </div>
                        </div>
                        <button onclick="calcolaRecuperi()" class="w-full btn-cyber py-3 px-6 rounded-xl font-bold">
                            üîç Verifica
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Report -->
        <div id="report-section" class="tool-section">
            <div class="report-grid mb-8">
                <!-- Report Mensile -->
                <div class="glass-card rounded-3xl p-6 md:p-8 fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-aurora to-magenta rounded-full flex items-center justify-center mr-4">
                                <span class="text-2xl">üìã</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-primary">Report Mensile</h3>
                                <p class="text-gray-600 font-semibold">Riepilogo completo</p>
                            </div>
                        </div>
                        <button onclick="exportPDF('mensile')" class="btn-aurora py-3 px-6 rounded-xl font-bold">
                            üìÑ PDF
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Turni Effettuati:</span>
                            <span class="font-bold text-aurora" id="report-turni">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Ore Totali:</span>
                            <span class="font-bold text-aurora" id="report-ore">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Straordinario:</span>
                            <span class="font-bold text-aurora" id="report-straordinario">0h</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Licenze Usate:</span>
                            <span class="font-bold text-aurora" id="report-licenze-usate">0</span>
                        </div>
                    </div>
                </div>

                <!-- Report Annuale -->
                <div class="glass-card rounded-3xl p-6 md:p-8 fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-gold to-yellow-600 rounded-full flex items-center justify-center mr-4">
                                <span class="text-2xl">üìä</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-primary">Report Annuale</h3>
                                <p class="text-gray-600 font-semibold">Bilancio anno corrente</p>
                            </div>
                        </div>
                        <button onclick="exportPDF('annuale')" class="btn-gold py-3 px-6 rounded-xl font-bold">
                            üìà PDF
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Giorni Lavorati:</span>
                            <span class="font-bold text-gold" id="report-giorni-anno">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Ore Annuali:</span>
                            <span class="font-bold text-gold" id="report-ore-anno">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Licenze Totali:</span>
                            <span class="font-bold text-gold" id="report-licenze-anno">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Performance:</span>
                            <span class="font-bold text-gold" id="report-performance">98%</span>
                        </div>
                    </div>
                </div>

                <!-- Grafici Statistiche -->
                <div class="glass-card rounded-3xl p-6 md:p-8 fade-in">
                    <h3 class="text-xl font-black text-primary mb-6">üìà Statistiche Turni</h3>
                    <div class="chart-container">
                        <canvas id="chartTurniMensili"></canvas>
                    </div>
                </div>

                <!-- Export Data -->
                <div class="glass-card rounded-3xl p-6 md:p-8 fade-in">
                    <h3 class="text-xl font-black text-primary mb-6">üì§ Export Dati</h3>
                    <div class="space-y-3">
                        <button onclick="exportExcel('turni')" class="w-full btn-success py-3 px-6 rounded-xl font-bold">
                            üìä Turni Excel
                        </button>
                        <button onclick="exportExcel('licenze')" class="w-full btn-success py-3 px-6 rounded-xl font-bold">
                            üèñÔ∏è Licenze Excel
                        </button>
                        <button onclick="exportExcel('completo')" class="w-full btn-cyber py-3 px-6 rounded-xl font-bold">
                            üìà Export Completo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Utilit√† -->
        <div id="utilita-section" class="tool-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="utility-card rounded-3xl p-6 md:p-8 text-center fade-in">
                    <div class="w-16 h-16 bg-gradient-to-br from-cyan to-blue-600 rounded-full mx-auto mb-6 flex items-center justify-center shadow-2xl"><span class="text-2xl text-white">üìä</span></div>
                    <h3 class="font-black text-ultra-visible text-lg md:text-xl mb-3">Rapporti</h3>
                    <p class="text-base md:text-lg text-ultra-visible font-semibold opacity-90 mb-6">Genera rapporti sui turni e le ore lavorate</p>
                    <button onclick="showTool('report', document.querySelector('[onclick*=\"report\"]'))" class="btn-cyber px-6 py-3 rounded-xl text-base md:text-lg font-bold"> üìã Vai ai Report </button>
                </div>

                <div class="utility-card rounded-3xl p-6 md:p-8 text-center fade-in">
                    <div class="w-16 h-16 bg-gradient-to-br from-teal to-green-600 rounded-full mx-auto mb-6 flex items-center justify-center shadow-2xl"><span class="text-2xl text-white">‚è∞</span></div>
                    <h3 class="font-black text-ultra-visible text-lg md:text-xl mb-3">Calcolo Ore</h3>
                    <p class="text-base md:text-lg text-ultra-visible font-semibold opacity-90 mb-6">Calcola ore straordinario e permessi</p>
                    <button onclick="showTool('calcoli', document.querySelector('[onclick*=\"calcoli\"]'))" class="btn-aurora px-6 py-3 rounded-xl text-base md:text-lg font-bold"> üí∞ Vai ai Calcoli </button>
                </div>

                <div class="utility-card rounded-3xl p-6 md:p-8 text-center fade-in">
                    <div class="w-16 h-16 bg-gradient-to-br from-magenta to-purple-600 rounded-full mx-auto mb-6 flex items-center justify-center shadow-2xl"><span class="text-2xl text-white">üì±</span></div>
                    <h3 class="font-black text-ultra-visible text-lg md:text-xl mb-3">Export Data</h3>
                    <p class="text-base md:text-lg text-ultra-visible font-semibold opacity-90 mb-6">Esporta dati turni in PDF o Excel</p>
                    <button onclick="exportExcel('completo')" class="btn-cyber px-6 py-3 rounded-xl text-base md:text-lg font-bold"> üì§ Export Ora </button>
                </div>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="glass-strong rounded-3xl p-6 md:p-8 text-center mt-12 fade-in">
            <h2 class="section-title text-ultra-visible mb-4">Serve Assistenza?</h2>
            <p class="hero-subtitle text-ultra-visible opacity-90 mb-8 max-w-2xl mx-auto">
                Il nostro team dirigenti √® sempre pronto ad aiutarti con qualsiasi necessit√†
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="dirigenti_index.html" class="btn-aurora font-black py-4 px-8 rounded-2xl text-base md:text-lg inline-block"> üìû Contatta Dirigenti </a>
                <a href="home.html" class="btn-secondary font-black py-4 px-8 rounded-2xl text-base md:text-lg inline-block"> üè† Torna alla Home </a>
            </div>
        </div>

    </main>

    <!-- MODAL PROGRAMMAZIONE TURNO -->
    <div id="turnoModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-black text-primary" id="turno-modal-title">‚ú® Programma Turno</h3>
                <button onclick="closeTurnoModal()" class="text-gray-500 hover:text-aurora text-3xl font-bold transition-colors" aria-label="Chiudi">&times;</button>
            </div>
            <form id="turnoForm" class="space-y-6">
                <input type="hidden" name="turno_id" id="turno-id">
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìÖ Data</label>
                    <input name="data_turno" type="date" class="w-full p-4 text-base md:text-lg font-semibold" required>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üéØ Tipo Turno</label>
                    <select name="tipo_turno" class="w-full p-4 text-base md:text-lg font-semibold" required>
                        <option value="">Seleziona turno...</option>
                        <option value="mattina">üåÖ Mattina</option>
                        <option value="pomeriggio">‚òÄÔ∏è Pomeriggio</option>
                        <option value="sera">üåÜ Sera</option>
                        <option value="notte">üåô Notte</option>
                        <option value="riposo">üò¥ Riposo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-bold text-gray-700 mb-3">üìù Note (opzionale)</label>
                    <textarea name="note" rows="3" class="w-full p-4 text-base md:text-lg" placeholder="Eventuali note..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="flex-1 btn-aurora py-4 px-6 rounded-2xl font-black text-base md:text-lg" id="turno-submit-btn"> ‚úÖ Salva Turno </button>
                    <button type="button" onclick="closeTurnoModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 px-6 rounded-2xl font-black text-base md:text-lg hover:from-gray-600 hover:to-gray-700 transition-all"> ‚ùå Annulla </button>
                </div>
                <div id="turno-delete-section" class="hidden">
                    <button type="button" onclick="deleteTurno()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 px-6 rounded-2xl font-black text-base md:text-lg hover:from-red-600 hover:to-red-700 transition-all"> üóëÔ∏è Elimina Turno </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL LICENZA/PERMESSO -->
    <div id="licenzaModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-black text-
