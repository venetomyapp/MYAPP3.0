<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Strumenti MyApp</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">

    <!-- Icone Standard -->
    <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/public/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/public/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/public/icons/icon-512x512.png">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Strumenti MyApp">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Android Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Strumenti MyApp">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    
    <!-- Preconnect per performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js per i grafici -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF per export PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#0f3460',
                        aurora: '#e94560',
                        cyan: '#00d4ff',
                        magenta: '#ff006e',
                        gold: '#ffd700',
                        teal: '#03dac6',
                        dark: '#0a0a23',
                        light: '#f8fafc',
                        success: '#10b981',
                        // Nuovi colori per i turni, con migliore visibilit√†
                        shift: {
                            morning: '#FF9500',   // Arancione brillante per mattina
                            afternoon: '#00CCFF', // Azzurro brillante per pomeriggio
                            evening: '#9966FF',   // Viola brillante per sera
                            night: '#0066CC',     // Blu scuro per notte
                            rest: '#33CC66'       // Verde brillante per riposo
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-gold: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            
            /* Nuovi colori per i turni con migliore contrasto */
            --shift-morning: #FF9500;
            --shift-afternoon: #00CCFF; 
            --shift-evening: #9966FF;
            --shift-night: #0066CC;
            --shift-rest: #33CC66;
        }

        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .text-ultra-visible { 
            color: #fff; 
            text-shadow: 0 8px 25px rgba(0,0,0,.9), 0 4px 12px rgba(0,0,0,.8), 0 2px 6px rgba(0,0,0,1); 
            font-weight: 800; 
        }

        .glass-morphism { 
            background: rgba(255,255,255,.08); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,.18); 
            box-shadow: 0 8px 32px rgba(31,38,135,.37); 
        }

        .glass-card { 
            background: rgba(255,255,255,.95); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,.3); 
            box-shadow: 0 20px 40px rgba(0,0,0,.1); 
        }

        .btn-aurora { 
            background: var(--gradient-magic); 
            color: #fff; 
            border: 2px solid rgba(233,69,96,.3); 
            transition: all .4s cubic-bezier(.4,0,.2,1); 
            position: relative; 
            overflow: hidden; 
            min-height: 44px; 
        }

        .btn-aurora:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(233,69,96,.4); 
            border-color: rgba(233,69,96,.6); 
        }

        .btn-aurora:active {
            transform: translateY(0) scale(0.98);
            transition: all .1s ease;
        }

        .btn-cyber { 
            background: var(--gradient-cyber); 
            border: 2px solid rgba(0,212,255,.3); 
            color: #fff; 
            transition: all .4s cubic-bezier(.4,0,.2,1); 
            min-height: 44px; 
        }

        .btn-cyber:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(0,212,255,.4); 
            border-color: rgba(0,212,255,.6); 
        }

        .btn-cyber:active {
            transform: translateY(0) scale(0.98);
            transition: all .1s ease;
        }

        .btn-cyan { 
            background: var(--gradient-cyber); 
            border: 2px solid rgba(0,212,255,.3); 
            color: #fff; 
            transition: all .4s cubic-bezier(.4,0,.2,1); 
            min-height: 44px; 
        }

        .btn-cyan:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(0,212,255,.4); 
            border-color: rgba(0,212,255,.6); 
        }

        .btn-cyan:active {
            transform: translateY(0) scale(0.98);
            transition: all .1s ease;
        }

        .btn-success { 
            background: var(--gradient-success); 
            border: 2px solid rgba(16,185,129,.3); 
            color: #fff; 
            transition: all .4s cubic-bezier(.4,0,.2,1); 
            min-height: 44px; 
        }

        .btn-success:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(16,185,129,.4); 
            border-color: rgba(16,185,129,.6); 
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
            transition: all .1s ease;
        }

        /* ENHANCED BOTTOM NAVIGATION - migliorata per gli schermi piccoli */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,.3);
            box-shadow: 0 -10px 30px rgba(0,0,0,.1);
            z-index: 100;
            height: 70px; /* Ridotta l'altezza */
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 5px; /* Ridotto padding */
        }
        
        /* Miglioriamo la nav per schermi piccoli */
        @media (max-width: 360px) {
            .bottom-nav {
                height: 60px;
                padding: 0 2px;
            }
            
            .nav-icon {
                font-size: 20px; /* Icone pi√π piccole */
            }
            
            .nav-text {
                font-size: 11px; /* Testo pi√π piccolo */
            }
        }

        /* NUOVI STILI PER I TURNI CON MAGGIORE VISIBILIT√Ä */
        .shift-card {
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid;
            font-weight: 600;
            color: #000;
            display: flex;
            align-items: center;
            position: relative;
        }

        /* Colori specifici per i diversi tipi di turno con pi√π visibilit√† e bordi pi√π spessi */
        .shift-mattina {
            background-color: var(--shift-morning);
            border-color: #E67700;
        }

        .shift-pomeriggio {
            background-color: var(--shift-afternoon);
            border-color: #0099CC;
        }

        .shift-sera {
            background-color: var(--shift-evening);
            border-color: #7733CC;
        }

        .shift-notte {
            background-color: var(--shift-night);
            border-color: #004C99;
            color: white; /* Testo bianco per migliore leggibilit√† su sfondo scuro */
        }

        .shift-riposo {
            background-color: var(--shift-rest);
            border-color: #27A352;
        }

        /* Badge per stato turno - migliorato contrasto */
        .shift-status {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid white;
        }

        .shift-status-confermato {
            background-color: #10B981;
            color: white;
        }

        .shift-status-attesa {
            background-color: #F59E0B;
            color: black;
        }

        .shift-status-modificato {
            background-color: #3B82F6;
            color: white;
        }

        /* Stile per il testo e icone dei turni */
        .shift-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .shift-time {
            font-weight: 700;
            font-size: 16px;
        }

        /* Miglioramenti per i bottoni di azione con focus sulla accessibilit√† e tap targets */
        .action-button {
            min-width: 44px;
            min-height: 44px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        /* Calendario pi√π leggibile e responsivo */
        .calendar-day {
            min-height: 44px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Indicator per eventi sul calendario */
        .calendar-event-indicator {
            position: absolute;
            bottom: 2px;
            width: 6px;
            height: 6px;
            border-radius: 3px;
            background-color: currentColor;
        }

        /* Scale UI per schermi molto piccoli */
        @media (max-width: 320px) {
            html {
                font-size: 14px;
            }
            
            .shift-card {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            h1, h2, h3 {
                margin: 0.5rem 0;
            }
            
            .container {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
        }

        /* Input fields pi√π grandi e facili da toccare */
        input, select, button {
            min-height: 44px;
            font-size: 16px; /* Evita zoom automatico su iOS */
        }
    </style>
	<script>
        // Inserisci qui il contenuto delle righe 218-3006 dal tuo file originale

        // *** AGGIUNGI QUESTE NUOVE FUNZIONI ALLA FINE DEL TUO CODICE JAVASCRIPT ESISTENTE ***

        // Funzione migliorata per ottenere lo stile del turno (con colori pi√π visibili)
        function getTurnoClass(tipo) {
            const classes = {
                mattina: 'shift-mattina',
                pomeriggio: 'shift-pomeriggio', 
                sera: 'shift-sera',
                notte: 'shift-notte',
                riposo: 'shift-riposo'
            };
            return classes[tipo] || 'shift-default';
        }

        // Funzione per facilitare la navigazione su schermi piccoli
        function setupResponsiveUI() {
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // Gestione pulsanti e controls per schermi piccoli
            if (viewportWidth < 360) {
                document.querySelectorAll('.btn-text').forEach(el => {
                    el.style.fontSize = '14px';
                });
                
                // Riduci padding contenitori principali
                document.querySelectorAll('.container').forEach(el => {
                    el.classList.remove('px-6');
                    el.classList.add('px-3');
                });
            }
            
            // Gestione altezza contenuto per evitare overflow
            const bottomNavHeight = document.querySelector('.bottom-nav')?.offsetHeight || 70;
            const contentContainers = document.querySelectorAll('.content-container');
            
            contentContainers.forEach(container => {
                container.style.maxHeight = `${viewportHeight - bottomNavHeight - 20}px`;
                container.style.overflowY = 'auto';
            });
            
            console.log(`üì± UI adattata: ${viewportWidth}x${viewportHeight}px`);
        }

        // Renderiamo la funzione di rendering dei turni pi√π accessibile
        function renderTurno(turno) {
            const turnoClass = getTurnoClass(turno.tipo);
            const turnoName = getTurnoName(turno.tipo);
            const turnoIcon = getTurnoIcon(turno.tipo);
            
            // Creiamo un elemento con colori pi√π visibili e area di tap pi√π grande
            return `
                <div class="shift-card ${turnoClass}" id="turno-${turno.id}">
                    <span class="shift-icon">${turnoIcon}</span>
                    <div class="flex-1">
                        <div class="shift-time">${turnoName}</div>
                        <div>${formatDate(turno.data)}</div>
                    </div>
                    ${turno.stato ? `<div class="shift-status shift-status-${turno.stato.toLowerCase()}">${turno.stato}</div>` : ''}
                    <button class="action-button ml-2" onclick="showTurnoDetails(${turno.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>
                </div>
            `;
        }

        // Funzione per il feedback tattile - migliora UX
        function triggerHapticFeedback() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function getTurnoName(tipo) {
            const names = {
                mattina: 'Mattina',
                pomeriggio: 'Pomeriggio',
                sera: 'Sera',
                notte: 'Notte',
                riposo: 'Riposo'
            };
            return names[tipo] || 'Turno';
        }

        function getTurnoIcon(tipo) {
            const icons = {
                mattina: 'üåÖ',
                pomeriggio: '‚òÄÔ∏è',
                sera: 'üåÜ',
                notte: 'üåô',
                riposo: 'üò¥'
            };
            return icons[tipo] || 'üìÖ';
        }

        function getLicenzaName(tipo) {
            const names = {
                ordinaria: 'Licenza Ordinaria',
                straordinaria: 'Licenza Straordinaria',
                speciale: 'Licenza Speciale',
                permesso: 'Permesso',
                riposo_settimanale: 'Riposo Settimanale'
            };
            return names[tipo] || 'Licenza';
        }

        function getLicenzaShortName(tipo) {
            const names = {
                ordinaria: 'Licenza',
                straordinaria: 'Lic. Str.',
                speciale: 'Lic. Sp.',
                permesso: 'Permesso',
                riposo_settimanale: 'Riposo S.'
            };
            return names[tipo] || 'Licenza';
        }

        function getLicenzaIcon(tipo) {
            const icons = {
                ordinaria: 'üèñÔ∏è',
                straordinaria: '‚≠ê',
                speciale: 'üéØ',
                permesso: 'üìã',
                riposo_settimanale: 'üõèÔ∏è'
            };
            return icons[tipo] || 'üìÖ';
        }

        function getRecuperoName(tipo) {
            const names = {
                festivita: 'Festivit√†',
                settimana_del: 'Settimana del...',
                straordinario: 'Giorni Straordinario',
                altro: 'Altro'
            };
            return names[tipo] || 'Recupero';
        }

        function getRecuperoIcon(tipo) {
            const icons = {
                festivita: 'üéÑ',
                settimana_del: 'üìÖ',
                straordinario: '‚è∞',
                altro: 'üéØ'
            };
            return icons[tipo] || 'üîÑ';
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('it-IT');
        }

        function calculateDaysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            return Math.ceil((end - start) / (1000 * 3600 * 24)) + 1;
        }

        function isDateInLicenza(dateStr) {
            return licenzeData.some(licenza => {
                const dataInizio = new Date(licenza.data_inizio);
                const dataFine = new Date(licenza.data_fine);
                const dataCheck = new Date(dateStr);
                return dataCheck >= dataInizio && dataCheck <= dataFine && 
                       licenza.stato !== 'rifiutata' && licenza.stato !== 'annullata';
            });
        }

        function getLicenzaForDate(dateStr) {
            return licenzeData.find(licenza => {
                const dataInizio = new Date(licenza.data_inizio);
                const dataFine = new Date(licenza.data_fine);
                const dataCheck = new Date(dateStr);
                return dataCheck >= dataInizio && dataCheck <= dataFine && 
                       licenza.stato !== 'rifiutata' && licenza.stato !== 'annullata';
            });
        }

        // ======================= USER ROLE & NAVIGATION =======================
        async function getUserRole() {
            try {
                if (!currentUser) {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) return null;
                    currentUser = session.user;
                }
                
                const { data: prof, error } = await supabase
                    .from('user_profiles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();
                    
                if (!error && prof && prof.role) {
                    return ('' + prof.role).toUpperCase();
                }
            } catch (e) {
                console.warn('Ruolo da user_profiles non disponibile:', e);
            }
            
            try {
                const roleMeta = currentUser?.user_metadata?.role || currentUser?.app_metadata?.role;
                if (roleMeta) return ('' + roleMeta).toUpperCase();
            } catch (e) {}
            
            return null;
        }

        async function navigateBack() {
            try {
                triggerHapticFeedback();
                const role = await getUserRole();
                if (role === 'DIRIGENTE' || role === 'ADMIN') {
                    window.location.href = '../home_dirigenti.html';
                } else {
                    window.location.href = '../home.html';
                }
            } catch (e) {
                console.error('Errore navigazione back:', e);
                window.location.href = '../home.html';
            }
        }

        // ======================= UI HELPERS =======================
        function showLoading(isLoading) {
            const elements = document.querySelectorAll('button, .nav-item');
            elements.forEach(el => {
                if (isLoading) {
                    el.classList.add('loading');
                } else {
                    el.classList.remove('loading');
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `fixed top-6 right-6 ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-transform duration-500 font-bold backdrop-blur-md border border-white/20`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // ======================= PERFORMANCE & ACCESSIBILITY =======================
        window.addEventListener('online', function() {
            showNotification('Connessione ripristinata', 'success');
            if (currentUser) loadAllData();
        });

        window.addEventListener('offline', function() {
            showNotification('Modalit√† offline attiva', 'info');
        });

        window.addEventListener('error', function(e) {
            console.error('Errore globale:', e.error);
            showNotification('Si √® verificato un errore', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejection:', e.reason);
            showNotification('Errore di connessione', 'error');
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('‚úÖ Service Worker registrato'))
                .catch(() => console.log('‚ö†Ô∏è Service Worker non disponibile'));
        }

        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                if (turniChart) {
                    turniChart.resize();
                }
                updateCalendar();
                setupResponsiveUI();
            }, 500);
        });

        window.addEventListener('resize', function() {
            setupResponsiveUI();
        });

        window.addEventListener('load', function() {
            setupResponsiveUI();
            
            setTimeout(() => {
                if ('performance' in window) {
                    const perf = performance.getEntriesByType('navigation')[0];
                    console.log(`üìä Performance: ${Math.round(perf.loadEventEnd - perf.loadEventStart)}ms`);
                }
            }, 0);
        });

        console.log('üåê MyApp Strumenti Mobile Enhanced - Sistema caricato');
    </script>
</body>
</html>
