<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferma Email - MyApp</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- CONFIGURAZIONE COLORI TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#0f3460',
                        aurora: '#e94560',
                        cyan: '#00d4ff',
                        magenta: '#ff006e',
                        gold: '#ffd700',
                        teal: '#03dac6',
                        dark: '#0a0a23',
                        light: '#f8fafc',
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
        }

        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            min-height: 100vh;
        }

        @keyframes aurora {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -30px, 0); }
            70% { transform: translate3d(0, -15px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .status-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            padding: 3rem 2.5rem;
            margin: 2rem;
            text-align: center;
        }

        .icon-bounce {
            animation: bounce 2s infinite;
        }

        .icon-spin {
            animation: spin 1s linear infinite;
        }

        .icon-pulse {
            animation: pulse 2s infinite;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-magic);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .btn-primary {
            background: var(--gradient-magic);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #1a1a2e;
            border: 2px solid rgba(26, 26, 46, 0.2);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(26, 26, 46, 0.4);
        }

        .status-text {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: #64748b;
            line-height: 1.6;
        }

        .status-title {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1rem;
            color: #1a1a2e;
        }

        .status-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .step-info {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #e94560;
            text-align: left;
        }

        .step-title {
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 8px;
        }

        .step-description {
            color: #64748b;
            font-size: 0.95rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- STATO LOADING -->
    <div id="loadingState" class="status-container">
        <div class="status-icon icon-spin">‚ö°</div>
        <h1 class="status-title">Conferma in corso...</h1>
        <p class="status-text">
            Stiamo verificando la tua email e configurando il tuo account.
        </p>
        
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        
        <div class="step-info">
            <div class="step-title">üîê Fase attuale: <span id="currentStep">Verifica email</span></div>
            <div class="step-description" id="stepDescription">
                Stiamo verificando la validit√† del link di conferma...
            </div>
        </div>
    </div>

    <!-- STATO SETUP -->
    <div id="setupState" class="status-container hidden">
        <div class="status-icon icon-bounce">üöÄ</div>
        <h1 class="status-title">Configurazione account</h1>
        <p class="status-text">
            Email confermata! Stiamo configurando il tuo profilo e la tua tessera digitale.
        </p>
        
        <div class="progress-bar">
            <div id="setupProgress" class="progress-fill" style="width: 50%"></div>
        </div>
        
        <div class="step-info">
            <div class="step-title">‚öôÔ∏è Configurazione automatica</div>
            <div class="step-description">
                ‚Ä¢ Creazione profilo utente<br>
                ‚Ä¢ Generazione tessera digitale<br>
                ‚Ä¢ Attivazione servizi
            </div>
        </div>
    </div>

    <!-- STATO SUCCESS -->
    <div id="successState" class="status-container hidden">
        <div class="status-icon icon-bounce">üéâ</div>
        <h1 class="status-title">Account attivato!</h1>
        <p class="status-text">
            La tua registrazione √® stata completata con successo. Ora puoi accedere a tutti i servizi di MyApp.
        </p>
        
        <div class="step-info">
            <div class="step-title">‚úÖ Configurazione completata</div>
            <div class="step-description">
                ‚Ä¢ Profilo utente creato<br>
                ‚Ä¢ Tessera digitale generata<br>
                ‚Ä¢ Tutti i servizi attivati
            </div>
        </div>
        
        <div style="margin-top: 2rem;">
            <a href="home.html" class="btn-primary">üè† Accedi all'App</a>
            <a href="auth.html" class="btn-secondary">üîê Vai al Login</a>
        </div>
    </div>

    <!-- STATO ERROR -->
    <div id="errorState" class="status-container hidden">
        <div class="status-icon icon-pulse">‚ùå</div>
        <h1 class="status-title">Errore conferma</h1>
        <p class="status-text" id="errorMessage">
            Si √® verificato un errore durante la conferma dell'email.
        </p>
        
        <div class="step-info">
            <div class="step-title">üîç Possibili cause</div>
            <div class="step-description">
                ‚Ä¢ Link di conferma scaduto (valido 24h)<br>
                ‚Ä¢ Link gi√† utilizzato in precedenza<br>
                ‚Ä¢ Problema di connessione temporaneo
            </div>
        </div>
        
        <div style="margin-top: 2rem;">
            <a href="auth.html" class="btn-primary">üîÑ Riprova Registrazione</a>
            <a href="index.html" class="btn-secondary">üè† Torna alla Home</a>
        </div>
    </div>

    <script>
        // === CONFIGURAZIONE SUPABASE ===
        const SUPABASE_URL = 'https://pvzdilkozpspsnepedqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2emRpbGtvenBzcHNuZXBlZHFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDY1NDUsImV4cCI6MjA3MDA4MjU0NX0.JimqeUkyOGcOw-pt-yJUVevSP3n6ikBPDR3N8y_7YIk';
        
        let supabaseClient;

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìß CONFERMA EMAIL PAGE LOADED - MyApp v5.0');
            
            try {
                // Inizializza Supabase
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase client inizializzato');
                
                // Avvia processo di conferma
                await handleEmailConfirmation();
                
            } catch (error) {
                console.error('‚ùå Errore inizializzazione:', error);
                showError('Errore inizializzazione sistema');
            }
        });

        // === GESTIONE CONFERMA EMAIL ===
        async function handleEmailConfirmation() {
            try {
                console.log('üîÑ Inizio processo di conferma email...');
                
                // Aggiorna progress
                updateProgress(20, 'Verifica parametri', 'Analisi dei parametri di conferma...');
                
                // Ottieni i parametri dalla URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const type = urlParams.get('type');
                
                console.log('üìã Parametri URL:', { token: token ? 'presente' : 'assente', type });
                
                if (!token || type !== 'signup') {
                    throw new Error('Parametri di conferma non validi');
                }
                
                // Aggiorna progress
                updateProgress(40, 'Conferma email', 'Verifica del token di conferma...');
                
                // Verifica il token con Supabase
                const { data, error } = await supabaseClient.auth.verifyOtp({
                    token_hash: token,
                    type: 'signup'
                });

                if (error) {
                    console.error('‚ùå Errore verifica token:', error);
                    throw new Error(`Errore conferma: ${error.message}`);
                }

                if (!data.user) {
                    throw new Error('Utente non trovato dopo la conferma');
                }

                console.log('‚úÖ Email confermata per:', data.user.email);
                
                // Aggiorna progress
                updateProgress(60, 'Email confermata', 'Email verificata con successo!');
                
                // Avvia setup account
                await setupUserAccount(data.user);
                
            } catch (error) {
                console.error('‚ùå Errore conferma email:', error);
                showError(error.message);
            }
        }

        // === SETUP ACCOUNT UTENTE ===
        async function setupUserAccount(user) {
            try {
                console.log('‚öôÔ∏è Inizio setup account per:', user.email);
                
                // Mostra stato setup
                showState('setupState');
                updateSetupProgress(25);
                
                // Ottieni metadati utente
                const userData = user.user_metadata || {};
                console.log('üìã Metadati utente:', userData);
                
                // 1. Verifica/Crea profilo utente
                await createOrUpdateProfile(user, userData);
                updateSetupProgress(50);
                
                // Pausa per UX
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2. Crea tessera digitale
                await createDigitalTessera(user, userData);
                updateSetupProgress(75);
                
                // Pausa per UX
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. Finalizza setup
                updateSetupProgress(100);
                
                // Mostra successo
                setTimeout(() => showSuccess(), 1500);
                
                console.log('üéâ Setup account completato con successo');
                
            } catch (error) {
                console.error('‚ùå Errore setup account:', error);
                showError(`Errore durante la configurazione: ${error.message}`);
            }
        }

        // === CREAZIONE/AGGIORNAMENTO PROFILO ===
        async function createOrUpdateProfile(user, userData) {
            try {
                console.log('üë§ Creazione profilo utente...');
                
                // Verifica se il profilo esiste gi√†
                const { data: existingProfile } = await supabaseClient
                    .from('user_profiles')
                    .select('id')
                    .eq('user_id', user.id)
                    .single();

                if (existingProfile) {
                    console.log('‚úÖ Profilo esistente trovato, aggiorno stato');
                    
                    // Aggiorna solo lo stato se il profilo esiste
                    const { error: updateError } = await supabaseClient
                        .from('user_profiles')
                        .update({ 
                            stato: 'ATTIVO',
                            email: user.email 
                        })
                        .eq('user_id', user.id);
                    
                    if (updateError) {
                        console.error('‚ùå Errore aggiornamento profilo:', updateError);
                    }
                } else {
                    console.log('üÜï Creazione nuovo profilo');
                    
                    // Crea nuovo profilo con i dati dai metadati
                    const profileData = {
                        user_id: user.id,
                        email: user.email,
                        nome: userData.nome || 'Non specificato',
                        cognome: userData.cognome || 'Non specificato',
                        full_name: userData.nome && userData.cognome 
                            ? `${userData.nome} ${userData.cognome}` 
                            : 'Non specificato',
                        telefono: userData.telefono || null,
                        data_nascita: userData.data_nascita || null,
                        luogo_nascita: userData.luogo_nascita || null,
                        role: 'USER',
                        stato: 'ATTIVO'
                    };

                    const { error: insertError } = await supabaseClient
                        .from('user_profiles')
                        .insert([profileData]);

                    if (insertError) {
                        console.error('‚ùå Errore creazione profilo:', insertError);
                        throw new Error('Impossibile creare il profilo utente');
                    }
                }
                
                console.log('‚úÖ Profilo configurato correttamente');
                
            } catch (error) {
                console.error('‚ùå Errore gestione profilo:', error);
                throw error;
            }
        }

        // === CREAZIONE TESSERA DIGITALE ===
        async function createDigitalTessera(user, userData) {
            try {
                console.log('üé´ Creazione tessera digitale...');
                
                // Verifica se la tessera esiste gi√†
                const { data: existingTessera } = await supabaseClient
                    .from('tessere')
                    .select('numero_tessera')
                    .eq('user_id', user.id)
                    .single();

                if (existingTessera) {
                    console.log('‚úÖ Tessera esistente trovata:', existingTessera.numero_tessera);
                    return;
                }
                
                // Genera numero tessera univoco
                const numeroTessera = await generateTesseraNumber();
                
                // Crea tessera digitale
                const tesseraData = {
                    user_id: user.id,
                    numero_tessera: numeroTessera,
                    nome_completo: userData.nome && userData.cognome 
                        ? `${userData.nome} ${userData.cognome}` 
                        : 'Non specificato',
                    email: user.email,
                    telefono: userData.telefono || null,
                    data_emissione: new Date().toISOString().split('T')[0],
                    data_scadenza: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +1 anno
                    stato: 'ATTIVA',
                    tipo: 'STANDARD',
                    qr_code_data: JSON.stringify({
                        tessera: numeroTessera,
                        user_id: user.id,
                        timestamp: Date.now(),
                        type: 'MyApp_tessera'
                    })
                };

                const { error: tesseraError } = await supabaseClient
                    .from('tessere')
                    .insert([tesseraData]);

                if (tesseraError) {
                    console.error('‚ùå Errore creazione tessera:', tesseraError);
                    throw new Error('Impossibile creare la tessera digitale');
                }
                
                console.log('‚úÖ Tessera digitale creata:', numeroTessera);
                
            } catch (error) {
                console.error('‚ùå Errore creazione tessera:', error);
                throw error;
            }
        }

        // === GENERAZIONE NUMERO TESSERA ===
        async function generateTesseraNumber() {
            try {
                const year = new Date().getFullYear();
                
                // Conta tessere esistenti per determinare il numero progressivo
                const { count } = await supabaseClient
                    .from('tessere')
                    .select('*', { count: 'exact', head: true });
                
                const nextNumber = (count || 0) + 1;
                const numeroTessera = `MYAPP-${year}-${nextNumber.toString().padStart(4, '0')}`;
                
                console.log('üéØ Numero tessera generato:', numeroTessera);
                return numeroTessera;
                
            } catch (error) {
                console.error('‚ùå Errore generazione numero tessera:', error);
                // Fallback con timestamp
                const timestamp = Date.now().toString().slice(-6);
                return `MYAPP-${new Date().getFullYear()}-${timestamp}`;
            }
        }

        // === FUNZIONI UI ===
        function showState(stateId) {
            // Nasconde tutti gli stati
            ['loadingState', 'setupState', 'successState', 'errorState'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Mostra lo stato richiesto
            document.getElementById(stateId).classList.remove('hidden');
        }

        function updateProgress(percentage, step, description) {
            const progressFill = document.getElementById('progressFill');
            const currentStep = document.getElementById('currentStep');
            const stepDescription = document.getElementById('stepDescription');
            
            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (currentStep) currentStep.textContent = step;
            if (stepDescription) stepDescription.textContent = description;
        }

        function updateSetupProgress(percentage) {
            const setupProgress = document.getElementById('setupProgress');
            if (setupProgress) setupProgress.style.width = `${percentage}%`;
        }

        function showSuccess() {
            showState('successState');
            
            // Aggiungi confetti effect (opzionale)
            setTimeout(() => {
                console.log('üéâ Account configurato con successo!');
            }, 500);
        }

        function showError(message) {
            showState('errorState');
            
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = message || 'Si √® verificato un errore imprevisto.';
            }
            
            console.error('‚ùå Errore mostrato all\'utente:', message);
        }

        // === UTILITY ===
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        console.log('üöÄ MyApp Email Confirmation System - Ready');
    </script>

</body>
</html>
