<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MyApp</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">

    <!-- Icone -->
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- App Configuration -->
    <script src="/assets/js/app-config.js"></script>
    
    <!-- CONFIGURAZIONE COLORI TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#0f3460',
                        aurora: '#e94560',
                        cyan: '#00d4ff',
                        magenta: '#ff006e',
                        gold: '#ffd700',
                        teal: '#03dac6',
                        dark: '#0a0a23',
                        light: '#f8fafc',
                        textDark: '#1C1C1E',
                        backgroundLight: '#F4F4F8',
                    }
                }
            }
        }
    </script>
    
    <!-- STILI CSS -->
    <style>
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
        }

        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            min-height: 100vh;
        }

        @keyframes aurora {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .text-ultra-visible {
            color: #ffffff;
            text-shadow: 0 8px 25px rgba(0, 0, 0, 0.9), 0 4px 12px rgba(0, 0, 0, 0.8), 0 2px 6px rgba(0, 0, 0, 1);
            font-weight: 800;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        .btn-aurora {
            background: var(--gradient-magic);
            color: white;
            border: 2px solid rgba(233, 69, 96, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
        }

        .btn-aurora:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 20px 40px rgba(233, 69, 96, 0.4);
            border-color: rgba(233, 69, 96, 0.8);
        }

        .service-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .service-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .tessera-digitale {
            background: linear-gradient(135deg, #1a1a2e, #0f3460);
            border-radius: 20px;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 250px;
        }

        .tessera-digitale::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,212,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px) scale(1.05);
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-item {
            color: #6b7280;
            transition: all 0.3s ease;
            padding: 0.5rem;
        }

        .nav-item:hover {
            color: #1a1a2e;
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: #e94560;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 12px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @media (max-width: 640px) {
            .service-card {
                padding: 1rem;
            }
            
            .tessera-digitale {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

    <!-- Loading State -->
    <div id="loadingState" class="fixed inset-0 bg-primary bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-aurora mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">Caricamento dashboard...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="w-full px-4 py-6 relative z-10 glass-morphism">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-ultra-visible">MyApp</h1>
                <p class="text-cyan text-sm font-semibold" id="welcomeMessage">Bentornuto</p>
            </div>
            <button id="logoutBtn" class="btn-aurora px-6 py-2 rounded-full text-sm">
                üö™ Esci
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-6 max-w-6xl mx-auto w-full">
        
        <!-- Tessera Digitale -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4">La tua Tessera Digitale</h2>
            <div class="tessera-digitale" id="tesseraContainer">
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <p class="text-cyan text-sm font-semibold mb-1">TESSERA ASSOCIATIVA</p>
                            <h3 class="text-2xl font-bold" id="tesseraNome">Caricamento...</h3>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 bg-green-500 rounded-full text-xs font-bold">ATTIVA</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-cyan text-xs mb-1">NUMERO TESSERA</p>
                            <p class="font-mono text-lg" id="tesseraNumero">--------</p>
                        </div>
                        <div>
                            <p class="text-cyan text-xs mb-1">SCADENZA</p>
                            <p class="font-mono text-lg" id="tesseraScadenza">--/--/----</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-cyan text-xs mb-1">TIPO</p>
                            <p class="font-semibold" id="tesseraTipo">STANDARD</p>
                        </div>
                        <div class="text-4xl">üõ°Ô∏è</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card text-center">
                <div class="text-3xl mb-2">üì¢</div>
                <div class="text-2xl font-bold text-white" id="newsCount">0</div>
                <div class="text-cyan text-sm">Nuovi Avvisi</div>
            </div>
            
            <div class="stat-card text-center">
                <div class="text-3xl mb-2">üìÑ</div>
                <div class="text-2xl font-bold text-white" id="docsCount">0</div>
                <div class="text-cyan text-sm">Documenti</div>
            </div>
            
            <div class="stat-card text-center">
                <div class="text-3xl mb-2">üéØ</div>
                <div class="text-2xl font-bold text-white" id="convenzioniCount">0</div>
                <div class="text-cyan text-sm">Convenzioni</div>
            </div>
            
            <div class="stat-card text-center">
                <div class="text-3xl mb-2">üí¨</div>
                <div class="text-2xl font-bold text-white" id="richiesteCount">0</div>
                <div class="text-cyan text-sm">Richieste</div>
            </div>
        </div>

        <!-- Services Grid -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Servizi Rapidi</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <a href="profilo.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üë§</div>
                        <h3 class="font-bold text-primary">Il Mio Profilo</h3>
                        <p class="text-sm text-gray-600 mt-1">Gestisci i tuoi dati</p>
                    </div>
                </a>
                
                <a href="convenzioni.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üéÅ</div>
                        <h3 class="font-bold text-primary">Convenzioni</h3>
                        <p class="text-sm text-gray-600 mt-1">Sconti esclusivi</p>
                    </div>
                </a>
                
                <a href="documenti.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üìö</div>
                        <h3 class="font-bold text-primary">Documenti</h3>
                        <p class="text-sm text-gray-600 mt-1">Area download</p>
                    </div>
                </a>
                
                <a href="assistenza.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üÜò</div>
                        <h3 class="font-bold text-primary">Assistenza</h3>
                        <p class="text-sm text-gray-600 mt-1">Richiedi supporto</p>
                    </div>
                </a>
                
                <a href="news.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üì∞</div>
                        <h3 class="font-bold text-primary">News</h3>
                        <p class="text-sm text-gray-600 mt-1">Ultime notizie</p>
                    </div>
                </a>
                
                <a href="dirigenti.html" class="service-card">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üë•</div>
                        <h3 class="font-bold text-primary">Dirigenti</h3>
                        <p class="text-sm text-gray-600 mt-1">I nostri referenti</p>
                    </div>
                </a>
            </div>
        </div>

        <!-- News Section -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Ultime News</h2>
            <div id="newsContainer" class="space-y-4">
                <!-- News items will be loaded here -->
                <div class="glass-card rounded-xl p-4">
                    <p class="text-gray-600 text-center">Caricamento news...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 px-4 py-3">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <a href="home.html" class="nav-item active flex flex-col items-center text-xs">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 0 0 1 1h3m10-11 2 2m-2-2v10a1 1 0 0 1-1 1h-3m-6 0a1 1 0 0 0 1-1v-4a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1m-6 0h6"></path>
                </svg>
                Home
            </a>
            <a href="convenzioni.html" class="nav-item flex flex-col items-center text-xs">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Convenzioni
            </a>
            <a href="tessera.html" class="nav-item flex flex-col items-center text-xs">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                </svg>
                Tessera
            </a>
            <a href="profilo.html" class="nav-item flex flex-col items-center text-xs">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Profilo
            </a>
        </div>
    </nav>

    <script>
        // Variabili globali
        let currentUser = null;
        let userProfile = null;
        let userTessera = null;

        // üîí Verifica autenticazione
        async function checkAuth() {
            try {
                const session = await APP_CONFIG.AuthManager.checkAuth();
                
                if (!session) {
                    console.log('‚ùå Nessuna sessione trovata');
                    APP_CONFIG.APP_PATHS.navigate('login');
                    return null;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Utente autenticato:', currentUser.email);
                
                // Carica profilo utente
                userProfile = await APP_CONFIG.AuthManager.getUserProfile(currentUser.id);
                
                // Se non esiste profilo, crealo
                if (!userProfile) {
                    await createUserProfile();
                }
                
                // Verifica ruolo e redirect se necessario
                if (userProfile && (userProfile.role === 'DIRIGENTE' || userProfile.role === 'ADMIN')) {
                    console.log('üëë Utente dirigente/admin, redirect...');
                    APP_CONFIG.APP_PATHS.navigate('homeDirigenti');
                    return null;
                }
                
                // Aggiorna messaggio di benvenuto
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (welcomeMsg && userProfile) {
                    welcomeMsg.textContent = `Bentornato, ${userProfile.full_name || userProfile.nome || 'Utente'}!`;
                }
                
                return currentUser;
            } catch (error) {
                console.error('Errore auth:', error);
                APP_CONFIG.APP_PATHS.navigate('login');
                return null;
            }
        }

        // üÜï Crea profilo se non esiste
        async function createUserProfile() {
            try {
                const supabaseClient = APP_CONFIG.getSupabaseClient();
                const userData = currentUser.user_metadata || {};
                
                const profileData = {
                    user_id: currentUser.id,
                    email: currentUser.email,
                    full_name: userData.full_name || '',
                    nome: userData.nome || '',
                    cognome: userData.cognome || '',
                    telefono: userData.telefono || '',
                    role: userData.role || 'USER',
                    stato: 'ATTIVO'
                };
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .insert([profileData])
                    .select()
                    .single();
                
                if (!error) {
                    userProfile = data;
                    console.log('‚úÖ Profilo creato:', userProfile);
                }
            } catch (error) {
                console.error('Errore creazione profilo:', error);
            }
        }

        // üé´ Carica tessera
        async function loadTessera() {
            try {
                const supabaseClient = APP_CONFIG.getSupabaseClient();
                const { data, error } = await supabaseClient
                    .from('tessere')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('stato', 'ATTIVA')
                    .single();
                
                if (error) {
                    console.log('Tessera non trovata, creazione...');
                    await createTessera();
                    return;
                }
                
                userTessera = data;
                displayTessera();
                
            } catch (error) {
                console.error('Errore caricamento tessera:', error);
            }
        }

        // üÜï Crea tessera
        async function createTessera() {
            try {
                const supabaseClient = APP_CONFIG.getSupabaseClient();
                const tesseraData = {
                    user_id: currentUser.id,
                    numero_tessera: APP_CONFIG.Utils.generateTessera(),
                    nome_completo: userProfile?.full_name || `${userProfile?.nome} ${userProfile?.cognome}` || 'Nome Cognome',
                    email: currentUser.email,
                    telefono: userProfile?.telefono || '',
                    stato: 'ATTIVA',
                    tipo: 'STANDARD'
                };
                
                const { data, error } = await supabaseClient
                    .from('tessere')
                    .insert([tesseraData])
                    .select()
                    .single();
                
                if (!error) {
                    userTessera = data;
                    displayTessera();
                }
            } catch (error) {
                console.error('Errore creazione tessera:', error);
            }
        }

        // üé® Mostra tessera
        function displayTessera() {
            if (!userTessera) return;
            
            document.getElementById('tesseraNome').textContent = userTessera.nome_completo;
            document.getElementById('tesseraNumero').textContent = userTessera.numero_tessera;
            document.getElementById('tesseraTipo').textContent = userTessera.tipo;
            
            // Formatta data scadenza
            if (userTessera.data_scadenza) {
                const formattedDate = APP_CONFIG.Utils.formatDate(userTessera.data_scadenza);
                document.getElementById('tesseraScadenza').textContent = formattedDate;
            }
        }

        // üìä Carica statistiche
        async function loadStats() {
            try {
                const supabaseClient = APP_CONFIG.getSupabaseClient();
                
                // Conta news non lette
                const { count: newsCount } = await supabaseClient
                    .from('news')
                    .select('*', { count: 'exact', head: true })
                    .eq('pubblicato', true)
                    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
                
                document.getElementById('newsCount').textContent = newsCount || 0;
                
                // Conta convenzioni attive
                const { count: convenzioniCount } = await supabaseClient
                    .from('convenzioni')
                    .select('*', { count: 'exact', head: true })
                    .eq('attiva', true);
                
                document.getElementById('convenzioniCount').textContent = convenzioniCount || 0;
                
                // Conta richieste aperte
                const { count: richiesteCount } = await supabaseClient
                    .from('richieste')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id)
                    .eq('stato', 'APERTA');
                
                document.getElementById('richiesteCount').textContent = richiesteCount || 0;
                
                // Conta documenti
                const { count: docsCount } = await supabaseClient
                    .from('documenti')
                    .select('*', { count: 'exact', head: true })
                    .eq('pubblico', true);
                
                document.getElementById('docsCount').textContent = docsCount || 0;
                
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // üì∞ Carica ultime news
        async function loadLatestNews() {
            try {
                const supabaseClient = APP_CONFIG.getSupabaseClient();
                const { data: news, error } = await supabaseClient
                    .from('news')
                    .select('*')
                    .eq('pubblicato', true)
                    .order('data_pubblicazione', { ascending: false })
                    .limit(3);
                
                if (error) throw error;
                
                const newsContainer = document.getElementById('newsContainer');
                
                if (news && news.length > 0) {
                    newsContainer.innerHTML = news.map(item => `
                        <div class="glass-card rounded-xl p-4 cursor-pointer hover:scale-[1.02] transition-transform">
                            <div class="flex items-start gap-4">
                                <div class="text-3xl">${getCategoryIcon(item.categoria)}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-primary">${item.titolo}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${item.sottotitolo || ''}</p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ${APP_CONFIG.Utils.formatDate(item.data_pubblicazione)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    newsContainer.innerHTML = `
                        <div class="glass-card rounded-xl p-8 text-center">
                            <div class="text-4xl mb-3">üì≠</div>
                            <p class="text-gray-600">Nessuna news disponibile</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Errore caricamento news:', error);
                document.getElementById('newsContainer').innerHTML = `
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-red-600">Errore nel caricamento delle news</p>
                    </div>
                `;
            }
        }

        // üéØ Ottieni icona categoria
        function getCategoryIcon(categoria) {
            const icons = {
                'GENERALE': 'üì¢',
                'SINDACALE': 'ü§ù',
                'LEGALE': '‚öñÔ∏è',
                'EVENTI': 'üìÖ',
                'FORMAZIONE': 'üìö',
                'CONVENZIONI': 'üéÅ'
            };
            return icons[categoria] || 'üì∞';
        }

        // üöÄ Inizializzazione
        async function initDashboard() {
            // Verifica autenticazione
            const user = await checkAuth();
            if (!user) return; // Se non autenticato o √® dirigente, stop
            
            // Nascondi loading
            document.getElementById('loadingState').style.display = 'none';
            
            // Carica tutti i dati
            await Promise.all([
                loadTessera(),
                loadStats(),
                loadLatestNews()
            ]);
            
            console.log('‚úÖ Dashboard caricata completamente');
        }

        // üìù Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† HOME PAGE LOADED - MyApp Dashboard');
            
            // Inizializza dashboard
            initDashboard();
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                APP_CONFIG.AuthManager.logout();
            });
            
            // Update service links with correct paths
            const serviceLinks = {
                'profilo': document.querySelector('a[href="profilo.html"]'),
                'convenzioni': document.querySelector('a[href="convenzioni.html"]'),
                'documenti': document.querySelector('a[href="documenti.html"]'),
                'assistenza': document.querySelector('a[href="assistenza.html"]'),
                'news': document.querySelector('a[href="news.html"]'),
                'dirigenti': document.querySelector('a[href="dirigenti.html"]')
            };
            
            // Update hrefs with APP_CONFIG paths
            if (serviceLinks.profilo) serviceLinks.profilo.href = APP_CONFIG.APP_PATHS.getPath('profilo');
            if (serviceLinks.convenzioni) serviceLinks.convenzioni.href = APP_CONFIG.APP_PATHS.getPath('convenzioni');
            if (serviceLinks.dirigenti) serviceLinks.dirigenti.href = APP_CONFIG.APP_PATHS.getPath('dirigenti');
            
            // Update bottom nav links
            const bottomNavLinks = {
                'home': document.querySelector('nav a[href="home.html"]'),
                'convenzioni': document.querySelector('nav a[href="convenzioni.html"]'),
                'tessera': document.querySelector('nav a[href="tessera.html"]'),
                'profilo': document.querySelector('nav a[href="profilo.html"]')
            };
            
            if (bottomNavLinks.home) bottomNavLinks.home.href = APP_CONFIG.APP_PATHS.getPath('home');
            if (bottomNavLinks.convenzioni) bottomNavLinks.convenzioni.href = APP_CONFIG.APP_PATHS.getPath('convenzioni');
            if (bottomNavLinks.tessera) bottomNavLinks.tessera.href = APP_CONFIG.APP_PATHS.getPath('tessera');
            if (bottomNavLinks.profilo) bottomNavLinks.profilo.href = APP_CONFIG.APP_PATHS.getPath('profilo');
        });

        // üîÑ Auto-refresh ogni 5 minuti
        setInterval(() => {
            if (currentUser) {
                loadStats();
                loadLatestNews();
            }
        }, 5 * 60 * 1000);

        console.log('‚úÖ Home Dashboard con APP_CONFIG Ready');
    </script>

        // Variabili globali
        let currentUser = null;
        let userProfile = null;
        let userTessera = null;

        // üîí Verifica autenticazione
        async function checkAuth() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    console.log('‚ùå Nessuna sessione trovata');
                    window.location.href = 'login.html';
                    return null;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Utente autenticato:', currentUser.email);
                
                // Carica profilo utente
                await loadUserProfile();
                
                // Verifica ruolo e redirect se necessario
                if (userProfile && (userProfile.role === 'DIRIGENTE' || userProfile.role === 'ADMIN')) {
                    console.log('üëë Utente dirigente/admin, redirect...');
                    window.location.href = 'home_dirigenti.html';
                    return null;
                }
                
                return currentUser;
            } catch (error) {
                console.error('Errore auth:', error);
                window.location.href = 'login.html';
                return null;
            }
        }

        // üë§ Carica profilo utente
        async function loadUserProfile() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                userProfile = data;
                console.log('‚úÖ Profilo caricato:', userProfile);
                
                // Aggiorna messaggio di benvenuto
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Bentornato, ${userProfile.full_name || userProfile.nome || 'Utente'}!`;
                }
                
            } catch (error) {
                console.error('Errore caricamento profilo:', error);
                // Se il profilo non esiste, crealo
                await createUserProfile();
            }
        }

        // üÜï Crea profilo se non esiste
        async function createUserProfile() {
            try {
                const userData = currentUser.user_metadata || {};
                
                const profileData = {
                    user_id: currentUser.id,
                    email: currentUser.email,
                    full_name: userData.full_name || '',
                    nome: userData.nome || '',
                    cognome: userData.cognome || '',
                    telefono: userData.telefono || '',
                    role: userData.role || 'USER',
                    stato: 'ATTIVO'
                };
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .insert([profileData])
                    .select()
                    .single();
                
                if (!error) {
                    userProfile = data;
                    console.log('‚úÖ Profilo creato:', userProfile);
                }
            } catch (error) {
                console.error('Errore creazione profilo:', error);
            }
        }

        // üé´ Carica tessera
        async function loadTessera() {
            try {
                const { data, error } = await supabaseClient
                    .from('tessere')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('stato', 'ATTIVA')
                    .single();
                
                if (error) {
                    console.log('Tessera non trovata, creazione...');
                    await createTessera();
                    return;
                }
                
                userTessera = data;
                displayTessera();
                
            } catch (error) {
                console.error('Errore caricamento tessera:', error);
            }
        }

        // üÜï Crea tessera
        async function createTessera() {
            try {
                const tesseraData = {
                    user_id: currentUser.id,
                    numero_tessera: generateNumeroTessera(),
                    nome_completo: userProfile?.full_name || `${userProfile?.nome} ${userProfile?.cognome}` || 'Nome Cognome',
                    email: currentUser.email,
                    telefono: userProfile?.telefono || '',
                    stato: 'ATTIVA',
                    tipo: 'STANDARD'
                };
                
                const { data, error } = await supabaseClient
                    .from('tessere')
                    .insert([tesseraData])
                    .select()
                    .single();
                
                if (!error) {
                    userTessera = data;
                    displayTessera();
                }
            } catch (error) {
                console.error('Errore creazione tessera:', error);
            }
        }

        // üé≤ Genera numero tessera
        function generateNumeroTessera() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
            return `MA${year}${random}`;
        }

        // üé® Mostra tessera
        function displayTessera() {
            if (!userTessera) return;
            
            document.getElementById('tesseraNome').textContent = userTessera.nome_completo;
            document.getElementById('tesseraNumero').textContent = userTessera.numero_tessera;
            document.getElementById('tesseraTipo').textContent = userTessera.tipo;
            
            // Formatta data scadenza
            if (userTessera.data_scadenza) {
                const scadenza = new Date(userTessera.data_scadenza);
                const formattedDate = `${scadenza.getDate().toString().padStart(2, '0')}/${(scadenza.getMonth() + 1).toString().padStart(2, '0')}/${scadenza.getFullYear()}`;
                document.getElementById('tesseraScadenza').textContent = formattedDate;
            }
        }

        // üìä Carica statistiche
        async function loadStats() {
            try {
                // Conta news non lette
                const { count: newsCount } = await supabaseClient
                    .from('news')
                    .select('*', { count: 'exact', head: true })
                    .eq('pubblicato', true)
                    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
                
                document.getElementById('newsCount').textContent = newsCount || 0;
                
                // Conta convenzioni attive
                const { count: convenzioniCount } = await supabaseClient
                    .from('convenzioni')
                    .select('*', { count: 'exact', head: true })
                    .eq('attiva', true);
                
                document.getElementById('convenzioniCount').textContent = convenzioniCount || 0;
                
                // Conta richieste aperte
                const { count: richiesteCount } = await supabaseClient
                    .from('richieste')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id)
                    .eq('stato', 'APERTA');
                
                document.getElementById('richiesteCount').textContent = richiesteCount || 0;
                
                // Conta documenti
                const { count: docsCount } = await supabaseClient
                    .from('documenti')
                    .select('*', { count: 'exact', head: true })
                    .eq('pubblico', true);
                
                document.getElementById('docsCount').textContent = docsCount || 0;
                
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // üì∞ Carica ultime news
        async function loadLatestNews() {
            try {
                const { data: news, error } = await supabaseClient
                    .from('news')
                    .select('*')
                    .eq('pubblicato', true)
                    .order('data_pubblicazione', { ascending: false })
                    .limit(3);
                
                if (error) throw error;
                
                const newsContainer = document.getElementById('newsContainer');
                
                if (news && news.length > 0) {
                    newsContainer.innerHTML = news.map(item => `
                        <div class="glass-card rounded-xl p-4 cursor-pointer hover:scale-[1.02] transition-transform">
                            <div class="flex items-start gap-4">
                                <div class="text-3xl">${getCategoryIcon(item.categoria)}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-primary">${item.titolo}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${item.sottotitolo || ''}</p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ${formatDate(item.data_pubblicazione)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    newsContainer.innerHTML = `
                        <div class="glass-card rounded-xl p-8 text-center">
                            <div class="text-4xl mb-3">üì≠</div>
                            <p class="text-gray-600">Nessuna news disponibile</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Errore caricamento news:', error);
                document.getElementById('newsContainer').innerHTML = `
                    <div class="glass-card rounded-xl p-4 text-center">
                        <p class="text-red-600">Errore nel caricamento delle news</p>
                    </div>
                `;
            }
        }

        // üìÖ Formatta data
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('it-IT', options);
        }

        // üéØ Ottieni icona categoria
        function getCategoryIcon(categoria) {
            const icons = {
                'GENERALE': 'üì¢',
                'SINDACALE': 'ü§ù',
                'LEGALE': '‚öñÔ∏è',
                'EVENTI': 'üìÖ',
                'FORMAZIONE': 'üìö',
                'CONVENZIONI': 'üéÅ'
            };
            return icons[categoria] || 'üì∞';
        }

        // üö™ Logout
        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                console.log('‚úÖ Logout effettuato');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Errore logout:', error);
                // Forza redirect anche in caso di errore
                window.location.href = 'index.html';
            }
        }

        // üöÄ Inizializzazione
        async function initDashboard() {
            // Verifica autenticazione
            const user = await checkAuth();
            if (!user) return; // Se non autenticato o √® dirigente, stop
            
            // Nascondi loading
            document.getElementById('loadingState').style.display = 'none';
            
            // Carica tutti i dati
            await Promise.all([
                loadTessera(),
                loadStats(),
                loadLatestNews()
            ]);
            
            console.log('‚úÖ Dashboard caricata completamente');
        }

        // üìù Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† HOME PAGE LOADED - MyApp Dashboard');
            
            // Inizializza dashboard
            initDashboard();
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Listen for auth state changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') {
                    window.location.href = 'index.html';
                }
            });
        });

        // üîÑ Auto-refresh ogni 5 minuti
        setInterval(() => {
            if (currentUser) {
                loadStats();
                loadLatestNews();
            }
        }, 5 * 60 * 1000);

        console.log('‚úÖ Home Dashboard System Ready');
    </script>
</body>
<<<<<<< HEAD
</html>
=======
</html>
>>>>>>> 2f7a0d5c3a988903f618457dcc3a93a67815f3d9
